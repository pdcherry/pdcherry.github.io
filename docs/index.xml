<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Frameshift</title>
<link>https://pdcherry.github.io/</link>
<atom:link href="https://pdcherry.github.io/index.xml" rel="self" type="application/rss+xml"/>
<description>A blog of indeterminate subject matter and publication frequency from a bioinformatician and data scientist by way of molecular biology.</description>
<generator>quarto-1.6.39</generator>
<lastBuildDate>Tue, 08 Oct 2024 07:00:00 GMT</lastBuildDate>
<item>
  <title>San Francisco political support clustering</title>
  <dc:creator>Patrick Cherry</dc:creator>
  <link>https://pdcherry.github.io/posts/2024_10_08-SF_political_support_clustering.html</link>
  <description><![CDATA[ 





<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_10_08-SF_political_support_data/2022_06_26-Pride_Lasers-057-horz_crop.jpg" class="img-fluid figure-img"></p>
<figcaption>LGBTQ+ Pride light cannons project down Market Street at the Ferry Building, with a uterus projected onto the clock tower in the background. The ballot this November includes Prop. 3 to protect the right to marriage in the state constitution and Prop. O to protect reproductive health rights and privacy in San Francisco.</figcaption>
</figure>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In the spirit of <a href="../posts/2024_03_02-SF_political_support_data.html">last March’s primary election recommendations analysis</a>, by popular demand, I am again running clustering analysis on the ballot measure and political race recommendations by the various political organizations in San Francisco that issue endorsements of issues and candidates.</p>
<p>San Francisco (and much of the Bay Area) has a curious political idiosyncrasy where brand-name <strong>R</strong>epublican candidates and issues get so little traction among voters so as to be considered irrelevant. Yet, many <strong>r</strong>epublican ideals and beliefs do receive substantial support from locals.</p>
<p>This dynamic causes practically republican organizations to outwardly re-code and re-brand as something—anything—other than GOP. Popular self-descriptions include Moderate or middle-of-the-road Democrat. However, this analysis is motivated by ignoring these pretenses and looking exclusively at indicated issue recommendations / endorsements, and understanding how similar vs.&nbsp;how different each political organization is acting (a behaviorist / empirical approach).</p>
<section id="notes-on-approach" class="level2">
<h2 class="anchored" data-anchor-id="notes-on-approach">Notes on approach</h2>
<p>The website <a href="https://sfendorsements.com/">sfendorsements.com</a> has collected and cataloged many of the city’s politically active groups’ (often Political Action Committees, or PACs) positions on ballot measures and election races for local positions. I hypothesize that these can be used to deduce the true alignment of these organizations.</p>
<p>Peter Xu <a href="https://gitlab.com/peterxu/sf-endorsements">make the code available</a>, and has has previously made <a href="https://docs.google.com/spreadsheets/d/1f3cGgXjI912nA8e1_iTlEhJ7XpxjpSKZdT7wX3ryztg/edit#gid=1545354255">google sheets</a> available for the endorsement data, but those are for 2022.</p>
<p>For this analysis, I will scrape the November 2024 General Elections data, tidy it up, and analyze it.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>This page may be incomplete. As of 2024-10-09, endorsement data has yet to be published for a few organizations that have made recommendations in the past (San Francisco Chronicle, San Francisco Examiner, United Educators of San Francisco, <del>SPUR (Planning / Urban Research Association)</del>, Tech Workers Voter Guide, San Francisco Parent Action, San Francisco Rising Action, and SF Young Democrats).</p>
</div>
</div>
<ul>
<li>SPUR published their voter guide 2024-10-08.</li>
<li>Yes on L <a href="https://sfba.social/@sftransitact/113283728641463168">let me know</a> that Housing Action Coalition now endorses Prop L (<a href="https://housingactioncoalition.org/news/november-2024-election-endorsements/#section-sf">which is true</a>, as of what date I’m not sure).</li>
</ul>
</section>
<section id="import-and-tidy-data" class="level2">
<h2 class="anchored" data-anchor-id="import-and-tidy-data">Import and tidy data</h2>
<p>Great, the data are now tidy, where each row is an observation (a political group), and each column is a variable (race / measure).</p>
</section>
<section id="what-are-the-propositions" class="level2">
<h2 class="anchored" data-anchor-id="what-are-the-propositions">What are the propositions?</h2>
<p>See the <a href="../posts/2024_08_29-Cali_Nov_2024_ballot_measures.html#state-wide-ballot-measures">August 29 post on San Francisco’s November 2024 ballot review</a> page for full descriptions of each State-wide and San Francisco ballot measure.</p>
</section>
<section id="analyze-by-ballot-measures" class="level2">
<h2 class="anchored" data-anchor-id="analyze-by-ballot-measures">Analyze by ballot measures</h2>
<section id="who-is-recommending-what" class="level3">
<h3 class="anchored" data-anchor-id="who-is-recommending-what">Who is recommending what?</h3>
<div class="cell">
<div class="cell-output-display">
<div id="fig-measure-plot" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-measure-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_10_08-SF_political_support_clustering_files/figure-html/fig-measure-plot-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-measure-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Color-coded layout of political organizations’ Yes / No / no opinion endorsement of state and local ballot measures
</figcaption>
</figure>
</div>
</div>
</div>
<p>Visually, we can see from this plot that there is significant variation across political organizations on endorsements for props 33, 36, C, D, E, and F and to a lesser extent 34, G, L, and N; whereas ballot measures 2, 3, 32, A, B, and O show less variation among political organizations. Also, interestingly, some organizations that offer endorsements did not endorse any position for some (or even most) propositions on the November 5 ballot.</p>
<p>However, for the above plot, the variation is easier to see than if the political organizations were sorted alphabetically because I cheated: I pre-sorted these based on their clustering order. So let’s explore the clustering result. I can plot the clustering dendrogram along side the endorsement color code data to illustrate:</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-measure-with-dendro-plot" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-measure-with-dendro-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_10_08-SF_political_support_clustering_files/figure-html/fig-measure-with-dendro-plot-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-measure-with-dendro-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Color-coded of political organizations’ Yes / No / no opinion endorsement of state and local ballot measures with dendrogram displayed
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="nominal-clustering" class="level3">
<h3 class="anchored" data-anchor-id="nominal-clustering">Nominal clustering</h3>
<p>Clustering is typically a quantitative method, so special accommodations have to be taken for clustering nominal / factor data like these (where there are discrete values that do not have an order over one another). Luckily, we can use the <a href="https://cran.r-project.org/web/packages/nomclust/index.html"><code>nomclust</code></a> package (<a href="https://link.springer.com/article/10.1007/s00180-022-01209-4">paper</a>), which handles the details as a purpose-built package for hierarchical clustering of nominal (categorical) variables.</p>
<p>One weakness of this clustering analysis is that it weights all ballot measures and races as the same. For an individual voter, some topics and races may have more salience or effect, and this analysis cannot take that into account.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-measure-dendrogram" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-measure-dendrogram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_10_08-SF_political_support_clustering_files/figure-html/fig-measure-dendrogram-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-measure-dendrogram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Dendrogram of political organizations’ Yes / No / no opinion endorsement of state and local ballot measures
</figcaption>
</figure>
</div>
</div>
</div>
<p>Generally speaking, the agglomerative coefficient of a clustering analysis describes the strength of the clustering structure that has been obtained by group average linkage. The coefficient takes values from 0 to 1, and is calculated as the mean of the normalized lengths at which the clusters are formed, <em>e.g.</em> the uniformity lengths displayed on the dendrogram. The more evenly and gradually the categories get broken down into different clusters, the closer to 1 the agglomerative coefficient will be.</p>
<section id="political-organization-distance-heat-map" class="level4">
<h4 class="anchored" data-anchor-id="political-organization-distance-heat-map">Political organization distance heat map</h4>
<p>I can also make a heat map of the clustering distance, or dissimilarity.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-measure-dist-heatmap" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-measure-dist-heatmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_10_08-SF_political_support_clustering_files/figure-html/fig-measure-dist-heatmap-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-measure-dist-heatmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Heat map of political organizations’ Yes / No / no opinion endorsement of state and local ballot measures
</figcaption>
</figure>
</div>
</div>
</div>
<p>The heat map shows darker, purple-er coloring for pairs of organizations whose set of endorsements are more similar, and lighter, yellow-er colors for organizations with very different endorsements.</p>
</section>
</section>
</section>
<section id="trying-clustering-again-on-just-sf-local-ballot-measure-data" class="level2">
<h2 class="anchored" data-anchor-id="trying-clustering-again-on-just-sf-local-ballot-measure-data">Trying clustering again on just SF local ballot measure data</h2>
<p>As the color-coded Yes / No / NA plot showed above (Figure&nbsp;1), many organizations did not make endorsements in the state-wide ballot measures (which get coded for clustering purposes as “No comment”). This phenomenon may be skewing the clustering results, causing the result to over-index on the “No comment” ballot measures rather than the active “Yes or No” endorsements. Because these “No comment” observations appear overwhelmingly in the State measures, we can run clustering only on the SF local measures.</p>
<section id="analyze-by-sf-local-only-ballot-measures" class="level3">
<h3 class="anchored" data-anchor-id="analyze-by-sf-local-only-ballot-measures">Analyze by SF-local-only ballot measures</h3>
<div class="cell">
<div class="cell-output-display">
<div id="fig-SF-measure-dendrogram" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-SF-measure-dendrogram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_10_08-SF_political_support_clustering_files/figure-html/fig-SF-measure-dendrogram-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-SF-measure-dendrogram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Dendrogram of political organizations’ Yes / No / no opinion endorsement of local-only ballot measures
</figcaption>
</figure>
</div>
</div>
</div>
<p>This clustering (Figure&nbsp;5) shows a different result than the first dendrogram (Figure&nbsp;3).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-SF-measure-plot" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-SF-measure-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_10_08-SF_political_support_clustering_files/figure-html/fig-SF-measure-plot-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-SF-measure-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Color-coded layout of political organizations’ Yes / No / no opinion endorsement of local-only sorting
</figcaption>
</figure>
</div>
</div>
</div>
<p>Shown above (Figure&nbsp;6), we can generate the Yes / No map with ordering based on the clustering of only the SF measures.</p>
<p>The clustering and ordering by SF-ballot measures only shows that the “no comment” was having a disproportional effect on the clustering, and now those political organizations are getting distributed elsewhere among the clusters.</p>
<p>Cluster 1 (on the left in Figure&nbsp;5 and on the top in Figure&nbsp;6) now contains a mixture of Republican and Democratic organizations. Based on the alignment, “No” endorsements for Props C, E, G, N, and to a lesser extent L are key features of this cluster, and “Yes” endorsements for D, and F are also prominent.</p>
<p>In contrast, Cluster 2 (in the middle of the figures) features prominent “No” endorsement for D and F, and high levels of “Yes” support for C and E.</p>
<p>Cluster 3 is fairly dominated by the “No comment” non-endorsements among the SF local ballot measures, but feature prominent “Yes” support for B, G, K, and L, which contrasts with the varying support for both in clusters 1 and 2. This makes some sense due to the non-partisan interests of measure K (Permanently Closing the Upper Great Highway to Private Vehicles to Establish a Public) and L (Additional Business Tax on Transportation Network Companies and Autonomous Vehicle Businesses to Fund Public Transportation).</p>
<section id="political-organization-distance-table" class="level4">
<h4 class="anchored" data-anchor-id="political-organization-distance-table">Political organization distance table</h4>
<div class="cell">
<div id="tbl-org-dis" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-org-dis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Table of unique political organization pairs, sorted by clustering proximity
</figcaption>
<div aria-describedby="tbl-org-dis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-a6d1dbebf89e300ec13d" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-a6d1dbebf89e300ec13d">{"x":{"filter":"none","vertical":false,"extensions":["FixedColumns","FixedHeader"],"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206","207","208","209","210","211","212","213","214","215","216","217","218","219","220","221","222","223","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","255","256","257","258","259","260","261","262","263","264","265","266","267","268","269","270","271","272","273","274","275","276","277","278","279","280","281","282","283","284","285","286","287","288","289","290","291","292","293","294","295","296","297","298","299","300","301","302","303","304","305","306","307","308","309","310","311","312","313","314","315","316","317","318","319","320","321","322","323","324","325","326","327","328","329","330","331","332","333","334","335","336","337","338","339","340","341","342","343","344","345","346","347","348","349","350","351","352","353","354","355","356","357","358","359","360","361","362","363","364","365","366","367","368","369","370","371","372","373","374","375","376","377","378","379","380","381","382","383","384","385","386","387","388","389","390","391","392","393","394","395","396","397","398","399","400","401","402","403","404","405","406","407","408","409","410","411","412","413","414","415","416","417","418","419","420","421","422","423","424","425","426","427","428","429","430","431","432","433","434","435"],["Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","District 11 Democratic Club","Alice B. Toklas LGBT Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Alice B. Toklas LGBT Democratic Club","League of Women Voters of SF","Alice B. Toklas LGBT Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","SF League of Pissed Off Voters","Alice B. Toklas LGBT Democratic Club","SF Tenants Union","SF Women's Political Committee","Alice B. Toklas LGBT Democratic Club","San Francisco Bay Guardian","Alice B. Toklas LGBT Democratic Club","TogetherSF","United Democratic Club","YIMBY Action","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","District 11 Democratic Club","Bernal Heights Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Bernal Heights Democratic Club","League of Women Voters of SF","Bernal Heights Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","SF League of Pissed Off Voters","Bernal Heights Democratic Club","SF Tenants Union","SF Women's Political Committee","Bernal Heights Democratic Club","San Francisco Bay Guardian","Bernal Heights Democratic Club","TogetherSF","United Democratic Club","YIMBY Action","Chinese American Democratic Club","Chinese American Democratic Club","District 11 Democratic Club","Chinese American Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Chinese American Democratic Club","League of Women Voters of SF","Chinese American Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","SF League of Pissed Off Voters","Chinese American Democratic Club","SF Tenants Union","SF Women's Political Committee","Chinese American Democratic Club","San Francisco Bay Guardian","Chinese American Democratic Club","TogetherSF","United Democratic Club","YIMBY Action","Democratic Party (SF)","District 11 Democratic Club","Eastern Neighborhoods Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","League of Women Voters of SF","Democratic Party (SF)","Potrero Hill Democratic Club","SEIU 1021","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","SF League of Pissed Off Voters","Democratic Party (SF)","SF Tenants Union","SF Women's Political Committee","SPUR","San Francisco Bay Guardian","Democratic Party (SF)","TogetherSF","United Democratic Club","YIMBY Action","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","Green Party (SF)","GrowSF","District 11 Democratic Club","District 11 Democratic Club","League of Women Voters of SF","District 11 Democratic Club","District 11 Democratic Club","SEIU 1021","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","SF League of Pissed Off Voters","District 11 Democratic Club","SF Tenants Union","SF Women's Political Committee","District 11 Democratic Club","San Francisco Bay Guardian","District 11 Democratic Club","TogetherSF","District 11 Democratic Club","YIMBY Action","Eastern Neighborhoods Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Eastern Neighborhoods Democratic Club","League of Women Voters of SF","Eastern Neighborhoods Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","SF League of Pissed Off Voters","Eastern Neighborhoods Democratic Club","SF Tenants Union","SF Women's Political Committee","Eastern Neighborhoods Democratic Club","San Francisco Bay Guardian","Eastern Neighborhoods Democratic Club","TogetherSF","United Democratic Club","YIMBY Action","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Ed M. Lee Asian Pacific Democratic Club","League of Women Voters of SF","Ed M. Lee Asian Pacific Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","SF League of Pissed Off Voters","Ed M. Lee Asian Pacific Democratic Club","SF Tenants Union","SF Women's Political Committee","Ed M. Lee Asian Pacific Democratic Club","San Francisco Bay Guardian","Ed M. Lee Asian Pacific Democratic Club","TogetherSF","United Democratic Club","YIMBY Action","Green Party (SF)","GrowSF","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","SF League of Pissed Off Voters","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","San Francisco Bay Guardian","Green Party (SF)","Green Party (SF)","Green Party (SF)","YIMBY Action","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","SF League of Pissed Off Voters","GrowSF","GrowSF","GrowSF","GrowSF","San Francisco Bay Guardian","GrowSF","GrowSF","GrowSF","YIMBY Action","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","League of Women Voters of SF","Harvey Milk LGBTQ Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","SF League of Pissed Off Voters","Harvey Milk LGBTQ Democratic Club","SF Tenants Union","SF Women's Political Committee","Harvey Milk LGBTQ Democratic Club","San Francisco Bay Guardian","Harvey Milk LGBTQ Democratic Club","TogetherSF","Harvey Milk LGBTQ Democratic Club","YIMBY Action","Home Sharers Democratic Club","League of Women Voters of SF","Home Sharers Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","SF League of Pissed Off Voters","Home Sharers Democratic Club","SF Tenants Union","SF Women's Political Committee","Home Sharers Democratic Club","San Francisco Bay Guardian","Home Sharers Democratic Club","TogetherSF","United Democratic Club","YIMBY Action","League of Women Voters of SF","League of Women Voters of SF","League of Women Voters of SF","SEIU 1021","League of Women Voters of SF","League of Women Voters of SF","League of Women Voters of SF","League of Women Voters of SF","SF League of Pissed Off Voters","League of Women Voters of SF","SF Tenants Union","SF Women's Political Committee","League of Women Voters of SF","San Francisco Bay Guardian","League of Women Voters of SF","TogetherSF","League of Women Voters of SF","YIMBY Action","Noe Valley Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Noe Valley Democratic Club","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SPUR","San Francisco Bay Guardian","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","Potrero Hill Democratic Club","SEIU 1021","Potrero Hill Democratic Club","Potrero Hill Democratic Club","Potrero Hill Democratic Club","Potrero Hill Democratic Club","SF League of Pissed Off Voters","Potrero Hill Democratic Club","SF Tenants Union","SF Women's Political Committee","Potrero Hill Democratic Club","San Francisco Bay Guardian","Potrero Hill Democratic Club","TogetherSF","Potrero Hill Democratic Club","YIMBY Action","SEIU 1021","SEIU 1021","SEIU 1021","SEIU 1021","SEIU 1021","SF League of Pissed Off Voters","SEIU 1021","SF Tenants Union","SEIU 1021","SEIU 1021","SEIU 1021","SEIU 1021","SEIU 1021","YIMBY Action","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SPUR","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF League of Pissed Off Voters","SF Housing Action Coalition","SF Tenants Union","SF Women's Political Committee","SPUR","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","SF Labor Council","SF Labor Council","SF League of Pissed Off Voters","SF Labor Council","SF Tenants Union","SF Women's Political Committee","SPUR","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","SF League of Conservation Voters","SF League of Pissed Off Voters","SF League of Conservation Voters","SF Tenants Union","SF Women's Political Committee","SPUR","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SPUR","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","SF Tenants Union","SF Tenants Union","SF Tenants Union","SF Tenants Union","SF Tenants Union","SF Tenants Union","YIMBY Action","SF Women's Political Committee","SF Women's Political Committee","SF Women's Political Committee","SF Women's Political Committee","SF Women's Political Committee","YIMBY Action","SPUR","TogetherSF","United Democratic Club","YIMBY Action","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","SPUR","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","TogetherSF","TogetherSF","YIMBY Action","United Democratic Club","YIMBY Action","YIMBY Action"],["Alice B. Toklas LGBT Democratic Club","Bernal Heights Democratic Club","Chinese American Democratic Club","Democratic Party (SF)","Alice B. Toklas LGBT Democratic Club","Eastern Neighborhoods Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Home Sharers Democratic Club","Alice B. Toklas LGBT Democratic Club","Noe Valley Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","Alice B. Toklas LGBT Democratic Club","SF Republican Party","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","SPUR","Alice B. Toklas LGBT Democratic Club","Sierra Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Bernal Heights Democratic Club","Chinese American Democratic Club","Democratic Party (SF)","Bernal Heights Democratic Club","Eastern Neighborhoods Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Home Sharers Democratic Club","Bernal Heights Democratic Club","Noe Valley Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","Bernal Heights Democratic Club","SF Republican Party","Bernal Heights Democratic Club","Bernal Heights Democratic Club","SPUR","Bernal Heights Democratic Club","Sierra Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Chinese American Democratic Club","Democratic Party (SF)","Chinese American Democratic Club","Eastern Neighborhoods Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Home Sharers Democratic Club","Chinese American Democratic Club","Noe Valley Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","Chinese American Democratic Club","SF Republican Party","Chinese American Democratic Club","Chinese American Democratic Club","SPUR","Chinese American Democratic Club","Sierra Club","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Noe Valley Democratic Club","Democratic Party (SF)","Democratic Party (SF)","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","Democratic Party (SF)","SF Republican Party","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Sierra Club","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","District 11 Democratic Club","Eastern Neighborhoods Democratic Club","Ed M. Lee Asian Pacific Democratic Club","District 11 Democratic Club","District 11 Democratic Club","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","District 11 Democratic Club","Noe Valley Democratic Club","Potrero Hill Democratic Club","District 11 Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","District 11 Democratic Club","SF Republican Party","District 11 Democratic Club","District 11 Democratic Club","SPUR","District 11 Democratic Club","Sierra Club","District 11 Democratic Club","United Democratic Club","District 11 Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Home Sharers Democratic Club","Eastern Neighborhoods Democratic Club","Noe Valley Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","Eastern Neighborhoods Democratic Club","SF Republican Party","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","SPUR","Eastern Neighborhoods Democratic Club","Sierra Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Home Sharers Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Noe Valley Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","Ed M. Lee Asian Pacific Democratic Club","SF Republican Party","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","SPUR","Ed M. Lee Asian Pacific Democratic Club","Sierra Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","Green Party (SF)","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","League of Women Voters of SF","Noe Valley Democratic Club","Potrero Hill Democratic Club","SEIU 1021","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","Green Party (SF)","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SPUR","Green Party (SF)","Sierra Club","TogetherSF","United Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","League of Women Voters of SF","Noe Valley Democratic Club","Potrero Hill Democratic Club","SEIU 1021","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","GrowSF","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SPUR","GrowSF","Sierra Club","TogetherSF","United Democratic Club","GrowSF","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","Harvey Milk LGBTQ Democratic Club","Noe Valley Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","Harvey Milk LGBTQ Democratic Club","SF Republican Party","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","SPUR","Harvey Milk LGBTQ Democratic Club","Sierra Club","Harvey Milk LGBTQ Democratic Club","United Democratic Club","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","Home Sharers Democratic Club","SF Republican Party","Home Sharers Democratic Club","Home Sharers Democratic Club","SPUR","Home Sharers Democratic Club","Sierra Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","League of Women Voters of SF","Noe Valley Democratic Club","Potrero Hill Democratic Club","League of Women Voters of SF","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","League of Women Voters of SF","SF Republican Party","League of Women Voters of SF","League of Women Voters of SF","SPUR","League of Women Voters of SF","Sierra Club","League of Women Voters of SF","United Democratic Club","League of Women Voters of SF","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","SF Bicycle Coalition","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Potrero Hill Democratic Club","Potrero Hill Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","Potrero Hill Democratic Club","SF Republican Party","Potrero Hill Democratic Club","Potrero Hill Democratic Club","SPUR","Potrero Hill Democratic Club","Sierra Club","Potrero Hill Democratic Club","United Democratic Club","Potrero Hill Democratic Club","SEIU 1021","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SEIU 1021","SF Republican Party","SEIU 1021","SF Women's Political Committee","SPUR","Sierra Club","TogetherSF","United Democratic Club","SEIU 1021","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF Housing Action Coalition","SF Republican Party","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF Labor Council","SF Republican Party","SF Labor Council","SF Labor Council","SF Labor Council","SF Labor Council","SF Labor Council","SF Labor Council","SF Labor Council","SF League of Conservation Voters","SF League of Conservation Voters","SF Republican Party","SF League of Conservation Voters","SF League of Conservation Voters","SF League of Conservation Voters","SF League of Conservation Voters","SF League of Conservation Voters","SF League of Conservation Voters","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SPUR","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","SF Republican Party","SF Republican Party","SF Republican Party","SF Republican Party","SF Republican Party","SF Republican Party","SF Republican Party","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SPUR","Sierra Club","TogetherSF","United Democratic Club","SF Tenants Union","SF Women's Political Committee","SPUR","Sierra Club","TogetherSF","United Democratic Club","SF Women's Political Committee","SPUR","SPUR","SPUR","SPUR","SEIU 1021","SF Bicycle Coalition","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SPUR","San Francisco Bay Guardian","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","Sierra Club","Sierra Club","Sierra Club","Sierra Club","Sierra Club","TogetherSF","United Democratic Club","TogetherSF","United Democratic Club","United Democratic Club","YIMBY Action"],[0,0.305,0.763,1.05,0.512,0.484,0.574,0.614,0.429,0.436,0.657,0.424,0.699,0.366,0.369,1.97,2.09,1.2,1.6,0.367,1.7,0.436,0.307,0.6860000000000001,0.503,1.8,0.432,0.362,1.34,0,0.57,1.2,0.253,0.5649999999999999,0.873,0.325,0.577,0.11,1,0.302,1.21,0.25,0.437,3.35,2.93,1.04,1.61,0.0359,3.26,0.156,0.109,1.05,0.112,2.47,0.655,0.673,2.5,0,0.663,0.587,0.42,0.312,0.61,0.43,0.665,0.983,0.754,0.861,0.758,0.663,1.66,1.3,0.671,1.54,0.661,1.36,0.763,0.58,0.782,0.658,1.31,0.492,0.589,1.02,0,1.06,0.896,0.89,1.64,0.698,1.06,1.35,1.19,0.15,1.2,0.8090000000000001,0.738,0.667,0.203,0.6,1.38,0.536,1.61,0.8090000000000001,0.6889999999999999,1.38,0.578,1.18,1.21,0.676,0,0.769,0.896,0.459,0.681,0.155,0.761,0.246,1.58,0.25,0.369,2.02,1.56,0.698,1.06,0.201,2.68,0.155,0.156,0.921,0.252,1.57,0.767,1.04,1.59,0,0.238,0.92,0.102,0.659,0.575,0.993,0.869,0.757,0.881,3.31,4.11,1.79,3.53,0.655,1.41,0.874,0.575,1.16,0.741,3.36,0.187,0.144,1.57,0,1.08,0.2,1.01,0.752,0.995,0.658,1,1.16,3.12,2.77,1.34,2.92,1,1.06,1.15,0.887,1.18,0.999,2.8,0.191,0.201,1.76,0,1.21,0.387,0.659,0.463,1.87,0.39,0.612,1.68,1.56,1.23,1.38,0.323,1.33,0.322,0.458,1.64,0.32,1.57,1.05,1.05,2.14,0,0.506,0.765,0.881,0.782,0.67,0.6860000000000001,3.96,4.29,1.38,3.67,0.668,1.65,0.775,0.436,1.2,0.668,3.49,0.151,0.158,1.79,0,1,0.301,1.82,0.308,0.313,2.79,2.47,0.922,1.4,0.06909999999999999,4.85,0.112,0.07340000000000001,1.2,0.155,2.11,0.761,0.894,2.13,0,0.653,1.15,0.765,0.667,1.31,1.13,1.76,1.16,0.873,1.02,0.767,1.01,1.01,1.13,1.3,0.654,0.491,0.995,0,1.34,0.302,0.196,1.47,1.01,0.895,0.79,0.3,2.29,0.151,0.248,0.681,0.356,1.16,0.755,0.771,1.34,0,1.57,1.19,0.714,0.753,0.426,0.679,1.39,0.226,2.14,1.37,0.777,1.84,0.655,0.788,0.785,0.654,0,0.31,1.76,1.2,0.903,1.21,0.307,3.86,0.156,0.306,0.6919999999999999,0.3,1.38,0.581,0.776,1.58,0,1.5,1.03,0.696,0.923,0.369,2.24,0.255,0.314,0.6929999999999999,1.18,0.889,0.902,1.19,0,0.101,0.647,0.182,2.78,0.707,2.36,2.8,0.486,0.0618,3.91,2.3,0.186,0,0.499,0.148,2.46,0.766,1.57,2.48,0.434,0.0348,2.87,2.44,0.24,0,0.44,1.2,0.819,1.2,0.699,0.6,0.503,1.78,2.52,0.784,0,1.39,0.8,1.22,1.4,0.376,0.106,4.4,2.17,0.25,0,3.24,0.111,0.153,1.2,2.1,0.756,0.776,2.12,0,4.84,3.9,1.23,0.772,1.44,1.43,0.77,0,0.203,1.05,1.81,0.766,0.895,1.83,0,0.916,2.11,0.666,0.784,2.14,0,1.55,0.795,0.255,0.435,3.32,2.43,0.913,1.6,0.157,3.21,0.198,0.153,1.04,0,2.45,0.856,0.769,2.48,0.368,0,3.45,2.08,0.19,0,0.198,2.39,0,1.17,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>org<\/th>\n      <th>org2<\/th>\n      <th>proximity<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"paging":true,"fixedHeader":true,"fixedHeight":true,"order":[[3,"asc"]],"columnDefs":[{"className":"dt-right","targets":3},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"org","targets":1},{"name":"org2","targets":2},{"name":"proximity","targets":3}],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</figure>
</div>
</div>
<p>The least-distant org to the SF Republican Party (aside from itself) is Noe Valley Democratic Club (distance = 0.226), followed by Democratic Party (SF) (distance 0.536)</p>
</section>
</section>
<section id="remarks-on-clustering-by-ballot-measure" class="level3">
<h3 class="anchored" data-anchor-id="remarks-on-clustering-by-ballot-measure">Remarks on clustering by ballot measure</h3>
<p>We can see from a reasonably well-fitting categorical clustering model that many political organizations have high similarity with the SF Republican Party’s positions on ballot measures, despite having “Democratic” in their name. This result supports the idea that an empirical approach can reveal more about the character of an organization that the words in its name.</p>
</section>
</section>
<section id="aanlyze-by-national-state-candidate-endorsements" class="level2">
<h2 class="anchored" data-anchor-id="aanlyze-by-national-state-candidate-endorsements">Aanlyze by National &amp; State candidate endorsements</h2>
<p>Great, the data are now tidy, where each row is an observation (a political group), and each column is a variable (race).</p>
<section id="who-is-recommending-whom" class="level3">
<h3 class="anchored" data-anchor-id="who-is-recommending-whom">Who is recommending whom?</h3>
<div class="cell">
<div id="tbl-cand-recs" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-cand-recs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Table of organization endorsements of candidates for races
</figcaption>
<div aria-describedby="tbl-cand-recs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Organization</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">President</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">US Senator</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">House CA-11</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">House CA-15</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">State Senate 11</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">State Assembly 17</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">State Assembly 19</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Democratic Party (SF)</td>
<td style="text-align: left;">Kamala Harris</td>
<td style="text-align: left;">Adam Schiff</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
</tr>
<tr class="even">
<td style="text-align: left;">TogetherSF</td>
<td style="text-align: left;">Kamala Harris</td>
<td style="text-align: left;">Adam Schiff</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
</tr>
<tr class="odd">
<td style="text-align: left;">United Democratic Club</td>
<td style="text-align: left;">Kamala Harris</td>
<td style="text-align: left;">Adam Schiff</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
</tr>
<tr class="even">
<td style="text-align: left;">Ed M. Lee Asian Pacific Democratic Club</td>
<td style="text-align: left;">Kamala Harris</td>
<td style="text-align: left;">Adam Schiff</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Alice B. Toklas LGBT Democratic Club</td>
<td style="text-align: left;">Kamala Harris</td>
<td style="text-align: left;">Adam Schiff</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
</tr>
<tr class="even">
<td style="text-align: left;">Chinese American Democratic Club</td>
<td style="text-align: left;">Kamala Harris</td>
<td style="text-align: left;">Adam Schiff</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Home Sharers Democratic Club</td>
<td style="text-align: left;">Kamala Harris</td>
<td style="text-align: left;">Adam Schiff</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
</tr>
<tr class="even">
<td style="text-align: left;">Eastern Neighborhoods Democratic Club</td>
<td style="text-align: left;">Kamala Harris</td>
<td style="text-align: left;">Adam Schiff</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SF Women's Political Committee</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Adam Schiff</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
</tr>
<tr class="even">
<td style="text-align: left;">Sierra Club</td>
<td style="text-align: left;">Kamala Harris</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SEIU 1021</td>
<td style="text-align: left;">Kamala Harris</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
</tr>
<tr class="even">
<td style="text-align: left;">District 11 Democratic Club</td>
<td style="text-align: left;">Kamala Harris</td>
<td style="text-align: left;">Adam Schiff</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Bernal Heights Democratic Club</td>
<td style="text-align: left;">Kamala Harris</td>
<td style="text-align: left;">Adam Schiff</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Potrero Hill Democratic Club</td>
<td style="text-align: left;">Kamala Harris</td>
<td style="text-align: left;">Adam Schiff</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Noe Valley Democratic Club</td>
<td style="text-align: left;">Kamala Harris</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Harvey Milk LGBTQ Democratic Club</td>
<td style="text-align: left;">Kamala Harris</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">David Lee</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SF League of Pissed Off Voters</td>
<td style="text-align: left;">Kamala Harris</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Green Party (SF)</td>
<td style="text-align: left;">Jill Stein</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">YIMBY Action</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
</tr>
<tr class="even">
<td style="text-align: left;">GrowSF</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SF Housing Action Coalition</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
</tr>
<tr class="even">
<td style="text-align: left;">SF Bicycle Coalition</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">SF Tenants Union</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">David Lee</td>
</tr>
<tr class="even">
<td style="text-align: left;">SF Republican Party</td>
<td style="text-align: left;">Donald Trump</td>
<td style="text-align: left;">Steve Garvey</td>
<td style="text-align: left;">Bruce Lou</td>
<td style="text-align: left;">Anna Cheng Kramer</td>
<td style="text-align: left;">Yvette Corkrean</td>
<td style="text-align: left;">Manuel Noris-Barrera</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">SF Young Republicans</td>
<td style="text-align: left;">Donald Trump</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Bruce Lou</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Yvette Corkrean</td>
<td style="text-align: left;">Manuel Noris-Barrera</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<p>I’ve cheated again and pre-arranged this table of candidate endorsements by the clustering order. It makes it pretty clear there are a few block. I’ll also do a distance heat map below (which doesn’t say the endorsement names, but shows similarity more clearly.)</p>
<div class="cell">
<div id="tbl-cand-recs-uniq-count" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-cand-recs-uniq-count-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Unique options per race
</figcaption>
<div aria-describedby="tbl-cand-recs-uniq-count-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">President</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">US Senator</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">House CA-11</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">House CA-15</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">State Senate 11</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">State Assembly 17</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">State Assembly 19</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">4</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<p>Note that races have one to four options among the endorsements made by these political organizations. This is different than the ballot measures (where options were Yes / No / NA). This increase in the number of levels of each factor can affect the clustering.</p>
<div class="cell">
<div id="tbl-cand-recs-na-count" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-cand-recs-na-count-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: Races where one or more organizations did not endorse anyone (binary: Yes / No)
</figcaption>
<div aria-describedby="tbl-cand-recs-na-count-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">President</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">US Senator</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">House CA-11</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">House CA-15</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">State Senate 11</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">State Assembly 17</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">State Assembly 19</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">Yes</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<p>Also note that, in every race, there is one option that is the organization declining to endorse anyone. Thus, the number of <em>candidates</em> endorsed is <code>n - 1</code> the value represented in the table.</p>
<p>This means that no organization made any endorsements for President. This fact is not true of any other race.</p>
</section>
<section id="nominal-clustering-1" class="level3">
<h3 class="anchored" data-anchor-id="nominal-clustering-1">Nominal clustering</h3>
<p>Very tellingly, we see two broad clusters and two narrow clusters:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_10_08-SF_political_support_clustering_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<section id="political-organization-distance-heat-map-1" class="level4">
<h4 class="anchored" data-anchor-id="political-organization-distance-heat-map-1">Political organization distance heat map</h4>
<p>I can also make a heat map of the clustering distance, or dissimilarity.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_10_08-SF_political_support_clustering_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="720"></p>
</figure>
</div>
</div>
</div>
<p>For the two large clusters in the dendrogram, this heat maps show two large squares of low-distance coloring (purple to dark blue) along the diagonal downward and to the right. These square blocks of proximity indicate clusters similarity among the organizations.</p>
<p>Clearly shown on this heatmap is how divergent the SF Young Republicans and the SF Republican Party are from any other organization analyzed. For example, the NOE Valley Democratic Club is closer (in clustering distance) to the SF Young Republicans and the SF Republican Party than the latter two are to each other.</p>
</section>
<section id="political-organization-distance-table-for-candidate-recs" class="level4">
<h4 class="anchored" data-anchor-id="political-organization-distance-table-for-candidate-recs">Political organization distance table (for candidate recs)</h4>
<p>Use the table below to filer, sort, and rank the clustering model’s distance to make your own comparisons.</p>
<div class="cell">
<div id="tbl-org-cand-dis" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-org-cand-dis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5: Table of unique political organization pairs, sorted by clustering proximity on endorsement
</figcaption>
<div aria-describedby="tbl-org-cand-dis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-679a6d8b426ca827e529" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-679a6d8b426ca827e529">{"x":{"filter":"none","vertical":false,"extensions":["FixedColumns","FixedHeader"],"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206","207","208","209","210","211","212","213","214","215","216","217","218","219","220","221","222","223","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","255","256","257","258","259","260","261","262","263","264","265","266","267","268","269","270","271","272","273","274","275","276","277","278","279","280","281","282","283","284","285","286","287","288","289","290","291","292","293","294","295","296","297","298","299","300","301","302","303","304","305","306","307","308","309","310","311","312","313","314","315","316","317","318","319","320","321","322","323","324","325"],["Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Democratic Party (SF)","District 11 Democratic Club","Alice B. Toklas LGBT Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","Alice B. Toklas LGBT Democratic Club","Harvey Milk LGBTQ Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Alice B. Toklas LGBT Democratic Club","SF Women's Political Committee","Alice B. Toklas LGBT Democratic Club","Sierra Club","TogetherSF","United Democratic Club","Alice B. Toklas LGBT Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Democratic Party (SF)","District 11 Democratic Club","Bernal Heights Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","Bernal Heights Democratic Club","Harvey Milk LGBTQ Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Bernal Heights Democratic Club","Bernal Heights Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Bernal Heights Democratic Club","SF Women's Political Committee","Bernal Heights Democratic Club","Sierra Club","TogetherSF","United Democratic Club","Bernal Heights Democratic Club","Chinese American Democratic Club","Democratic Party (SF)","District 11 Democratic Club","Chinese American Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","Chinese American Democratic Club","Harvey Milk LGBTQ Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Chinese American Democratic Club","Chinese American Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Chinese American Democratic Club","SF Women's Political Committee","Chinese American Democratic Club","Sierra Club","TogetherSF","United Democratic Club","Chinese American Democratic Club","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","Green Party (SF)","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","SEIU 1021","District 11 Democratic Club","District 11 Democratic Club","SF League of Pissed Off Voters","SF Republican Party","District 11 Democratic Club","SF Women's Political Committee","District 11 Democratic Club","Sierra Club","TogetherSF","District 11 Democratic Club","District 11 Democratic Club","Eastern Neighborhoods Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","Eastern Neighborhoods Democratic Club","Harvey Milk LGBTQ Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Eastern Neighborhoods Democratic Club","SF Women's Political Committee","Eastern Neighborhoods Democratic Club","Sierra Club","TogetherSF","United Democratic Club","Eastern Neighborhoods Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","Ed M. Lee Asian Pacific Democratic Club","Harvey Milk LGBTQ Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Ed M. Lee Asian Pacific Democratic Club","SF Women's Political Committee","Ed M. Lee Asian Pacific Democratic Club","Sierra Club","TogetherSF","United Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","SF League of Pissed Off Voters","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Potrero Hill Democratic Club","SEIU 1021","GrowSF","GrowSF","SF League of Pissed Off Voters","SF Republican Party","GrowSF","SF Women's Political Committee","SF Young Republicans","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Harvey Milk LGBTQ Democratic Club","SF Women's Political Committee","Harvey Milk LGBTQ Democratic Club","Sierra Club","TogetherSF","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Home Sharers Democratic Club","Home Sharers Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Home Sharers Democratic Club","SF Women's Political Committee","Home Sharers Democratic Club","Sierra Club","TogetherSF","United Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Noe Valley Democratic Club","Noe Valley Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Noe Valley Democratic Club","SF Women's Political Committee","Noe Valley Democratic Club","Sierra Club","TogetherSF","United Democratic Club","Noe Valley Democratic Club","Potrero Hill Democratic Club","SEIU 1021","Potrero Hill Democratic Club","Potrero Hill Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Potrero Hill Democratic Club","SF Women's Political Committee","Potrero Hill Democratic Club","Sierra Club","TogetherSF","Potrero Hill Democratic Club","Potrero Hill Democratic Club","SEIU 1021","SEIU 1021","SEIU 1021","SF League of Pissed Off Voters","SEIU 1021","SEIU 1021","SEIU 1021","SEIU 1021","Sierra Club","SEIU 1021","SEIU 1021","SEIU 1021","SF Bicycle Coalition","SF Housing Action Coalition","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SF Young Republicans","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","SF Housing Action Coalition","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SF Young Republicans","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF Republican Party","SF Republican Party","SF Women's Political Committee","SF Republican Party","Sierra Club","TogetherSF","SF Republican Party","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SF Young Republicans","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","SF Women's Political Committee","SF Women's Political Committee","Sierra Club","SF Women's Political Committee","SF Women's Political Committee","SF Women's Political Committee","SF Young Republicans","Sierra Club","TogetherSF","United Democratic Club","SF Young Republicans","Sierra Club","Sierra Club","Sierra Club","Sierra Club","TogetherSF","TogetherSF","TogetherSF","United Democratic Club","United Democratic Club","YIMBY Action"],["Alice B. Toklas LGBT Democratic Club","Bernal Heights Democratic Club","Chinese American Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Eastern Neighborhoods Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","GrowSF","Alice B. Toklas LGBT Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","SF Tenants Union","Alice B. Toklas LGBT Democratic Club","SF Young Republicans","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","YIMBY Action","Bernal Heights Democratic Club","Chinese American Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Eastern Neighborhoods Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","GrowSF","Bernal Heights Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","Bernal Heights Democratic Club","Bernal Heights Democratic Club","SF Tenants Union","Bernal Heights Democratic Club","SF Young Republicans","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","YIMBY Action","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Eastern Neighborhoods Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","GrowSF","Chinese American Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","Chinese American Democratic Club","Chinese American Democratic Club","SF Tenants Union","Chinese American Democratic Club","SF Young Republicans","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","YIMBY Action","Democratic Party (SF)","District 11 Democratic Club","Eastern Neighborhoods Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Potrero Hill Democratic Club","SEIU 1021","SF Bicycle Coalition","SF Housing Action Coalition","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SF Young Republicans","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","District 11 Democratic Club","Eastern Neighborhoods Democratic Club","Ed M. Lee Asian Pacific Democratic Club","District 11 Democratic Club","GrowSF","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Potrero Hill Democratic Club","District 11 Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","District 11 Democratic Club","District 11 Democratic Club","SF Tenants Union","District 11 Democratic Club","SF Young Republicans","District 11 Democratic Club","District 11 Democratic Club","United Democratic Club","YIMBY Action","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","GrowSF","Eastern Neighborhoods Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","SF Tenants Union","Eastern Neighborhoods Democratic Club","SF Young Republicans","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","YIMBY Action","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","GrowSF","Ed M. Lee Asian Pacific Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","SF Tenants Union","Ed M. Lee Asian Pacific Democratic Club","SF Young Republicans","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","YIMBY Action","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Potrero Hill Democratic Club","SEIU 1021","SF Bicycle Coalition","SF Housing Action Coalition","Green Party (SF)","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SF Young Republicans","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","SF Bicycle Coalition","SF Housing Action Coalition","GrowSF","GrowSF","SF Tenants Union","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","SF Tenants Union","Harvey Milk LGBTQ Democratic Club","SF Young Republicans","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","United Democratic Club","YIMBY Action","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","Home Sharers Democratic Club","Home Sharers Democratic Club","SF Tenants Union","Home Sharers Democratic Club","SF Young Republicans","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","YIMBY Action","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","Noe Valley Democratic Club","Noe Valley Democratic Club","SF Tenants Union","Noe Valley Democratic Club","SF Young Republicans","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","YIMBY Action","Potrero Hill Democratic Club","Potrero Hill Democratic Club","SF Bicycle Coalition","SF Housing Action Coalition","Potrero Hill Democratic Club","Potrero Hill Democratic Club","SF Tenants Union","Potrero Hill Democratic Club","SF Young Republicans","Potrero Hill Democratic Club","Potrero Hill Democratic Club","United Democratic Club","YIMBY Action","SEIU 1021","SF Bicycle Coalition","SF Housing Action Coalition","SEIU 1021","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SF Young Republicans","SEIU 1021","TogetherSF","United Democratic Club","YIMBY Action","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Bicycle Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SF Young Republicans","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","SF Republican Party","SF Tenants Union","SF Republican Party","SF Young Republicans","SF Republican Party","SF Republican Party","United Democratic Club","YIMBY Action","SF Tenants Union","SF Tenants Union","SF Tenants Union","SF Tenants Union","SF Tenants Union","SF Tenants Union","SF Tenants Union","SF Women's Political Committee","SF Young Republicans","SF Women's Political Committee","TogetherSF","United Democratic Club","YIMBY Action","SF Young Republicans","SF Young Republicans","SF Young Republicans","SF Young Republicans","YIMBY Action","Sierra Club","TogetherSF","United Democratic Club","YIMBY Action","TogetherSF","United Democratic Club","YIMBY Action","United Democratic Club","YIMBY Action","YIMBY Action"],[0,0.252,0,0,0.116,0.0525,0,0.633,0.261,0.228,0,0.181,0.115,0.0526,0.352,0.261,0.435,1.16,0.641,0.0589,0.765,0.111,0,0,0.261,0,0.252,0.252,0.108,0.179,0.252,0.228,0.447,0.335,0.252,0.174,0.109,0.336,0.344,0.447,0.113,1.37,0.352,0.346,0.757,0.253,0.252,0.252,0.447,0,0,0.116,0.0525,0,0.633,0.261,0.228,0,0.181,0.115,0.0526,0.352,0.261,0.435,1.16,0.641,0.0589,0.765,0.111,0,0,0.261,0,0.116,0.0525,0,0.633,0.261,0.228,0,0.181,0.115,0.0526,0.352,0.261,0.435,1.16,0.641,0.0589,0.765,0.111,0,0,0.261,0,0.182,0.116,0.396,0.452,0.181,0.116,0.177,0.112,0.182,0.348,0.452,0.249,1.11,0.5580000000000001,0.19,0.729,0.256,0.116,0.116,0.452,0,0.0525,0.51,0.187,0.308,0.0525,0.115,0.0561,0.111,0.267,0.187,0.339,1.13,0.517,0.118,0.622,0.0526,0.0525,0.0525,0.187,0,0.633,0.261,0.228,0,0.181,0.115,0.0526,0.352,0.261,0.435,1.16,0.641,0.0589,0.765,0.111,0,0,0.261,0,0.368,0.507,0.633,0.306,0.398,0.51,0.275,0.368,0.092,1.96,0.283,0.726,0.871,0.404,0.633,0.633,0.368,0,0.414,0.261,0.191,0.267,0.187,0.0561,0,0.261,1.5,0.225,0.179,0.675,0.12,0.261,0.261,0,0,0.228,0.256,0.34,0.157,0.451,0.414,0.338,1.69,0.258,0.318,0.903,0.228,0.228,0.228,0.414,0,0.181,0.115,0.0526,0.352,0.261,0.435,1.16,0.641,0.0589,0.765,0.111,0,0,0.261,0,0.0526,0.115,0.12,0.191,0.177,0.914,0.447,0.264,0.39,0.0561,0.181,0.181,0.191,0,0.181,0.187,0.267,0.25,0.914,0.5600000000000001,0.189,0.493,0.115,0.115,0.115,0.267,0,0.266,0.187,0.339,1.16,0.517,0.118,0.622,0.0525,0.0526,0.0526,0.187,0,0.0561,0.182,1.21,0.252,0.258,0.538,0.191,0.352,0.352,0.0561,0,0.261,1.5,0.225,0.179,0.675,0.12,0.261,0.261,0,0,1.57,0.188,0.5600000000000001,0.706,0.255,0.435,0.435,0.261,0,3,1.35,0.246,1.13,1.16,1.16,1.5,0,0.504,1.24,0.41,0.641,0.641,0.225,0,0.885,0.184,0.0589,0.0589,0.179,0,0.5,0.765,0.765,0.675,0,0.111,0.111,0.12,0,0,0.261,0,0.261,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>org<\/th>\n      <th>org2<\/th>\n      <th>proximity<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"paging":true,"fixedHeader":true,"fixedHeight":true,"order":[[3,"asc"]],"columnDefs":[{"className":"dt-right","targets":3},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"org","targets":1},{"name":"org2","targets":2},{"name":"proximity","targets":3}],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</figure>
</div>
</div>
</section>
</section>
<section id="remarks-on-clustering-by-candidate-endorsement" class="level3">
<h3 class="anchored" data-anchor-id="remarks-on-clustering-by-candidate-endorsement">Remarks on clustering by candidate endorsement</h3>
<p>The race endorsements data set contains more options in general, allowing each organization for vary significantly in its character. We see this born out in the clustering dendrogram with more divergent clusters than seen in the ballot measure analysis.</p>
<p>While the candidate endorsement clustering did not reveal any surprising similarities (in the opinion of yours truly), it did show how divergent the SF Republican Party and the SF Young Republicans are from the rest of the organizations, in terms of candidate endorsements.</p>
</section>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<p>The nominal clustering analysis worked well at identifying similar groups and quantifying relative similarity. <strong>The ballot measure endorsement clustering was more revealing of the spectrum of relatedness of the political organizations</strong> than the candidate clustering was. One weakness of this clustering analysis is that it weights all ballot measures and races as the same. For an individual voter, some topics and races may have more salience or effect, and this analysis cannot take that into account.</p>
<p>Broadly, these results support the idea that an empirical approach can reveal more about the character of an organization than the words in its name, and that this analysis is useful for determining action-based political alignment.</p>


</section>
</section>

 ]]></description>
  <category>politics</category>
  <guid>https://pdcherry.github.io/posts/2024_10_08-SF_political_support_clustering.html</guid>
  <pubDate>Tue, 08 Oct 2024 07:00:00 GMT</pubDate>
  <media:content url="https://pdcherry.github.io/posts/2024_10_08-SF_political_support_data/2022_06_26-Pride_Lasers-057.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>San Francisco’s November 2024 ballot review</title>
  <dc:creator>Patrick Cherry</dc:creator>
  <link>https://pdcherry.github.io/posts/2024_08_29-Cali_Nov_2024_ballot_measures.html</link>
  <description><![CDATA[ 





<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_08_29-Cali_Nov_2024_ballot_measures/SF_flyover.jpg" class="img-fluid figure-img"></p>
<figcaption>The San Francisco ballot will be a long one this November. View from above of the San Francisco penninsula to the north, including the Bay, the Golden Gate, and some islands and land forms of North Bay.</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This page is incomplete. I have yet to decide on the relative importance of these ballot measures, or provide guidance for voting. That is to come in the coming days.</p>
</div>
</div>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>San Francisco has a big ballot incoming to voters this November, with 25 total ballot measures for voters to decide upon before–or on–election day (10 state measures, and 15 city / county measures of San Francisco). This is less than other <em>very lengthy</em> ballots previously sent to voters <span class="citation" data-cites="sfvote1993">(Registrar of Voters 1993)</span>, but still longer than many in recent memory.</p>
<p>Below, I have collated the ballot measure numbers (or letters), titles, descriptions, and some context (in some cases, where available.)</p>
</section>
<section id="state-wide-ballot-measures" class="level2">
<h2 class="anchored" data-anchor-id="state-wide-ballot-measures">State-wide ballot measures</h2>
<div class="cell">
<div id="tbl-state-props" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-state-props-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Table of statewide ballot propositions
</figcaption>
<div aria-describedby="tbl-state-props-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Title</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Description</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Proposition 2</td>
<td style="text-align: left;">Borrow $10 billion to build schools.</td>
<td style="text-align: left;">BI</td>
<td style="text-align: left;">Issue $10 billion in bonds to fund construction and modernization of public education facilities</td>
<td style="text-align: left;">Legislative Democrats put on the ballot a bond issue to give $8.5 billion to K-12 schools and $1.5 billion to community colleges for construction and modernization.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Proposition 3</td>
<td style="text-align: left;">Reaffirm the right of same-sex couples to marry.</td>
<td style="text-align: left;">LRCA</td>
<td style="text-align: left;">Repeal Proposition 8 and establish a right to marry</td>
<td style="text-align: left;">This constitutional amendment from the Legislature would remove outdated language from Proposition 8 passed by voters in 2008 that characterizes marriage as being between a man and a woman.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Proposition 4</td>
<td style="text-align: left;">Borrow $10 billion for climate programs.</td>
<td style="text-align: left;">BI</td>
<td style="text-align: left;">Issue $10 billion in bonds to fund state and local parks, environmental protection projects, water infrastructure projects, energy projects, and flood protection projects</td>
<td style="text-align: left;">Legislative Democrats also placed a bond issue on the ballot that includes $3.8 billion for drinking water and groundwater $1.5 billion for wildfire and forest programs and $1.2 billion for sea level rise. In part the money would offset some budget cuts.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Proposition 5</td>
<td style="text-align: left;">Lower voter approval requirements for local housing and infrastructure bonds.</td>
<td style="text-align: left;">LRCA</td>
<td style="text-align: left;">Lower the vote threshold from 66.67% to 55% for local bond measures to fund housing projects and public infrastructure</td>
<td style="text-align: left;">This constitutional amendment from the Legislature would make it easier for local governments to borrow money for affordable housing and other infrastructure. To avoid opposition from the influential real estate industry supporters agreed to block bond money from being used to buy single-family homes.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Proposition 6</td>
<td style="text-align: left;">Limit forced labor in state prisons.</td>
<td style="text-align: left;">LRCA</td>
<td style="text-align: left;">Remove involuntary servitude as punishment for a crime from the state constitution</td>
<td style="text-align: left;">Lawmakers added this one late‚ a constitutional amendment to end indentured servitude in state prisons considered one of the last remnants of slavery. The California Black Legislative Caucus included the amendment in its reparations bill package.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Proposition 32</td>
<td style="text-align: left;">Raise the state minimum wage to $18 an hour.</td>
<td style="text-align: left;">CISS</td>
<td style="text-align: left;">Increase minimum wage to $18 an hour</td>
<td style="text-align: left;">This initiative seemed a much bigger deal when it was first proposed in 2021. But under existing law the overall minimum wage has risen to $16 an hour. And lower-paid workers in two huge industries are getting more: Fast food workers received a $20 an hour minimum on April 1 and health care workers will eventually get $25 though the start date has been pushed back to at least Oct. 15.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Proposition 33</td>
<td style="text-align: left;">Allow local governments to impose rent controls.</td>
<td style="text-align: left;">CISS</td>
<td style="text-align: left;">Repeals Costa Hawkins Rental Housing Act</td>
<td style="text-align: left;">This is the latest attempt to roll back a state law that generally prevents cities and counties from limiting rents in properties first occupied after Feb. 1995</td>
</tr>
<tr class="even">
<td style="text-align: left;">Proposition 34</td>
<td style="text-align: left;">Require certain health providers to use nearly all revenue from a federal prescription drug program on patient care.</td>
<td style="text-align: left;">CISS</td>
<td style="text-align: left;">Requires health care providers to spend 98% of revenues from federal discount prescription drug program on direct patient care</td>
<td style="text-align: left;">Sponsored by the trade group for California‚ landlords this measure is squarely aimed at knee-capping the AIDS Healthcare Foundation which has been active in funding ballot measures (see Prop. 33).</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Proposition 35</td>
<td style="text-align: left;">Make permanent a tax on managed health care insurance plans.</td>
<td style="text-align: left;">CISS</td>
<td style="text-align: left;">Permanently authorizes a tax on managed care organizations to fund Medi-Cal programs</td>
<td style="text-align: left;">This initiative is sponsored by California‚ health care industry to raise more money for Medi-Cal and block lawmakers from using the cash to avoid cuts to other programs. The measure would hold Newsom to a promise to permanently secure that tax money for health care for low-income patients.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Proposition 36</td>
<td style="text-align: left;">Increase penalties for theft and drug trafficking.</td>
<td style="text-align: left;">CISS</td>
<td style="text-align: left;">Increase drug crime and theft penalties and allow a new class of crime to be called treatment-mandated felony, which gives the offender the option to participate in drug and mental health treatment</td>
<td style="text-align: left;">This initiative may be the most contentious on the ballot. It would partly roll back Proposition 47 approved by voters in 2014</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<p>Type is the category of ballot measure from Ballotpedia: BI = <a href="https://ballotpedia.org/Bond_issue">Bond issue</a>; CISS = <a href="https://ballotpedia.org/Initiated_state_statute">Initiated state statute</a>; LRCA = <a href="https://ballotpedia.org/Legislatively_referred_constitutional_amendment">Legislatively referred constitutional amendment</a> <span class="citation" data-cites="BP2024">(<span>“California 2024 Ballot Propositions”</span> 2024)</span> Notes are from <span class="citation" data-cites="Calmatters2024">(<span>“What’s on Your November Ballot? 2024 California Ballot Measures: What You Need to Know”</span> 2024)</span>.</p>
</section>
<section id="san-francisco-ballot-measures" class="level2">
<h2 class="anchored" data-anchor-id="san-francisco-ballot-measures">San Francisco ballot measures</h2>
<div class="cell">
<div id="tbl-sf-props" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-sf-props-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Table of San Francisco ballot propositions
</figcaption>
<div aria-describedby="tbl-sf-props-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 1%">
<col style="width: 0%">
<col style="width: 9%">
<col style="width: 88%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Letter</th>
<th style="text-align: left;">Title</th>
<th style="text-align: left;">Desc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">School Proposition</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">Schools Improvement and Safety Bond</td>
<td style="text-align: left;">To improve earthquakesafety and accessibility at San Francisco public schools; provide reliable internet in classrooms;replace worn-out plumbing, electrical and ventilation systems; improve student nutritionservices; and have updated security features; shall San Francisco Unified School District’smeasure authorizing $790,000,000 in bonds at legal rates levying approximately $12.95 per$100,000 of assessed value, raising approximately $56,400,000 annually while bonds areoutstanding, with independent oversight and all funds staying local, be adopted?</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bond</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">Community Health and Medical Facilities, Street Safety, Public Spaces, and Shelter to Reduce Homelessness Bond</td>
<td style="text-align: left;">HEALTHY, SAFE, AND VIBRANTSAN FRANCISCO BOND. To finance the acquisition or improvement of real property,including : temporary shelters, particularly for families; facilities that deliver healthcare services,including preventive care and behavioral health services, such as the Chinatown Public HealthCenter; critical repairs, renovations, and seismic upgrades at Zuckerberg San Francisco GeneralHospital and Trauma Center and Laguna Honda Hospital; and pedestrian and street safetyimprovements, streetscape enhancements, and other public space improvements; and to payrelated costs; shall the City and County of San Francisco issue $390,000,000 in generalobligation bonds with a duration of up to 30 years from the time of issuance, an estimatedaverage tax rate of $0.0069/$100 of assessed property value, and projected average annualrevenues of $31,000,000, subject to independent citizen oversight and regular audits? The City’scurrent debt management policy is to keep the property tax rate for City general obligation bondsbelow the 2006 rate by issuing new bonds as older ones are retired and the tax base grows,though this property tax rate may vary based on other factors.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Charter amendment</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">Inspector General</td>
<td style="text-align: left;">Shall the City amend the Charter to create thenew position of Inspector General in the Controller’s Office to review and investigate complaintsof fraud, waste, and abuse, and give the Controller’s Office additional powers to issue subpoenasand execute search warrants when permitted by State law?</td>
</tr>
<tr class="even">
<td style="text-align: left;">Charter amendment</td>
<td style="text-align: left;">D</td>
<td style="text-align: left;">City Commissions and Mayoral Authority</td>
<td style="text-align: left;">Shall the City amendthe Charter to limit the total number of commissions the City may have to 65, retaining certaindecision-making commissions and dissolving the others unless the Board of Supervisors insteadcontinues any as advisory bodies; give the Mayor sole authority to appoint and remove Citydepartment heads; and give the Police Chief sole authority to adopt rules governing policeofficers’ conduct?</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Charter amendment</td>
<td style="text-align: left;">E</td>
<td style="text-align: left;">Creating a Task Force to Recommend Changing, Eliminating, or Combining City Commissions</td>
<td style="text-align: left;">Shall the City amend the Charter to create a Task Force withauthority to make recommendations by February 1, 2026, on ways the City could change,eliminate, or consolidate commissions to improve the administration of City government; requirea financial report on the City’s commissions; and give the Task Force authority to introduceordinances to implement its recommendations, and if required provide for the City Attorney todraft Charter amendments to submit to voters at a future election?</td>
</tr>
<tr class="even">
<td style="text-align: left;">Charter amendment</td>
<td style="text-align: left;">F</td>
<td style="text-align: left;">Police Staffing and Deferred Retirement</td>
<td style="text-align: left;">Shall the City amendthe Charter to define full-duty sworn officer; require the Police Chief to make a report andrecommendation on future staffing of full-duty sworn officers to the Police Commission everythree years instead of two; require the Police Commission to report annually to the Board ofSupervisors on Police Department staffing; and create a five-year program with possiblerenewals allowing police officers to continue working for the Police Department after retiring,with pension payments deferred while they are working?</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Charter amendment</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">Funding Rental Subsidies for Affordable Housing Developments Serving Low Income Seniors, Families, and Persons with Disabilities</td>
<td style="text-align: left;">Shall the City amendthe Charter to require the City to appropriate at least $8.25 million a year to pay for rentalsubsidies for affordable housing developments serving extremely low-income households ofseniors, families, and persons with disabilities?</td>
</tr>
<tr class="even">
<td style="text-align: left;">Charter amendment</td>
<td style="text-align: left;">H</td>
<td style="text-align: left;">Retirement Benefits for Firefighters</td>
<td style="text-align: left;">Shall the City amend theCharter to change how pension benefits are calculated for members of the Fire Department hiredon or after January 7, 2012, by lowering the age these members can receive the highest pensionfrom 58 to 55, and make those benefits the same as members hired before January 7, 2012?</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Charter amendment</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">Retirement Benefits for Nurses and 911 Operators</td>
<td style="text-align: left;">Shall the Cityamend the Charter to allow registered nurses who are members of the San Francisco Employees’Retirement System and meet certain requirements to purchase credits toward their total pensionyears of service for time previously worked as per diem nurses, and to allow 911 dispatchers,supervisors, and coordinators to increase their pension benefits by joining the SFERSMiscellaneous Safety Plan for time worked starting in January 2025?</td>
</tr>
<tr class="even">
<td style="text-align: left;">Charter amendment</td>
<td style="text-align: left;">J</td>
<td style="text-align: left;">Funding Programs Serving Children, Youth, and Families</td>
<td style="text-align: left;">Shallthe City amend the Charter to create an initiative led by the Mayor and the Superintendent of theSchool District with the mission of ensuring that City funding for children, youth, and families isused effectively?</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ordinance</td>
<td style="text-align: left;">K</td>
<td style="text-align: left;">Permanently Closing the Upper Great Highway to Private Vehicles to Establish a Public Open Recreation Space</td>
<td style="text-align: left;">Shall the City use the Upper Great Highway aspublic open recreation space, permanently closing it to private motor vehicles seven days a week,with limited exceptions?</td>
</tr>
<tr class="even">
<td style="text-align: left;">Ordinance</td>
<td style="text-align: left;">L</td>
<td style="text-align: left;">Additional Business Tax on Transportation Network Companies and Autonomous Vehicle Businesses to Fund Public Transportation</td>
<td style="text-align: left;">Shall the City place anadditional tax permanently on transportation network companies and autonomous vehiclebusinesses that provide passenger service for compensation with rates between 1% and 4.5% ofgross receipts in San Francisco above $500,000 for an estimated annual revenue of $25 million,and use the funds the City collects from the tax to support Muni transportation services and farediscount programs?</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ordinance</td>
<td style="text-align: left;">M</td>
<td style="text-align: left;">Changes to Business Taxes</td>
<td style="text-align: left;">Shall the City permanently changethe taxes it collects from businesses, including : changing annual gross receipts tax rates tobetween 0.1% and 3.716%, homelessness gross receipts tax rates to between 0.0162% and1.64%, business registration fees to between $55 and $60,000, overpaid executive gross receiptstax rates to between 0.02% and 0.129%, and administrative office tax rates to between 2.97%and 3.694% of payroll expense; increasing the gross receipts tax exemption for small businesses;and changing how the City calculates these taxes; for estimated annual revenue of $50 milliononce fully implemented?</td>
</tr>
<tr class="even">
<td style="text-align: left;">Ordinance</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">First Responder Student Loan and Training Reimbursement Fund</td>
<td style="text-align: left;">Shall the City create a fund that the City could use in the future to help reimburse eligible Cityemployees, including police officers, firefighters, sheriffs, paramedics, registered nurses, and 911dispatchers, for student loans and education and training programs?</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ordinance</td>
<td style="text-align: left;">O</td>
<td style="text-align: left;">Supporting Reproductive Rights</td>
<td style="text-align: left;">Shall it be City policy and lawto support, protect, and expand reproductive rights and services?</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>San Francisco ballot measure information. <span class="citation" data-cites="sfgov">(Chiu 2024)</span></p>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This page is incomplete. I have yet to decide on the relative importance of these ballot measures, or provide guidance for voting. That is to come in the coming days.</p>
</div>
</div>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-BP2024" class="csl-entry">
<span>“California 2024 Ballot Propositions.”</span> 2024. BallotPedia. <a href="https://ballotpedia.org/California_2024_ballot_propositions">https://ballotpedia.org/California_2024_ballot_propositions</a>.
</div>
<div id="ref-sfgov" class="csl-entry">
Chiu, David. 2024. <span>“Qualified Measures Nov. 5 2024.”</span> San Francisco Department of Elections. <a href="https://www.sf.gov/reports/november-2024/qualified-measures">https://www.sf.gov/reports/november-2024/qualified-measures</a>.
</div>
<div id="ref-sfvote1993" class="csl-entry">
Registrar of Voters, Office of the. 1993. <span>“SF Voter Pamphlet and Sample Ballot November 2, 1993 Consolidated General Election.”</span> <a href="https://newspack-missionlocal.s3.amazonaws.com/mission/wp-content/uploads/2024/08/1993-voter-pamphlet-SF.pdf">https://newspack-missionlocal.s3.amazonaws.com/mission/wp-content/uploads/2024/08/1993-voter-pamphlet-SF.pdf</a>.
</div>
<div id="ref-Calmatters2024" class="csl-entry">
<span>“What’s on Your November Ballot? 2024 California Ballot Measures: What You Need to Know.”</span> 2024. <a href="https://calmatters.org/explainers/california-ballot-measures-2024/#6776ace0-e646-46bf-8211-088172e0f187">https://calmatters.org/explainers/california-ballot-measures-2024/#6776ace0-e646-46bf-8211-088172e0f187</a>.
</div>
</div>


</section>

 ]]></description>
  <category>politics</category>
  <category>opinions</category>
  <guid>https://pdcherry.github.io/posts/2024_08_29-Cali_Nov_2024_ballot_measures.html</guid>
  <pubDate>Thu, 29 Aug 2024 07:00:00 GMT</pubDate>
  <media:content url="https://pdcherry.github.io/posts/2024_08_29-Cali_Nov_2024_ballot_measures/SF_flyover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Copy-number-variant (CNV) TE Panel Analysis</title>
  <dc:creator>Patrick Cherry</dc:creator>
  <link>https://pdcherry.github.io/posts/2024_07_15-CNV_TE_panel_analysis.html</link>
  <description><![CDATA[ 





<section id="summary" class="level1">
<h1>Summary</h1>
<p>In this hypothetical exercise, a recently characterized disorder called under study is “CNV-emia”, an genetic disease showing autosomal recessive inheritance of mutations in the “CNSL” gene. The deletion/duplication breakpoints can vary from sample to sample (see table below), and it has been hypothesized that the breakpoints correspond with ethnicity. The breakpoint positions are known from the literature.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Del/Dup index</th>
<th>5´ breakpoint</th>
<th>3´ breakpoint</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>CNSL_probe_32</td>
<td>CNSL_probe_38</td>
</tr>
<tr class="even">
<td>2</td>
<td>CNSL_probe_27</td>
<td>CNSL_probe_34</td>
</tr>
<tr class="odd">
<td>3</td>
<td>CNSL_probe_20</td>
<td>CNSL_probe_40</td>
</tr>
<tr class="even">
<td>4</td>
<td>CNSL_probe_10</td>
<td>CNSL_probe_40</td>
</tr>
</tbody>
</table>
<p>Three probes with off-trend uniformity are CNSL_5, CNSL_23, and CNSL_46. I would recommend these probes be re-designed for better uniformity of capture and lower off-target.</p>
<p>The CNV calling and statistical analysis indicated that, significantly, the duplication vs.&nbsp;deletion of a CNV helps predict ethnicity. While the hypothesized probe intervals were not statistically significant in the model, the control data show that the method has high precision. In the CNSL region, ethnicity A has a CNV frequency of 3.2%, followed by B with a frequency of 1.0%, followed lastly by C with a frequency of 0.8%; in terms of CNV type, A is 1.8x more likely to have a deletion than a duplication, B is heavily biased toward deletions, and C is exclusively deletions (n = 21). Due to interval overlap of many hypothesized breakpoints, the model is partly confounded because the probe CNV calls are not fully independent.</p>
<p>In order to predict the unknown ethnicity of another set of data, I would train a classifier machine-learning model, such as a random forest classifier, a logistic model, or a K-nearest neighbors model, on the data in this analysis. Best practice is to separate training, validation, and test data. Once trained, parameters optimized, and predictions reasonably accurate, I would apply the model to the unknown data.</p>
</section>
<section id="procedure" class="level1">
<h1>Procedure</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quietly =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rlang)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(here)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(magrittr)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(patchwork)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(valr)</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(flextable)</span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(mclogit)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(data_dir, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_col_types =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
• `` -&gt; `...1`</code></pre>
</div>
</div>
<section id="exploratory-checks" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-checks">Exploratory &amp; Checks</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_detect</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 100</code></pre>
</div>
</div>
<section id="how-many-are-cnsl-vs.-non-cnsl" class="level3">
<h3 class="anchored" data-anchor-id="how-many-are-cnsl-vs.-non-cnsl">How many are CNSL vs.&nbsp;non-CNSL</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_detect</span>(value, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe_type"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_detect</span>(value, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"non_CNSL_probe_"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"non-CNSL"</span>,</span>
<span id="cb6-5">                                  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_detect</span>(value, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL"</span>,</span>
<span id="cb6-6">                                  <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(probe_type)</span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">probe_type</th>
<th style="text-align: right;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CNSL</td>
<td style="text-align: right;">50</td>
</tr>
<tr class="even">
<td style="text-align: left;">non-CNSL</td>
<td style="text-align: right;">50</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="check-id-uniqueness" class="level3">
<h3 class="anchored" data-anchor-id="check-id-uniqueness">Check id uniqueness</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(data);</span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">10000</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(data, id, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"num_occurences"</span>))</span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">10000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>All ids are unique.</p>
<p>Ethnicities are not balanced in the experiment.</p>
</section>
<section id="distributions-of-probe-counts" class="level3">
<h3 class="anchored" data-anchor-id="distributions-of-probe-counts">Distributions of probe counts</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">probe_count_hist_facet <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">contains</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"counts"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(counts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> ethnicity)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> probe)</span>
<span id="cb9-6">probe_count_hist_facet <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_07_15-CNV_TE_panel_analysis_files/figure-html/Distributions of probe counts-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file_prefix"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe_count_hist_facet"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".png"</span>), probe_count_hist_facet,</span>
<span id="cb11-2">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpi =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">320</span>)</span></code></pre></div>
</div>
</section>
</section>
</section>
<section id="normalize-probe-coverage" class="level1">
<h1>Normalize probe coverage</h1>
<section id="normalize-probe-coverage-withing-samples-first" class="level3">
<h3 class="anchored" data-anchor-id="normalize-probe-coverage-withing-samples-first">Normalize probe coverage withing samples (first)</h3>
<p>So there are 100 probe columns. The only other columns are <code>id</code> and <code>ethnicity</code>. We have 50 CNSL probes (which are hypothesized to contribute to “CNV-emia”, an autosomal recessive disease), and 50 non-CNSL probes in the target enrichment capture.</p>
<p>“Due to variability of extraction efficiency in the lab and error in the quantification of DNA libraries, each sample has a slightly different average NGS read depth across all probes.”</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">norm_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute mean coverage for each sample (rowwise)</span></span>
<span id="cb12-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean_sample_cov"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c_across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">contains</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_probe_"</span>))),</span>
<span id="cb12-5">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_probes_in_mean"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c_across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">contains</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_probe_"</span>)))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relocate</span>(mean_sample_cov, n_probes_in_mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.after =</span> ethnicity) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute sample-normalized coverage for each probe</span></span>
<span id="cb12-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">contains</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_probe_"</span>),</span>
<span id="cb12-10">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.fns =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"norm_cov"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">~</span> .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> mean_sample_cov),</span>
<span id="cb12-11">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.names =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{.fn}_{.col}"</span>),</span>
<span id="cb12-12">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> id)</span></code></pre></div>
</div>
</section>
<section id="normalize-probe-coverage-per-probe-across-samples-second" class="level3">
<h3 class="anchored" data-anchor-id="normalize-probe-coverage-per-probe-across-samples-second">Normalize probe coverage per probe across samples (second)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">norm_data_filtered <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb13-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_23"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_46"</span>))</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">norm_norm_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm_data_filtered <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb14-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">contains</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"norm_cov"</span>),</span>
<span id="cb14-3">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.fns =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"norm"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">~</span> .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.x) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#,</span></span>
<span id="cb14-4">                         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># n_samples_in_norm originally here to ensure 10,000 samples per probe were in calc.</span></span>
<span id="cb14-5">                         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#"n_samples_in_norm" = ~ length(.x)</span></span>
<span id="cb14-6">                         ),</span>
<span id="cb14-7">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.names =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{.fn}_{.col}"</span>))</span></code></pre></div>
</div>
<p>Normalize to coverage levels empirically seen in nonCNSL probes based on the assumptions of “nonCNSL” regions are CN=2 and ~1 or ~3, respectively. Thus, we can use the coverage data from nonCNSL probes to “calibrate” what a CN=2 sample looks like in this assay, after normalizing these data by sample and probe in the same way we did for the CNSL data.</p>
</section>
<section id="pivot-2x-normalized-data-to-long-format" class="level2">
<h2 class="anchored" data-anchor-id="pivot-2x-normalized-data-to-long-format">Pivot 2x normalized data to long format</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">norm_norm_data_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm_norm_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(id, ethnicity, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">contains</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"norm_norm_cov"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">contains</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"norm_norm_cov"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"norm_norm_cov"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create order for probes</span></span>
<span id="cb15-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe_number"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_extract</span>(probe, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(?&lt;=CNSL_probe_)</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d{1,2}"</span>)),</span>
<span id="cb15-6">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe_ordering"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_detect</span>(probe, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"non_"</span>),</span>
<span id="cb15-7">                                  probe_number <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, probe_number)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># simplify names for easier plotting</span></span>
<span id="cb15-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(probe, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"norm_norm_cov_"</span>),</span>
<span id="cb15-10">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(probe, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe_"</span>),</span>
<span id="cb15-11">         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># impose integer ordering on probe name strings</span></span>
<span id="cb15-12">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_reorder</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(probe), probe_ordering)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>probe_ordering)</span></code></pre></div>
</div>
<section id="save-2x-normalized-data" class="level4">
<h4 class="anchored" data-anchor-id="save-2x-normalized-data">Save 2x normalized data</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_csv</span>(norm_norm_data_long, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(file_prefix, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_norm_norm_data_long"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".csv.gz"</span>))</span></code></pre></div>
</div>
</section>
<section id="quick-plot-to-check-results" class="level4">
<h4 class="anchored" data-anchor-id="quick-plot-to-check-results">quick plot to check results</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">norm_norm_count_hist_facet <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm_norm_data_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb17-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(norm_norm_cov, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> ethnicity)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">binwidth =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">transform =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log1p"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_cartesian</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> probe <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ethnicity) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)),</span>
<span id="cb17-8">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb17-9"></span>
<span id="cb17-10">norm_norm_count_hist_facet <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_07_15-CNV_TE_panel_analysis_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(file_prefix, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"norm_norm_count_hist_facet"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".png"</span>), norm_norm_count_hist_facet,</span>
<span id="cb18-2">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpi =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">320</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">copy_n_res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.17</span></span>
<span id="cb19-2"></span>
<span id="cb19-3">CNSL_30_norm_norm_hist <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm_norm_data_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb19-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(probe <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_30"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb19-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(norm_norm_cov, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> ethnicity)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">binwidth =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">01</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> copy_n_res, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> copy_n_res, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">transform =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log1p"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#coord_cartesian(xlim = c(0, 2.5)) +</span></span>
<span id="cb19-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> probe <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ethnicity)</span>
<span id="cb19-12">CNSL_30_norm_norm_hist</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_07_15-CNV_TE_panel_analysis_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(file_prefix, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_30_norm_norm_hist"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".png"</span>), CNSL_30_norm_norm_hist,</span>
<span id="cb20-2">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpi =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">320</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>)</span>
<span id="cb21-2">norm_norm_cov_lineplot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm_norm_data_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(id, ethnicity) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_sample</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> ethnicity) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(norm_norm_data_long, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ethnicity"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> norm_norm_cov, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> probe_number, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> ethnicity)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> id, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)),</span>
<span id="cb21-10">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb21-11"></span>
<span id="cb21-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(file_prefix, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"norm_norm_cov_lineplot"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".png"</span>), norm_norm_cov_lineplot,</span>
<span id="cb21-13">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpi =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">320</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">probe_norm_count_hist_facet <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">contains</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"norm_cov"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"norm_counts"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(norm_counts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> ethnicity)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">binwidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> probe)</span>
<span id="cb22-6"></span>
<span id="cb22-7">probe_norm_count_hist_limited_facet <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">contains</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"norm_cov"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"norm_counts"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(probe, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"norm_cov_"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(probe) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(probe <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_23"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_46"</span>,</span>
<span id="cb22-12">                      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"non_CNSL_probe_2"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(norm_counts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> ethnicity)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">binwidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> probe) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Normalized count histograms"</span>,</span>
<span id="cb22-17">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Example set, for demonstration"</span>,</span>
<span id="cb22-18">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sample count (n)"</span>,</span>
<span id="cb22-19">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Normalized counts (ratio to mean)"</span>)</span>
<span id="cb22-20"></span>
<span id="cb22-21">probe_norm_count_hist_limited_facet</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_07_15-CNV_TE_panel_analysis_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file_prefix"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe_norm_count_hist_facet"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".png"</span>), probe_norm_count_hist_facet,</span>
<span id="cb23-2">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpi =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">320</span>)</span></code></pre></div>
</div>
<p>Most of the normalized coverage distributions of probes look great! The per-sample normalization worked well. However, we can see (highlighted specifically here, in the example) some probes that are not behaving well.</p>
</section>
<section id="identify-bad-probes" class="level3">
<h3 class="anchored" data-anchor-id="identify-bad-probes">Identify bad probes</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">probe_eval_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm_norm_data_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb24-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(norm_norm_cov,</span>
<span id="cb24-3">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.fns =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mean,</span>
<span id="cb24-4">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> sd,</span>
<span id="cb24-5">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"min"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> min</span>
<span id="cb24-6">                            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#"max" = max</span></span>
<span id="cb24-7">                            ),</span>
<span id="cb24-8">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.names =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{.fn}_{.col}"</span>),</span>
<span id="cb24-9">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#"n_samples" = n(),</span></span>
<span id="cb24-10">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(probe, probe_number)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb24-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.numeric), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(.x, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)))</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1">probe_uniformity_dist_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> probe_eval_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb25-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(sd_norm_norm_cov)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">binwidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Probe uniformity check"</span>,</span>
<span id="cb25-5">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Distribution of standard deviations of coverages by probe"</span>,</span>
<span id="cb25-6">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"number of probes"</span>,</span>
<span id="cb25-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stadard deviation of coverage"</span>)</span>
<span id="cb25-8">probe_uniformity_dist_plot</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_07_15-CNV_TE_panel_analysis_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So we have three outlier probes with poor uniformity of coverage. Let’s list out what they are.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1">probe_eval_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(sd_norm_norm_cov)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_head</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 15%">
<col style="width: 16%">
<col style="width: 24%">
<col style="width: 21%">
<col style="width: 22%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">probe</th>
<th style="text-align: right;">probe_number</th>
<th style="text-align: right;">mean_norm_norm_cov</th>
<th style="text-align: right;">sd_norm_norm_cov</th>
<th style="text-align: right;">min_norm_norm_cov</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CNSL_5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1.010</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="even">
<td style="text-align: left;">CNSL_23</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.512</td>
<td style="text-align: right;">0.0362</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CNSL_46</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.512</td>
<td style="text-align: right;">0.0409</td>
</tr>
<tr class="even">
<td style="text-align: left;">CNSL_32</td>
<td style="text-align: right;">32</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.111</td>
<td style="text-align: right;">0.4350</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CNSL_36</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.108</td>
<td style="text-align: right;">0.4270</td>
</tr>
<tr class="even">
<td style="text-align: left;">non_CNSL_23</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.100</td>
<td style="text-align: right;">0.6320</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>In this head of the table of uniformity sorted by standard deviation of the probes, the three probes with off-trend uniformity are CNSL_5, CNSL_23, and CNSL_46. I would recommend these probes be re-designed for better uniformity of capture and lower off-target.</p>
<p>In target enrichment, probes that perform poorly (due to their design / positioning) typically exhibit high rates of off-target reads (not directly observable in this data set) and a high variability in coverage from sample-to-sample (<em>i.e.</em> low uniformity of coverage). This analysis uses a rough measure of uniformity to identify potentially poorly-performing probes.</p>
</section>
<section id="filter-out-bad-probes" class="level3">
<h3 class="anchored" data-anchor-id="filter-out-bad-probes">Filter out bad probes</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1">norm_norm_data_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&lt;&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_detect</span>(probe, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(?&lt;!non_)(CNSL_5|CNSL_23|CNSL_46)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">negate =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span></code></pre></div>
</div>
</section>
</section>
<section id="convert-coverage-to-integer-cnv-levels" class="level2">
<h2 class="anchored" data-anchor-id="convert-coverage-to-integer-cnv-levels">Convert coverage to integer CNV levels</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">nonCNSL_CNV_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm_norm_data_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb28-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute non-CNSL coverage means</span></span>
<span id="cb28-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_detect</span>(probe, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"non"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb28-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean_nonCNSL_cov"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(norm_norm_cov),</span>
<span id="cb28-5">           <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd_nonCNSL_cov"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(norm_norm_cov),</span>
<span id="cb28-6">           <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_samples"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb28-7">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> probe)</span>
<span id="cb28-8"></span>
<span id="cb28-9">nonCNSL_CNV_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb28-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(probe, mean_nonCNSL_cov, n_samples) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb28-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean cov for all non-CNSL probes"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(mean_nonCNSL_cov),</span>
<span id="cb28-12">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SD cov for all non-CNSL probes"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(mean_nonCNSL_cov),</span>
<span id="cb28-13">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"min cov"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(mean_nonCNSL_cov),</span>
<span id="cb28-14">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max cov"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(mean_nonCNSL_cov),</span>
<span id="cb28-15">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n probes"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb28-16">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n samples in each mean"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(n_samples))</span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 29%">
<col style="width: 27%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">mean cov for all non-CNSL probes</th>
<th style="text-align: right;">SD cov for all non-CNSL probes</th>
<th style="text-align: right;">min cov</th>
<th style="text-align: right;">max cov</th>
<th style="text-align: right;">n probes</th>
<th style="text-align: right;">n samples in each mean</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">50</td>
<td style="text-align: right;">10000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>This analysis shows that all non-CNSL probes have a mean coverage (across the 10,000 samples sequenced) of exactly 1.0 . Thus, to convert these coverage values to CNV values (normalized haploid genomic equivalents), we must multiply by 2. (The standard deviation is so small as to be negligible, and is likely caused by floating point calculation error accumulation. This is supported by the min and max calculations in the next columns of the summary table.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1">norm_norm_data_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&lt;&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNV_level"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> norm_norm_cov <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
</div>
<section id="save-2x-normalized-data-1" class="level4">
<h4 class="anchored" data-anchor-id="save-2x-normalized-data-1">Save 2x normalized data</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_csv</span>(norm_norm_data_long, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(file_prefix, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_norm_norm_data_long"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".csv.gz"</span>))</span></code></pre></div>
</div>
</section>
</section>
<section id="analyze-to-detect-copy-number-variations-unsing-rle" class="level2">
<h2 class="anchored" data-anchor-id="analyze-to-detect-copy-number-variations-unsing-rle">Analyze to detect copy number variations (unsing rle)</h2>
<p>Run length encoding is a lossless form of compression that encodes a data series as a different series where each consecutive repeated value is recorded as the value and the number of repeats. In R, this is accomplished with the <code>rle</code> function, and the output is a linked pair of lists where the values and number of repeats occupy the same position in their respective lists.</p>
<p>We can take advantage of run length encoding not for its compression properties, but for its ability to variably call the number of consecutive values. We will use <code>TRUE</code>/<code>FALSE</code> binary values (or <code>Dup</code>, <code>Del</code>, and <code>No CNV</code> values) for whether there is a CNV (deletion or duplication).</p>
<p>However, because we have eliminated three probes from the analysis, and because the start and stop positions of the CNV will be reported in units of <em><em>list elements</em></em> —not probes—, we have to create a secondary positional order column. This will allow for seamless consecutive CNV calling, and for conversion back to probe number annotations used in the original dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1">norm_norm_data_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&lt;&gt;%</span></span>
<span id="cb31-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># new code to correct for probe position</span></span>
<span id="cb31-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe_CNSL_target"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_extract</span>(probe, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(non_)*CNSL"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb31-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"continuous_probe_id"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># row_number() starts at 1</span></span>
<span id="cb31-5">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(id, ethnicity, probe_CNSL_target))</span></code></pre></div>
</div>
<p>As expected, there should be 50 non-CNSL probes, and 47 CNSL probes.</p>
<section id="run-rle-cnv-detection" class="level3">
<h3 class="anchored" data-anchor-id="run-rle-cnv-detection">Run rle CNV detection</h3>
<section id="make-plot-to-set-threshold-by-eye" class="level4">
<h4 class="anchored" data-anchor-id="make-plot-to-set-threshold-by-eye">Make plot to set threshold by eye</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1">cnv_level_dist_tbl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm_norm_data_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb32-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mean CNV"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(CNV_level),</span>
<span id="cb32-3">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Max CNV"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(CNV_level),</span>
<span id="cb32-4">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Min CNV"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(CNV_level),</span>
<span id="cb32-5">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(id, ethnicity)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb32-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pivot longer for faceted plots</span></span>
<span id="cb32-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mean CNV"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Max CNV"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Min CNV"</span>),</span>
<span id="cb32-8">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Measure"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1">cnv_call_threshold <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span></span>
<span id="cb33-2"></span>
<span id="cb33-3">cnv_level_dist <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cnv_level_dist_tbl <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb33-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> ethnicity)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">binwidth =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">01</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotdash"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.33</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">transform =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log10"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Measure) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># theme(strip.text = element_text(size = 3, margin = margin(0, 0, 0, 0)),</span></span>
<span id="cb33-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#       axis.text = element_text(size = 4)) +</span></span>
<span id="cb33-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Distributions of CNV means, maxes, &amp; mins by probe"</span>,</span>
<span id="cb33-14">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dashed lines indicate CNV calling thresholds"</span>,</span>
<span id="cb33-15">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNV level"</span>,</span>
<span id="cb33-16">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Count (number of samples) (log scale)"</span>)</span>
<span id="cb33-17">cnv_level_dist</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_07_15-CNV_TE_panel_analysis_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The above plot shows the distribution of CNV levels in samples, and puts the distribution in the context of manually (by eye) setting thresholds of a Deletion (low) or a Duplication (high).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(file_prefix, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cnv_level_dist"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".png"</span>), cnv_level_dist,</span>
<span id="cb34-2">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpi =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">320</span>)</span></code></pre></div>
</div>
</section>
<section id="apply-thresholds-in-rle-analysis" class="level4">
<h4 class="anchored" data-anchor-id="apply-thresholds-in-rle-analysis">Apply thresholds in rle analysis</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1">cnv_rle <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(sub_df, lower_thresh, upper_thresh){</span>
<span id="cb35-2">  </span>
<span id="cb35-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check that thresholds are valid</span></span>
<span id="cb35-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(lower_thresh <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> upper_thresh) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error: lower CNV threshold, `lower_thresh`, must be less than the upper CNV threshold, `upper_thresh`."</span>)</span>
<span id="cb35-5">  </span>
<span id="cb35-6">  sub_df_cnv_calls <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sub_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb35-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNV_call"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(CNV_level <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> lower_thresh <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Deletion"</span>,</span>
<span id="cb35-8">                                  CNV_level <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> upper_thresh <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Duplication"</span>,</span>
<span id="cb35-9">                                  <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No CNV"</span>))</span>
<span id="cb35-10">  </span>
<span id="cb35-11">  df_rle <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(</span>
<span id="cb35-12">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rle_lengths"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rle</span>(sub_df_cnv_calls<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>CNV_call)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]],</span>
<span id="cb35-13">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rle_values"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rle</span>(sub_df_cnv_calls<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>CNV_call)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]</span>
<span id="cb35-14">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb35-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"start_pos"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(rle_lengths))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb35-16">           <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"end_pos"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(rle_lengths))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb35-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replace_na</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"start_pos"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb35-18">  </span>
<span id="cb35-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(df_rle)</span>
<span id="cb35-20">}</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">cnv_rle <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm_norm_data_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ethnicity"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe_CNSL_target"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rle_result"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(data, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cnv_rle</span>(.x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower_thresh =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.33</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper_thresh =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.75</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(rle_result)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNV_call_length"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(end_pos <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> start_pos))</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1">cnv_rle_hits <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cnv_rle <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb37-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(rle_values <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No CNV"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> CNV_call_length <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div>
</div>
</section>
</section>
<section id="analyze-the-analysis" class="level3">
<h3 class="anchored" data-anchor-id="analyze-the-analysis">Analyze the analysis</h3>
<p>In the hits, are there any samples with more than one CNV call?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1">cnv_rle_hits <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(id, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"number CNV contigs"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">number CNV contigs</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"number of samples"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">number CNV contigs</th>
<th style="text-align: right;">number of samples</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">206</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>In this rle analysis using the above thresholds, 206 samples have one CNV detected, 8 samples have 2 CNVs called, and 1 sample has 3.</p>
<p>How many CNVs are too short to make the cut?</p>
<p>1359 out of 21,951 total called CNVs have a consecutive length of less than 3 probes</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1">(cnv_rl_dist <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cnv_rle_hits <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb39-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(CNV_call_length)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">binwidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-3">  ggdist<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_dist_pointinterval</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Distribution of called CNV run lengths"</span>,</span>
<span id="cb39-5">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample count"</span>))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_07_15-CNV_TE_panel_analysis_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The above QC plot shows the distribution of the consecutive length of the called CNV regions. We see the median length is 6, with a standard deviation of 5.8; the distribution is skewed to the left, with some potential groupings of CNV run lengths.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1">cnv_rl_dist <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> rle_values)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_07_15-CNV_TE_panel_analysis_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The deletions tend to occupy ~ 3 clusters fo lengths, around 6~7 probes, ~19 probes, and ~ 29 probes. The duplications are more clustered around ~5 probes in length.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1">cnv_rle_hits <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb41-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(CNV_call_length)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">binwidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb41-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_grid</span>(ethnicity <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> rle_values, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb41-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Distribution of called CNV run lengths"</span>,</span>
<span id="cb41-5">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Faceted by ethnicity and CNV type"</span>,</span>
<span id="cb41-6">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample count"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_07_15-CNV_TE_panel_analysis_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1">cnv_rle_hits_tidy_bed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cnv_rle <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb42-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># keep observations where No CNV is the call, or it's hit based on 4 consecutive probes</span></span>
<span id="cb42-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(rle_values <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No CNV"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> CNV_call_length <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb42-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert start positions to probe number</span></span>
<span id="cb42-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(probe_number_lookup_tbl,</span>
<span id="cb42-6">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"start_pos"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"continuous_probe_id"</span>,</span>
<span id="cb42-7">                   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe_CNSL_target"</span>),</span>
<span id="cb42-8">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">suffix =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_start"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb42-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert end positions to probe number</span></span>
<span id="cb42-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">end_pos =</span> end_pos <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb42-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(probe_number_lookup_tbl,</span>
<span id="cb42-12">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"end_pos"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"continuous_probe_id"</span>,</span>
<span id="cb42-13">                   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe_CNSL_target"</span>),</span>
<span id="cb42-14">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">suffix =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_start"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_end"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb42-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prepare dataframe for bed tools (equivalent)</span></span>
<span id="cb42-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chrom"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> probe_CNSL_target, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"start"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> probe_number_start, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"end"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> probe_number_end)</span></code></pre></div>
</div>
<p>Here we have what looks like evidence we can classify the samples into ethnicity based on the status of the deletion v. duplication, and the run length of the consecutive number of probes affected by each type of genomic aberration.</p>
<section id="hard-code-hypothesized-breakpoints" class="level4">
<h4 class="anchored" data-anchor-id="hard-code-hypothesized-breakpoints">Hard-code hypothesized breakpoints</h4>
<p>Note that bed format specifies that the start position for an interval is zero based and the end position is one-based. So we will have to manually add 1 to the end position of the probes in the hypothesis table.</p>
<p>Using a R-dataframe-compatible version of <a href="https://bedtools.readthedocs.io/en/latest/content/tools/closest.html">bedtools closest</a> to compute data for breakpoint hypotheses.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># filtering out non-CNSL calls, because they are not in the hypothesis table</span></span>
<span id="cb43-2">cnv_rle_closest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> valr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bed_closest</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(cnv_rle_hits_tidy_bed, chrom <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"non_CNSL"</span>),</span>
<span id="cb43-3">                                          breakpoints_bed_df,</span>
<span id="cb43-4">                                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">overlap =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb43-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(id.x)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1">cnv_rle_hits_closest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cnv_rle_closest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb44-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># keep only CNV-positives</span></span>
<span id="cb44-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(rle_values.x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No CNV"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb44-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># tidy up factors and leveling</span></span>
<span id="cb44-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ethnicity.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(ethnicity.x),</span>
<span id="cb44-6">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(name.y)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb44-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name.y"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_relevel</span>(name.y,</span>
<span id="cb44-8">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_32-CNSL_probe_38"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_27-CNSL_probe_34"</span>,</span>
<span id="cb44-9">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_20-CNSL_probe_40"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_10-CNSL_probe_40"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb44-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sort for priority of keeping one per sample</span></span>
<span id="cb44-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(id.x, .dist, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(.overlap), name.y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb44-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sort to prioritize lowest distance, highest overlap</span></span>
<span id="cb44-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(id.x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.keep_all =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
</div>
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1">cnv_rle_closest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb45-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(id.x) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb45-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean CNVs per sample"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(n),</span>
<span id="cb45-4">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SD CNVs per sample"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(n))</span>
<span id="cb45-5">cnv_rle_hits_closest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>()</span></code></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2" data-tbl-subcap="[&quot;CNVs called per sample&quot;,&quot;Unique samples with any CNVs&quot;]">
<div class="quarto-layout-row">
<div class="kable-table quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">mean CNVs per sample</th>
<th style="text-align: right;">SD CNVs per sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">4.382</td>
<td style="text-align: right;">1.907312</td>
</tr>
</tbody>
</table>
</div>
<div class="kable-table quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">215</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>215 samples have a CNV called. 891 CNVs were called, meaning on average each positive sample has 4.14 CNVs called.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1">cnv_rle_summary <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cnv_rle_closest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb46-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># tidy up factors and leveling</span></span>
<span id="cb46-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ethnicity.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_relevel</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(ethnicity.x), LETTERS[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]),</span>
<span id="cb46-4">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(name.y)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb46-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name.y"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_relevel</span>(name.y,</span>
<span id="cb46-6">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_32-CNSL_probe_38"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_27-CNSL_probe_34"</span>,</span>
<span id="cb46-7">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_20-CNSL_probe_40"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_10-CNSL_probe_40"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb46-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb46-9">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean_CNV_length"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(CNV_call_length.x),</span>
<span id="cb46-10">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd_CNV_length"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(CNV_call_length.x),</span>
<span id="cb46-11">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean_overlap"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.overlap),</span>
<span id="cb46-12">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd_overlap"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(.overlap),</span>
<span id="cb46-13">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean_distance"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(.dist)),</span>
<span id="cb46-14">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd_distance"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(.dist)),</span>
<span id="cb46-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(ethnicity.x, rle_values.x, name.y)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb46-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.double), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(.x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb46-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"percent"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>),</span>
<span id="cb46-18">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(ethnicity.x, name.y)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb46-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relocate</span>(percent, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.after =</span> n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb46-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(ethnicity.x, rle_values.x, name.y)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1">cnv_rle_summary <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb47-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ethnicity"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> ethnicity.x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNV type"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> rle_values.x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe name"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> name.y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb47-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe name"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove_all</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probe name</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNSL_probe_"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb47-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(sd_CNV_length, sd_overlap, sd_distance)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb47-5">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CNV_length"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mean_CNV_length, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overlap"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mean_overlap, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"distance"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mean_distance) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb47-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">CNV type</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No CNV"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<caption>CNV types and loci by ethnicity</caption>
<colgroup>
<col style="width: 13%">
<col style="width: 16%">
<col style="width: 15%">
<col style="width: 5%">
<col style="width: 10%">
<col style="width: 15%">
<col style="width: 10%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">ethnicity</th>
<th style="text-align: left;">CNV type</th>
<th style="text-align: left;">probe name</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">percent</th>
<th style="text-align: right;">CNV_length</th>
<th style="text-align: right;">overlap</th>
<th style="text-align: right;">distance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">A</td>
<td style="text-align: left;">Deletion</td>
<td style="text-align: left;">32-38</td>
<td style="text-align: right;">112</td>
<td style="text-align: right;">2.0700</td>
<td style="text-align: right;">6.491</td>
<td style="text-align: right;">3.527</td>
<td style="text-align: right;">0.00000</td>
</tr>
<tr class="even">
<td style="text-align: left;">A</td>
<td style="text-align: left;">Deletion</td>
<td style="text-align: left;">27-34</td>
<td style="text-align: right;">112</td>
<td style="text-align: right;">2.0700</td>
<td style="text-align: right;">6.491</td>
<td style="text-align: right;">3.964</td>
<td style="text-align: right;">0.00000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A</td>
<td style="text-align: left;">Deletion</td>
<td style="text-align: left;">20-40</td>
<td style="text-align: right;">112</td>
<td style="text-align: right;">2.0300</td>
<td style="text-align: right;">6.491</td>
<td style="text-align: right;">5.491</td>
<td style="text-align: right;">0.00000</td>
</tr>
<tr class="even">
<td style="text-align: left;">A</td>
<td style="text-align: left;">Deletion</td>
<td style="text-align: left;">10-40</td>
<td style="text-align: right;">112</td>
<td style="text-align: right;">2.0300</td>
<td style="text-align: right;">6.491</td>
<td style="text-align: right;">5.491</td>
<td style="text-align: right;">0.00000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A</td>
<td style="text-align: left;">Duplication</td>
<td style="text-align: left;">32-38</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">1.1500</td>
<td style="text-align: right;">5.097</td>
<td style="text-align: right;">2.629</td>
<td style="text-align: right;">0.37100</td>
</tr>
<tr class="even">
<td style="text-align: left;">A</td>
<td style="text-align: left;">Duplication</td>
<td style="text-align: left;">27-34</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">1.1500</td>
<td style="text-align: right;">5.097</td>
<td style="text-align: right;">2.694</td>
<td style="text-align: right;">0.08065</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A</td>
<td style="text-align: left;">Duplication</td>
<td style="text-align: left;">20-40</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">1.1300</td>
<td style="text-align: right;">5.097</td>
<td style="text-align: right;">4.097</td>
<td style="text-align: right;">0.00000</td>
</tr>
<tr class="even">
<td style="text-align: left;">A</td>
<td style="text-align: left;">Duplication</td>
<td style="text-align: left;">10-40</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">1.1300</td>
<td style="text-align: right;">5.097</td>
<td style="text-align: right;">4.097</td>
<td style="text-align: right;">0.00000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">B</td>
<td style="text-align: left;">Deletion</td>
<td style="text-align: left;">32-38</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">1.0100</td>
<td style="text-align: right;">17.250</td>
<td style="text-align: right;">6.357</td>
<td style="text-align: right;">0.14290</td>
</tr>
<tr class="even">
<td style="text-align: left;">B</td>
<td style="text-align: left;">Deletion</td>
<td style="text-align: left;">27-34</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">1.0100</td>
<td style="text-align: right;">16.830</td>
<td style="text-align: right;">6.897</td>
<td style="text-align: right;">0.06897</td>
</tr>
<tr class="odd">
<td style="text-align: left;">B</td>
<td style="text-align: left;">Deletion</td>
<td style="text-align: left;">20-40</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">0.9600</td>
<td style="text-align: right;">16.830</td>
<td style="text-align: right;">16.720</td>
<td style="text-align: right;">0.00000</td>
</tr>
<tr class="even">
<td style="text-align: left;">B</td>
<td style="text-align: left;">Deletion</td>
<td style="text-align: left;">10-40</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">0.9600</td>
<td style="text-align: right;">16.830</td>
<td style="text-align: right;">16.720</td>
<td style="text-align: right;">0.00000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">B</td>
<td style="text-align: left;">Duplication</td>
<td style="text-align: left;">32-38</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0359</td>
<td style="text-align: right;">4.000</td>
<td style="text-align: right;">2.000</td>
<td style="text-align: right;">0.00000</td>
</tr>
<tr class="even">
<td style="text-align: left;">B</td>
<td style="text-align: left;">Duplication</td>
<td style="text-align: left;">27-34</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0348</td>
<td style="text-align: right;">4.000</td>
<td style="text-align: right;">3.000</td>
<td style="text-align: right;">0.00000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">B</td>
<td style="text-align: left;">Duplication</td>
<td style="text-align: left;">20-40</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0331</td>
<td style="text-align: right;">4.000</td>
<td style="text-align: right;">3.000</td>
<td style="text-align: right;">0.00000</td>
</tr>
<tr class="even">
<td style="text-align: left;">B</td>
<td style="text-align: left;">Duplication</td>
<td style="text-align: left;">10-40</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0331</td>
<td style="text-align: right;">4.000</td>
<td style="text-align: right;">3.000</td>
<td style="text-align: right;">0.00000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">C</td>
<td style="text-align: left;">Deletion</td>
<td style="text-align: left;">32-38</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">0.5980</td>
<td style="text-align: right;">19.800</td>
<td style="text-align: right;">5.200</td>
<td style="text-align: right;">0.26670</td>
</tr>
<tr class="even">
<td style="text-align: left;">C</td>
<td style="text-align: left;">Deletion</td>
<td style="text-align: left;">27-34</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">0.7470</td>
<td style="text-align: right;">17.680</td>
<td style="text-align: right;">5.000</td>
<td style="text-align: right;">1.05300</td>
</tr>
<tr class="odd">
<td style="text-align: left;">C</td>
<td style="text-align: left;">Deletion</td>
<td style="text-align: left;">20-40</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0.8040</td>
<td style="text-align: right;">16.670</td>
<td style="text-align: right;">11.140</td>
<td style="text-align: right;">0.38100</td>
</tr>
<tr class="even">
<td style="text-align: left;">C</td>
<td style="text-align: left;">Deletion</td>
<td style="text-align: left;">10-40</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0.7950</td>
<td style="text-align: right;">16.670</td>
<td style="text-align: right;">16.240</td>
<td style="text-align: right;">0.00000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_csv</span>(cnv_rle_summary, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(file_prefix, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cnv_rle_global_summary.csv"</span>))</span></code></pre></div>
</div>
</section>
<section id="statistical-analysis" class="level4">
<h4 class="anchored" data-anchor-id="statistical-analysis">Statistical analysis</h4>
<p>We need to model the evidence in the data (CNVs, which locus they’re in) to predict ethnicity. Ethnicity has 3 levels, CNVs have 3 (or 2 when omitting no CNV), and locus has 4 levels, so we need a multinomial logit models, which is what <a href="https://melff.github.io/mclogit/reference/mblogit.html"><code>mclogit</code></a> provides.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(probes_mblogit)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
mblogit(formula = ethnicity.x ~ name.y + rle_values.x, data = ., 
    weights = n)

Equation for B vs A:
                                  Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)                       -1.38520    0.20791  -6.662 2.69e-11 ***
name.yCNSL_probe_27-CNSL_probe_34  0.03364    0.29053   0.116    0.908    
name.yCNSL_probe_20-CNSL_probe_40  0.03364    0.29053   0.116    0.908    
name.yCNSL_probe_10-CNSL_probe_40  0.03364    0.29053   0.116    0.908    
rle_values.xDuplication           -2.76727    0.51474  -5.376 7.62e-08 ***

Equation for C vs A:
                                  Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)                        -2.0102     0.2748  -7.314 2.59e-13 ***
name.yCNSL_probe_27-CNSL_probe_34   0.2361     0.3701   0.638    0.524    
name.yCNSL_probe_20-CNSL_probe_40   0.3362     0.3633   0.925    0.355    
name.yCNSL_probe_10-CNSL_probe_40   0.3362     0.3633   0.925    0.355    
rle_values.xDuplication           -16.8589   706.1172  -0.024    0.981    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate residual Deviance: 1076 
Number of Fisher scoring iterations:  14 
Number of observations:  891 </code></pre>
</div>
</div>
</section>
<section id="interpretation-of-cnv-data-against-hypothesized-breakpoints" class="level4">
<h4 class="anchored" data-anchor-id="interpretation-of-cnv-data-against-hypothesized-breakpoints">Interpretation of CNV data against hypothesized breakpoints</h4>
<p><em>Ethnicity A</em> has CNVs in the CNSL region detected 3.2% of the time. When there is a CNV, 2.07% are Deletions in the either of the CNSL_probe_27-CNSL_probe_34 or CNSL_probe_32-CNSL_probe_38 regions, and 1.13% are Duplications, primarily in the CNSL_probe_20-CNSL_probe_40 region. Because CNSL_probe_10-CNSL_probe_40 is a superset of all other regions, we can conclude from the counts / frequencies being the same for all four hypothesized regions that these CNVs are occurring over the narrowest possible interpretation.</p>
<p><em>Ethnicity B</em> has CNVs in the CNSL region detected 1% of the time. When there is a CNV, 0.96% of the time it’s a Deletion in CNSL_probe_20-CNSL_probe_40, and 0.0331% of the time (n = 1) it’s a Duplication with overlap for both CNSL_probe_27-CNSL_probe_34 and CNSL_probe_32-CNSL_probe_38.</p>
<p><em>Ethnicity C</em> has CNVs in the CNSL region detected 0.8% of the time. When there is a CNV, it’s a Deletion in CNSL_probe_10-CNSL_probe_40 that occurs 0.795% of samples, with a mean overlap of 16.24 probes.</p>
</section>
</section>
<section id="global-analysis-of-ethnicities" class="level3">
<h3 class="anchored" data-anchor-id="global-analysis-of-ethnicities">Global analysis of ethnicities</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1">cnv_rle_global_counts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cnv_rle_hits_tidy_bed <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb51-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe_CNSL_target"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> chrom) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb51-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(ethnicity, probe_CNSL_target, rle_values) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb51-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"percent"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>),</span>
<span id="cb51-5">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(ethnicity, probe_CNSL_target))</span>
<span id="cb51-6"></span>
<span id="cb51-7">cnv_rle_global_counts</span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<caption>CNV types and counts by ethnicity</caption>
<thead>
<tr class="header">
<th style="text-align: left;">ethnicity</th>
<th style="text-align: left;">probe_CNSL_target</th>
<th style="text-align: left;">rle_values</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">percent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">A</td>
<td style="text-align: left;">CNSL</td>
<td style="text-align: left;">Deletion</td>
<td style="text-align: right;">112</td>
<td style="text-align: right;">2.0300</td>
</tr>
<tr class="even">
<td style="text-align: left;">A</td>
<td style="text-align: left;">CNSL</td>
<td style="text-align: left;">Duplication</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">1.1300</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A</td>
<td style="text-align: left;">CNSL</td>
<td style="text-align: left;">No CNV</td>
<td style="text-align: right;">5330</td>
<td style="text-align: right;">96.8000</td>
</tr>
<tr class="even">
<td style="text-align: left;">A</td>
<td style="text-align: left;">non_CNSL</td>
<td style="text-align: left;">No CNV</td>
<td style="text-align: right;">4992</td>
<td style="text-align: right;">100.0000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">B</td>
<td style="text-align: left;">CNSL</td>
<td style="text-align: left;">Deletion</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">0.9600</td>
</tr>
<tr class="even">
<td style="text-align: left;">B</td>
<td style="text-align: left;">CNSL</td>
<td style="text-align: left;">Duplication</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0331</td>
</tr>
<tr class="odd">
<td style="text-align: left;">B</td>
<td style="text-align: left;">CNSL</td>
<td style="text-align: left;">No CNV</td>
<td style="text-align: right;">2991</td>
<td style="text-align: right;">99.0000</td>
</tr>
<tr class="even">
<td style="text-align: left;">B</td>
<td style="text-align: left;">non_CNSL</td>
<td style="text-align: left;">No CNV</td>
<td style="text-align: right;">2551</td>
<td style="text-align: right;">100.0000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">C</td>
<td style="text-align: left;">CNSL</td>
<td style="text-align: left;">Deletion</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0.7950</td>
</tr>
<tr class="even">
<td style="text-align: left;">C</td>
<td style="text-align: left;">CNSL</td>
<td style="text-align: left;">No CNV</td>
<td style="text-align: right;">2620</td>
<td style="text-align: right;">99.2000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">C</td>
<td style="text-align: left;">non_CNSL</td>
<td style="text-align: left;">No CNV</td>
<td style="text-align: right;">2490</td>
<td style="text-align: right;">100.0000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The above control table shows that, for all ethnicities, 100% of non-CNSL probes are <strong>not</strong> detected as having a CNV. Thus, based on these control data and our threshold settings, we can expect a false-positive rate (Type I error) very close to zero.</p>
<p>In the CNSL region, ethnicity A has a CNV frequency of 3.2%, followed by B with a frequency of 1.0%, followed lastly by C with a frequency of 0.8%; in terms of CNV type, A is 1.8x more likely to have a deletion than a duplication, B is heavily biased toward deletions, and C is exclusively deletions (n = 21).</p>


</section>
</section>
</section>

 ]]></description>
  <category>data</category>
  <category>code</category>
  <category>target enrichment</category>
  <category>CNV</category>
  <category>next generation sequencing</category>
  <category>genetics</category>
  <category>genomics</category>
  <guid>https://pdcherry.github.io/posts/2024_07_15-CNV_TE_panel_analysis.html</guid>
  <pubDate>Mon, 15 Jul 2024 07:00:00 GMT</pubDate>
  <media:content url="https://pdcherry.github.io/posts/2024_07_15-CNV_TE_panel_analysis/2024_07_15-CNV_TE_cnv_level_dist.png" medium="image" type="image/png" height="90" width="144"/>
</item>
<item>
  <title>CITE-seq analysis proof-of-concept</title>
  <dc:creator>Patrick Cherry</dc:creator>
  <link>https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC.html</link>
  <description><![CDATA[ 





<section id="intro" class="level2">
<h2 class="anchored" data-anchor-id="intro">Intro</h2>
<p>CITE-seq is a method developed at the New York Genome Center for adding phenotypic data in the form of cell-surface protein expression to the RNA expression data that comes from single-cell RNA sequencing <a href="https://www.nature.com/articles/nmeth.4380">Nat Methods 14, 865–868 (2017)</a>. This is accomplished by incubating the cells with DNA oligonucleotide bar-coded antibodies that recognize epitopes on cell surface proteins, and then perform single-cell sequencing. The DNA-tags of the antibodies get indexed using the oligo-dT primers on the beads of the single-cell emulsion, allowing the antibody-derived tags to be mapped back to the scRNA-seq data of the single cells. Thus, RNA expression data and cell-surface protein data can be combined in one experiment for a multi-omics analysis.</p>
<section id="this-experiment" class="level3">
<h3 class="anchored" data-anchor-id="this-experiment">This experiment</h3>
<p>CITE-seq using data from Stoeckius, et al.&nbsp;(Nat Methods 14, 865–868 (2017) 10.1038/nmeth.4380) obtained from GEO series GSE100866.</p>
<p>Seurat multi-modal clustering will be used to cross-validate the cell-surface protein data with the RNA-seq data using a purposely-mixed two-species (human and mouse) immune cell sample.</p>
<!-- https://cran.r-project.org/web/packages/dsb/vignettes/end_to_end_workflow.html -->
<!-- https://broadinstitute.github.io/2020_scWorkshop/cite-seq.html -->
</section>
<section id="methods-intro" class="level3">
<h3 class="anchored" data-anchor-id="methods-intro">Methods Intro</h3>
<p>From <a href="https://www.nature.com/articles/nmeth.4380#Sec18">Supplementary Figure 1 CITE-seq library preparation</a>:</p>
<blockquote class="blockquote">
<p>Illustration of the DNA-barcoded antibodies used in CITE-seq. (b) Antibody-oligonucleotide complexes appear as a high-molecular-weight smear when run on an agarose gel (1). Cleavage of the oligo from the antibody by reduction of the disulfide bond collapses the smear to oligo length (2). (c) Drop-seq beads are microparticles with conjugated oligonucleotides comprising a common PCR handle, a cell barcode, followed by a unique molecular identifier (UMI) and a polyT tail. (d) Schematic illustration of CITE-seq library prep in Drop-seq (downstream of Fig. 1b). Reverse transcription and template switch is performed in bulk after emulsion breakage. After amplification, full length cDNA and antibody-oligo products can be separated by size and amplified independently (also shown in d) (e) Reverse transcription and amplification produces two product populations with distinct sizes (left panel). These can be size separated and amplified independently to obtain full length cDNAs (top panel, capillary electrophoresis trace) and ADTs (bottom panel, capillary electrophoresis trace).</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">fs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir_ls</span>(data_dir) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> fs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">path_file</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "GSE100866_CBMC_8K_13AB_10X-ADT_clr-transformed.csv.gz"
[2] "GSE100866_CBMC_8K_13AB_10X-ADT_umi.csv.gz"            
[3] "GSE100866_CBMC_8K_13AB_10X-RNA_umi.csv.gz"            
[4] "GSE100866_CD8_merged-ADT_clr-transformed.csv.gz"      
[5] "GSE100866_CD8_merged-ADT_umi.csv.gz"                  
[6] "GSE100866_CD8_merged-RNA_umi.csv.gz"                  
[7] "GSE100866_PBMC_vs_flow_10X-ADT_clr-transformed.csv.gz"
[8] "GSE100866_PBMC_vs_flow_10X-ADT_umi.csv.gz"            
[9] "GSE100866_PBMC_vs_flow_10X-RNA_umi.csv.gz"            </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">path</span>(out_path, file_prefix)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/Users/patrick/pdcherry_github_io/posts/2024_06_20-CITE-seq/CITE-seq</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">source</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CITE-seq_data_fetch.R"</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readLines</span>(fs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">path</span>(out_path, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CITE-seq_data_fetch.R"</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>if(!require(GEOquery)){BiocManager::install("GEOquery")}
library(GEOquery)
library(fs)

# https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE100866
# https://www.nature.com/articles/nmeth.4380#article-info

gse_id &lt;- "GSE100866"

gse &lt;- getGEO(gse_id, GSEMatrix = TRUE)
show(gse)

filePaths &lt;- getGEOSuppFiles(gse_id)

fs::file_delete(fs::path("data", gse_id, fs::path_file(fs::dir_ls(gse_id))))
fs::file_move(fs::path(gse_id), "data")</code></pre>
</div>
</div>
</section>
</section>
<section id="read-in-data" class="level2">
<h2 class="anchored" data-anchor-id="read-in-data">Read in data</h2>
<section id="count-data" class="level3">
<h3 class="anchored" data-anchor-id="count-data">count data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">cbmc_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb8-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.sparse</span>(</span>
<span id="cb8-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.csv</span>(</span>
<span id="cb8-4">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">path</span>(data_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GSE100866_CBMC_8K_13AB_10X-RNA_umi.csv.gz"</span>),</span>
<span id="cb8-5">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">header =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row.names =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(cbmc_rna)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 36280  8617</code></pre>
</div>
</div>
<p><code>dim()</code> outputs (columns, rows); the CBMC matrix (cord blood mono-nuclear cells) contains 36280 features and 8617 samples (single cell droplets).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">cbmc_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">CollapseSpeciesExpressionMatrix</span>(cbmc_rna,</span>
<span id="cb11-2">                                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prefix =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HUMAN_"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">controls =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MOUSE_"</span>,</span>
<span id="cb11-3">                                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncontrols =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(cbmc_rna)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 20501  8617</code></pre>
</div>
</div>
<p><code>CollapseSpeciesExpressionMatrix()</code> is a convenience function for slimming down a multi-species expression matrix, when only one species is primarily of interest. Given the default parameter of <code>ncontrols = 100</code>, this command keeps only the top 100 features detected from each species in each sample. This matrix went from 36280 to 20501 features, which is a 43% reduction.</p>
</section>
<section id="adt-umi-matrix" class="level3">
<h3 class="anchored" data-anchor-id="adt-umi-matrix">ADT UMI matrix</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">cbmc_adt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb14-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.sparse</span>(</span>
<span id="cb14-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.csv</span>(</span>
<span id="cb14-4">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">path</span>(data_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GSE100866_CBMC_8K_13AB_10X-ADT_umi.csv.gz"</span>),</span>
<span id="cb14-5">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">header =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row.names =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(cbmc_adt)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   13 8617</code></pre>
</div>
</div>
<section id="quick-matrix-qc" class="level4">
<h4 class="anchored" data-anchor-id="quick-matrix-qc">Quick matrix QC</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">testthat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expect_equal</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(cbmc_rna)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(cbmc_adt)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb17-2">                       <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
</div>
<p>The number of rows (samples / UMIs) matches the RNA counts matrix; we have corresponding sample data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">intersect</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(cbmc_rna), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(cbmc_adt))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span></span>
<span id="cb18-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">union</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(cbmc_rna), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(cbmc_adt)))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<p>And the names of the samples all match.</p>
</section>
</section>
</section>
<section id="seurat-object-cluster" class="level2">
<h2 class="anchored" data-anchor-id="seurat-object-cluster">Seurat object &amp; cluster</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">cbmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">CreateSeuratObject</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts =</span> cbmc_rna)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Feature names cannot have underscores ('_'), replacing with dashes
('-')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">cbmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">NormalizeData</span>(cbmc)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Normalizing layer: counts</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">cbmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindVariableFeatures</span>(cbmc)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Finding variable features for layer counts</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1">cbmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ScaleData</span>(cbmc)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Centering and scaling data matrix</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">cbmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RunPCA</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb28-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ElbowPlot</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ndims =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-cbmc-elbowplot" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cbmc-elbowplot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC_files/figure-html/fig-cbmc-elbowplot-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cbmc-elbowplot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Elbow plot or scree plot of principle components computed from scRNA-seq counts
</figcaption>
</figure>
</div>
</div>
</div>
<p>The elbow plot above shows some interesting PC influence behavior. There are some clusters PCs (like 4-7, 8-10, and 11-13) that make it less clear where the “elbow” of influence trend is. To be very safe, we can keep up to PC 25, where the trend approaches a horizontal line.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1">cbmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindNeighbors</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dims =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing nearest neighbor graph</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing SNN</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1">cbmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindClusters</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resolution =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck

Number of nodes: 8617
Number of edges: 343912

Running Louvain algorithm...
Maximum modularity in 10 random starts: 0.8613
Number of communities: 19
Elapsed time: 0 seconds</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1">cbmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RunTSNE</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dims =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FIt-SNE"</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1">cbmc_rna_markers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb35-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindAllMarkers</span>(cbmc,</span>
<span id="cb35-3">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.cells.per.ident =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logfc.threshold =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb35-4">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">only.pos =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.diff.pct =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span></code></pre></div>
</div>
<p>The following cluster identities are provided for us from the authors of the paper. A cell-type classifier would need to be run on the data to label the bar-codes (droplets) with their identifiers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">new.cluster.ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Memory CD4 T"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD14+ Mono"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Naive CD4 T"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NK"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD14+ Mono"</span>,</span>
<span id="cb36-2">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mouse"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8 T"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD16+ Mono"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T/Mono doublets"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NK"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD34+"</span>,</span>
<span id="cb36-3">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Multiplets"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mouse"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Eryth"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mk"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mouse"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DC"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pDCs"</span>)</span>
<span id="cb36-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(new.cluster.ids) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(cbmc)</span>
<span id="cb36-5">cbmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RenameIdents</span>(cbmc, new.cluster.ids)</span></code></pre></div>
</div>
<section id="clustering-t-sne-plot" class="level3">
<h3 class="anchored" data-anchor-id="clustering-t-sne-plot">Clustering t-SNE plot</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DimPlot</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reduction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tsne"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-tsne-plot-rna" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-tsne-plot-rna-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC_files/figure-html/fig-tsne-plot-rna-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tsne-plot-rna-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: tSNE plot of clustered and classified scRNA-seq data. The 18 cluster ids provided from authors of paper.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="incorporate-protein-expression-antibody-barcodes-to-the-seurat-object" class="level2">
<h2 class="anchored" data-anchor-id="incorporate-protein-expression-antibody-barcodes-to-the-seurat-object">Incorporate protein expression (antibody barcodes) to the Seurat object</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1">cbmc[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ADT"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">CreateAssayObject</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts =</span> cbmc_adt)</span></code></pre></div>
</div>
<p>The above code adds a new assay called “ADT” to the Seurat object <code>cmbc</code>. We can confirm it’s added with the following <code>GetAssayData()</code> command.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">GetAssayData</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">layer =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"counts"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">assay =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ADT"</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3 x 3 sparse Matrix of class "dgCMatrix"
    CTGTTTACACCGCTAG CTCTACGGTGTGGCTC AGCAGCCAGGCTCATT
CD3               60               52               89
CD4               72               49              112
CD8               76               59               61</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(cbmc_adt)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "CD3"    "CD4"    "CD8"    "CD45RA" "CD56"   "CD16"   "CD10"   "CD11c" 
 [9] "CD14"   "CD19"   "CD34"   "CCR5"   "CCR7"  </code></pre>
</div>
</div>
<p>Now we can repeat the pre-processing (normalization and scaling) steps that we typically run with RNA, but modifying the ‘assay’ argument.</p>
<p>(For CITE-seq data, the Broad does not recommend typical Log-normalization. Instead, they use a centered log-ratio (CLR) normalization, computed independently for each feature. This is a slightly improved procedure from the original publication.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1">cbmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">NormalizeData</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">assay =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ADT"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalization.method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CLR"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Normalizing across features</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1">cbmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ScaleData</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">assay =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ADT"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Centering and scaling data matrix</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DefaultAssay</span>(cbmc) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span></span></code></pre></div>
</div>
<section id="visualize-protein-levels-on-rna-clusters" class="level3">
<h3 class="anchored" data-anchor-id="visualize-protein-levels-on-rna-clusters">Visualize protein levels on RNA clusters</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FeaturePlot</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">features =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD11c"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD8"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD16"</span>,</span>
<span id="cb48-2">                               <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3E"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ITGAX"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FCGR3A"</span>),</span>
<span id="cb48-3">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.cutoff =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"q05"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.cutoff =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"q95"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-adv-rna-tsne-a" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-adv-rna-tsne-a-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC_files/figure-html/fig-adv-rna-tsne-a-1.png" class="img-fluid figure-img" width="1344">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-adv-rna-tsne-a-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Set I: Juxtaposed heat map of cell-surface antibody-derived signal (top row) versus mRNA-seq (bottom row) of correspoding proteins and their mRNAs
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compare gene and protein expression levels for the other 6 antibodies.</span></span>
<span id="cb49-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FeaturePlot</span>(cbmc,</span>
<span id="cb49-3">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">features =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD45RA"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD56"</span>,</span>
<span id="cb49-4">                         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD14"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD19"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD34"</span>,</span>
<span id="cb49-5">                         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PTPRC"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NCAM1"</span>,</span>
<span id="cb49-6">                         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD14"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD19"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD34"</span>),</span>
<span id="cb49-7">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.cutoff =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"q05"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.cutoff =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"q95"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-adv-rna-tsne-b" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-adv-rna-tsne-b-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC_files/figure-html/fig-adv-rna-tsne-b-1.png" class="img-fluid figure-img" width="1728">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-adv-rna-tsne-b-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Set II: Juxtaposed heat map of cell-surface antibody-derived signal (top row) versus mRNA-seq (bottom row) of correspoding proteins and their mRNAs
</figcaption>
</figure>
</div>
</div>
</div>
<p>As we can see from the above figures Figure&nbsp;3 and Figure&nbsp;4, in some cases, the same clusters / tSNE neighborhoods have high correspondence for the mRNA and the cell surface protein (<em>e.g.</em> CD3, CD4), but the penetrance (proportion of the cells) showing both antibody and mRNA feature may not be 100%; in other cases, some clusters expressing the cell-surface marker do not show much mRNA level (<em>e.g.</em> CD11, CD56, CD19, CD34), and vice-versa (<em>e.g.</em> CD45RA).</p>
<p>These side-by-side comparison illustrate the strength of the evidence added to the experiment by analyzing for both mRNA and protein.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RidgePlot</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">features =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD11c"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD8"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD16"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-adv-rna-joy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-adv-rna-joy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC_files/figure-html/fig-adv-rna-joy-1.png" class="img-fluid figure-img" width="720">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-adv-rna-joy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Stacked density plots showing this distribution of antibody-derived tag (ADT) signal in each scRNA-seq cell class for four cell-sirface markers: CD3, CD11c, CD8, and CD16.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="why-may-these-differences-occur" class="level3">
<h3 class="anchored" data-anchor-id="why-may-these-differences-occur">Why may these differences occur?</h3>
<p>One reason the “levels” between protein and mRNA could differ is that one of them is samples a very low count, and the normalization is concealing that fact.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1">norm_joy_plot_cd3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RidgePlot</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">features =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_CD3E"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb51-2">  patchwork<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_annotation</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Normalized expression levels"</span>)</span>
<span id="cb51-3">count_joy_plot_cd3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RidgePlot</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">features =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_CD3E"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">layer =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"counts"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb51-4">  patchwork<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_annotation</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Un-normalized NGS counts"</span>)</span>
<span id="cb51-5"></span>
<span id="cb51-6">patchwork_plot_cd3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm_joy_plot_cd3 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> count_joy_plot_cd3</span>
<span id="cb51-7"></span>
<span id="cb51-8">(patchwork_plot_cd3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> patchwork_plot_cd3 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb51-9">  patchwork<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_annotation</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Comparison of normalized and count data"</span>,</span>
<span id="cb51-10">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tag_levels =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb51-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb51-12">  )</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-norm-count-compare" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-norm-count-compare-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC_files/figure-html/fig-norm-count-compare-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-norm-count-compare-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: One gene, CD3, displayed as either antibody-derived tags (left side) or mRNA (right side), with x-axis in units of normalized expression (top half) or raw, un-normalized counts (bottom) for all cell classes.
</figcaption>
</figure>
</div>
</div>
</div>
<p>As Figure&nbsp;6 shows, the raw counts (which are UMI-collapsed) of the antibody-derived tags has a very large dynamic range with large values (around 1000 to 2000 counts) for positive cells, whereas the mRNA raw counts shows discretization close to 0, with the plurality of cells in each classification having 0 counts, followed by 1, then 2, then 3… counts. This shows that a low number of mRNA molecules either present in the cells (or incorporated into the single cell NGS library) is limiting the <em>sensitivity</em> of the scRNA-seq method at identifying key transcripts in the cells; ADTs have far less of this problem, where there is a large difference (from ~ 0 to about 1000 counts) between negative and positive cells, suggesting the antibody method is less susceptible to Poisson / binomial sampling noise and uncertainty.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FeatureScatter</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature1 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD19"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature2 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD3"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pt.size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shuffle =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-cd3-cd19-cor" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cd3-cd19-cor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC_files/figure-html/fig-cd3-cd19-cor-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cd3-cd19-cor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Scatter plot showing the correlation (in title) of CD3 vs CD19 antibody-derived tag (ADT) signal across ovserved cells.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Figure&nbsp;7 shows that CD3 and CD19 are poorly correlated, with CD19 displaying high antibody signal in B cells, and CD3 showing higher signals in the T-cell classes (memory CD4+ T cells, naive CD4 T cells, and some T cell - monocyte doublets). This scatter plot of ADTs could function similarly to a flow plot, complete with gates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1">patchwork_cor_plots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (</span>
<span id="cb53-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FeatureScatter</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature1 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD3"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature2 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_CD3E"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pt.size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shuffle =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">combine =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span></span>
<span id="cb53-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FeatureScatter</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slot =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"counts"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature1 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD3"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature2 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_CD3E"</span>,</span>
<span id="cb53-4">                                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pt.size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">jitter =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">combine =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb53-5">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (</span>
<span id="cb53-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FeatureScatter</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature1 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD4"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature2 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_CD4"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pt.size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shuffle =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">combine =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span></span>
<span id="cb53-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FeatureScatter</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slot =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"counts"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature1 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD4"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature2 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_CD4"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pt.size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">jitter =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">combine =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb53-8">    )</span>
<span id="cb53-9">(patchwork_cor_plots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> patchwork_cor_plots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb53-10">    patchwork<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_annotation</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Comparison of normalized and count data in scatter plot with correlation"</span>,</span>
<span id="cb53-11">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tag_levels =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb53-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_layout</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guides =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"collect"</span>))</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-cd3-cd4-cor" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cd3-cd4-cor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC_files/figure-html/fig-cd3-cd4-cor-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cd3-cd4-cor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Scatter plot showing the correlation (in title) of ADT to mRNA expression for CD3 and CD4 using both normalized data and direct count data
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="t-cell-analysis" class="level3">
<h3 class="anchored" data-anchor-id="t-cell-analysis">T-cell analysis</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1">tcells <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">idents =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Naive CD4 T"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Memory CD4 T"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8 T"</span>))</span>
<span id="cb54-2"></span>
<span id="cb54-3">(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FeatureScatter</span>(tcells, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature1 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD4"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature2 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD8"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb54-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FeatureScatter</span>(tcells, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature1 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD4"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature2 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD8"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slot =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"counts"</span>) ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb54-5">  patchwork<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_annotation</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Comparison of normalized and count data"</span>,</span>
<span id="cb54-6">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tag_levels =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb54-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_layout</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guides =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"collect"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-cd4-cd8-adt-scatters" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cd4-cd8-adt-scatters-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC_files/figure-html/fig-cd4-cd8-adt-scatters-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cd4-cd8-adt-scatters-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Scatter plot of antibody-derived tags (ADT) for CD4 and CD8 receptors, with normalized data in (a) and raw counts in (b)
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(tcells, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subset =</span> adt_CD4 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> adt_CD8 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(tcells)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.009978833</code></pre>
</div>
</div>
<p>In Figure&nbsp;9, the pearson correlation of CD4 and CD8 antibody CITE-seq signal is -0.79, indicating these are signals are significantly anti-correlated, which is consistent with the immunology of T cells vs B cells. While the normalized data (a) look pretty separate / disjoint, the count data (b) are even more orthogonal, though there is less space separating the clusters in b than in a.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1">(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FeatureScatter</span>(tcells, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature1 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_CD4"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature2 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_CD8A"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">jitter =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb57-2">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FeatureScatter</span>(tcells, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature1 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_CD4"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature2 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_CD8A"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slot =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"counts"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">jitter =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-3">    patchwork<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_annotation</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Comparison of normalized (a) and count data (b) of mRNA expression"</span>,</span>
<span id="cb57-4">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tag_levels =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb57-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_layout</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guides =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"collect"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-cd4-cd8-rna-scatters" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cd4-cd8-rna-scatters-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC_files/figure-html/fig-cd4-cd8-rna-scatters-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cd4-cd8-rna-scatters-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Scatter plot of mRNA expression for CD4 and CD8, with normalized data in (a) and raw counts in (b)
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(tcells, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subset =</span> rna_CD4 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> rna_CD8A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(tcells)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8285455</code></pre>
</div>
</div>
<p>The above plot Figure&nbsp;10 shows the weakness of attempting to classify immune cells by rarely-expressed mRNAs alone (despite the corresponding gene product being definitional to the cell class) when measured by RNA expression; As high as 83% of the T-cells are double-negative for CD4 and CD8.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DefaultAssay</span>(tcells) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ADT"</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># work with ADT count matrix</span></span>
<span id="cb60-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FeatureScatter</span>(tcells, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature1 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD4"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature2 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_CD8"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(tcells, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subset =</span> adt_CD4 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> adt_CD8 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(tcells)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.009978833</code></pre>
</div>
</div>
<p>However, for surface antigen detection in CITE-seq, only 0.997% are double negative for CD4 protein and CD8 protein.</p>
</section>
</section>
<section id="differential-protein-levels-between-clusters" class="level2">
<h2 class="anchored" data-anchor-id="differential-protein-levels-between-clusters">Differential protein levels between clusters</h2>
<p>Here, I sample 300 cells per cluster to enhance visualization.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1">cbmc_subset <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">downsample =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb63-2"></span>
<span id="cb63-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find protein markers for all clusters, and draw a heatmap</span></span>
<span id="cb63-4">adt_markers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindAllMarkers</span>(cbmc_subset, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">assay =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ADT"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">only.pos =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster Memory CD4 T</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster CD14+ Mono</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster Naive CD4 T</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster NK</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster Mouse</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster B</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster CD8 T</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster CD16+ Mono</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster T/Mono doublets</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster CD34+</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster Multiplets</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster Eryth</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in FindMarkers.default(object = data.use, cells.1 = cells.1, cells.2 =
cells.2, : No features pass logfc.threshold threshold; returning empty
data.frame</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster Mk</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster DC</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster pDCs</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DoHeatmap</span>(cbmc_subset,</span>
<span id="cb80-2">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">features =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(adt_markers<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gene),</span>
<span id="cb80-3">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">assay =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ADT"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb80-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb80-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>),</span>
<span id="cb80-6">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The unknown cells co-express both myeloid and lymphoid markers (true at the RNA level as well). They are likely cell clumps / multiplets that should be discarded.</p>
<section id="cluster-directly-on-protein-levels" class="level3">
<h3 class="anchored" data-anchor-id="cluster-directly-on-protein-levels">Cluster directly on protein levels</h3>
<p>Keeping human cells only:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1">cbmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">idents =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Multiplets"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mouse"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">invert =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DefaultAssay</span>(cbmc) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ADT"</span></span>
<span id="cb82-2">cbmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb82-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RunPCA</span>(cbmc,</span>
<span id="cb82-4">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">features =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(cbmc),</span>
<span id="cb82-5">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reduction.name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pca_adt"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reduction.key =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pcaadt_"</span>,</span>
<span id="cb82-6">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in irlba(A = t(x = object), nv = npcs, ...): You're computing too large
a percentage of total singular values, use a standard svd instead.</code></pre>
</div>
</div>
<p>I’m using <code>reduction.name</code> and <code>reduction.key</code>, because this is the second PCA being run on this multi-modal Seurat object, and I don’t want the names to collide with the scRNA-seq PCA.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DimPlot</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reduction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pca_adt"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb85" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ElbowPlot</span>(cbmc)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb86" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1">adt_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">GetAssayData</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">layer =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>)</span>
<span id="cb86-2">adt_dist <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(adt_data))</span>
<span id="cb86-3"></span>
<span id="cb86-4">cbmc[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rnaClusterID"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Idents</span>(cbmc)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb87" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1">cbmc[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tsne_adt"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RunTSNE</span>(adt_dist, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">assay =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ADT"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reduction.key =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adtTSNE_"</span>)</span>
<span id="cb87-2">cbmc[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_snn"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindNeighbors</span>(adt_dist)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>snn</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Building SNN based on a provided distance matrix</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing SNN</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb90" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1">cbmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindClusters</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resolution =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">graph.name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adt_snn"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck

Number of nodes: 7891
Number of edges: 274115

Running Louvain algorithm...
Maximum modularity in 10 random starts: 0.9482
Number of communities: 12
Elapsed time: 0 seconds</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Adding a command log without an assay associated with it</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb93" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1">( clustering_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Idents</span>(cbmc), cbmc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rnaClusterID) )</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    
     Memory CD4 T CD14+ Mono Naive CD4 T   NK    B CD8 T CD16+ Mono
  0          1416          0        1071    3    0    18          0
  1             1       2198           0    5    0     0         36
  2             6          0           3  887    2    10          0
  3           273          0         194   26    0     6          0
  4             0          4           0    3  313     0          1
  5            23          0          18    4    1   247          0
  6             1         23           3  153    2     2          9
  7             3         59           4    0    0     0          9
  8             0          7           0    4    0     0        175
  9             3          4           0    1    0     1          0
  10            0          0           1    0    0     0          0
  11            1          0           2    0   24     0          0
    
     T/Mono doublets CD34+ Eryth   Mk   DC pDCs
  0                3    45     2    8    0    1
  1                3     0     3   24   55    1
  2                0    45     2    7    2    1
  3                2     7     4   16    1    1
  4                7     2     0    3    0    0
  5                0    10     0    2    0    0
  6               59     7     1    9    6    2
  7              118     2     0    1    0    0
  8                0     0     0    1    0    0
  9                2     5    92   17    5    1
  10               0     0     0    0    1   42
  11               3     0     0    0    0    0</code></pre>
</div>
</div>
<!-- ```{r} -->
<!-- # new_cluster_ids <- c("CD4 T", "CD14+ Mono", "NK", "B", -->
<!-- #                      "CD8 T", "NK", "CD34+", "T/Mono doublets", -->
<!-- #                      "CD16+ Mono", "pDCs", "B") -->
<!-- ``` -->
<div class="cell">
<div class="sourceCode cell-code" id="cb95" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1">new_cluster_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(cbmc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rnaClusterID))</span>
<span id="cb95-2"></span>
<span id="cb95-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(new_cluster_ids) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(cbmc)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb96" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(cbmc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rnaClusterID))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Memory CD4 T"    "CD14+ Mono"      "Naive CD4 T"     "NK"             
 [5] "B"               "CD8 T"           "CD16+ Mono"      "T/Mono doublets"
 [9] "CD34+"           "Eryth"           "Mk"              "DC"             
[13] "pDCs"           </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb98" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(new_cluster_ids)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "0"  "1"  "2"  "3"  "4"  "5"  "6"  "7"  "8"  "9"  "10" "11" NA  </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb100" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(cbmc)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "0"  "1"  "2"  "3"  "4"  "5"  "6"  "7"  "8"  "9"  "10" "11"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb102" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1">cbmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RenameIdents</span>(cbmc, new_cluster_ids)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Cannot find identity NA</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb104" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1">tsne_rnaClusters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DimPlot</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reduction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tsne_adt"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group.by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rnaClusterID"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pt.size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb104-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">NoLegend</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb104-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Classification based on scRNA-seq"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb104-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>))</span>
<span id="cb104-5"></span>
<span id="cb104-6">tsne_rnaClusters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">LabelClusters</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot =</span> tsne_rnaClusters, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rnaClusterID"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb104-7"></span>
<span id="cb104-8">tsne_adtClusters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DimPlot</span>(cbmc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reduction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tsne_adt"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pt.size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb104-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">NoLegend</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb104-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Classification based on ADT signal"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb104-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>))</span>
<span id="cb104-12"></span>
<span id="cb104-13">tsne_adtClusters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">LabelClusters</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot =</span> tsne_adtClusters, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ident"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb104-14"></span>
<span id="cb104-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Note: for this comparison, both the RNA and protein clustering are visualized on a tSNE</span></span>
<span id="cb104-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># generated using the ADT distance matrix.</span></span>
<span id="cb104-17">( tsne_rna_adtClusters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> patchwork<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wrap_plots</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(tsne_rnaClusters, tsne_adtClusters), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb104-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_annotation</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tag_levels =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'a'</span>) )</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-pairedtSNE" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-pairedtSNE-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC_files/figure-html/fig-pairedtSNE-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pairedtSNE-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Juxtaposed tSNE plots of ADT (antibody) signal, colored and labeled by the data source indicated in the title (classification based on scRNA-seq in a; classification based on ADT signal in b).
</figcaption>
</figure>
</div>
</div>
</div>
<p>The tSNE clustering in Figure&nbsp;11 above is based on the distance matrix ADT (antibody) signal, whereas the coloring and cluster labels are, on the scRNA-seq data.</p>
<p>Overall, the ADT-driven clustering yields similar results. The compare / contrast conclusions are:</p>
<ul>
<li>ADT clustering improves CD4/CD8 T cell group distinction, based on the robust, high-count ADT data for CD4, CD8, CD14, and CD45RA.</li>
<li>However, ADT-based clustering is worse for the Mk/Ery/DC cell-surface markers, and scRNA-seq distinguishes these populations better.</li>
<li>Some of the clusters are likely doublets, which have low confidence classifier calls in both the scRNA-seq and ADT methods. (However, scRNA-seq could have more features for more confident doublet identification and removal.)</li>
</ul>


</section>
</section>

 ]]></description>
  <category>multi-modal analysis</category>
  <category>CITE-seq</category>
  <category>scRNA-seq</category>
  <category>code</category>
  <category>data</category>
  <guid>https://pdcherry.github.io/posts/2024_06_20-CITE-seq_analysis_PoC.html</guid>
  <pubDate>Thu, 20 Jun 2024 07:00:00 GMT</pubDate>
  <media:content url="https://pdcherry.github.io/posts/2024_06_20-CITE-seq/tsne_rna_adtClusters.png" medium="image" type="image/png" height="96" width="144"/>
</item>
<item>
  <title>emmeans: estimated marginal means</title>
  <dc:creator>Patrick Cherry</dc:creator>
  <link>https://pdcherry.github.io/posts/2024_05_19-emmeans_estimated_marginal_means.html</link>
  <description><![CDATA[ 





<!-- improved plot, added table illustrating EMM OMM differences -->
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_05_19-emmeans_estimated_marginal_means_dir/2024_05_19-emmeans_estimated_marginal_means_pigs_cc.jpg" class="img-fluid figure-img"></p>
<figcaption>The diet of pigs contributes to their rate of growth and macromolecular composition. Photo reproduced here from m_takahashi under CC BY-ND 2.0 Deed Attribution-NoDerivs 2.0 Generic</figcaption>
</figure>
</div>
<section id="introduction-to-marginal-means" class="level1">
<h1>Introduction to marginal means</h1>
<p>Estimated marginal means (EMMs, previously known as least-squares means in the context of traditional regression models) are derived by using a model to make predictions over a regular grid of predictor combinations (called a reference grid) <span class="citation" data-cites="Searle1980">(S. R. Searle and Milliken 1980)</span>. Estimated marginal means have historically been used commonly in agricultural science publications. <a href="https://stat.uiowa.edu/people/russell-v-lenth">Russ Lenth</a> authored the <code>emmeans</code> package (distributed <a href="https://cran.r-project.org/web/packages/emmeans/">on CRAN</a>) to be an implementation of the “least-squares” means (which Lenth prefers to call “marginal means” for the reasons discussed below) in R.</p>
<p>As Searle, <em>et al.</em> write, there is a <strong>marginal mean</strong> for every variable (and every level of factor variables) in a data set, and a sufficiently defined model (be it a linear model (<code>lm</code>), <code>glm</code>, <code>lmer</code>, or <code>glmer</code> <em>etc</em>.) will allow for those marginal means to be estimated.</p>
<section id="ceteris-paribus" class="level3">
<h3 class="anchored" data-anchor-id="ceteris-paribus"><em>Ceteris paribus</em></h3>
<p>But I just used “marginal” in the definition of “estimated marginal means.” So what does marginal signify? To distill it down, a marginal mean is the effect size that a particular variable contributes, <em>all else being equal</em>. (The all else being equal part comes from accounting for all other <em>significant</em> effects in the model.)</p>
<p>There are many advantages to using estimated marginal means to arrive at effect sizes (as well as confidence intervals) for a multi-factor / multi-level <em>experiment</em>.</p>
<ol type="1">
<li>One challenge where EMMs provide real advantage is when the number of subjects / samples per condition are not all the same or close to the same; this situation is called an “unbalanced experiment,” and it occurs often during large <a href="../posts/2024_04_05-DoE_design_of_experiment.html">Designs of Experiment (DoEs)</a>, either intentionally by design, or unintentionally due to experimental sample drop outs. EMMs can provide accurate estimates of means and standard errors (confidence intervals) for conditions that differ in sample size, such that, all else equal, conditions with a smaller <em>n</em> have wider confidence intervals.</li>
<li>Another advantage is when there is a hypothesized (or evident) interaction effect in either the mean or the spread of one or more conditions in the experiment. EMMs can estimate accurate relative effects and standard errors (confidence intervals) for each of those interactions.</li>
</ol>
</section>
<section id="note-on-using-emms-for-experiments" class="level3">
<h3 class="anchored" data-anchor-id="note-on-using-emms-for-experiments">Note on using EMMs for <em>experiments</em></h3>
<div id="EMMs-for-experiments" class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
EMMs are best used on data obtained from controlled experiments.
</div>
</div>
<div class="callout-body-container callout-body">
<p>EMMs are less applicable to observational data.</p>
</div>
</div>
<p>A <em><a href="https://en.wikipedia.org/wiki/Ceteris_paribus">ceteris paribus</a></em> (all else being equal) assumption is often critical to drawing scientific conclusions, because scientists seek to infer cause by ruling out all other possible influences. The “else” in “all else equal” distills both:</p>
<ol type="1">
<li><strong>the scientific idea of a controlled experiment</strong>, wherein variables being tested are altered precisely and systematically, and variables <em>not</em> being tested are held constant for all samples in the experiment;</li>
<li>and <strong>the statistical idea of marginal</strong>, which is the relative change from an arbitrary starting point. Marginal statistics show what change or influence can be expected if we know one variable is changing—but know no other information about the condition.</li>
</ol>
<p>Thus, a marginal effect, or a marginal mean, is a <em>causal</em> statement that says, on the margin (all else being equal), if a variable changes in this way, the average response <em>due to that one change</em> is this much <span class="citation" data-cites="hernan2010causal">(Hernán and Robins 2010)</span>.</p>
</section>
</section>
<section id="the-pigs-dataset" class="level1">
<h1>The pigs dataset</h1>
<p>Consider the pigs dataset provided with the package (<code>help("pigs")</code> provides details). These data come from an experiment where pigs are given different percentages of protein (percent) from different sources (source) in their diet, and later the concentration (conc) of free plasma leucine, in mcg/mL, was measured. (Observations 7, 22, 23, 31, 33, and 35 have been omitted, creating a more notable imbalance. <span class="citation" data-cites="oehlert2010first">(Oehlert 2010)</span>) The percent values are quantitative, but the experimenter chose those particular values deliberately (like a DoE), and (at least initially) the experimenter wants separate estimates at each percent level; that is, in this case, percent is a factor, not a quantitative predictor.</p>
<section id="initial-model-fitting" class="level2">
<h2 class="anchored" data-anchor-id="initial-model-fitting">Initial model fitting</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">suppressMessages</span>()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dplyr, ggplot2, etc.</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_light</span>())    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set default themes for ggplot in this doc to add contrast</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(broom)              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># help tidy display and compare of model summary stats</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(emmeans)            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ~~The estimated marginal means package~~</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(modelbased)         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># https://easystats.github.io/modelbased/articles/estimate_means.html</span></span></code></pre></div>
</div>
<p>Our first task is to come up with a good model. Making sure the model is appropriate for the data, experiment, and underlying scientific processes is critical to drawing valid conclusions with <code>emmeans</code>. Constructing good models is equal parts art and science, but I won’t labor too much over the details; any reader is encouraged to seek more in-depth guidance on model construction and evaluation. I will construct and view some models and settle on one of them. The key model diagnostics I will keep an eye on are:</p>
<ul>
<li>AIC</li>
<li>BIC</li>
<li>r-squared</li>
<li>Residuals vs Fitted (appropriate model)</li>
<li>Scale-Location (<a href="https://en.wikipedia.org/wiki/Homoscedasticity_and_heteroscedasticity">homoscedasticity</a>)</li>
<li>Residuals vs Leverage (outliers / overly-influential points)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">mod1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(conc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> source <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(percent), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> pigs)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mfrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)); <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(mod1)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_05_19-emmeans_estimated_marginal_means_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">mod2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update</span>(mod1, . <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> source <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(percent))   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># no interaction</span></span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mfrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)); <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(mod2)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_05_19-emmeans_estimated_marginal_means_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(mod1, mod2), glance, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 2%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 10%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">model</th>
<th style="text-align: right;">r.squared</th>
<th style="text-align: right;">adj.r.squared</th>
<th style="text-align: right;">sigma</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p.value</th>
<th style="text-align: right;">df</th>
<th style="text-align: right;">logLik</th>
<th style="text-align: right;">AIC</th>
<th style="text-align: right;">BIC</th>
<th style="text-align: right;">deviance</th>
<th style="text-align: right;">df.residual</th>
<th style="text-align: right;">nobs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: right;">0.8083816</td>
<td style="text-align: right;">0.6843933</td>
<td style="text-align: right;">4.716024</td>
<td style="text-align: right;">6.519819</td>
<td style="text-align: right;">0.0003417</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">-78.38304</td>
<td style="text-align: right;">182.7661</td>
<td style="text-align: right;">200.5409</td>
<td style="text-align: right;">378.0950</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">29</td>
</tr>
<tr class="even">
<td style="text-align: left;">2</td>
<td style="text-align: right;">0.6996728</td>
<td style="text-align: right;">0.6343843</td>
<td style="text-align: right;">5.075926</td>
<td style="text-align: right;">10.716628</td>
<td style="text-align: right;">0.0000207</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">-84.89886</td>
<td style="text-align: right;">183.7977</td>
<td style="text-align: right;">193.3688</td>
<td style="text-align: right;">592.5957</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">29</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>These models have R2 values of 0.808 and 0.700, and adjusted R2 values of 0.684 and 0.634. mod1 is preferable to mod2, suggesting the interaction term is needed. However, a residual-vs-predicted plot of mod2 has a classic “horn” shape (curving and fanning out), indicating a situation where a response transformation might help better than including the interaction.</p>
<p>After trial and error, it turns out that an inverse (reciprocal) transformation, (1/conc) serves really well. (Perhaps this isn’t too surprising, as concentrations are often determined by titration, in which the actual measurements are volumes of some counter-reactant; and these are reciprocally related to concentrations, i.e., amounts per unit volume.) In a real experiment, I would read the experimental protocol to verify this idea, or speak with the scientist conducting the experiment.</p>
<p>So here are three more models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">mod3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update</span>(mod1, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inverse</span>(conc) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .)</span>
<span id="cb5-2">mod4 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update</span>(mod2, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inverse</span>(conc) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># no interaction</span></span>
<span id="cb5-3">mod5 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update</span>(mod4, . <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> source <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> percent)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># continuous (non-factor) term for percent</span></span>
<span id="cb5-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mfrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)); <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(mod5)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_05_19-emmeans_estimated_marginal_means_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(mod1, mod2, mod3, mod4, mod5), glance, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 4%">
<col style="width: 8%">
<col style="width: 11%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 2%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">model</th>
<th style="text-align: right;">r.squared</th>
<th style="text-align: right;">adj.r.squared</th>
<th style="text-align: right;">sigma</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p.value</th>
<th style="text-align: right;">df</th>
<th style="text-align: right;">logLik</th>
<th style="text-align: right;">AIC</th>
<th style="text-align: right;">BIC</th>
<th style="text-align: right;">deviance</th>
<th style="text-align: right;">df.residual</th>
<th style="text-align: right;">nobs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: right;">0.8083816</td>
<td style="text-align: right;">0.6843933</td>
<td style="text-align: right;">4.7160240</td>
<td style="text-align: right;">6.519819</td>
<td style="text-align: right;">0.0003417</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">-78.38304</td>
<td style="text-align: right;">182.7661</td>
<td style="text-align: right;">200.5409</td>
<td style="text-align: right;">378.0950000</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">29</td>
</tr>
<tr class="even">
<td style="text-align: left;">2</td>
<td style="text-align: right;">0.6996728</td>
<td style="text-align: right;">0.6343843</td>
<td style="text-align: right;">5.0759265</td>
<td style="text-align: right;">10.716628</td>
<td style="text-align: right;">0.0000207</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">-84.89886</td>
<td style="text-align: right;">183.7977</td>
<td style="text-align: right;">193.3688</td>
<td style="text-align: right;">592.5956760</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">29</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: right;">0.8175928</td>
<td style="text-align: right;">0.6995647</td>
<td style="text-align: right;">0.0031259</td>
<td style="text-align: right;">6.927099</td>
<td style="text-align: right;">0.0002349</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">133.86797</td>
<td style="text-align: right;">-241.7359</td>
<td style="text-align: right;">-223.9611</td>
<td style="text-align: right;">0.0001661</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">29</td>
</tr>
<tr class="even">
<td style="text-align: left;">4</td>
<td style="text-align: right;">0.7866455</td>
<td style="text-align: right;">0.7402641</td>
<td style="text-align: right;">0.0029065</td>
<td style="text-align: right;">16.960361</td>
<td style="text-align: right;">0.0000005</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">131.59563</td>
<td style="text-align: right;">-249.1912</td>
<td style="text-align: right;">-239.6202</td>
<td style="text-align: right;">0.0001943</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">29</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: right;">0.7487292</td>
<td style="text-align: right;">0.7185767</td>
<td style="text-align: right;">0.0030254</td>
<td style="text-align: right;">24.831412</td>
<td style="text-align: right;">0.0000001</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">129.22377</td>
<td style="text-align: right;">-248.4475</td>
<td style="text-align: right;">-241.6111</td>
<td style="text-align: right;">0.0002288</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">29</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="reciprocal-fun-model" class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>I could have used <code>1/conc</code> as the response variable, but <code>emmeans</code> provides an equivalent <code>inverse()</code> function that will prove more advantageous later.</p>
</div>
</div>
<p>The residual plots for these models look a lot more like a random scatter of points (and that is good). The R^2 values for these models are 0.818, 0.787, and 0.749, respectively; and the adjusted R^2s are 0.700, 0.740, and 0.719. mod4 has the best adjusted R^2 and will be our choice.</p>
</section>
</section>
<section id="estimated-marginal-means" class="level1">
<h1>Estimated marginal means</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">(EMM.source <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">emmeans</span>(mod4, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">specs =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"source"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> source emmean       SE df lower.CL upper.CL
 fish   0.0337 0.000926 23   0.0318   0.0356
 soy    0.0257 0.000945 23   0.0237   0.0276
 skim   0.0229 0.000994 23   0.0208   0.0249

Results are averaged over the levels of: percent 
Results are given on the inverse (not the response) scale. 
Confidence level used: 0.95 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">(EMM.percent <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">emmeans</span>(mod4, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">specs =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"percent"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> percent emmean       SE df lower.CL upper.CL
       9 0.0322 0.001032 23   0.0301   0.0344
      12 0.0270 0.000969 23   0.0250   0.0290
      15 0.0263 0.001104 23   0.0240   0.0286
      18 0.0241 0.001337 23   0.0213   0.0268

Results are averaged over the levels of: source 
Results are given on the inverse (not the response) scale. 
Confidence level used: 0.95 </code></pre>
</div>
</div>
<p>Calling <code>tidy()</code> (from <code>broom</code>) on the object will put it into a beautiful data frame. And data frames can be plotted.</p>
<p>The input type can be set to <code>“response”</code>, indicating that values should be back-transformed. Note that the back-transformation is done as the last step, so all tests are conducted on the transformed scale.</p>
<p>The package <code>emmeans</code> supports <code>confint</code> (confidence intervals) and <code>test</code> (hypothesis testing) using a function parameter called <code>type</code>. The parameter <code>type</code> only has an effect if there is a known transformation or link function. The parameter value <code>"response"</code> specifies that the inverse transformation be applied, and in that case, the reported values (estimates, standard errors, confidence intervals) will be on the original response scale; otherwise, the output is on the non-linear predictor scale, as defined in the formula for the regression.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">confint</span>(EMM.percent, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response"</span>))</span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">percent</th>
<th style="text-align: right;">response</th>
<th style="text-align: right;">std.error</th>
<th style="text-align: right;">df</th>
<th style="text-align: right;">conf.low</th>
<th style="text-align: right;">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">31.01002</td>
<td style="text-align: right;">0.9926247</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">29.08415</td>
<td style="text-align: right;">33.20903</td>
</tr>
<tr class="even">
<td style="text-align: right;">12</td>
<td style="text-align: right;">37.03236</td>
<td style="text-align: right;">1.3286375</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">34.47376</td>
<td style="text-align: right;">40.00120</td>
</tr>
<tr class="odd">
<td style="text-align: right;">15</td>
<td style="text-align: right;">38.05676</td>
<td style="text-align: right;">1.5989204</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">35.01363</td>
<td style="text-align: right;">41.67922</td>
</tr>
<tr class="even">
<td style="text-align: right;">18</td>
<td style="text-align: right;">41.53107</td>
<td style="text-align: right;">2.3061140</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">37.25203</td>
<td style="text-align: right;">46.92072</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">confint</span>(EMM.percent, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> response, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> percent)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,</span>
<span id="cb12-5">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> conf.low,</span>
<span id="cb12-6">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> conf.high)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginal effect with confidence intervals"</span>,</span>
<span id="cb12-8">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response, free plasma leucine (µg/mL)"</span>,</span>
<span id="cb12-9">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"percent of source protein in diet (%)"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_05_19-emmeans_estimated_marginal_means_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">emmeans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">test</span>(EMM.percent, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">percent</th>
<th style="text-align: right;">response</th>
<th style="text-align: right;">SE</th>
<th style="text-align: right;">df</th>
<th style="text-align: right;">null</th>
<th style="text-align: right;">t.ratio</th>
<th style="text-align: right;">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">31.01002</td>
<td style="text-align: right;">0.9926247</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">31.24043</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">12</td>
<td style="text-align: right;">37.03236</td>
<td style="text-align: right;">1.3286375</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">27.87243</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">15</td>
<td style="text-align: right;">38.05676</td>
<td style="text-align: right;">1.5989204</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">23.80154</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">18</td>
<td style="text-align: right;">41.53107</td>
<td style="text-align: right;">2.3061140</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">18.00911</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<section id="comparison-to-ordinary-means" class="level2">
<h2 class="anchored" data-anchor-id="comparison-to-ordinary-means">Comparison to ordinary means</h2>
<p>Let’s compare these with the ordinary marginal means (OMMs) on inverse(conc):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with</span>(pigs, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tapply</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inverse</span>(conc), source, mean))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      fish        soy       skim 
0.03331687 0.02632333 0.02372024 </code></pre>
</div>
</div>
<p>The above code is <a href="https://www.rostrum.blog/posts/2024-05-08-aesthetic/">in the style of</a> base R <span class="citation" data-cites="Dray2024">(Dray 2024)</span>. Can I write the above ordinary means in Tidyverse/dplyr language?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">pigs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb16-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conc =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inverse</span>(conc)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb16-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(conc),</span>
<span id="cb16-4">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb16-5">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> source)</span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">source</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">fish</td>
<td style="text-align: right;">0.0333169</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="even">
<td style="text-align: left;">soy</td>
<td style="text-align: right;">0.0263233</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="odd">
<td style="text-align: left;">skim</td>
<td style="text-align: right;">0.0237202</td>
<td style="text-align: right;">9</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with</span>(pigs, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tapply</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inverse</span>(conc), percent, mean))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         9         12         15         18 
0.03146170 0.02700341 0.02602757 0.02659336 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">pigs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb19-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conc =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inverse</span>(conc)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb19-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(conc),</span>
<span id="cb19-4">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb19-5">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> percent)</span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">percent</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">0.0314617</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="even">
<td style="text-align: right;">12</td>
<td style="text-align: right;">0.0270034</td>
<td style="text-align: right;">9</td>
</tr>
<tr class="odd">
<td style="text-align: right;">15</td>
<td style="text-align: right;">0.0260276</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="even">
<td style="text-align: right;">18</td>
<td style="text-align: right;">0.0265934</td>
<td style="text-align: right;">5</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Both sets of OMMs are vaguely similar to the corresponding EMMs. However, please note that the EMMs for percent form a decreasing sequence, while the the OMMs decrease but then increase at the end.</p>
</section>
</section>
<section id="the-reference-grid-and-definition-of-emms" class="level1 page-columns page-full">
<h1>The reference grid, and definition of EMMs</h1>
<p>Estimated marginal means are defined as marginal means of model predictions over the grid comprising all factor combinations—called the reference grid. For the example at hand, the reference grid is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">emmeans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ref_grid</span>(mod4)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'emmGrid' object with variables:
    source = fish, soy, skim
    percent =  9, 12, 15, 18
Transformation: "inverse" </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">(RG <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand.grid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">source =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(pigs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>source), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">percent =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(pigs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>percent))))</span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">source</th>
<th style="text-align: left;">percent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">fish</td>
<td style="text-align: left;">9</td>
</tr>
<tr class="even">
<td style="text-align: left;">soy</td>
<td style="text-align: left;">9</td>
</tr>
<tr class="odd">
<td style="text-align: left;">skim</td>
<td style="text-align: left;">9</td>
</tr>
<tr class="even">
<td style="text-align: left;">fish</td>
<td style="text-align: left;">12</td>
</tr>
<tr class="odd">
<td style="text-align: left;">soy</td>
<td style="text-align: left;">12</td>
</tr>
<tr class="even">
<td style="text-align: left;">skim</td>
<td style="text-align: left;">12</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fish</td>
<td style="text-align: left;">15</td>
</tr>
<tr class="even">
<td style="text-align: left;">soy</td>
<td style="text-align: left;">15</td>
</tr>
<tr class="odd">
<td style="text-align: left;">skim</td>
<td style="text-align: left;">15</td>
</tr>
<tr class="even">
<td style="text-align: left;">fish</td>
<td style="text-align: left;">18</td>
</tr>
<tr class="odd">
<td style="text-align: left;">soy</td>
<td style="text-align: left;">18</td>
</tr>
<tr class="even">
<td style="text-align: left;">skim</td>
<td style="text-align: left;">18</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>To get the EMMs, I first need to obtain predictions on this grid:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1">(preds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mod4, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> RG), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]       [,2]       [,3]       [,4]
[1,] 0.03853514 0.03329091 0.03256404 0.03036586
[2,] 0.03050486 0.02526063 0.02453376 0.02233558
[3,] 0.02770292 0.02245869 0.02173182 0.01953364</code></pre>
</div>
</div>
<p>then obtain the marginal means of these predictions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(preds, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, mean)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># row means for source</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.03368899 0.02565870 0.02285677</code></pre>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p>For further reading on the family of R’s <code>apply</code> functions, see <a href="https://www.guru99.com/r-apply-sapply-tapply.html">Guru99’s great summary</a>.</p>
</div></div><div class="cell">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(preds, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, mean)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># column means for percent</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.03224764 0.02700341 0.02627654 0.02407836</code></pre>
</div>
</div>
<p>These marginal averages match the EMMs obtained earlier via <code>emmeans()</code>.</p>
<p>Now let’s go back to the comparison with the ordinary marginal means. The source levels are represented by the columns of <code>pred</code>; and note that each row of <code>pred</code> is a decreasing set of values. So it is no wonder that the marginal means—the EMMs for source—are decreasing. That the OMMs for percent do not behave this way is due to the imbalance in sample sizes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with</span>(pigs, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(source, percent));</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      percent
source 9 12 15 18
  fish 2  3  2  3
  soy  3  3  3  1
  skim 3  3  2  1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(pigs) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(RG)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.416667</code></pre>
</div>
</div>
<p><code>table</code> uses factors to build a contingency table of the counts at each combination of factor levels.</p>
<p>The mean number of samples per condition is 2.42, so any source * percent condition with greater than 2.42 has greater than average weighting in the OMM, whereas those with below 2.42 observations has below the average weighting.</p>
<p>The alarming observation that two conditions have only one observation (soy @ 18% and skim @ 18%) show that those effects, while they may be reported as “means,” are really just one observation, a situation which is more susceptible to bias.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1">emmeans<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">emmip</span>(mod4, source <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> percent, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EMM: Estimated marginal means result"</span>);</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_05_19-emmeans_estimated_marginal_means_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(pigs, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"conc"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(conc), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"percent"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"source"</span>)),</span>
<span id="cb34-2">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> conc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> percent, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> source)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb34-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OMM: Ordinary grouped means result"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_05_19-emmeans_estimated_marginal_means_files/figure-html/unnamed-chunk-22-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1">pigs_sample_n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pigs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb35-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"percent"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(percent)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb35-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(percent, source)</span>
<span id="cb35-4"></span>
<span id="cb35-5">combined_omm_emm_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pigs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb35-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"percent"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(percent)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb35-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"conc"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(conc), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"percent"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"source"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb35-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb35-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(RG,</span>
<span id="cb35-10">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inverse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mod4, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> RG, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">interval =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"confidence"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">level =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb35-11">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb35-12">                dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"conc"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> fit)</span>
<span id="cb35-13">              ),</span>
<span id="cb35-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"analysis"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb35-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"analysis"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(analysis <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OMM"</span>,</span>
<span id="cb35-16">                                analysis <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EMM"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb35-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(pigs_sample_n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"percent"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"source"</span>))</span></code></pre></div>
</div>
<p>As seen in the above code, I can also use the <code>predict()</code> function to calculate confidence intervals for the marginal means. To do this, I need to specify the <code>interval</code> argument, which can take two values: <code>"confidence"</code> and <code>"prediction"</code> <span class="citation" data-cites="Sanderson2023">(Steven P. Sanderson II 2023)</span>.</p>
<p>A confidence interval is the range of values within which we are confident that the true mean of the population will fall. A prediction interval is the range of values within which we are confident that the true value of a new observation will fall. Thus, for comparing the EMM to the OMM, a confidence interval is appropriate because we are comparing means, not individual observations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">combined_omm_emm_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> combined_omm_emm_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> conc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> percent, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> source, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> analysis)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb36-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">interaction</span>(source, analysis))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb36-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> n)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb36-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> upr, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> lwr),</span>
<span id="cb36-6">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb36-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_viridis_d</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">end =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb36-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_size_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb36-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> source) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb36-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overlay of EMM and ordinary means analysis"</span>,</span>
<span id="cb36-11">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response, free plasma leucine (µg/mL)"</span>,</span>
<span id="cb36-12">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"percent of source protein in diet (%)"</span>,</span>
<span id="cb36-13">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample n"</span>,</span>
<span id="cb36-14">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error bars are for EMMs."</span>)</span>
<span id="cb36-15">combined_omm_emm_plot</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_05_19-emmeans_estimated_marginal_means_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Overlaying the data using some custom code to tidy up the combining of both EMM and OMM data into one plottable frame shows how the ordinary marginal (<em>i.e.</em> grouped) means deviate from the Estimated Marginal Means when there are fewer individual observations (n = 1 for soy @ 18% and n = 1 for skim @ 18%, which happens to deviate the farthest). Those low-n observations are displayed as smaller dots, whereas the other conditions have 2 or 3, which get plotted as larger dots.</p>
<p>Note that where the ordinary marginal means diverge away from the estimated marginal means, the EMM confidence interval is also wide, ultimately leading to the ordinary mean being within the confidence interval. This observation shows that the model (and its predictions) are consistent with the data. These confidence intervals are not calculated when doing ordinary means analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1">combined_omm_emm_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb37-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"source"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"percent"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>),</span>
<span id="cb37-3">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"analysis"</span>,</span>
<span id="cb37-4">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"conc"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lwr"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"upr"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb37-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(.x)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb37-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EMM_CI_width"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> lwr_EMM <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> upr_EMM,</span>
<span id="cb37-7">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EMM_pct_uncertainty"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(EMM_CI_width <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> conc_EMM <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb37-8">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OMM_EMM_pct_diff"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>((conc_OMM <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> conc_EMM) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> conc_EMM <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb37-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relocate</span>(EMM_pct_uncertainty, OMM_EMM_pct_diff, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.after =</span> conc_EMM)</span></code></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 2%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 19%">
<col style="width: 16%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">source</th>
<th style="text-align: left;">percent</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">conc_OMM</th>
<th style="text-align: right;">conc_EMM</th>
<th style="text-align: right;">EMM_pct_uncertainty</th>
<th style="text-align: right;">OMM_EMM_pct_diff</th>
<th style="text-align: right;">lwr_EMM</th>
<th style="text-align: right;">upr_EMM</th>
<th style="text-align: right;">EMM_CI_width</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">fish</td>
<td style="text-align: left;">9</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">25.75000</td>
<td style="text-align: right;">25.95034</td>
<td style="text-align: right;">14.6</td>
<td style="text-align: right;">-0.8</td>
<td style="text-align: right;">27.98352</td>
<td style="text-align: right;">24.19259</td>
<td style="text-align: right;">3.790934</td>
</tr>
<tr class="even">
<td style="text-align: left;">fish</td>
<td style="text-align: left;">12</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">30.93333</td>
<td style="text-align: right;">30.03823</td>
<td style="text-align: right;">15.6</td>
<td style="text-align: right;">3.0</td>
<td style="text-align: right;">32.55836</td>
<td style="text-align: right;">27.88020</td>
<td style="text-align: right;">4.678168</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fish</td>
<td style="text-align: left;">15</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">31.15000</td>
<td style="text-align: right;">30.70872</td>
<td style="text-align: right;">17.7</td>
<td style="text-align: right;">1.4</td>
<td style="text-align: right;">33.66886</td>
<td style="text-align: right;">28.22702</td>
<td style="text-align: right;">5.441832</td>
</tr>
<tr class="even">
<td style="text-align: left;">fish</td>
<td style="text-align: left;">18</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">32.33333</td>
<td style="text-align: right;">32.93172</td>
<td style="text-align: right;">19.0</td>
<td style="text-align: right;">-1.8</td>
<td style="text-align: right;">36.35469</td>
<td style="text-align: right;">30.09786</td>
<td style="text-align: right;">6.256834</td>
</tr>
<tr class="odd">
<td style="text-align: left;">soy</td>
<td style="text-align: left;">9</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">34.63333</td>
<td style="text-align: right;">32.78166</td>
<td style="text-align: right;">17.2</td>
<td style="text-align: right;">5.6</td>
<td style="text-align: right;">35.83639</td>
<td style="text-align: right;">30.20681</td>
<td style="text-align: right;">5.629573</td>
</tr>
<tr class="even">
<td style="text-align: left;">soy</td>
<td style="text-align: left;">12</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">39.63333</td>
<td style="text-align: right;">39.58730</td>
<td style="text-align: right;">20.4</td>
<td style="text-align: right;">0.1</td>
<td style="text-align: right;">44.04318</td>
<td style="text-align: right;">35.95019</td>
<td style="text-align: right;">8.092997</td>
</tr>
<tr class="odd">
<td style="text-align: left;">soy</td>
<td style="text-align: left;">15</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">39.23333</td>
<td style="text-align: right;">40.76017</td>
<td style="text-align: right;">21.8</td>
<td style="text-align: right;">-3.7</td>
<td style="text-align: right;">45.69176</td>
<td style="text-align: right;">36.78942</td>
<td style="text-align: right;">8.902343</td>
</tr>
<tr class="even">
<td style="text-align: left;">soy</td>
<td style="text-align: left;">18</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">42.90000</td>
<td style="text-align: right;">44.77162</td>
<td style="text-align: right;">30.6</td>
<td style="text-align: right;">-4.2</td>
<td style="text-align: right;">52.64817</td>
<td style="text-align: right;">38.94515</td>
<td style="text-align: right;">13.703024</td>
</tr>
<tr class="odd">
<td style="text-align: left;">skim</td>
<td style="text-align: left;">9</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">35.40000</td>
<td style="text-align: right;">36.09727</td>
<td style="text-align: right;">19.1</td>
<td style="text-align: right;">-1.9</td>
<td style="text-align: right;">39.86363</td>
<td style="text-align: right;">32.98118</td>
<td style="text-align: right;">6.882447</td>
</tr>
<tr class="even">
<td style="text-align: left;">skim</td>
<td style="text-align: left;">12</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">43.46667</td>
<td style="text-align: right;">44.52619</td>
<td style="text-align: right;">23.3</td>
<td style="text-align: right;">-2.4</td>
<td style="text-align: right;">50.30224</td>
<td style="text-align: right;">39.94000</td>
<td style="text-align: right;">10.362244</td>
</tr>
<tr class="odd">
<td style="text-align: left;">skim</td>
<td style="text-align: left;">15</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">50.45000</td>
<td style="text-align: right;">46.01547</td>
<td style="text-align: right;">26.8</td>
<td style="text-align: right;">9.6</td>
<td style="text-align: right;">53.00407</td>
<td style="text-align: right;">40.65509</td>
<td style="text-align: right;">12.348975</td>
</tr>
<tr class="even">
<td style="text-align: left;">skim</td>
<td style="text-align: left;">18</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">59.80000</td>
<td style="text-align: right;">51.19373</td>
<td style="text-align: right;">35.6</td>
<td style="text-align: right;">16.8</td>
<td style="text-align: right;">61.88076</td>
<td style="text-align: right;">43.65446</td>
<td style="text-align: right;">18.226302</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The EMMs vs OMMs tend to differ more for smaller sample sizes (n). The confidence intervals also tend to be wider for the <code>lm</code> predictions on the lower sample size conditions in the experiment, and these tend to correlate with the difference between the OMM (ordinary marginal mean) and the EMM (estimated marginal mean), as the table above shows.</p>
<p>EMMs worked well for us. The application of a linear model (and a linearizing transformation of the response scale) allows for the balanced <em>reference grid</em> to get balanced estimated means for each effect. This process produced more balanced estimated means than the ordinary means taken from the grouped-by factor levels.</p>
<p>Given the good fit of the model, I would trust these EMMs more than the ordinary grouped-by means. Plus, the linear model gives us confidence intervals for each estimated marginal effect, to which statistical analysis can be applied.</p>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<p>In summary, I obtained a reference grid of all factor combinations, obtained model predictions on that grid, and then I estimated the expected marginal means as equally-weighted marginal averages of those predictions. Those EMMs are not subject to confounding by other factors or biased sampling, such as might happen with ordinary marginal means of the data. Moreover, unlike OMMs, EMMs are based on a model that is well-fitted to the data.</p>
</section>
<section id="references" class="level1">
<h1>References</h1>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-Dray2024" class="csl-entry">
Dray, Matt. 2024. <span>“The Aesthetics Wiki: An r Addendum.”</span> rostrum.blog. <a href="https://www.rostrum.blog/posts/2024-05-08-aesthetic/">https://www.rostrum.blog/posts/2024-05-08-aesthetic/</a>.
</div>
<div id="ref-hernan2010causal" class="csl-entry">
Hernán, Miguel A, and James M Robins. 2010. <em>"Causal Inference: What If"</em>. Boca Raton: Chapman &amp; Hall/CRC.
</div>
<div id="ref-oehlert2010first" class="csl-entry">
Oehlert, Gary W. 2010. <em>A First Course in Design and Analysis of Experiments</em>.
</div>
<div id="ref-Searle1980" class="csl-entry">
S. R. Searle, F. M. Speed, and G. A. Milliken. 1980. <span>“Population Marginal Means in the Linear Model: An Alternative to Least Squares Means.”</span> <em>The American Statistician</em> 34 (4): 216–21. <a href="https://doi.org/10.1080/00031305.1980.10483031">https://doi.org/10.1080/00031305.1980.10483031</a>.
</div>
<div id="ref-Sanderson2023" class="csl-entry">
Steven P. Sanderson II, MPH. 2023. <span>“Unlocking the Power of Prediction Intervals in r: A Practical Guide.”</span> Steve’s Data Tips; Tricks. <a href="https://www.spsanderson.com/steveondata/posts/2023-11-13/index.html">https://www.spsanderson.com/steveondata/posts/2023-11-13/index.html</a>.
</div>
</div>


</section>

 ]]></description>
  <category>data</category>
  <category>code</category>
  <category>experimental analysis</category>
  <category>DoE</category>
  <category>unbalanced DoE</category>
  <category>causal inference</category>
  <guid>https://pdcherry.github.io/posts/2024_05_19-emmeans_estimated_marginal_means.html</guid>
  <pubDate>Sun, 19 May 2024 07:00:00 GMT</pubDate>
  <media:content url="https://pdcherry.github.io/posts/2024_05_19-emmeans_estimated_marginal_means_dir/2024_05_19-emmeans_diff_plot.png" medium="image" type="image/png" height="115" width="144"/>
</item>
<item>
  <title>DoE: Design of Experiment</title>
  <dc:creator>Patrick Cherry</dc:creator>
  <link>https://pdcherry.github.io/posts/2024_04_05-DoE_design_of_experiment.html</link>
  <description><![CDATA[ 





<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_04_05-DoE_design_of_experiment/2024_04_05-DoE_architecture_imperfect_grid.jpg" class="img-fluid figure-img"></p>
<figcaption>DoE experiments can make conclusions that are greater than the sum of its parts, through thoughtful designs. Much like an architectural facade, DoEs often employ a grid of conditions that do not perfectly sample every possible combination. Image credit: seier+seier on Flickr under CC</figcaption>
</figure>
</div>
<blockquote class="blockquote">
<p>To consult the statistician after an experiment is finished is often merely to ask him to conduct a post mortem examination. He can perhaps say what the experiment died of. — Ronald A. Fisher First Session of the Indian Statistical Conference, Calcutta, 1938 <span class="citation" data-cites="OxfordEssentialQuotations">(Ratcliffe 2018)</span></p>
</blockquote>
<section id="introduction-and-motivation" class="level2">
<h2 class="anchored" data-anchor-id="introduction-and-motivation">Introduction and motivation</h2>
<p>In this post, I describe an experimental design for generating a genomics dataset using statistical DoE principles.</p>
<p>My motivation for designing and carrying out this experiment was that I had data showing the sensitivity (by percent recall of a set of genetic variants expressed as mRNAs) over a controlled range of concentrations (made by serial dilution). <em>However, those data were only gathered with one target enrichment panel, which was a fairly esoteric TE Panel.</em> The goal was to extend the conclusions on sensitivity and recall to other, more mainstream panels used in RNA-seq experiments. We’ll call the esoteric panel “Panel A.” I had the idea that, given the success Panel A’s bioinformatic performance, <em>it could be useful to show that many different TE panels work well for an extension of said bioinformatic performance</em>, encouraging the use of those other panels by showing equal analytical performance in a head-to-head experiment.</p>
<p>To do so, I proposed using multiplexed capture (to save on wet-lab resources and time), 100 ng of input RNA (and optionally 10 ng), and technical replicates (n = 3, or a minimum of n = 2 for dropout protection). These are parameterized in this DoE script below, and the resulting sample plan is exported to google sheets for directing the lab activities a team of scientists and research associates.</p>
<section id="historical-roots-of-design-of-experiment" class="level3">
<h3 class="anchored" data-anchor-id="historical-roots-of-design-of-experiment">Historical roots of design of experiment</h3>
<p>British statistician and geneticist Ronald A. Fisher (1890-1962) heavily influenced the modern ideals of experimental design. His influential 1922 publication on maximum likelihood laid the groundwork for now widely-taught concepts of sufficiency, information, and efficiency <span class="citation" data-cites="Fisher1922">(Fisher 1922)</span>. Fisher also pioneered and developed the methods of study randomization, and he promoted principles of <em>design of experiment</em> <span class="citation" data-cites="Edwards1974">(Edwards 1974)</span>. The radical idea (at the time) was that designs could be based on varying multiple factors simultaneously, and the downstream analysis could be supported by multi-factor analysis of variance. This progress in design and analysis allowed for the testing of many variables and factors in one experiment (when designed properly) instead of many one-by-one factor comparisons.</p>
</section>
</section>
<section id="brief-intro-to-doe-concepts" class="level2">
<h2 class="anchored" data-anchor-id="brief-intro-to-doe-concepts">Brief intro to DoE concepts</h2>
<p>Below, I provide a glossary of design of experiment (DoE) concepts and their definitions. After, I describe which apply to here, and how I incorporated that concept into the design.</p>
<ul>
<li><em>Independent variable</em>: Also called treatment factor, it is a variable under study as a potential cause, and so it is controlled at or near some target value, as informed by the hypothesis. An experiment can have more than one independent variable; it is common to analyze multiple independent variables at the same time.</li>
<li><em>Background variable</em>: Also called a <em>lurking variable</em>, it is a variable that the experimenter is not aware exists or affects the outcome of the experiment. Due to this lack of awareness, it is not controlled. In a well-planned experiment, lurking variables should balance out in effect so as not to impact the conclusion of the experiment.</li>
<li><em>Dependent variable</em>: Also called a <em>response variable</em>, it is the outcome or output measured from the experiment. An experiment can have multiple dependent variables, but it is more typical to analyze for one of these variables at a time.</li>
<li><em>Replicate</em>: additional runs of the same experiment (same treatment, same controls, etc.). Replicates help to understand the within-condition variability of outcomes, and decide if enough evidence is present to conclude the independent variable is <em>causing</em> a change in the response variable.</li>
<li><em>Confounded factors</em>: <em>Confounding</em> is a relationship of two or more factors to each other. Two or more factors are confounded when they are <em>auto-correlated</em> in the design—that is, when the levels / values of each factor co-occur throughout the experiment—to the exclusion of other combinations of levels of those factors. In this situation, it is impossible to provide evidence for which factor causes any observed change in the response variable. (Some analyses will emit an error or a warning when confounding or autocorrelation of independent variable occurs.)</li>
<li><em>Biased factor</em>: <em>Bias</em> in another relationship between experimental factors. Bias occurs when an experimenter makes a change to an independent variable at the precise time when changes in a lurking variable also occur. This is effectively confounding with a lurking variable, but because lurking variables are not always known or measured, the situation can go undetected, which can lead to erroneous conclusions. For this reason, it can be good to measure suspected lurking variables <em>even if they are not controlled</em> for retrospective analysis of bias.</li>
<li><em>Experimental error</em>: the difference between the measured response for a condition and the long-run average of that condition. In this definition, error is a statistical measure, and not literally a “mistake” or “inaccuracy,” as synonyms for error suggest. Experimental error is expected (to some degree) because background or lurking variables can subtly influence outcomes or measurements.</li>
<li><em>Randomization</em>: the random assignment of conditions to a particular sample of an experiment, which leads to the likely reduction of experimental error.</li>
<li><em>Blocking</em>: the spreading of all other variables as evenly as is practical over the variable in question. If a variable is suspected of being a lurking variable, it can be “blocked” in the experimental design, which spreads its bias (if any) as evenly as is practical across all other combinations of factors. This even spreading allows for a bias in the blocked variable to be detected with high precision in analysis.</li>
</ul>
<p>Experimental error is subdivided into <strong>bias error</strong> and <strong>random error</strong>:</p>
<ul>
<li><em>Bias error</em> tends to remain constant or change in a consistent pattern over time or with other variables (whether measured or not).</li>
<li><em>Random error</em> changes from one experiment to another unpredictably. However, it the long run, random error averages to zero and has a consistent probability distribution that allows us to draw conclusions.</li>
</ul>
<section id="aplying-doe-principle-to-this-experiment" class="level3">
<h3 class="anchored" data-anchor-id="aplying-doe-principle-to-this-experiment">Aplying DoE principle to this experiment</h3>
<p>Randomization is a good way to get random error to cancel out within an experiment. Any one randomized experiment that suffers (by chance) from a preponderance of random error will not replicate that random error in a repeat experiment, because the randomization will change, and likely distribute the error differently across samples. Thus, randomization is effective for preventing error from confounding experimental conclusion in the long term.</p>
<p>But what if we want to prevent error from affecting <em>this experiment</em>? If we have a hypothesized source of the bias in mind, then we can deploy a <em>randomized complete block</em> design, also known as using blocking on a variable.</p>
<p>If we have a suspected influence from a variable that we’re not testing as an independent variable, we can attempt to minimize the contribution of its effect (or bias) to the experimental conclusions.</p>
</section>
</section>
<section id="procedure" class="level2">
<h2 class="anchored" data-anchor-id="procedure">Procedure</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">panel_info <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tribble</span>(</span>
<span id="cb1-2">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>panel,  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>panel_size,  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>needed_sequencing,</span>
<span id="cb1-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE Panel A"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,</span>
<span id="cb1-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE Panel B"</span>,  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">36.8</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,</span>
<span id="cb1-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE Panel C"</span>,  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">35.8</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,</span>
<span id="cb1-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Whole Transcriptome"</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span></code></pre></div>
</div>
</section>
<section id="doe-with-blocking-for-multiple-operators" class="level2">
<h2 class="anchored" data-anchor-id="doe-with-blocking-for-multiple-operators">DoE with blocking for multiple operators</h2>
<p>I will block for the operators carrying out library prep, because operator is a known source of variation that is not relevant to understanding the effect of TE panel, RNA input mass, or concentration on performance. (For example, my direct report is better at target enrichment than I am—she gets better fold-80 scores and off-target percentages than me routinely. But we’re here to study <em>the panels</em>, not the operators, and we need to share the work.)</p>
<p>Blocking is the non-random assignment of samples to groups to minimize differences in the sample composition between the groups such that any effect of the grouping can be determined by the model and ignored (modeled out quantitatively and precisely).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">panels <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE Panel A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE Panel V"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE Panel C"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Whole Transcriptome"</span>))</span>
<span id="cb2-2">concentrations <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">027</span>, .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0027</span>, .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">00027</span>, .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">000027</span>, .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0000027</span>))</span>
<span id="cb2-3">mass_inputs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>))</span>
<span id="cb2-4"></span>
<span id="cb2-5">vec_levels_for_variables <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(panels, concentrations, mass_inputs)</span>
<span id="cb2-6"></span>
<span id="cb2-7">rna_TE_sensitivity_doe <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gen.factorial</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nVars =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">factors =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb2-8">                                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">varNames =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"panel"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"conc"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mass_input"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(., ., .) </span>
<span id="cb2-10"></span>
<span id="cb2-11">rna_TE_sensitivity_doe</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["panel"],"name":[1],"type":["fct"],"align":["left"]},{"label":["conc"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["mass_input"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"1","2":"-2","3":"-1"},{"1":"2","2":"-2","3":"-1"},{"1":"3","2":"-2","3":"-1"},{"1":"4","2":"-2","3":"-1"},{"1":"1","2":"-1","3":"-1"},{"1":"2","2":"-1","3":"-1"},{"1":"3","2":"-1","3":"-1"},{"1":"4","2":"-1","3":"-1"},{"1":"1","2":"0","3":"-1"},{"1":"2","2":"0","3":"-1"},{"1":"3","2":"0","3":"-1"},{"1":"4","2":"0","3":"-1"},{"1":"1","2":"1","3":"-1"},{"1":"2","2":"1","3":"-1"},{"1":"3","2":"1","3":"-1"},{"1":"4","2":"1","3":"-1"},{"1":"1","2":"2","3":"-1"},{"1":"2","2":"2","3":"-1"},{"1":"3","2":"2","3":"-1"},{"1":"4","2":"2","3":"-1"},{"1":"1","2":"-2","3":"1"},{"1":"2","2":"-2","3":"1"},{"1":"3","2":"-2","3":"1"},{"1":"4","2":"-2","3":"1"},{"1":"1","2":"-1","3":"1"},{"1":"2","2":"-1","3":"1"},{"1":"3","2":"-1","3":"1"},{"1":"4","2":"-1","3":"1"},{"1":"1","2":"0","3":"1"},{"1":"2","2":"0","3":"1"},{"1":"3","2":"0","3":"1"},{"1":"4","2":"0","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"2","2":"1","3":"1"},{"1":"3","2":"1","3":"1"},{"1":"4","2":"1","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"2","2":"2","3":"1"},{"1":"3","2":"2","3":"1"},{"1":"4","2":"2","3":"1"},{"1":"1","2":"-2","3":"-1"},{"1":"2","2":"-2","3":"-1"},{"1":"3","2":"-2","3":"-1"},{"1":"4","2":"-2","3":"-1"},{"1":"1","2":"-1","3":"-1"},{"1":"2","2":"-1","3":"-1"},{"1":"3","2":"-1","3":"-1"},{"1":"4","2":"-1","3":"-1"},{"1":"1","2":"0","3":"-1"},{"1":"2","2":"0","3":"-1"},{"1":"3","2":"0","3":"-1"},{"1":"4","2":"0","3":"-1"},{"1":"1","2":"1","3":"-1"},{"1":"2","2":"1","3":"-1"},{"1":"3","2":"1","3":"-1"},{"1":"4","2":"1","3":"-1"},{"1":"1","2":"2","3":"-1"},{"1":"2","2":"2","3":"-1"},{"1":"3","2":"2","3":"-1"},{"1":"4","2":"2","3":"-1"},{"1":"1","2":"-2","3":"1"},{"1":"2","2":"-2","3":"1"},{"1":"3","2":"-2","3":"1"},{"1":"4","2":"-2","3":"1"},{"1":"1","2":"-1","3":"1"},{"1":"2","2":"-1","3":"1"},{"1":"3","2":"-1","3":"1"},{"1":"4","2":"-1","3":"1"},{"1":"1","2":"0","3":"1"},{"1":"2","2":"0","3":"1"},{"1":"3","2":"0","3":"1"},{"1":"4","2":"0","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"2","2":"1","3":"1"},{"1":"3","2":"1","3":"1"},{"1":"4","2":"1","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"2","2":"2","3":"1"},{"1":"3","2":"2","3":"1"},{"1":"4","2":"2","3":"1"},{"1":"1","2":"-2","3":"-1"},{"1":"2","2":"-2","3":"-1"},{"1":"3","2":"-2","3":"-1"},{"1":"4","2":"-2","3":"-1"},{"1":"1","2":"-1","3":"-1"},{"1":"2","2":"-1","3":"-1"},{"1":"3","2":"-1","3":"-1"},{"1":"4","2":"-1","3":"-1"},{"1":"1","2":"0","3":"-1"},{"1":"2","2":"0","3":"-1"},{"1":"3","2":"0","3":"-1"},{"1":"4","2":"0","3":"-1"},{"1":"1","2":"1","3":"-1"},{"1":"2","2":"1","3":"-1"},{"1":"3","2":"1","3":"-1"},{"1":"4","2":"1","3":"-1"},{"1":"1","2":"2","3":"-1"},{"1":"2","2":"2","3":"-1"},{"1":"3","2":"2","3":"-1"},{"1":"4","2":"2","3":"-1"},{"1":"1","2":"-2","3":"1"},{"1":"2","2":"-2","3":"1"},{"1":"3","2":"-2","3":"1"},{"1":"4","2":"-2","3":"1"},{"1":"1","2":"-1","3":"1"},{"1":"2","2":"-1","3":"1"},{"1":"3","2":"-1","3":"1"},{"1":"4","2":"-1","3":"1"},{"1":"1","2":"0","3":"1"},{"1":"2","2":"0","3":"1"},{"1":"3","2":"0","3":"1"},{"1":"4","2":"0","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"2","2":"1","3":"1"},{"1":"3","2":"1","3":"1"},{"1":"4","2":"1","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"2","2":"2","3":"1"},{"1":"3","2":"2","3":"1"},{"1":"4","2":"2","3":"1"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">rna_TE_sensitivity_doe <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> AlgDesign<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optBlock</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">frml =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> conc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> panel <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mass_input,</span>
<span id="cb3-2">                                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">withinData =</span> rna_TE_sensitivity_doe,</span>
<span id="cb3-3">                                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">blocksizes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nRepeats =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
</div>
<p>The <code>optBlock</code> function from the <code>AlgDesign</code> package is maximizing <img src="https://latex.codecogs.com/png.latex?%7CX'X%7C">, the determinant of the product of the inverse of the design matrix and the design matrix, a process called <em>D-optimization</em>. (The D criterion minimizes the overall variance of the estimates during analysis.) <span class="citation" data-cites="Donev1988">(Donev and Atkinson 1988)</span> Further explanation is beyond the scope of this tutorial, but is available in copious detail in the documentation of the <code>AlgDesign</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">rna_TE_sensitivity_doe<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>D;</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3789291</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">rna_TE_sensitivity_doe<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>diagonality</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.871</code></pre>
</div>
</div>
<p>Diagonality is the degree to which the blocked variables are uncorrelated: a diagonality of 1.0 is perfectly uncorrelated. A value of 0.871 is moderate. We are getting values less than 1.0, because not every number of unique sample ( 2 * 4 * <del>5</del> ) factors to be processed is divisible by the number of blocking groups. We will see this effect illustrated in the “Check orthogonality of blocking” section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">rna_TE__blocking_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(rna_TE_sensitivity_doe<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Blocks),</span>
<span id="cb8-2">                        <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> rna_TE_sensitivity_doe<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Blocks[[.x]]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"operator"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"operator"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> LETTERS[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(operator)],</span>
<span id="cb8-6">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"operator"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Operator"</span>, operator)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(panel, conc, mass_input)</span></code></pre></div>
</div>
<p>Above, for each block, we bind the rows together into one data frame, converting the block names to the intended use, which is specifying which operator is working. Then arrange the data by panel name, concentration, and mass input.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">(panels_to_join <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rna_TE__blocking_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(panel) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-3">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(panel_info, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"panel_name"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)))</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["panel"],"name":[1],"type":["fct"],"align":["left"]},{"label":["panel_name"],"name":[2],"type":["chr"],"align":["left"]},{"label":["panel_size"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["needed_sequencing"],"name":[4],"type":["lgl"],"align":["right"]}],"data":[{"1":"1","2":"TE Panel A","3":"3.0","4":"NA"},{"1":"2","2":"TE Panel B","3":"36.8","4":"NA"},{"1":"3","2":"TE Panel C","3":"35.8","4":"NA"},{"1":"4","2":"Whole Transcriptome","3":"NA","4":"NA"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Above, we prepare the panel info for joining.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">(fusconcs_to_join <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rna_TE__blocking_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(conc) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(concentrations) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"concentrations"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["conc"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["concentrations"],"name":[2],"type":["fct"],"align":["left"]}],"data":[{"1":"-2","2":"0.027"},{"1":"-1","2":"0.0027"},{"1":"0","2":"0.00027"},{"1":"1","2":"2.7e-05"},{"1":"2","2":"2.7e-06"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>As well as preparing the concentration info for joining.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">(massinput_to_join <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rna_TE__blocking_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(mass_input) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(mass_inputs) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mass_inputs"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["mass_input"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["mass_inputs"],"name":[2],"type":["fct"],"align":["left"]}],"data":[{"1":"-1","2":"10"},{"1":"1","2":"100"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>And lastly prepare the mass input levels for joining.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">rna_TE__doe_blocked <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rna_TE__blocking_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(panels_to_join, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"panel"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(fusconcs_to_join, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"conc"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(massinput_to_join, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mass_input"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"panel"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"panel_name"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"conc"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"concentrations"</span>,</span>
<span id="cb12-6">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mass_input"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mass_inputs"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"operator"</span>, panel_size, needed_sequencing) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(panel, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(conc), mass_input) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"replicate_num"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(panel, conc, mass_input)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relocate</span>(replicate_num, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.after =</span> operator) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LP_operator"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"operator"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(panel, mass_input) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># below, assign samples to captures in plexity of up to 6</span></span>
<span id="cb12-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the table is sorted in order of panel and mass input, so most of the time,</span></span>
<span id="cb12-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># samples will be paired with other samples with the same mass input, which is</span></span>
<span id="cb12-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># best practice.</span></span>
<span id="cb12-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"capture"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ceiling</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relocate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"capture"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.after =</span> replicate_num) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(panel, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(conc), mass_input)</span>
<span id="cb12-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(rna_TE__doe_blocked, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["panel"],"name":[1],"type":["chr"],"align":["left"]},{"label":["conc"],"name":[2],"type":["fct"],"align":["left"]},{"label":["mass_input"],"name":[3],"type":["fct"],"align":["left"]},{"label":["LP_operator"],"name":[4],"type":["chr"],"align":["left"]},{"label":["replicate_num"],"name":[5],"type":["int"],"align":["right"]},{"label":["capture"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["panel_size"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["needed_sequencing"],"name":[8],"type":["lgl"],"align":["right"]}],"data":[{"1":"TE Panel A","2":"0.027","3":"10","4":"Operator A","5":"1","6":"1","7":"3","8":"NA"},{"1":"TE Panel A","2":"0.027","3":"10","4":"Operator B","5":"2","6":"1","7":"3","8":"NA"},{"1":"TE Panel A","2":"0.027","3":"10","4":"Operator B","5":"3","6":"1","7":"3","8":"NA"},{"1":"TE Panel A","2":"0.027","3":"100","4":"Operator B","5":"1","6":"3","7":"3","8":"NA"},{"1":"TE Panel A","2":"0.027","3":"100","4":"Operator B","5":"2","6":"3","7":"3","8":"NA"},{"1":"TE Panel A","2":"0.027","3":"100","4":"Operator B","5":"3","6":"3","7":"3","8":"NA"},{"1":"TE Panel A","2":"0.0027","3":"10","4":"Operator A","5":"1","6":"1","7":"3","8":"NA"},{"1":"TE Panel A","2":"0.0027","3":"10","4":"Operator A","5":"2","6":"1","7":"3","8":"NA"},{"1":"TE Panel A","2":"0.0027","3":"10","4":"Operator A","5":"3","6":"1","7":"3","8":"NA"},{"1":"TE Panel A","2":"0.0027","3":"100","4":"Operator A","5":"1","6":"4","7":"3","8":"NA"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Above, we interpret the numeric levels from the DoE by joining each to the tables that provide the literal values for those experimental variables.</p>
<p>Above, we also assigned samples to captures in plexity of up to 6 the table is sorted in order of panel and mass input, so most of the time, samples will be paired with other samples with the same mass input, which is best practice.</p>
<p>Quickly spot-checking the first 10 rows, everything looks reasonable.</p>
<section id="check-orthogonality-of-blocking" class="level3">
<h3 class="anchored" data-anchor-id="check-orthogonality-of-blocking">Check orthogonality of blocking</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">rna_TE__doe_blocked <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(LP_operator, mass_input)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["LP_operator"],"name":[1],"type":["chr"],"align":["left"]},{"label":["mass_input"],"name":[2],"type":["fct"],"align":["left"]},{"label":["n"],"name":[3],"type":["int"],"align":["right"]}],"data":[{"1":"Operator A","2":"10","3":"30"},{"1":"Operator A","2":"100","3":"30"},{"1":"Operator B","2":"10","3":"30"},{"1":"Operator B","2":"100","3":"30"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Above, we count how many samples are operated by each operator at each mass level. The counts are all equal, meaning the two <code>mass_input</code> factor levels have been “spread evenly” across the available operators.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">rna_TE__doe_blocked <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(LP_operator, panel)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["LP_operator"],"name":[1],"type":["chr"],"align":["left"]},{"label":["panel"],"name":[2],"type":["chr"],"align":["left"]},{"label":["n"],"name":[3],"type":["int"],"align":["right"]}],"data":[{"1":"Operator A","2":"TE Panel A","3":"15"},{"1":"Operator A","2":"TE Panel B","3":"15"},{"1":"Operator A","2":"TE Panel C","3":"15"},{"1":"Operator A","2":"Whole Transcriptome","3":"15"},{"1":"Operator B","2":"TE Panel A","3":"15"},{"1":"Operator B","2":"TE Panel B","3":"15"},{"1":"Operator B","2":"TE Panel C","3":"15"},{"1":"Operator B","2":"Whole Transcriptome","3":"15"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>The same is true for the levels of the <code>panel</code> factor: they have been “spread evenly” across the available operators.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">rna_TE__doe_blocked <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(LP_operator, conc)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["LP_operator"],"name":[1],"type":["chr"],"align":["left"]},{"label":["conc"],"name":[2],"type":["fct"],"align":["left"]},{"label":["n"],"name":[3],"type":["int"],"align":["right"]}],"data":[{"1":"Operator A","2":"2.7e-06","3":"13"},{"1":"Operator A","2":"2.7e-05","3":"12"},{"1":"Operator A","2":"0.00027","3":"9"},{"1":"Operator A","2":"0.0027","3":"14"},{"1":"Operator A","2":"0.027","3":"12"},{"1":"Operator B","2":"2.7e-06","3":"11"},{"1":"Operator B","2":"2.7e-05","3":"12"},{"1":"Operator B","2":"0.00027","3":"15"},{"1":"Operator B","2":"0.0027","3":"10"},{"1":"Operator B","2":"0.027","3":"12"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Finally, with RNA concentration, we see that not exactly every operator has the same number of samples at each level of RNA concentration being tested. This is because the number is not evenly divisible, and so some variability in the number of assigned samples will have to exist. Qualitatively, they look reasonably evenly-spread from across the two operators.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">googlesheets4<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_sheet</span>(rna_TE__doe_blocked, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ss =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sheet_string_goes_here"</span>,</span>
<span id="cb16-2">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sheet =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_TE_sensitivity_doe"</span>);</span>
<span id="cb16-3">file_dest_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doe_design_of_experiment_with_library_prep_files"</span></span>
<span id="cb16-4">fs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir_create</span>(file_dest_dir);</span>
<span id="cb16-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_csv</span>(rna_TE__doe_blocked, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(file_dest_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>,</span>
<span id="cb16-6">                                      file_pref,</span>
<span id="cb16-7">                                      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_rna_TE_sensitivity_doe.csv"</span>))</span></code></pre></div>
</div>
<p>Output the design to google sheets, where the scientists and research associates can view the experiment’s sample plan.</p>
</section>
<section id="analyze-captures" class="level3">
<h3 class="anchored" data-anchor-id="analyze-captures">Analyze captures</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">rna_TE__doe_blocked <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb17-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(capture, panel, mass_input)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["capture"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["panel"],"name":[2],"type":["chr"],"align":["left"]},{"label":["mass_input"],"name":[3],"type":["fct"],"align":["left"]},{"label":["n"],"name":[4],"type":["int"],"align":["right"]}],"data":[{"1":"1","2":"TE Panel A","3":"10","4":"6"},{"1":"2","2":"TE Panel A","3":"10","4":"6"},{"1":"3","2":"TE Panel A","3":"10","4":"3"},{"1":"3","2":"TE Panel A","3":"100","4":"3"},{"1":"4","2":"TE Panel A","3":"100","4":"6"},{"1":"5","2":"TE Panel A","3":"100","4":"6"},{"1":"6","2":"TE Panel B","3":"10","4":"6"},{"1":"7","2":"TE Panel B","3":"10","4":"6"},{"1":"8","2":"TE Panel B","3":"10","4":"3"},{"1":"8","2":"TE Panel B","3":"100","4":"3"},{"1":"9","2":"TE Panel B","3":"100","4":"6"},{"1":"10","2":"TE Panel B","3":"100","4":"6"},{"1":"11","2":"TE Panel C","3":"10","4":"6"},{"1":"12","2":"TE Panel C","3":"10","4":"6"},{"1":"13","2":"TE Panel C","3":"10","4":"3"},{"1":"13","2":"TE Panel C","3":"100","4":"3"},{"1":"14","2":"TE Panel C","3":"100","4":"6"},{"1":"15","2":"TE Panel C","3":"100","4":"6"},{"1":"16","2":"Whole Transcriptome","3":"10","4":"6"},{"1":"17","2":"Whole Transcriptome","3":"10","4":"6"},{"1":"18","2":"Whole Transcriptome","3":"10","4":"3"},{"1":"18","2":"Whole Transcriptome","3":"100","4":"3"},{"1":"19","2":"Whole Transcriptome","3":"100","4":"6"},{"1":"20","2":"Whole Transcriptome","3":"100","4":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Above, we can see that, for as many samples as possible, libraries with the same total RNA input mass are captured together in the same multiplexed hybridization reaction. In some cases, we see up to three 10 ng input libraries being co-hybridized with 100 ng input libraries. Given the number of samples we want to run and the division of different TE panels, this is the best we can do.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Great! We have an experiment design for testing the effect of these panels against each other and against whole transcriptome sequencing. The experiment had n = 3 replicates, and it is blocked for having two operators carry out the RNA-seq library preps.</p>
<p>Importantly, when I get feedback on the design of this sample layout, I can easily show my work. Even better, if changes are needed, the entire design is programmed, and can be changed in seconds.</p>
<p>Let’s get this experiment started.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-Donev1988" class="csl-entry">
Donev, A. N., and A. C. Atkinson. 1988. <span>“An Adjustment Algorithm for the Construction of Exact d -Optimum Experimental Designs.”</span> <em>Technometrics</em> 30 (4): 429–33. <a href="https://doi.org/10.1080/00401706.1988.10488438">https://doi.org/10.1080/00401706.1988.10488438</a>.
</div>
<div id="ref-Edwards1974" class="csl-entry">
Edwards, A. W. F. 1974. <span>“The History of Likelihood.”</span> <em>International Statistical Review / Revue Internationale de Statistique</em> 42 (1): 9–15. <a href="http://www.jstor.org/stable/1402681">http://www.jstor.org/stable/1402681</a>.
</div>
<div id="ref-fedorov1972optimal" class="csl-entry">
Fedorov, Valerii V, and Malyutov MB. 1972. <span>“Optimal Designs in Regression Problems.”</span>
</div>
<div id="ref-Fisher1922" class="csl-entry">
Fisher, Ronald A. 1922. <span>“On the Mathematical Foundations of Theoretical Statistics.”</span> <em>Philosophical Transactions of the Royal Society of London. Series A, Containing Papers of a Mathematical or Physical Character</em> 222 (594-604): 309–68.
</div>
<div id="ref-OxfordEssentialQuotations" class="csl-entry">
Ratcliffe, Susan. 2018. <em>Oxford Essential Quotations</em>. Oxford University Press. <a href="https://doi.org/10.1093/acref/9780191866692.001.0001">https://doi.org/10.1093/acref/9780191866692.001.0001</a>.
</div>
</div></section></div> ]]></description>
  <category>DoE</category>
  <category>design of experiment</category>
  <category>code</category>
  <guid>https://pdcherry.github.io/posts/2024_04_05-DoE_design_of_experiment.html</guid>
  <pubDate>Fri, 05 Apr 2024 07:00:00 GMT</pubDate>
  <media:content url="https://pdcherry.github.io/posts/2024_04_05-DoE_design_of_experiment/2024_04_05-DoE_architecture_imperfect_grid.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>San Francisco political support data shows true alignment</title>
  <dc:creator>Patrick Cherry</dc:creator>
  <link>https://pdcherry.github.io/posts/2024_03_02-SF_political_support_data.html</link>
  <description><![CDATA[ 





<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_03_02-SF_political_support_data/2024_03_02-San_Francisco_and_Bay.jpg" class="img-fluid figure-img"></p>
<figcaption>View of the daytime skyline of San Francisco</figcaption>
</figure>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>The saying goes “all politics are local,” and San Francisco is no exception.</p>
<p>San Francisco (and much of the Bay Area) has a curious political idiosyncrasy where brand-name <strong>R</strong>epublican candidates and issues get so little traction among voters so as to be considered irrelevant. Yet, many <strong>r</strong>epublican ideals and beliefs do receive substantial support from locals.</p>
<p>This dynamic causes practically republican organizations to outwardly re-code and re-brand as something—anything—other than GOP. Popular self-descriptions include Moderate or middle-of-the-road Democrat. However, this analysis is motivated by ignoring these pretenses and looking exclusively at indicated issue recommendations / endorsements, and understanding how similar vs.&nbsp;how different each political organization is acting (a behaviorist / empirical approach).</p>
<section id="notes-on-approach" class="level2">
<h2 class="anchored" data-anchor-id="notes-on-approach">Notes on approach</h2>
<p>The website <a href="https://sfendorsements.com/">sfendorsements.com</a> has collected and cataloged many of the city’s politically active groups’ (often Political Action Committees, or PACs) positions on ballot measures and election races for local positions. I hypothesize that these can be used to deduce the true alignment of these organizations.</p>
<p>Peter Xu <a href="https://gitlab.com/peterxu/sf-endorsements">make the code available</a>, and has has previously made <a href="https://docs.google.com/spreadsheets/d/1f3cGgXjI912nA8e1_iTlEhJ7XpxjpSKZdT7wX3ryztg/edit#gid=1545354255">google sheets</a> available for the endorsement data, but those are for 2022.</p>
<p>For this analysis, I will scrape the 2024 data, tidy it up, and analyze it.</p>
</section>
<section id="import-and-tidy-data" class="level2">
<h2 class="anchored" data-anchor-id="import-and-tidy-data">Import and tidy data</h2>
<!-- ```{r, message = FALSE} -->
<!-- former_endorsements_import <- googlesheets4::read_sheet(ss = "1f3cGgXjI912nA8e1_iTlEhJ7XpxjpSKZdT7wX3ryztg", -->
<!--                                                  sheet = "Endorsements", -->
<!--                                                  col_types = "c") %>% -->
<!--   select(!Instructions) -->
<!-- endorsements_tidy <- endorsements_import %>% -->
<!--   pivot_longer(cols = !1, names_to = "names") %>% -->
<!--   pivot_wider(id_cols = names, names_from = 1) %>% -->
<!--   type_convert() -->
<!-- slice_head(endorsements_import, n = 5) %>% select(1:3, 5) -->
<!-- ``` -->
<p>Great, the data are now tidy, where each row is an observation (a political group), and each column is a variable (race / measure).</p>
<section id="what-are-the-propositions" class="level3">
<h3 class="anchored" data-anchor-id="what-are-the-propositions">What are the propositions?</h3>
<div class="cell">
<div id="tbl-props" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-props-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Table of proposition names, titles, and descriptive summary
</figcaption>
<div aria-describedby="tbl-props-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Prop</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Title</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><a href="https://voterguide.sos.ca.gov/" style="     ">Prop 1</a></td>
<td style="text-align: left;">Mental health care reform including bond measure to fund treatment beds</td>
<td style="text-align: left;">Proposition 1 would shift the way California spends tax revenue from the Mental Health Services Act to cover addiction treatment and housing. It would also authorize $6.38 billion in bond funding to build residential mental health treatment facilities. Its part of Gov. Gavin Newsoms plan to get people with severe mental illness who are languishing on the streets into housing and treatment.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><a href="https://voterguide.sfelections.org/local-ballot-measures/measure-a" style="     ">Prop A</a></td>
<td style="text-align: left;">Affordable Housing Bonds</td>
<td style="text-align: left;">SAN FRANCISCO AFFORDABLE HOUSING BONDS. To construct, develop, acquire, and/or rehabilitate housing, including workforce housing and senior housing, that will be affordable to households ranging from extremely low-income to moderate-income households; shall the City and County of San Francisco issue $300,000,000 in general obligation bonds, subject to independent citizen oversight and regular audits, with a duration of up to 30 years from the time of issuance, an estimated average tax rate of $0.0057/$100 of assessed property value, and projected average annual revenues of $25,000,000?</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><a href="https://voterguide.sfelections.org/local-ballot-measures/measure-b" style="     ">Prop B</a></td>
<td style="text-align: left;">Police Officer Staffing Levels Conditioned on Future Tax Funding</td>
<td style="text-align: left;">Shall the City amend the Charter to set minimum police officer staffing levels, require the City to budget enough money to pay the number of police officers employed in the previous year, allow the Police Department to introduce amendments to its budget, and set aside funds to pay for police recruitment, all for at least five years, but all if and only if the voters later adopt a new tax or amend an existing tax to fund these requirements?</td>
</tr>
<tr class="even">
<td style="text-align: left;"><a href="https://voterguide.sfelections.org/local-ballot-measures/measure-c" style="     ">Prop C</a></td>
<td style="text-align: left;">Real Estate Transfer Tax Exemption and Office Space Allocation</td>
<td style="text-align: left;">Shall the City exempt from the real estate transfer tax the first time a property is transferred after being converted from a commercial to residential use, have authority to amend the transfer tax without voter approval but not to increase it, and increase the annual limit on office space available for development by including office space that has been converted to a different use or demolished?</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><a href="https://voterguide.sfelections.org/local-ballot-measures/measure-a" style="     ">Prop D</a></td>
<td style="text-align: left;">Changes to Local Ethics Laws</td>
<td style="text-align: left;">Shall the City amend its ethics laws to further restrict the gifts City employees and officers may accept, expand the definition of conduct by City employees, officers and others that those laws prohibit as bribery, require additional reporting of gifts to City departments, create a uniform set of rules for nonwork activities of City employees and officers instead of rules by each department, create additional penalties for some ethics violations, require ethics training for additional City employees, and change the requirements for making future amendments to some ethics laws?</td>
</tr>
<tr class="even">
<td style="text-align: left;"><a href="https://voterguide.sfelections.org/local-ballot-measures/measure-e" style="     ">Prop E</a></td>
<td style="text-align: left;">Police Department Policies and Procedures</td>
<td style="text-align: left;">Shall the City allow the Police Department to hold community meetings before the Police Commission can change policing policies, reduce recordkeeping and reporting requirements for police officers, set new policies for police officers to report use-of-force incidents and to engage in vehicle pursuits, authorize the Police Department to use drones and install public surveillance cameras without further approval, and authorize the Police Department to use new surveillance technology unless the Board of Supervisors disapproves?</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><a href="https://voterguide.sfelections.org/local-ballot-measures/measure-f" style="     ">Prop F</a></td>
<td style="text-align: left;">Illegal Substance Dependence Screening and Treatment for Recipients of City Public Assistance</td>
<td style="text-align: left;">Shall the City require single adults age 65 and under with no dependent children who receive City public assistance benefits and whom the City reasonably suspects are dependent on illegal drugs to participate in screening, evaluation and treatment for drug dependency for those adults to be eligible for most of those benefits?</td>
</tr>
<tr class="even">
<td style="text-align: left;"><a href="https://voterguide.sfelections.org/local-ballot-measures/measure-g" style="     ">Prop G</a></td>
<td style="text-align: left;">Offering Algebra 1 to Eighth Graders</td>
<td style="text-align: left;">Shall it be City policy to encourage the San Francisco Unified School District to offer Algebra 1 to students by their eighth-grade year and to support the School Districts development of its math curriculum?</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
</section>
</section>
<section id="edit-after-initial-publication" class="level2">
<h2 class="anchored" data-anchor-id="edit-after-initial-publication">Edit after initial publication</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>March 3, 2024 2:15 PM local time</p>
<p>It has <a href="https://carfree.city/@scott/112034022686769771">come to my attention</a> that the scraped data were not 100% complete. The SF Chronicle has posted some endorsements on Ballot Measures E and F that were not included in this analysis. Thanks to Scott for noticing this. As of this moment, I have manually verified and added these to the table.</p>
</div>
</div>
</section>
<section id="analyze-by-ballot-measures" class="level2">
<h2 class="anchored" data-anchor-id="analyze-by-ballot-measures">Analyze by ballot measures</h2>
<section id="who-is-recommending-what" class="level3">
<h3 class="anchored" data-anchor-id="who-is-recommending-what">Who is recommending what?</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_03_02-SF_political_support_data_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Visually, we can see from this plot that there is significant variation across political organizations on endorsements for props C, E, F, G, and to a lesser extent B; whereas ballot measures 1, A, and D show less variation among political organizations. Also, interestingly, some organizations that offer endorsements did not endorse any position for some (or even most) propositions on the March 5 ballot.</p>
<p>However, for the above plot, the variation is easier to see than if the political organizations were sorted alphabetically because I cheated: I pre-sorted these based on their clustering order. So let’s explore the clustering result.</p>
</section>
<section id="nominal-clustering" class="level3">
<h3 class="anchored" data-anchor-id="nominal-clustering">Nominal clustering</h3>
<p>Clustering is typically a quantitative method, so special accommodations have to be taken for clustering nominal / factor data like these (where there are discrete values that do not have an order over one another). Luckily, we can use the <a href="https://cran.r-project.org/web/packages/nomclust/index.html"><code>nomclust</code></a> package (<a href="https://link.springer.com/article/10.1007/s00180-022-01209-4">paper</a>), which handles the details as a purpose-built package for hierarchical clustering of nominal (categorical) variables.</p>
<p>One weakness of this clustering analysis is that it weights all ballot measures and races as the same. For an individual voter, some topics and races may have more salience or effect, and this analysis cannot take that into account.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_03_02-SF_political_support_data_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The underlying data have been updated since the original publication. The clustering is meaningfully different than previously displayed.</p>
</div>
</div>
<p>Generally speaking, the agglomerative coefficient of a clustering analysis describes the strength of the clustering structure that has been obtained by group average linkage. The coefficient takes values from 0 to 1, and is calculated as the mean of the normalized lengths at which the clusters are formed, <em>e.g.</em> the uniformity lengths displayed on the dendrogram. The more evenly and gradually the categories get broken down into different clusters, the closer to 1 the agglomerative coefficient will be.</p>
<p>Very tellingly, we see three broad clusters:</p>
<ul>
<li>On the left (in red), the fist cluster is the largest cluster (in terms of number of organizations). It contains some heavy hitters, like the San Francisco Chronicle, the Harvey Milk LGBTQ Democratic Club, and the San Francisco Democratic Party.<br>
</li>
<li>Next, in the middle (in green), this cluster is defined by SPUR and the YIMBY Action / Sierra Club / SF League of Conservation Voters (the latter three having identical ballot measure endorsements).</li>
<li>On the right (in blue) is the cluster defined by the SF Republican Party. It also contains many low-distance neighborhood Democratic Clubs, and <a href="https://growsf.org/">GrowSF</a>, a nominally non-partisan and <a href="https://missionlocal.org/2024/02/explore-big-money-san-francisco-growsf-togethersf-neighbors-larsen-moritz-tan-web/">well-funded</a> local 501(c)(4) political advocacy group.</li>
</ul>
<section id="political-organization-distance-heat-map" class="level4">
<h4 class="anchored" data-anchor-id="political-organization-distance-heat-map">Political organization distance heat map</h4>
<p>I can also make a heat map of the clustering distance, or dissimilarity.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_03_02-SF_political_support_data_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The heat map shows darker, purple-er coloring for pairs of organizations whose set of endorsements are more similar, and lighter, yellow-er colors for organizations with very different endorsements.</p>
</section>
<section id="political-organization-distance-table" class="level4">
<h4 class="anchored" data-anchor-id="political-organization-distance-table">Political organization distance table</h4>
<div class="cell">
<div id="tbl-org-dis" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-org-dis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Table of unique political organization pairs, sorted by clustering proximity
</figcaption>
<div aria-describedby="tbl-org-dis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-61c176e370e69ec6e54c" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-61c176e370e69ec6e54c">{"x":{"filter":"none","vertical":false,"extensions":["FixedColumns","FixedHeader"],"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206","207","208","209","210","211","212","213","214","215","216","217","218","219","220","221","222","223","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","255","256","257","258","259","260","261","262","263","264","265","266","267","268","269","270","271","272","273","274","275","276","277","278","279","280","281","282","283","284","285","286","287","288","289","290","291","292","293","294","295","296","297","298","299","300","301","302","303","304","305","306","307","308","309","310","311","312","313","314","315","316","317","318","319","320","321","322","323","324","325","326","327","328","329","330","331","332","333","334","335","336","337","338","339","340","341","342","343","344","345","346","347","348","349","350","351","352","353","354","355","356","357","358","359","360","361","362","363","364","365","366","367","368","369","370","371","372","373","374","375","376","377","378","379","380","381","382","383","384","385","386","387","388","389","390","391","392","393","394","395","396","397","398","399","400","401","402","403","404","405","406","407","408","409","410","411","412","413","414","415","416","417","418","419","420","421","422","423","424","425","426","427","428","429","430","431","432","433","434","435","436","437","438","439","440","441","442","443","444","445","446","447","448","449","450","451","452","453","454","455","456","457","458","459","460","461","462","463","464","465"],["Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Democratic Party (SF)","District 11 Democratic Club","Alice B. Toklas LGBT Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Alice B. Toklas LGBT Democratic Club","League of Women Voters of SF","Alice B. Toklas LGBT Democratic Club","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","San Francisco Bay Guardian","San Francisco Chronicle","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Sierra Club","United Democratic Club","Alice B. Toklas LGBT Democratic Club","YIMBY Action","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Democratic Party (SF)","District 11 Democratic Club","Bernal Heights Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Bernal Heights Democratic Club","League of Women Voters of SF","Bernal Heights Democratic Club","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","San Francisco Bay Guardian","San Francisco Chronicle","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Sierra Club","United Democratic Club","Bernal Heights Democratic Club","YIMBY Action","Chinese American Democratic Club","Democratic Party (SF)","District 11 Democratic Club","Chinese American Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Chinese American Democratic Club","League of Women Voters of SF","Chinese American Democratic Club","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","San Francisco Bay Guardian","San Francisco Chronicle","Chinese American Democratic Club","Chinese American Democratic Club","Sierra Club","United Democratic Club","Chinese American Democratic Club","YIMBY Action","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","San Francisco Chronicle","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","Green Party (SF)","GrowSF","District 11 Democratic Club","District 11 Democratic Club","League of Women Voters of SF","District 11 Democratic Club","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","San Francisco Bay Guardian","San Francisco Chronicle","District 11 Democratic Club","District 11 Democratic Club","Sierra Club","District 11 Democratic Club","District 11 Democratic Club","YIMBY Action","Eastern Neighborhoods Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Eastern Neighborhoods Democratic Club","League of Women Voters of SF","Eastern Neighborhoods Democratic Club","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","San Francisco Bay Guardian","San Francisco Chronicle","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Sierra Club","United Democratic Club","Eastern Neighborhoods Democratic Club","YIMBY Action","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Ed M. Lee Asian Pacific Democratic Club","League of Women Voters of SF","Ed M. Lee Asian Pacific Democratic Club","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","San Francisco Bay Guardian","San Francisco Chronicle","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Sierra Club","United Democratic Club","Ed M. Lee Asian Pacific Democratic Club","YIMBY Action","Green Party (SF)","GrowSF","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","SF League of Pissed Off Voters","Green Party (SF)","Green Party (SF)","Green Party (SF)","San Francisco Bay Guardian","San Francisco Chronicle","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","YIMBY Action","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","SF League of Pissed Off Voters","GrowSF","GrowSF","GrowSF","San Francisco Bay Guardian","San Francisco Chronicle","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","YIMBY Action","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","League of Women Voters of SF","Harvey Milk LGBTQ Democratic Club","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","San Francisco Bay Guardian","San Francisco Chronicle","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Sierra Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","YIMBY Action","Home Sharers Democratic Club","League of Women Voters of SF","Noe Valley Democratic Club","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","San Francisco Bay Guardian","San Francisco Chronicle","Home Sharers Democratic Club","Home Sharers Democratic Club","Sierra Club","United Democratic Club","Home Sharers Democratic Club","YIMBY Action","League of Women Voters of SF","League of Women Voters of SF","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","League of Women Voters of SF","SF Tenants Union","SPUR (Planning / Urban Research Association)","San Francisco Bay Guardian","San Francisco Chronicle","League of Women Voters of SF","League of Women Voters of SF","Sierra Club","League of Women Voters of SF","League of Women Voters of SF","YIMBY Action","Noe Valley Democratic Club","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","San Francisco Bay Guardian","San Francisco Chronicle","Noe Valley Democratic Club","Noe Valley Democratic Club","Sierra Club","United Democratic Club","Noe Valley Democratic Club","YIMBY Action","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SEIU 1021","SF League of Pissed Off Voters","SEIU 1021","SF Tenants Union","SEIU 1021","Sierra Club","SEIU 1021","SEIU 1021","YIMBY Action","SF Berniecrats","SF Berniecrats","SF Berniecrats","SF Berniecrats","SF League of Pissed Off Voters","SF Berniecrats","SF Berniecrats","SF Berniecrats","SF Berniecrats","SF Berniecrats","SF Berniecrats","YIMBY Action","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF League of Pissed Off Voters","SF Housing Action Coalition","SF Tenants Union","SF Housing Action Coalition","Sierra Club","SF Housing Action Coalition","SF Housing Action Coalition","YIMBY Action","SF Labor Council","SF Labor Council","SF League of Pissed Off Voters","SF Labor Council","SF Tenants Union","SF Labor Council","Sierra Club","SF Labor Council","SF Labor Council","YIMBY Action","SF League of Conservation Voters","SF League of Pissed Off Voters","SF League of Conservation Voters","SF Tenants Union","SF League of Conservation Voters","Sierra Club","SF League of Conservation Voters","SF League of Conservation Voters","YIMBY Action","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","Sierra Club","SF Republican Party","SF Republican Party","YIMBY Action","SF Tenants Union","SF Tenants Union","SF Tenants Union","SF Tenants Union","SF Tenants Union","YIMBY Action","SPUR (Planning / Urban Research Association)","SPUR (Planning / Urban Research Association)","SPUR (Planning / Urban Research Association)","YIMBY Action","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Chronicle","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","San Francisco Parent Action","San Francisco Rising Action","Sierra Club","United Democratic Club","United Educators of San Francisco","YIMBY Action","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","San Francisco Rising Action","Sierra Club","United Democratic Club","San Francisco Rising Action","YIMBY Action","Sierra Club","Sierra Club","Sierra Club","Sierra Club","YIMBY Action","United Democratic Club","United Democratic Club","YIMBY Action","United Educators of San Francisco","YIMBY Action","YIMBY Action"],["Alice B. Toklas LGBT Democratic Club","Bernal Heights Democratic Club","Chinese American Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Eastern Neighborhoods Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Home Sharers Democratic Club","Alice B. Toklas LGBT Democratic Club","Noe Valley Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","San Francisco Parent Action","San Francisco Rising Action","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","United Educators of San Francisco","Alice B. Toklas LGBT Democratic Club","Bernal Heights Democratic Club","Chinese American Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Eastern Neighborhoods Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Home Sharers Democratic Club","Bernal Heights Democratic Club","Noe Valley Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","San Francisco Parent Action","San Francisco Rising Action","Bernal Heights Democratic Club","Bernal Heights Democratic Club","United Educators of San Francisco","Bernal Heights Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Eastern Neighborhoods Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Home Sharers Democratic Club","Chinese American Democratic Club","Noe Valley Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","San Francisco Parent Action","San Francisco Rising Action","Chinese American Democratic Club","Chinese American Democratic Club","United Educators of San Francisco","Chinese American Democratic Club","Democratic Party (SF)","District 11 Democratic Club","Eastern Neighborhoods Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","League of Women Voters of SF","Noe Valley Democratic Club","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","San Francisco Bay Guardian","Democratic Party (SF)","San Francisco Parent Action","San Francisco Rising Action","Sierra Club","United Democratic Club","United Educators of San Francisco","YIMBY Action","District 11 Democratic Club","Eastern Neighborhoods Democratic Club","Ed M. Lee Asian Pacific Democratic Club","District 11 Democratic Club","District 11 Democratic Club","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","District 11 Democratic Club","Noe Valley Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","San Francisco Parent Action","San Francisco Rising Action","District 11 Democratic Club","United Democratic Club","United Educators of San Francisco","District 11 Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Home Sharers Democratic Club","Eastern Neighborhoods Democratic Club","Noe Valley Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","San Francisco Parent Action","San Francisco Rising Action","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","United Educators of San Francisco","Eastern Neighborhoods Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Home Sharers Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Noe Valley Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","San Francisco Parent Action","San Francisco Rising Action","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","United Educators of San Francisco","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","Green Party (SF)","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","League of Women Voters of SF","Noe Valley Democratic Club","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","Green Party (SF)","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","Green Party (SF)","Green Party (SF)","San Francisco Parent Action","San Francisco Rising Action","Sierra Club","United Democratic Club","United Educators of San Francisco","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","League of Women Voters of SF","Noe Valley Democratic Club","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","GrowSF","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","GrowSF","GrowSF","San Francisco Parent Action","San Francisco Rising Action","Sierra Club","United Democratic Club","United Educators of San Francisco","GrowSF","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","Harvey Milk LGBTQ Democratic Club","Noe Valley Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","San Francisco Parent Action","San Francisco Rising Action","Harvey Milk LGBTQ Democratic Club","United Democratic Club","United Educators of San Francisco","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","San Francisco Parent Action","San Francisco Rising Action","Home Sharers Democratic Club","Home Sharers Democratic Club","United Educators of San Francisco","Home Sharers Democratic Club","League of Women Voters of SF","Noe Valley Democratic Club","League of Women Voters of SF","League of Women Voters of SF","League of Women Voters of SF","League of Women Voters of SF","League of Women Voters of SF","League of Women Voters of SF","SF Republican Party","League of Women Voters of SF","League of Women Voters of SF","League of Women Voters of SF","League of Women Voters of SF","San Francisco Parent Action","San Francisco Rising Action","League of Women Voters of SF","United Democratic Club","United Educators of San Francisco","League of Women Voters of SF","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","San Francisco Parent Action","San Francisco Rising Action","Noe Valley Democratic Club","Noe Valley Democratic Club","United Educators of San Francisco","Noe Valley Democratic Club","SEIU 1021","SEIU 1021","SEIU 1021","SEIU 1021","SF League of Conservation Voters","SEIU 1021","SF Republican Party","SEIU 1021","SPUR (Planning / Urban Research Association)","SEIU 1021","United Democratic Club","United Educators of San Francisco","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF Berniecrats","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","Sierra Club","United Democratic Club","United Educators of San Francisco","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF Housing Action Coalition","SF Republican Party","SF Housing Action Coalition","SPUR (Planning / Urban Research Association)","SF Housing Action Coalition","United Democratic Club","United Educators of San Francisco","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF Labor Council","SF Republican Party","SF Labor Council","SPUR (Planning / Urban Research Association)","SF Labor Council","United Democratic Club","United Educators of San Francisco","SF Labor Council","SF League of Conservation Voters","SF League of Conservation Voters","SF Republican Party","SF League of Conservation Voters","SPUR (Planning / Urban Research Association)","SF League of Conservation Voters","United Democratic Club","United Educators of San Francisco","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","Sierra Club","United Democratic Club","United Educators of San Francisco","YIMBY Action","SF Republican Party","SF Republican Party","SF Republican Party","SF Republican Party","United Democratic Club","United Educators of San Francisco","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","Sierra Club","United Democratic Club","United Educators of San Francisco","SF Tenants Union","SPUR (Planning / Urban Research Association)","United Democratic Club","United Educators of San Francisco","SPUR (Planning / Urban Research Association)","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Parent Action","San Francisco Rising Action","Sierra Club","United Democratic Club","United Educators of San Francisco","YIMBY Action","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Conservation Voters","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SPUR (Planning / Urban Research Association)","San Francisco Chronicle","San Francisco Parent Action","San Francisco Rising Action","Sierra Club","United Democratic Club","United Educators of San Francisco","YIMBY Action","San Francisco Parent Action","San Francisco Parent Action","San Francisco Parent Action","San Francisco Parent Action","San Francisco Parent Action","San Francisco Parent Action","San Francisco Parent Action","San Francisco Parent Action","San Francisco Parent Action","San Francisco Parent Action","San Francisco Parent Action","San Francisco Parent Action","San Francisco Parent Action","San Francisco Parent Action","San Francisco Parent Action","San Francisco Rising Action","San Francisco Rising Action","San Francisco Rising Action","San Francisco Rising Action","San Francisco Rising Action","San Francisco Rising Action","San Francisco Rising Action","San Francisco Rising Action","San Francisco Rising Action","San Francisco Rising Action","San Francisco Rising Action","San Francisco Rising Action","United Educators of San Francisco","San Francisco Rising Action","SPUR (Planning / Urban Research Association)","Sierra Club","United Democratic Club","United Educators of San Francisco","Sierra Club","United Democratic Club","United Educators of San Francisco","United Democratic Club","United Educators of San Francisco","United Educators of San Francisco","YIMBY Action"],[0,0.748,0.428,1.12,1.13,0.27,0.268,1.58,0.476,1.81,0.476,0.645,0.476,1.1,1.09,0.459,1.12,0.733,0.748,1.07,0.766,0.47,0.748,0.477,2.32,0.766,0.733,0.27,0.268,0.733,0,1.64,0.249,0.758,1.15,1.14,0.397,0.738,0.276,0.738,0.381,0.738,0.106,0.104,1.77,0.443,2.96,0,1.63,0.268,0.739,0,0.27,4.12,0.268,2.96,1.15,1.15,2.96,0,1.58,2.62,0.0949,0.225,1.3,0.244,5.14,0.244,2.24,0.244,2.53,2.51,1,4.84,1.56,1.64,0.349,2.75,1.63,1.64,0.6899999999999999,0.992,2.75,1.56,0.0949,1.04,1.56,0,1.06,1.11,1.11,0.382,0.714,0.427,0.714,0.602,0.714,0.116,0.415,1.65,0.275,2.72,0.249,1.58,0.452,0.6899999999999999,0.249,0.257,2.13,0.452,2.72,1.11,1.74,2.72,0,1.76,1.75,1.52,2.95,0.274,2.95,1.47,2.95,0.697,0.704,0.74,0.68,0.463,0.758,2.64,0.74,0.756,0.758,1.81,0.597,0.74,0.463,1.76,0.47,0.463,0,0.108,1.57,0.123,3.01,0.123,1.53,0.123,1.7,1.69,0.707,2.88,1.1,1.15,0.439,1.83,1.14,1.15,0.474,1.41,1.83,1.1,0,0.736,1.1,0,1.57,0.261,2.99,0.261,1.52,0.261,1.69,1.68,0.464,2.86,0.741,1.14,0.673,1.82,1.13,1.14,0.471,0.951,1.82,0.741,0.108,0.732,0.741,0,1.01,0.635,1.01,0.375,1.01,0.612,0.235,4.68,0.612,4.56,0.397,0.7,0.397,1.56,0.397,0.408,1.76,0.397,4.56,1.57,1.55,4.56,0,1.78,0,0.981,0,1.08,1.08,1.1,1.72,1.72,0.738,0.243,1.16,0.733,0.738,0.269,2.27,1.16,1.72,0.123,1.14,1.72,0,1.78,0.613,1.78,0.243,0.247,1.78,0.234,1.13,0.276,1.62,0.266,0.742,0.276,0.751,1.43,0.266,1.13,3.01,1.15,1.13,0,0.981,0,1.08,1.08,1.1,1.72,1.72,0.738,0.243,1.16,0.733,0.738,0.269,2.27,1.16,1.72,0.123,1.14,1.72,0,0.981,0.591,0.223,1.52,0.361,1.5,0.381,1.37,0.204,0.637,0.381,0.395,2.46,0.204,1.5,1.53,0.633,1.5,0,1.08,1.08,1.1,1.72,1.72,0.738,0.243,1.16,0.733,0.738,0.269,2.27,1.16,1.72,0.123,1.14,1.72,0,0.234,1.62,0.268,2.66,0.106,2.51,0.443,0.679,2.66,1.7,1.71,2.66,0,2.75,0.407,2.7,0.104,1.51,0.24,1.08,2.7,1.69,1.07,2.7,0,1.66,0.122,1.77,2.56,1.81,0.273,0.122,0.707,0.472,0.122,0,1.06,0.443,1.57,0.106,0.695,1.06,2.88,0.723,1.06,0,2.96,1.57,1.16,0.477,0,1.1,0.269,0,0,1.63,0.268,0.739,2.96,1.15,1.15,2.96,0,1.06,1.62,1.57,0.439,1.05,1.57,0,0.756,1.16,1.83,0.48,1.16,0,1.14,0.483,0.477,0.106,0.104,1.77,0.443,2.96,0,1.63,0.268,0.739,0,0.27,4.12,0.268,2.96,1.15,1.15,2.96,0.446,0.443,1.15,0.725,1.8,0.27,0.6870000000000001,0.481,0.47,0,2.38,0.481,1.8,0.474,0.756,1.8,3.64,3.69,0.625,2.12,0.381,4.12,1.17,2.33,1.49,0,2.33,0.381,1.41,0.952,0.381,0.443,0.24,1.81,0.106,1.16,0.268,1.06,0,0.756,0,1.16,1.83,0.48,1.16,0.477,0,1.1,0.269,0,0,0.736,1.1,0,0.269,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>org<\/th>\n      <th>org2<\/th>\n      <th>proximity<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"paging":true,"fixedHeader":true,"fixedHeight":true,"columnDefs":[{"className":"dt-right","targets":3},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"org","targets":1},{"name":"org2","targets":2},{"name":"proximity","targets":3}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</figure>
</div>
</div>
<!-- ```{r} -->
<!-- unq_org_dist_tbl %>% -->
<!--   filter(str_detect(org_sort_pair_chr, "YIMBY Action") & -->
<!--            org != org2) %>% -->
<!--   mutate("non_fil_term" = if_else(org != "YIMBY Action", org, org2)) %>% -->
<!--   arrange(proximity) %>% -->
<!--   left_join(endorsements_tidy, by = c("non_fil_term" = "Organization")) %>% -->
<!--   filter(`Prop A` == "Yes" & `Prop C` == "Yes" & (`Prop E` == "No" | `Prop F` == "No")) %>% -->
<!--   select(!c("org_sort_pair_list", "org_sort_pair_chr")) -->
<!-- ``` -->
<p>Some notable large-distance pairs jump out, like:</p>
<ul>
<li>Green Party (SF) vs SF Housing Action Coalition (distance = 4.3)</li>
<li>The Green Party (SF) versus the middle cluster (Sierra Club, YIMBY Action, SF League of Conservation Voters) (distance = 4.11)</li>
<li>Harvey Milk LGBTQ Democratic Club vs Chinese American Democratic Club and the United Democratic Club (distance = 2.89)</li>
<li>SF Labor Council vs Chinese American Democratic Club (distance = 2.75)</li>
</ul>
<p>The least-distant org to the SF Republican Party (aside from itself) is GrowSF (distance = 0.238)</p>
</section>
</section>
<section id="remarks-on-clustering-by-ballot-measure" class="level3">
<h3 class="anchored" data-anchor-id="remarks-on-clustering-by-ballot-measure">Remarks on clustering by ballot measure</h3>
<p>We can see from a reasonably well-fitting categorical clustering model that many political organizations have high similarity with the SF Republican Party’s positions on ballot measures, despite having “Democratic” in their name. This result supports the idea that an empirical approach can reveal more about the character of an organization that the words in its name.</p>
</section>
</section>
<section id="aanlyze-by-candidate-endorsement" class="level2">
<h2 class="anchored" data-anchor-id="aanlyze-by-candidate-endorsement">Aanlyze by candidate endorsement</h2>
<p>Great, the data are now tidy, where each row is an observation (a political group), and each column is a variable (race).</p>
<section id="who-is-recommending-whom" class="level3">
<h3 class="anchored" data-anchor-id="who-is-recommending-whom">Who is recommending whom?</h3>
<div class="cell">
<div id="tbl-cand-recs" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-cand-recs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Table of organization endorsements of candidates for races
</figcaption>
<div aria-describedby="tbl-cand-recs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Organization</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">President</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">US Senator</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">House CA-11</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">House CA-15</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">State Senate 11</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">State Assembly 17</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">State Assembly 19</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Superior Court Seat 1</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Superior Court Seat 13</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">San Francisco Chronicle</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Katie Porter</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Catherine Stefani</td>
<td style="text-align: left;">Michael Begert</td>
<td style="text-align: left;">Patrick Thompson</td>
</tr>
<tr class="even">
<td style="text-align: left;">San Francisco Bay Guardian</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Barbara Lee</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Michael Begert</td>
<td style="text-align: left;">Patrick Thompson</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SF League of Pissed Off Voters</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Barbara Lee</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Michael Begert</td>
<td style="text-align: left;">Patrick Thompson</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bernal Heights Democratic Club</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Barbara Lee</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Michael Begert</td>
<td style="text-align: left;">Patrick Thompson</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SF Women's Political Committee</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Barbara Lee</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Catherine Stefani</td>
<td style="text-align: left;">Michael Begert</td>
<td style="text-align: left;">Patrick Thompson</td>
</tr>
<tr class="even">
<td style="text-align: left;">SF Berniecrats</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Barbara Lee</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">David Lee</td>
<td style="text-align: left;">Michael Begert</td>
<td style="text-align: left;">Patrick Thompson</td>
</tr>
<tr class="odd">
<td style="text-align: left;">District 11 Democratic Club</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Michael Begert</td>
<td style="text-align: left;">Patrick Thompson</td>
</tr>
<tr class="even">
<td style="text-align: left;">SF Tenants Union</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Michael Begert</td>
<td style="text-align: left;">Patrick Thompson</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SF Labor Council</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Michael Begert</td>
<td style="text-align: left;">Patrick Thompson</td>
</tr>
<tr class="even">
<td style="text-align: left;">Green Party (SF)</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Michael Begert</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">San Francisco Rising Action</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Barbara Lee</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Democratic Party (SF)</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
<td style="text-align: left;">Michael Begert</td>
<td style="text-align: left;">Patrick Thompson</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Harvey Milk LGBTQ Democratic Club</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Barbara Lee</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Michael Begert</td>
<td style="text-align: left;">Patrick Thompson</td>
</tr>
<tr class="even">
<td style="text-align: left;">United Democratic Club</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Adam Schiff</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
<td style="text-align: left;">Chip Zecher</td>
<td style="text-align: left;">Jean Myungjin Roland</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ed M. Lee Asian Pacific Democratic Club</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Adam Schiff</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
<td style="text-align: left;">Chip Zecher</td>
<td style="text-align: left;">Jean Myungjin Roland</td>
</tr>
<tr class="even">
<td style="text-align: left;">Alice B. Toklas LGBT Democratic Club</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Barbara Lee</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
<td style="text-align: left;">Chip Zecher</td>
<td style="text-align: left;">Jean Myungjin Roland</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Chinese American Democratic Club</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Barbara Lee</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
<td style="text-align: left;">Chip Zecher</td>
<td style="text-align: left;">Jean Myungjin Roland</td>
</tr>
<tr class="even">
<td style="text-align: left;">Eastern Neighborhoods Democratic Club</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
<td style="text-align: left;">Chip Zecher</td>
<td style="text-align: left;">Jean Myungjin Roland</td>
</tr>
<tr class="odd">
<td style="text-align: left;">GrowSF</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
<td style="text-align: left;">Chip Zecher</td>
<td style="text-align: left;">Jean Myungjin Roland</td>
</tr>
<tr class="even">
<td style="text-align: left;">SEIU 1021</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">YIMBY Action</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Sierra Club</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">SF Housing Action Coalition</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">SF Young Democrats</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Barbara Lee</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Home Sharers Democratic Club</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Adam Schiff</td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;">Kevin Mullin</td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;">Catherine Stefani</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Noe Valley Democratic Club</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Nancy Pelosi</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Scott Wiener</td>
<td style="text-align: left;">Matt Haney</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Jean Myungjin Roland</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SF Young Republicans</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Jason Zeng</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Yvette Corkrean</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Arjun Sodhani</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">SF Republican Party</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Eric Early</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Yvette Corkrean</td>
<td style="text-align: left;">Manuel Noris-Barrera</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Chip Zecher</td>
<td style="text-align: left;">Jean Myungjin Roland</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<p>I’ve cheated again and pre-arranged this table of candidate endorsements by the clustering order. It makes it pretty clear there are a few block. I’ll also do a distance heat map below (which doesn’t say the endorsement names, but shows similarity more clearly.)</p>
<div class="cell">
<div id="tbl-cand-recs-uniq-count" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-cand-recs-uniq-count-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: Unique options per race
</figcaption>
<div aria-describedby="tbl-cand-recs-uniq-count-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">President</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">US Senator</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">House CA-11</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">House CA-15</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">State Senate 11</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">State Assembly 17</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">State Assembly 19</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Superior Court Seat 1</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Superior Court Seat 13</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<p>Note that races have one to four options among the endorsements made by these political organizations. This is different than the ballot measures (where options were Yes / No / NA). This increase in the number of levels of each factor can affect the clustering.</p>
<div class="cell">
<div id="tbl-cand-recs-na-count" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-cand-recs-na-count-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5: Races where one or more organizations did not endorse anyone (binary: Yes / No)
</figcaption>
<div aria-describedby="tbl-cand-recs-na-count-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">President</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">US Senator</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">House CA-11</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">House CA-15</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">State Senate 11</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">State Assembly 17</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">State Assembly 19</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Superior Court Seat 1</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Superior Court Seat 13</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">Yes</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<p>Also note that, in every race, there is one option that is the organization declining to endorse anyone. Thus, the number of <em>candidates</em> endorsed is <code>n - 1</code> the value represented in the table.</p>
<p>This means that no organization made any endorsements for President. This fact is not true of any other race.</p>
</section>
<section id="nominal-clustering-1" class="level3">
<h3 class="anchored" data-anchor-id="nominal-clustering-1">Nominal clustering</h3>
<p>Very tellingly, we see two broad clusters and two narrow clusters:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_03_02-SF_political_support_data_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>On the left (in red), the fist cluster is contains some heavy hitters, like the San Francisco Chronicle and the San Francisco Bay Guardian</li>
<li>Next, in the middle-left (in green), this large cluster contains some notable members, like the San Francisco Democratic Party, the Harvey Milk LGBTQ Democratic Club, GrowSF, and the Sierra Club.</li>
<li>On the right (in cyan and purple) are the two clusters for the SF Young Republicans and the SF Republican Party. It is curious these two organizations cluster apart (their fork is pretty high in distance), but looking to the endorsements table can shed light on why: their only common endorsement is for Yvette Corkrean for State Senate 11, and all others are disparate. All these endorsements are so divergent from the other organizations as to earn them their own clusters.</li>
</ul>
<section id="political-organization-distance-heat-map-1" class="level4">
<h4 class="anchored" data-anchor-id="political-organization-distance-heat-map-1">Political organization distance heat map</h4>
<p>I can also make a heat map of the clustering distance, or dissimilarity.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_03_02-SF_political_support_data_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="720"></p>
</figure>
</div>
</div>
</div>
<p>For the two large clusters in the dendrogram, this heat maps show two large squares of low-distance coloring (purple to dark blue) along the diagonal downward and to the right. These square blocks of proximity indicate clusters similarity among the organizations.</p>
<p>Interesting, there is visually a third square of low distance that suggests the YIMBY Action, Sierra Club, and SF Housing Action Coalition (and cluster relatives) are in a slightly different set than the SF Democratic Party, The Harvey Milk LGBTQ Democratic Club, and GrowSF.</p>
<p>Also clearly shown on this heatmap is how divergent the SF Young Republicans and the SF Republican Party are from any other organization analyzed. For example, the NOE Valley Democratic Club is closer (in clustering distance) to the SF Young Republicans and the SF Republican Party than the latter two are to each other.</p>
</section>
<section id="political-organization-distance-table-for-candidate-recs" class="level4">
<h4 class="anchored" data-anchor-id="political-organization-distance-table-for-candidate-recs">Political organization distance table (for candidate recs)</h4>
<p>Use the table below to filer, sort, and rank the clustering model’s distance to make your own comparisons.</p>
<div class="cell">
<div id="tbl-org-cand-dis" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-org-cand-dis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;6: Table of unique political organization pairs, sorted by clustering proximity on endorsement
</figcaption>
<div aria-describedby="tbl-org-cand-dis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-2866662a9e83744d5a76" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-2866662a9e83744d5a76">{"x":{"filter":"none","vertical":false,"extensions":["FixedColumns","FixedHeader"],"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206","207","208","209","210","211","212","213","214","215","216","217","218","219","220","221","222","223","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","255","256","257","258","259","260","261","262","263","264","265","266","267","268","269","270","271","272","273","274","275","276","277","278","279","280","281","282","283","284","285","286","287","288","289","290","291","292","293","294","295","296","297","298","299","300","301","302","303","304","305","306","307","308","309","310","311","312","313","314","315","316","317","318","319","320","321","322","323","324","325","326","327","328","329","330","331","332","333","334","335","336","337","338","339","340","341","342","343","344","345","346","347","348","349","350","351","352","353","354","355","356","357","358","359","360","361","362","363","364","365","366","367","368","369","370","371","372","373","374","375","376","377","378","379","380","381","382","383","384","385","386","387","388","389","390","391","392","393","394","395","396","397","398","399","400","401","402","403","404","405","406"],["Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Democratic Party (SF)","District 11 Democratic Club","Alice B. Toklas LGBT Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Harvey Milk LGBTQ Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","SEIU 1021","SF Berniecrats","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Alice B. Toklas LGBT Democratic Club","SF Women's Political Committee","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","San Francisco Bay Guardian","San Francisco Chronicle","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","United Democratic Club","Alice B. Toklas LGBT Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Democratic Party (SF)","District 11 Democratic Club","Bernal Heights Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Harvey Milk LGBTQ Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","SEIU 1021","SF Berniecrats","Bernal Heights Democratic Club","Bernal Heights Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Bernal Heights Democratic Club","SF Women's Political Committee","Bernal Heights Democratic Club","Bernal Heights Democratic Club","San Francisco Bay Guardian","San Francisco Chronicle","Bernal Heights Democratic Club","Bernal Heights Democratic Club","United Democratic Club","Bernal Heights Democratic Club","Chinese American Democratic Club","Democratic Party (SF)","District 11 Democratic Club","Chinese American Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Harvey Milk LGBTQ Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","SEIU 1021","SF Berniecrats","Chinese American Democratic Club","Chinese American Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Chinese American Democratic Club","SF Women's Political Committee","Chinese American Democratic Club","Chinese American Democratic Club","San Francisco Bay Guardian","San Francisco Chronicle","Chinese American Democratic Club","Chinese American Democratic Club","United Democratic Club","Chinese American Democratic Club","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","San Francisco Chronicle","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","Democratic Party (SF)","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","SEIU 1021","SF Berniecrats","District 11 Democratic Club","District 11 Democratic Club","SF League of Pissed Off Voters","SF Republican Party","District 11 Democratic Club","SF Women's Political Committee","District 11 Democratic Club","District 11 Democratic Club","San Francisco Bay Guardian","San Francisco Chronicle","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","District 11 Democratic Club","Eastern Neighborhoods Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Harvey Milk LGBTQ Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","SEIU 1021","SF Berniecrats","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Eastern Neighborhoods Democratic Club","SF Women's Political Committee","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","San Francisco Bay Guardian","San Francisco Chronicle","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","United Democratic Club","Eastern Neighborhoods Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Harvey Milk LGBTQ Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","SEIU 1021","SF Berniecrats","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Ed M. Lee Asian Pacific Democratic Club","SF Women's Political Committee","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","San Francisco Bay Guardian","San Francisco Chronicle","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","United Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","SEIU 1021","SF Berniecrats","Green Party (SF)","Green Party (SF)","SF League of Pissed Off Voters","SF Republican Party","Green Party (SF)","SF Women's Political Committee","SF Young Democrats","SF Young Republicans","San Francisco Bay Guardian","San Francisco Chronicle","San Francisco Rising Action","Green Party (SF)","United Democratic Club","YIMBY Action","GrowSF","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","SEIU 1021","SF Berniecrats","GrowSF","GrowSF","SF League of Pissed Off Voters","SF Republican Party","GrowSF","SF Women's Political Committee","SF Young Democrats","SF Young Republicans","San Francisco Bay Guardian","San Francisco Chronicle","San Francisco Rising Action","GrowSF","United Democratic Club","YIMBY Action","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","SEIU 1021","SF Berniecrats","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Harvey Milk LGBTQ Democratic Club","SF Women's Political Committee","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","San Francisco Bay Guardian","San Francisco Chronicle","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","SEIU 1021","SF Berniecrats","Home Sharers Democratic Club","Home Sharers Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Home Sharers Democratic Club","SF Women's Political Committee","SF Young Democrats","Home Sharers Democratic Club","San Francisco Bay Guardian","San Francisco Chronicle","Home Sharers Democratic Club","Home Sharers Democratic Club","United Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","SEIU 1021","SF Berniecrats","Noe Valley Democratic Club","Noe Valley Democratic Club","SF League of Pissed Off Voters","SF Republican Party","Noe Valley Democratic Club","SF Women's Political Committee","Noe Valley Democratic Club","Noe Valley Democratic Club","San Francisco Bay Guardian","San Francisco Chronicle","Noe Valley Democratic Club","Noe Valley Democratic Club","United Democratic Club","Noe Valley Democratic Club","SEIU 1021","SF Berniecrats","SEIU 1021","SEIU 1021","SF League of Pissed Off Voters","SEIU 1021","SEIU 1021","SEIU 1021","SEIU 1021","SEIU 1021","SEIU 1021","SEIU 1021","SEIU 1021","SF Berniecrats","SF Berniecrats","SF Berniecrats","SF League of Pissed Off Voters","SF Berniecrats","SF Berniecrats","SF Berniecrats","SF Berniecrats","SF Berniecrats","SF Berniecrats","SF Berniecrats","SF Berniecrats","SF Housing Action Coalition","SF Housing Action Coalition","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SF Young Democrats","SF Young Republicans","Sierra Club","United Democratic Club","YIMBY Action","SF Labor Council","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SF Young Democrats","SF Young Republicans","Sierra Club","United Democratic Club","YIMBY Action","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF League of Pissed Off Voters","SF Republican Party","SF Republican Party","SF Women's Political Committee","SF Republican Party","SF Republican Party","SF Republican Party","SF Republican Party","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SF Young Democrats","SF Young Republicans","SF Tenants Union","United Democratic Club","YIMBY Action","SF Women's Political Committee","SF Women's Political Committee","SF Women's Political Committee","SF Women's Political Committee","SF Women's Political Committee","SF Women's Political Committee","SF Young Democrats","SF Young Democrats","SF Young Democrats","United Democratic Club","SF Young Democrats","SF Young Republicans","SF Young Republicans","United Democratic Club","SF Young Republicans","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Chronicle","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","San Francisco Chronicle","SEIU 1021","SF Berniecrats","San Francisco Rising Action","San Francisco Rising Action","SF League of Pissed Off Voters","SF Republican Party","San Francisco Rising Action","SF Women's Political Committee","SF Young Democrats","SF Young Republicans","San Francisco Rising Action","San Francisco Rising Action","United Democratic Club","San Francisco Rising Action","Sierra Club","United Democratic Club","YIMBY Action","United Democratic Club","United Democratic Club","YIMBY Action"],["Alice B. Toklas LGBT Democratic Club","Bernal Heights Democratic Club","Chinese American Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","Eastern Neighborhoods Democratic Club","Alice B. Toklas LGBT Democratic Club","Green Party (SF)","GrowSF","Alice B. Toklas LGBT Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","SF Housing Action Coalition","SF Labor Council","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","SF Tenants Union","Alice B. Toklas LGBT Democratic Club","SF Young Democrats","SF Young Republicans","Alice B. Toklas LGBT Democratic Club","Alice B. Toklas LGBT Democratic Club","San Francisco Rising Action","Sierra Club","Alice B. Toklas LGBT Democratic Club","YIMBY Action","Bernal Heights Democratic Club","Chinese American Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","Eastern Neighborhoods Democratic Club","Bernal Heights Democratic Club","Green Party (SF)","GrowSF","Bernal Heights Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Bernal Heights Democratic Club","Bernal Heights Democratic Club","SF Housing Action Coalition","SF Labor Council","Bernal Heights Democratic Club","Bernal Heights Democratic Club","SF Tenants Union","Bernal Heights Democratic Club","SF Young Democrats","SF Young Republicans","Bernal Heights Democratic Club","Bernal Heights Democratic Club","San Francisco Rising Action","Sierra Club","Bernal Heights Democratic Club","YIMBY Action","Chinese American Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","Eastern Neighborhoods Democratic Club","Chinese American Democratic Club","Green Party (SF)","GrowSF","Chinese American Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Chinese American Democratic Club","Chinese American Democratic Club","SF Housing Action Coalition","SF Labor Council","Chinese American Democratic Club","Chinese American Democratic Club","SF Tenants Union","Chinese American Democratic Club","SF Young Democrats","SF Young Republicans","Chinese American Democratic Club","Chinese American Democratic Club","San Francisco Rising Action","Sierra Club","Chinese American Democratic Club","YIMBY Action","Democratic Party (SF)","District 11 Democratic Club","Eastern Neighborhoods Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SF Young Democrats","SF Young Republicans","San Francisco Bay Guardian","Democratic Party (SF)","San Francisco Rising Action","Sierra Club","United Democratic Club","YIMBY Action","District 11 Democratic Club","Eastern Neighborhoods Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","District 11 Democratic Club","District 11 Democratic Club","SF Housing Action Coalition","SF Labor Council","District 11 Democratic Club","District 11 Democratic Club","SF Tenants Union","District 11 Democratic Club","SF Young Democrats","SF Young Republicans","District 11 Democratic Club","District 11 Democratic Club","San Francisco Rising Action","Sierra Club","United Democratic Club","YIMBY Action","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","Green Party (SF)","GrowSF","Eastern Neighborhoods Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","SF Housing Action Coalition","SF Labor Council","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","SF Tenants Union","Eastern Neighborhoods Democratic Club","SF Young Democrats","SF Young Republicans","Eastern Neighborhoods Democratic Club","Eastern Neighborhoods Democratic Club","San Francisco Rising Action","Sierra Club","Eastern Neighborhoods Democratic Club","YIMBY Action","Ed M. Lee Asian Pacific Democratic Club","Green Party (SF)","GrowSF","Ed M. Lee Asian Pacific Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","SF Housing Action Coalition","SF Labor Council","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","SF Tenants Union","Ed M. Lee Asian Pacific Democratic Club","SF Young Democrats","SF Young Republicans","Ed M. Lee Asian Pacific Democratic Club","Ed M. Lee Asian Pacific Democratic Club","San Francisco Rising Action","Sierra Club","Ed M. Lee Asian Pacific Democratic Club","YIMBY Action","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","SF Housing Action Coalition","SF Labor Council","Green Party (SF)","Green Party (SF)","SF Tenants Union","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Green Party (SF)","Sierra Club","Green Party (SF)","Green Party (SF)","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","SF Housing Action Coalition","SF Labor Council","GrowSF","GrowSF","SF Tenants Union","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","GrowSF","Sierra Club","GrowSF","GrowSF","Harvey Milk LGBTQ Democratic Club","Home Sharers Democratic Club","Noe Valley Democratic Club","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","SF Housing Action Coalition","SF Labor Council","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","SF Tenants Union","Harvey Milk LGBTQ Democratic Club","SF Young Democrats","SF Young Republicans","Harvey Milk LGBTQ Democratic Club","Harvey Milk LGBTQ Democratic Club","San Francisco Rising Action","Sierra Club","United Democratic Club","YIMBY Action","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","Home Sharers Democratic Club","SF Housing Action Coalition","SF Labor Council","Home Sharers Democratic Club","Home Sharers Democratic Club","SF Tenants Union","Home Sharers Democratic Club","Home Sharers Democratic Club","SF Young Republicans","Home Sharers Democratic Club","Home Sharers Democratic Club","San Francisco Rising Action","Sierra Club","Home Sharers Democratic Club","YIMBY Action","Noe Valley Democratic Club","Noe Valley Democratic Club","Noe Valley Democratic Club","SF Housing Action Coalition","SF Labor Council","Noe Valley Democratic Club","Noe Valley Democratic Club","SF Tenants Union","Noe Valley Democratic Club","SF Young Democrats","SF Young Republicans","Noe Valley Democratic Club","Noe Valley Democratic Club","San Francisco Rising Action","Sierra Club","Noe Valley Democratic Club","YIMBY Action","SEIU 1021","SEIU 1021","SF Housing Action Coalition","SF Labor Council","SEIU 1021","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SF Young Democrats","SF Young Republicans","Sierra Club","United Democratic Club","YIMBY Action","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF Berniecrats","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SF Young Democrats","SF Young Republicans","Sierra Club","United Democratic Club","YIMBY Action","SF Housing Action Coalition","SF Labor Council","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Housing Action Coalition","SF Labor Council","SF Labor Council","SF Labor Council","SF Labor Council","SF Labor Council","SF Labor Council","SF Labor Council","SF Labor Council","SF Labor Council","SF Labor Council","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SF Young Democrats","SF Young Republicans","Sierra Club","United Democratic Club","YIMBY Action","SF Republican Party","SF Tenants Union","SF Republican Party","SF Young Democrats","SF Young Republicans","Sierra Club","United Democratic Club","YIMBY Action","SF Tenants Union","SF Tenants Union","SF Tenants Union","SF Tenants Union","Sierra Club","SF Tenants Union","SF Tenants Union","SF Women's Political Committee","SF Young Democrats","SF Young Republicans","Sierra Club","United Democratic Club","YIMBY Action","SF Young Democrats","SF Young Republicans","Sierra Club","SF Young Democrats","YIMBY Action","SF Young Republicans","Sierra Club","SF Young Republicans","YIMBY Action","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SF Young Democrats","SF Young Republicans","San Francisco Bay Guardian","San Francisco Bay Guardian","San Francisco Rising Action","Sierra Club","United Democratic Club","YIMBY Action","SEIU 1021","SF Berniecrats","SF Housing Action Coalition","SF Labor Council","SF League of Pissed Off Voters","SF Republican Party","SF Tenants Union","SF Women's Political Committee","SF Young Democrats","SF Young Republicans","San Francisco Chronicle","San Francisco Rising Action","Sierra Club","United Democratic Club","YIMBY Action","San Francisco Rising Action","San Francisco Rising Action","SF Housing Action Coalition","SF Labor Council","San Francisco Rising Action","San Francisco Rising Action","SF Tenants Union","San Francisco Rising Action","San Francisco Rising Action","San Francisco Rising Action","San Francisco Rising Action","Sierra Club","San Francisco Rising Action","YIMBY Action","Sierra Club","Sierra Club","Sierra Club","United Democratic Club","YIMBY Action","YIMBY Action"],[0,0.45,0.0327,0.203,0.473,0.0878,0.0839,0.574,0.135,0.192,0.267,0.234,0.272,0.525,0.337,0.5610000000000001,0.45,0.518,0.5610000000000001,0.369,0.154,0.918,0.45,0.551,0.478,0.337,0.0839,0.337,0,0.386,0.315,0.0959,0.487,0.633,0.119,0.407,0.176,0.612,0.391,0.469,0.09180000000000001,0.391,0.0516,0,0.58,0.0516,0.0427,0.433,0.664,0,0.145,0.126,0.391,0.633,0.391,0,0.251,0.407,0.0516,0.122,0.499,0.0959,0.238,0.32,0.188,0.223,0.455,0.283,0.487,0.386,0.448,0.487,0.312,0.197,0.8080000000000001,0.386,0.479,0.412,0.283,0.122,0.283,0,0.179,0.179,0.235,0.329,0.235,0.0989,0.222,0.23,0.167,0.377,0.222,0.235,0.315,0.835,0.235,0.248,0.191,0.6889999999999999,0.315,0.298,0.541,0.222,0.235,0.222,0,0.316,0.52,0.106,0.386,0.191,0.501,0.24,0.302,0.207,0.371,0.04,0.0959,0.665,0.04,0.147,0.455,0.555,0.0959,0.189,0.249,0.371,0.52,0.371,0,0.113,0.397,0.04,0.319,0.307,0.122,0.154,0.5669999999999999,0.207,0.386,0.487,0.436,0.386,0.402,0.272,0.661,0.487,0.465,0.517,0.207,0.113,0.207,0,0.628,0.163,0.313,0.154,0.267,0.307,0.73,0.376,0.614,0.633,0.546,0.614,0.531,0.267,0.999,0.633,0.581,0.669,0.376,0,0.376,0,0.325,0.344,0.46,0.311,0.271,0.235,0.212,0.0607,0.119,0.578,0.0607,0.173,0.416,0.414,0.119,0.217,0.115,0.212,0.628,0.212,0,0.389,0.376,0.173,0.207,0.478,0.154,0.316,0.407,0.36,0.316,0.33,0.337,0.642,0.407,0.387,0.434,0.154,0.163,0.154,0,0.299,0.242,0.304,0.305,0.373,0.248,0.176,0.725,0.248,0.235,0.18,0.873,0.176,0.382,0.353,0.373,0.313,0.373,0,0.263,0.113,0.705,0.163,0.593,0.612,0.947,0.593,0.512,0.0839,0.579,0.612,0.5600000000000001,0.366,0.163,0.154,0.163,0,0.119,0.576,0.169,0.302,0.391,0.493,0.302,0.475,0.23,0.513,0.391,0.546,0.302,0.169,0.267,0.169,0,0.547,0.04,0.371,0.469,0.775,0.371,0.386,0.0878,0.36,0.04,0.307,0.04,0,0.46,0.154,0.09180000000000001,0.822,0.154,0.08110000000000001,0.506,0.714,0.46,0.73,0.46,0,0.302,0.391,0.662,0.302,0.316,0.135,0.347,0,0.376,0,0,0.0516,0.5649999999999999,0,0.0989,0.541,0.538,0.302,0.614,0.302,0,0.58,0.0516,0.0427,0.433,0.664,0.391,0.633,0.391,0,0.5649999999999999,0.6889999999999999,0.903,0.832,0.662,0.546,0.662,0,0.0989,0.541,0.538,0.302,0.614,0.302,0,0.353,0.639,0.316,0.531,0.316,0,0.528,0.135,0.267,0.135,0,0.347,0.999,0.347,0.469,0.09180000000000001,0.391,0.0516,0,0.58,0.0516,0.0427,0.433,0.664,0,0.145,0.126,0.391,0.633,0.391,0.448,0.192,0.372,0.137,0.145,0.736,0.137,0.0941,0.532,0.726,0,0.313,0.372,0.581,0.372,0.262,0.243,0.204,0.191,0.126,0.614,0.191,0.18,0.235,0.403,0,0.204,0.669,0.204,0,0.376,0,0,0.376,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>org<\/th>\n      <th>org2<\/th>\n      <th>proximity<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"paging":true,"fixedHeader":true,"fixedHeight":true,"columnDefs":[{"className":"dt-right","targets":3},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"org","targets":1},{"name":"org2","targets":2},{"name":"proximity","targets":3}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</figure>
</div>
</div>
</section>
</section>
<section id="remarks-on-clustering-by-candidate-endorsement" class="level3">
<h3 class="anchored" data-anchor-id="remarks-on-clustering-by-candidate-endorsement">Remarks on clustering by candidate endorsement</h3>
<p>The race endorsements data set contains more options in general, allowing each organization for vary significantly in its character. We see this born out in the clustering dendrogram with more divergent clusters than seen in the ballot measure analysis.</p>
<p>While the candidate endorsement clustering didn’t reveal any surprising similarities (in the author’s opinion), it did show how divergent the SF Republican Party and the SF Young Republicans are from the rest of the organizations, in terms of candidate endorsements.</p>
</section>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<p>The nominal clustering analysis worked well at identifying similar groups and quantifying relative similarity. One weakness of this clustering analysis is that it weights all ballot measures and races as the same. For an individual voter, some topics and races may have more salience or effect, and this analysis cannot take that into account.</p>
<p>Broadly, these results support the idea that an empirical approach can reveal more about the character of an organization than the words in its name, and that this analysis is useful for determining action-based political alignment.</p>


</section>
</section>

 ]]></description>
  <category>politics</category>
  <guid>https://pdcherry.github.io/posts/2024_03_02-SF_political_support_data.html</guid>
  <pubDate>Sun, 03 Mar 2024 08:00:00 GMT</pubDate>
  <media:content url="https://pdcherry.github.io/posts/2024_03_02-SF_political_support_data/2024_03_02-San_Francisco_and_Bay.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>San Francisco tree classification model</title>
  <dc:creator>Patrick Cherry</dc:creator>
  <link>https://pdcherry.github.io/posts/2024_02_10-SF_tree_classification.html</link>
  <description><![CDATA[ 





<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_02_10-SF_tree_classification.jpg" class="img-fluid figure-img"></p>
<figcaption>A purple-leaf plum (Prunus cerasifera ‘Krauter Vesuvius’) tree bluming along a hilly San Francisco street</figcaption>
</figure>
</div>
<p>The goal is the make a predictor of whether a tree tracked in San Francisco is a Department of Public Works maintained legal status tree, or some other legal status.</p>
<section id="get-data" class="level1">
<h1>Get data</h1>
<p>This is a 2020-01-28 <a href="https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-01-28/readme.md">Tidy Tuesday</a> dataset. These data are from the San Francisco Public Works’ Bureau of Urban Forestry.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">sftrees <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-01-28/sf_trees.csv"</span>,</span>
<span id="cb1-2">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_col_types =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span></code></pre></div>
</div>
</section>
<section id="preliminary-exploration-of-data" class="level1">
<h1>Preliminary exploration of data</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(sftrees)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["tree_id"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["legal_status"],"name":[2],"type":["chr"],"align":["left"]},{"label":["species"],"name":[3],"type":["chr"],"align":["left"]},{"label":["address"],"name":[4],"type":["chr"],"align":["left"]},{"label":["site_order"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["site_info"],"name":[6],"type":["chr"],"align":["left"]},{"label":["caretaker"],"name":[7],"type":["chr"],"align":["left"]},{"label":["date"],"name":[8],"type":["date"],"align":["right"]},{"label":["dbh"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["plot_size"],"name":[10],"type":["chr"],"align":["left"]},{"label":["latitude"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["longitude"],"name":[12],"type":["dbl"],"align":["right"]}],"data":[{"1":"53719","2":"Permitted Site","3":"Tree(s) ::","4":"2963 Webster St","5":"1","6":"Sidewalk: Curb side : Cutout","7":"Private","8":"1955-09-19","9":"NA","10":"NA","11":"37.79787","12":"-122.4341"},{"1":"30313","2":"Permitted Site","3":"Tree(s) ::","4":"501 Arkansas St","5":"3","6":"Sidewalk: Curb side : Cutout","7":"Private","8":"1955-10-20","9":"NA","10":"NA","11":"37.75984","12":"-122.3981"},{"1":"30312","2":"Permitted Site","3":"Tree(s) ::","4":"501 Arkansas St","5":"2","6":"Sidewalk: Curb side : Cutout","7":"Private","8":"1955-10-20","9":"NA","10":"NA","11":"37.75984","12":"-122.3981"},{"1":"30314","2":"DPW Maintained","3":"Pittosporum undulatum :: Victorian Box","4":"501 Arkansas St","5":"1","6":"Sidewalk: Curb side : Cutout","7":"Private","8":"1955-10-20","9":"16","10":"NA","11":"37.75977","12":"-122.3981"},{"1":"30315","2":"Permitted Site","3":"Acacia melanoxylon :: Blackwood Acacia","4":"1190 Sacramento St","5":"5","6":"Sidewalk: Curb side : Cutout","7":"Private","8":"1955-10-24","9":"NA","10":"NA","11":"37.79265","12":"-122.4124"},{"1":"30316","2":"Permitted Site","3":"Acacia melanoxylon :: Blackwood Acacia","4":"1190 Sacramento St","5":"6","6":"Sidewalk: Curb side : Cutout","7":"Private","8":"1955-10-24","9":"NA","10":"NA","11":"37.79265","12":"-122.4124"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<section id="legal-status" class="level2">
<h2 class="anchored" data-anchor-id="legal-status">Legal status</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">sftrees <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(legal_status, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sort =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">percent =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>( n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["legal_status"],"name":[1],"type":["chr"],"align":["left"]},{"label":["n"],"name":[2],"type":["int"],"align":["right"]},{"label":["percent"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"DPW Maintained","2":"141725","3":"73.4"},{"1":"Permitted Site","2":"39732","3":"20.6"},{"1":"Undocumented","2":"8106","3":"4.2"},{"1":"Significant Tree","2":"1648","3":"0.9"},{"1":"Planning Code 138.1 required","2":"971","3":"0.5"},{"1":"Property Tree","2":"316","3":"0.2"},{"1":"Section 143","2":"230","3":"0.1"},{"1":"Private","2":"163","3":"0.1"},{"1":"NA","2":"54","3":"0.0"},{"1":"Landmark tree","2":"42","3":"0.0"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">sftrees <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(legal_status, caretaker, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sort =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["legal_status"],"name":[1],"type":["chr"],"align":["left"]},{"label":["caretaker"],"name":[2],"type":["chr"],"align":["left"]},{"label":["n"],"name":[3],"type":["int"],"align":["right"]}],"data":[{"1":"DPW Maintained","2":"Private","3":"113102"},{"1":"Permitted Site","2":"Private","3":"38312"},{"1":"DPW Maintained","2":"DPW","3":"26963"},{"1":"Undocumented","2":"Private","3":"7463"},{"1":"Significant Tree","2":"Private","3":"1505"},{"1":"Planning Code 138.1 required","2":"Private","3":"947"},{"1":"DPW Maintained","2":"SFUSD","3":"898"},{"1":"Permitted Site","2":"Port","3":"536"},{"1":"DPW Maintained","2":"Rec/Park","3":"281"},{"1":"Permitted Site","2":"Rec/Park","3":"262"},{"1":"Section 143","2":"Private","3":"229"},{"1":"Permitted Site","2":"PUC","3":"208"},{"1":"Property Tree","2":"Private","3":"202"},{"1":"Undocumented","2":"DPW","3":"200"},{"1":"DPW Maintained","2":"Port","3":"182"},{"1":"Undocumented","2":"Rec/Park","3":"165"},{"1":"Private","2":"Private","3":"155"},{"1":"DPW Maintained","2":"DPW for City Agency","3":"111"},{"1":"Undocumented","2":"SFUSD","3":"100"},{"1":"Permitted Site","2":"Purchasing Dept","3":"81"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>So the <code>legal_status</code> of “DPW Maintained” does not equate with a <code>caretaker</code> of “DPW”—in fact, most of the time, DPW-legal status trees are privately taken care of.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">col_plot_legalstatus_by_caretaker <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sftrees <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(legal_status, caretaker) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_count</span>(caretaker, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">wt =</span> n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"caretaker_count"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(caretaker_count <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(legal_status) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">percent_legal =</span> n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(percent_legal, caretaker, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> legal_status)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodge"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_viridis_d</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">begin =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">end =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.value =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"proportion of trees in each category"</span>)</span>
<span id="cb5-11">col_plot_legalstatus_by_caretaker</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_02_10-SF_tree_classification_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="nas-in-data" class="level2">
<h2 class="anchored" data-anchor-id="nas-in-data">NAs in data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">sftrees <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>(), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(.x))),</span>
<span id="cb6-3">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relocate</span>(n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.name_repair =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"minimal"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rownames =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"col_name"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["col_name"],"name":[1],"type":["chr"],"align":["left"]},{"label":[""],"name":[2],"type":["int"],"align":["right"]}],"data":[{"1":"n","2":"192987"},{"1":"tree_id","2":"0"},{"1":"legal_status","2":"54"},{"1":"species","2":"0"},{"1":"address","2":"1487"},{"1":"site_order","2":"1634"},{"1":"site_info","2":"0"},{"1":"caretaker","2":"0"},{"1":"date","2":"124610"},{"1":"dbh","2":"41819"},{"1":"plot_size","2":"50013"},{"1":"latitude","2":"2832"},{"1":"longitude","2":"2832"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Instead of using <code>glimpse()</code>, I’m using R’s native <code>t()</code>, or transpose, to print the results lengthwise instead of as columns across the page. The <code>n</code> row at the start shows how many rows are in the dataframe; the other named columns show how many <code>NA</code>s are in the data in each column. The <code>date</code> and <code>dhb</code> <a href="https://en.wikipedia.org/wiki/Diameter_at_breast_height">(Diameter at breast height)</a> columns show significant levels of NAs (64.5% and 21.7%, respectively).</p>
</section>
<section id="species" class="level2">
<h2 class="anchored" data-anchor-id="species">Species</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">sftrees <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(species, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sort =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rank"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["species"],"name":[1],"type":["chr"],"align":["left"]},{"label":["n"],"name":[2],"type":["int"],"align":["right"]},{"label":["rank"],"name":[3],"type":["int"],"align":["right"]}],"data":[{"1":"Tree(s) ::","2":"11629","3":"1"},{"1":"Platanus x hispanica :: Sycamore: London Plane","2":"11557","3":"2"},{"1":"Metrosideros excelsa :: New Zealand Xmas Tree","2":"8744","3":"3"},{"1":"Lophostemon confertus :: Brisbane Box","2":"8581","3":"4"},{"1":"Tristaniopsis laurina :: Swamp Myrtle","2":"7197","3":"5"},{"1":"Pittosporum undulatum :: Victorian Box","2":"7122","3":"6"},{"1":"Prunus cerasifera :: Cherry Plum","2":"6716","3":"7"},{"1":"Magnolia grandiflora :: Southern Magnolia","2":"6285","3":"8"},{"1":"Arbutus 'Marina' :: Hybrid Strawberry Tree","2":"5702","3":"9"},{"1":"Ficus microcarpa nitida 'Green Gem' :: Indian Laurel Fig Tree 'Green Gem'","2":"5624","3":"10"},{"1":"Prunus serrulata 'Kwanzan' :: Kwanzan Flowering Cherry","2":"4025","3":"11"},{"1":"Acacia melanoxylon :: Blackwood Acacia","2":"3956","3":"12"},{"1":"Maytenus boaria :: Mayten","2":"3899","3":"13"},{"1":"Olea europaea :: Olive Tree","2":"3694","3":"14"},{"1":"Corymbia ficifolia :: Red Flowering Gum","2":"3575","3":"15"},{"1":"Callistemon citrinus :: Lemon Bottlebrush","2":"3266","3":"16"},{"1":"Ginkgo biloba :: Maidenhair Tree","2":"3212","3":"17"},{"1":"Pyrus calleryana :: Ornamental Pear","2":"2969","3":"18"},{"1":"Prunus serrulata :: Ornamental Cherry","2":"2696","3":"19"},{"1":"Eriobotrya deflexa :: Bronze Loquat","2":"2402","3":"20"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">sftrees <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(species, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sort =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_observations"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(n_observations, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_tree_species"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["n_observations"],"name":[1],"type":["int"],"align":["right"]},{"label":["n_tree_species"],"name":[2],"type":["int"],"align":["right"]}],"data":[{"1":"1","2":"67"},{"1":"2","2":"44"},{"1":"3","2":"25"},{"1":"4","2":"29"},{"1":"5","2":"17"},{"1":"6","2":"16"},{"1":"7","2":"11"},{"1":"8","2":"9"},{"1":"9","2":"13"},{"1":"10","2":"7"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">col_plot_tree_species <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sftrees <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"species"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_rev</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_infreq</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(species), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">w =</span> n))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> species, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> species)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_viridis_d</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">begin =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">end =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.value =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_flip</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of trees"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Species"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>,</span>
<span id="cb9-11">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb9-12">col_plot_tree_species</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_02_10-SF_tree_classification_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From this distribution of tree species with 400 or more trees, we can see some species data quality issues. The observation “trees(s)::” for <code>species</code> is the most abundant classification, which really isn’t a classification at all. The 26th most common species observation is “::”, so no data at all.</p>
<p>In this San Francisco data, the most common tree is the Sycamore: London Plane (<em>Platanus x hispanica</em>) with 11557. I personally like the Cherry Plum tree (<em>Prunus cerasifera</em>), which is 7th with 6716 trees. Interestingly, there are lots of Southern Magnolia trees (<em>Magnolia grandiflora</em>), in 8th place with 6285.</p>
<p>Also interestingly, there are 67 tree species with one individual in the data set. And 44 species with just 2 individuals. There are lots of lone or near-lone tree species in San Francisco.</p>
<section id="what-about-tree-family" class="level3">
<h3 class="anchored" data-anchor-id="what-about-tree-family">What about tree family?</h3>
<p>We could perhaps call the tree family, or ‘spp’ based on the final word in the <code>species</code> data column.</p>
<p>A lot of common species names end in “tree”, so I will accommodate that by writing a special regex that will pull the next to last word if the last word is “tree”. Also, some trees are</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">sftrees <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tree_family"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_extract</span>(species, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">w+(?=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">s(T|t)ree))|(</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">w+)$"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use above regex to get next to last word when last word is tree</span></span>
<span id="cb10-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># also, don't keep "tree" text, because some species are coded as both with</span></span>
<span id="cb10-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and without tree at the end; this regex collapses those irregularities</span></span>
<span id="cb10-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(tree_family, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sort =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rank"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["tree_family"],"name":[1],"type":["chr"],"align":["left"]},{"label":["n"],"name":[2],"type":["int"],"align":["right"]},{"label":["rank"],"name":[3],"type":["int"],"align":["right"]}],"data":[{"1":"NA","2":"18225","3":"1"},{"1":"Box","2":"15718","3":"2"},{"1":"Plane","2":"11680","3":"3"},{"1":"Fig","2":"8770","3":"4"},{"1":"Xmas","2":"8744","3":"5"},{"1":"Magnolia","2":"8534","3":"6"},{"1":"Cherry","2":"7811","3":"7"},{"1":"Plum","2":"7398","3":"8"},{"1":"Myrtle","2":"7301","3":"9"},{"1":"Strawberry","2":"6334","3":"10"},{"1":"Gum","2":"6053","3":"11"},{"1":"Pear","2":"5922","3":"12"},{"1":"Palm","2":"5435","3":"13"},{"1":"Acacia","2":"5142","3":"14"},{"1":"Pine","2":"4440","3":"15"},{"1":"Bottlebrush","2":"4216","3":"16"},{"1":"Olive","2":"4013","3":"17"},{"1":"Mayten","2":"3899","3":"18"},{"1":"Elm","2":"3301","3":"19"},{"1":"Maidenhair","2":"3250","3":"20"},{"1":"Loquat","2":"2639","3":"21"},{"1":"Privet","2":"2353","3":"22"},{"1":"Maple","2":"2310","3":"23"},{"1":"Cypress","2":"2269","3":"24"},{"1":"Karo","2":"1795","3":"25"},{"1":"Cajeput","2":"1736","3":"26"},{"1":"Myoporum","2":"1590","3":"27"},{"1":"Eucalyptus","2":"1568","3":"28"},{"1":"Willow","2":"1470","3":"29"},{"1":"Pepper","2":"1409","3":"30"},{"1":"Juniper","2":"1405","3":"31"},{"1":"Hawthorn","2":"1386","3":"32"},{"1":"Oak","2":"1315","3":"33"},{"1":"Jacaranda","2":"1170","3":"34"},{"1":"Ash","2":"1123","3":"35"},{"1":"Tea","2":"1117","3":"36"},{"1":"Primrose","2":"1077","3":"37"},{"1":"Spp","2":"1000","3":"38"},{"1":"Banyan","2":"966","3":"39"},{"1":"Laurel","2":"941","3":"40"},{"1":"Carob","2":"855","3":"41"},{"1":"Bush","2":"790","3":"42"},{"1":"Ironbark","2":"718","3":"43"},{"1":"Buckthorn","2":"621","3":"44"},{"1":"Ironwood","2":"548","3":"45"},{"1":"Sycamore","2":"512","3":"46"},{"1":"Locust","2":"476","3":"47"},{"1":"Paperbark","2":"454","3":"48"},{"1":"Pistache","2":"428","3":"49"},{"1":"Melaleuca","2":"402","3":"50"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Based on pseudo-“family” classification, the Box tree is the most common tree family observed, followed by the Plane, and then Fig, “Xmas,” Magnolia, Cheery, Plum, Myrtle, Strawberry, Gum, and Pear families of trees.</p>
</section>
</section>
<section id="plot_size" class="level2">
<h2 class="anchored" data-anchor-id="plot_size">plot_size</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">sftrees <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(plot_size, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sort =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["plot_size"],"name":[1],"type":["chr"],"align":["left"]},{"label":["n"],"name":[2],"type":["int"],"align":["right"]}],"data":[{"1":"NA","2":"50013"},{"1":"Width 3ft","2":"36343"},{"1":"3x3","2":"29166"},{"1":"Width 0ft","2":"17017"},{"1":"Width 4ft","2":"13745"},{"1":"3X3","2":"12073"},{"1":"Width 2ft","2":"7363"},{"1":"Width 5ft","2":"4547"},{"1":"4X4","2":"2761"},{"1":"Width 6ft","2":"2455"},{"1":"4x4","2":"2232"},{"1":"Width 8ft","2":"1475"},{"1":"Width 10ft","2":"1361"},{"1":"60","2":"782"},{"1":"Width 1ft","2":"645"},{"1":"3X4","2":"628"},{"1":"Width 7ft","2":"503"},{"1":"5x5","2":"483"},{"1":"10","2":"378"},{"1":"20","2":"375"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="prepare-data-for-model" class="level2">
<h2 class="anchored" data-anchor-id="prepare-data-for-model">Prepare data for model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">trees_formodel <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sftrees <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#trees_df</span></span>
<span id="cb12-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb12-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"legal_status"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb12-4">      legal_status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DPW Maintained"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> legal_status,</span>
<span id="cb12-5">      <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Other"</span>),</span>
<span id="cb12-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plot_size"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_number</span>(plot_size)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>address) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">na.omit</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate_if</span>(is.character, factor)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There was 1 warning in `mutate()`.
ℹ In argument: `plot_size = parse_number(plot_size)`.
Caused by warning:
! 109 parsing failures.
  row col expected actual
10979  -- a number    TR 
13245  -- a number    CUT
13495  -- a number    TR 
13501  -- a number    TR 
13502  -- a number    TR 
..... ... ........ ......
See problems(...) for more details.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(trees_formodel)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["tree_id"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["legal_status"],"name":[2],"type":["fct"],"align":["left"]},{"label":["species"],"name":[3],"type":["fct"],"align":["left"]},{"label":["site_order"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["site_info"],"name":[5],"type":["fct"],"align":["left"]},{"label":["caretaker"],"name":[6],"type":["fct"],"align":["left"]},{"label":["date"],"name":[7],"type":["date"],"align":["right"]},{"label":["dbh"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["plot_size"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["latitude"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["longitude"],"name":[11],"type":["dbl"],"align":["right"]}],"data":[{"1":"30372","2":"DPW Maintained","3":"Ulmus parvifolia :: Chinese Elm","4":"1","5":"Sidewalk: Curb side : Cutout","6":"Private","7":"1956-03-02","8":"10","9":"3","10":"37.76005","11":"-122.3983"},{"1":"30460","2":"DPW Maintained","3":"Pittosporum undulatum :: Victorian Box","4":"1","5":"Sidewalk: Curb side : Cutout","6":"Private","7":"1956-05-11","8":"19","9":"4","10":"37.80074","11":"-122.4073"},{"1":"30454","2":"DPW Maintained","3":"Pittosporum undulatum :: Victorian Box","4":"1","5":"Sidewalk: Curb side : Cutout","6":"Private","7":"1956-05-11","8":"8","9":"3","10":"37.80081","11":"-122.4057"},{"1":"30428","2":"DPW Maintained","3":"Pittosporum undulatum :: Victorian Box","4":"1","5":"Sidewalk: Curb side : Cutout","6":"Private","7":"1956-05-11","8":"13","9":"7","10":"37.80082","11":"-122.4066"},{"1":"30468","2":"DPW Maintained","3":"Melaleuca quinquenervia :: Cajeput","4":"2","5":"Sidewalk: Curb side : Cutout","6":"Private","7":"1956-05-29","8":"8","9":"3","10":"37.80061","11":"-122.4073"},{"1":"30470","2":"DPW Maintained","3":"Melaleuca quinquenervia :: Cajeput","4":"3","5":"Sidewalk: Curb side : Cutout","6":"Private","7":"1956-05-29","8":"8","9":"3","10":"37.80062","11":"-122.4073"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">col_plot_legalstatus_by_caretaker <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> trees_formodel <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(legal_status, caretaker) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_count</span>(caretaker, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">wt =</span> n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"caretaker_count"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(caretaker_count <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(legal_status) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">percent_legal =</span> n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(percent_legal, caretaker, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> legal_status)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodge"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_viridis_d</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">begin =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">end =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.value =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb15-11">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"proportion of trees in each category"</span>)</span>
<span id="cb15-12">col_plot_legalstatus_by_caretaker</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_02_10-SF_tree_classification_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="quick-plotmap-of-data" class="level2">
<h2 class="anchored" data-anchor-id="quick-plotmap-of-data">Quick plot/map of data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">tree_loc_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> trees_formodel <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb16-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> longitude, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> latitude, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> legal_status)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.border =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb16-6">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.justification =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_viridis_d</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">begin =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">end =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: A numeric `legend.position` argument in `theme()` was deprecated in ggplot2
3.5.0.
ℹ Please use the `legend.position.inside` argument of `theme()` instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">tree_loc_plot</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_02_10-SF_tree_classification_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="build-model" class="level2">
<h2 class="anchored" data-anchor-id="build-model">Build Model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>)</span>
<span id="cb19-2">trees_split <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">initial_split</span>(trees_formodel, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strata =</span> legal_status)</span>
<span id="cb19-3">trees_train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span>(trees_split)</span>
<span id="cb19-4">trees_test <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">testing</span>(trees_split)</span>
<span id="cb19-5"></span>
<span id="cb19-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(trees_train); <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(trees_test)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 17881</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5961</code></pre>
</div>
</div>
</section>
<section id="feature-engineering-for-the-date" class="level2">
<h2 class="anchored" data-anchor-id="feature-engineering-for-the-date">Feature engineering for the date</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">tree_rec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recipe</span>(legal_status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> ., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> trees_train) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_role</span>(tree_id, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new_role =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ID"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_other</span>(species, caretaker, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">threshold =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">01</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_other</span>(site_info, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">threshold =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">005</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_dummy</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_nominal</span>(), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_outcomes</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_date</span>(date, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">features =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_rm</span>(date) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_downsample</span>(legal_status)</span>
<span id="cb22-9"></span>
<span id="cb22-10">tree_prep <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prep</span>(tree_rec)</span>
<span id="cb22-11"></span>
<span id="cb22-12">juiced <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">juice</span>(tree_prep)</span></code></pre></div>
</div>
<section id="review-data-preprocessing-results" class="level3">
<h3 class="anchored" data-anchor-id="review-data-preprocessing-results">Review data preprocessing results</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1">juiced <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(legal_status)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["legal_status"],"name":[1],"type":["fct"],"align":["left"]},{"label":["n"],"name":[2],"type":["int"],"align":["right"]}],"data":[{"1":"DPW Maintained","2":"4308"},{"1":"Other","2":"4308"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="set-up-model-hyperparameters" class="level1">
<h1>Set up model hyperparameters</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">tune_spec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand_forest</span>(</span>
<span id="cb24-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mtry =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune</span>(), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># </span></span>
<span id="cb24-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trees =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of trees to start with</span></span>
<span id="cb24-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min_n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune</span>() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># how many data points in a node to keep splitting further</span></span>
<span id="cb24-5">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb24-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_mode</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"classification"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb24-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_engine</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ranger"</span>)</span></code></pre></div>
</div>
<section id="set-up-workflow" class="level2">
<h2 class="anchored" data-anchor-id="set-up-workflow">Set up workflow</h2>
<p>convenience functions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1">tune_wf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">workflow</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb25-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_recipe</span>(tree_rec) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb25-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_model</span>(tune_spec)</span></code></pre></div>
</div>
</section>
<section id="train-test-some-model-hyperparameters" class="level2">
<h2 class="anchored" data-anchor-id="train-test-some-model-hyperparameters">Train-test some model hyperparameters</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">234</span>)</span>
<span id="cb26-2">trees_folds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vfold_cv</span>(trees_train)</span>
<span id="cb26-3"></span>
<span id="cb26-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">345</span>)</span>
<span id="cb26-5">doParallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">registerDoParallel</span>()</span>
<span id="cb26-6">tune_res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune_grid</span>(</span>
<span id="cb26-7">  tune_wf,</span>
<span id="cb26-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resamples =</span> trees_folds,</span>
<span id="cb26-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grid =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
</div>
<section id="view-results" class="level3">
<h3 class="anchored" data-anchor-id="view-results">view results</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">show_best</span>(tune_res, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"accuracy"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["mtry"],"name":[1],"type":["int"],"align":["right"]},{"label":["min_n"],"name":[2],"type":["int"],"align":["right"]},{"label":[".metric"],"name":[3],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[4],"type":["chr"],"align":["left"]},{"label":["mean"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["n"],"name":[6],"type":["int"],"align":["right"]},{"label":["std_err"],"name":[7],"type":["dbl"],"align":["right"]},{"label":[".config"],"name":[8],"type":["chr"],"align":["left"]}],"data":[{"1":"35","2":"5","3":"accuracy","4":"binary","5":"0.8471000","6":"10","7":"0.001880239","8":"Preprocessor1_Model18"},{"1":"14","2":"3","3":"accuracy","4":"binary","5":"0.8469882","6":"10","7":"0.001400917","8":"Preprocessor1_Model14"},{"1":"19","2":"8","3":"accuracy","4":"binary","5":"0.8459255","6":"10","7":"0.001502931","8":"Preprocessor1_Model19"},{"1":"35","2":"12","3":"accuracy","4":"binary","5":"0.8446392","6":"10","7":"0.001613269","8":"Preprocessor1_Model20"},{"1":"17","2":"11","3":"accuracy","4":"binary","5":"0.8439681","6":"10","7":"0.001547820","8":"Preprocessor1_Model13"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">show_best</span>(tune_res, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"roc_auc"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["mtry"],"name":[1],"type":["int"],"align":["right"]},{"label":["min_n"],"name":[2],"type":["int"],"align":["right"]},{"label":[".metric"],"name":[3],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[4],"type":["chr"],"align":["left"]},{"label":["mean"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["n"],"name":[6],"type":["int"],"align":["right"]},{"label":["std_err"],"name":[7],"type":["dbl"],"align":["right"]},{"label":[".config"],"name":[8],"type":["chr"],"align":["left"]}],"data":[{"1":"14","2":"3","3":"roc_auc","4":"binary","5":"0.9436789","6":"10","7":"0.001670672","8":"Preprocessor1_Model14"},{"1":"19","2":"8","3":"roc_auc","4":"binary","5":"0.9422167","6":"10","7":"0.001836972","8":"Preprocessor1_Model19"},{"1":"35","2":"5","3":"roc_auc","4":"binary","5":"0.9420326","6":"10","7":"0.001948534","8":"Preprocessor1_Model18"},{"1":"17","2":"11","3":"roc_auc","4":"binary","5":"0.9413050","6":"10","7":"0.001828302","8":"Preprocessor1_Model13"},{"1":"35","2":"12","3":"roc_auc","4":"binary","5":"0.9398899","6":"10","7":"0.002011990","8":"Preprocessor1_Model20"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1">side_facet_n_mtry_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tune_res <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb29-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect_metrics</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb29-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(.metric <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"roc_auc"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb29-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(mean, min_n, mtry) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb29-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(min_n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>mtry,</span>
<span id="cb29-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>,</span>
<span id="cb29-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameter"</span></span>
<span id="cb29-8">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb29-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(value, mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> parameter)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show.legend =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>parameter, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_x"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AUC"</span>)</span>
<span id="cb29-13">side_facet_n_mtry_plot</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_02_10-SF_tree_classification_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1">nonortho_gid_n_mtry_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tune_res <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect_metrics</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(.metric <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"roc_auc"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(mean, min_n, mtry) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> min_n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> mtry, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> mean)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_viridis_c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"roc_auc"</span>)</span>
<span id="cb30-13">nonortho_gid_n_mtry_plot</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_02_10-SF_tree_classification_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>While it’s not a regular grid (of orthogonal combinations that would allow for <em>ceteris paribus</em> testing) of <code>min_n</code> and <code>mtry</code>, but we can get an idea of what is going on. It looks like higher values of mtry are good (above about 10) and lower values of min_n are good (below about 10). We can get a better handle on the hyperparameters by tuning one more time, this time using regular_grid(). Let’s set ranges of hyperparameters we want to try, (inside of the dotted line box displayed on the 2D plot above) based on the results from our initial tune.</p>
</section>
</section>
<section id="train-test-some-model-hyperparameters-1" class="level2">
<h2 class="anchored" data-anchor-id="train-test-some-model-hyperparameters-1">Train-test some model hyperparameters</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">456</span>)</span>
<span id="cb31-2"></span>
<span id="cb31-3">rf_grid <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grid_regular</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mtry</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)),</span>
<span id="cb31-4">                        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min_n</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)),</span>
<span id="cb31-5">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb31-6"></span>
<span id="cb31-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(rf_grid)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 25</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">456</span>)</span>
<span id="cb33-2">doParallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">registerDoParallel</span>()</span>
<span id="cb33-3">tune_reg_res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune_grid</span>(tune_wf,</span>
<span id="cb33-4">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resamples =</span> trees_folds,</span>
<span id="cb33-5">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grid =</span> rf_grid)</span></code></pre></div>
</div>
<section id="view-results-1" class="level3">
<h3 class="anchored" data-anchor-id="view-results-1">view results</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1">tune_reg_res <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select_best</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"accuracy"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["mtry"],"name":[1],"type":["int"],"align":["right"]},{"label":["min_n"],"name":[2],"type":["int"],"align":["right"]},{"label":[".config"],"name":[3],"type":["chr"],"align":["left"]}],"data":[{"1":"30","2":"2","3":"Preprocessor1_Model05"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1">tune_reg_res <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select_best</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"roc_auc"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["mtry"],"name":[1],"type":["int"],"align":["right"]},{"label":["min_n"],"name":[2],"type":["int"],"align":["right"]},{"label":[".config"],"name":[3],"type":["chr"],"align":["left"]}],"data":[{"1":"15","2":"2","3":"Preprocessor1_Model02"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">grid_n_mtry_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tune_reg_res <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect_metrics</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(.metric <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"roc_auc"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min_n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(min_n)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(mtry, mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> min_n)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb36-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb36-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb36-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tune AUC by min_n and mtry"</span>,</span>
<span id="cb36-9">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AUC"</span>)</span>
<span id="cb36-10">grid_n_mtry_plot</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_02_10-SF_tree_classification_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1">nonortho_gid_n_mtry_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tune_reg_res <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb37-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect_metrics</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb37-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(.metric <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"roc_auc"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb37-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(mean, min_n, mtry) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb37-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> min_n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> mtry, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> mean)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb37-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb37-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_viridis_c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb37-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"roc_auc"</span>)</span>
<span id="cb37-9">nonortho_gid_n_mtry_plot</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_02_10-SF_tree_classification_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Both 2D plots show that the mtry = 15 and min_n = 2 hyperperamater maximize the AUC for this random forest model.</p>
</section>
</section>
</section>
<section id="finalize-the-model" class="level1">
<h1>Finalize the model</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1">best_auc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tune_reg_res <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select_best</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"roc_auc"</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1">final_rf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">finalize_model</span>(tune_spec, best_auc)</span>
<span id="cb39-2"></span>
<span id="cb39-3">final_rf</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Random Forest Model Specification (classification)

Main Arguments:
  mtry = 15
  trees = 1000
  min_n = 2

Computational engine: ranger </code></pre>
</div>
</div>
<section id="understand-final-model" class="level2">
<h2 class="anchored" data-anchor-id="understand-final-model">Understand final model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1">final_rf_vip_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> final_rf <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb41-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_engine</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ranger"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">importance =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"permutation"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb41-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit</span>(legal_status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> ., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(juiced, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>tree_id)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb41-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vip</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"point"</span>)</span>
<span id="cb41-5">final_rf_vip_plot</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_02_10-SF_tree_classification_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Satisfyingly, whether the caretaker is private makes a large difference, and latitude and longitide each make a large (and approximately equal) contribution.</p>
</section>
</section>
<section id="apply-the-final-model" class="level1">
<h1>Apply the final model</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1">final_wf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">workflow</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb42-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_recipe</span>(tree_rec) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb42-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_model</span>(final_rf)</span>
<span id="cb42-4"></span>
<span id="cb42-5">final_result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> final_wf <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">last_fit</span>(trees_split)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1">final_result <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect_metrics</span>()</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".metric"],"name":[1],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[2],"type":["chr"],"align":["left"]},{"label":[".estimate"],"name":[3],"type":["dbl"],"align":["right"]},{"label":[".config"],"name":[4],"type":["chr"],"align":["left"]}],"data":[{"1":"accuracy","2":"binary","3":"0.8475088","4":"Preprocessor1_Model1"},{"1":"roc_auc","2":"binary","3":"0.9463316","4":"Preprocessor1_Model1"},{"1":"brier_class","2":"binary","3":"0.1013336","4":"Preprocessor1_Model1"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>This is a great result, because it means we did not over fit to the training data set. This is the AUC we can expect for new San Francisco Trees.</p>
<section id="make-predictions" class="level2">
<h2 class="anchored" data-anchor-id="make-predictions">Make predictions</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1">final_result_ano <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> final_result <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb44-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect_predictions</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb44-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"correct_prediction"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(legal_status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.pred_class</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Correct"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Incorrect"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb44-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(trees_test)</span>
<span id="cb44-5"></span>
<span id="cb44-6">tree_correct_loc_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> final_result_ano <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb44-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> longitude, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> latitude, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> correct_prediction)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.border =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb44-11">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.justification =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_viridis_d</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">begin =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">end =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb44-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_equal</span>()</span>
<span id="cb44-14">tree_correct_loc_plot</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_02_10-SF_tree_classification_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There is some degree of spatial bias in the incorrect assignment of legal status of the SF Trees.</p>


</section>
</section>

 ]]></description>
  <category>data</category>
  <category>code</category>
  <category>tree models</category>
  <guid>https://pdcherry.github.io/posts/2024_02_10-SF_tree_classification.html</guid>
  <pubDate>Sat, 10 Feb 2024 08:00:00 GMT</pubDate>
  <media:content url="https://pdcherry.github.io/posts/2024_02_10-SF_tree_classification.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>scRNA-seq Analysis: Messy Mouse Brain</title>
  <dc:creator>Patrick Cherry</dc:creator>
  <link>https://pdcherry.github.io/posts/2024_01_22-scRNA-seq.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In this data analysis exercise, I analyze a mysterious 10x single-cell RNA-seq data file, which consists of a collection of single cells from an unknown tissue with unknown cell types. This is standard 10x mouse single cell RNA-seq data output and we are curious what type of tissue and cells these are.</p>
<section id="objectives" class="level3">
<h3 class="anchored" data-anchor-id="objectives">Objectives</h3>
<ol type="1">
<li><strong>Quality control and filtering.</strong> Perform a basic QC of the data, explaining the rationale behind each step and the choice of parameters. How do the data look? What would you examine before moving forward to downstream analysis? Why?</li>
<li><strong>Dimension reduction and visualization.</strong> How can we make sense of all this data? Perform dimensional reduction with any methods at your choice, explaining the rationale behind the choice and caveats of other potential dimensional reduction methods. Plot these out in a suitable visualization(s).</li>
<li><strong>Marker genes, clusters tissue, and cell types.</strong> Identify genes and gene-sets that define the tissue and are differentially expressed. What tissue are we looking at? How many cell types are present, and what kind?</li>
</ol>
<p>Cell states can be very dynamic within the same cell type. For some of the most abundant cell types, feel free to dig deeper on any observed heterogeneity and the biological underpinning.</p>
</section>
</section>
<section id="data-description" class="level2">
<h2 class="anchored" data-anchor-id="data-description">Data description</h2>
<ul>
<li>counts: matrix <code>matrix.mtx.gz</code></li>
<li>cell barcodes: <code>barcodes.tsv.gz</code></li>
<li>gene features: <code>features.tsv.gz</code></li>
</ul>
</section>
<section id="load-data" class="level1">
<h1>Load data</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">koaladata <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Read10X</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data.dir =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../scRNA-seq/Koala/"</span>)</span>
<span id="cb1-2"></span>
<span id="cb1-3">koala <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">CreateSeuratObject</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts =</span> koaladata, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">project =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"koala"</span>,</span>
<span id="cb1-4">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.cells =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.features =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span></code></pre></div>
</div>
<p>The following parameters are used: - min.cells = 3: a feature must have appeared in at least 3 cell barcodes - min.features = 200 a cell must have at least 200 features to be included</p>
</section>
<section id="data-qc" class="level1">
<h1>Data QC</h1>
<p>Here are some features in the metadata we can use for QC:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">koala<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "orig.ident"   "nCount_RNA"   "nFeature_RNA"</code></pre>
</div>
</div>
<p>Unfortunately, a <em>“percent.mt”</em> vector is not available. I ordinarily would heavily QC on this information.</p>
<section id="features" class="level2">
<h2 class="anchored" data-anchor-id="features">Features</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">VlnPlot</span>(koala, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">features =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nCount_RNA"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nFeature_RNA"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pt.size =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1100</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Default search for "data" layer in "RNA" assay yielded no results;
utilizing "counts" layer instead.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">koala<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"koala"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> value)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_violin</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pink"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nCount_RNA"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>()</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>These are both skewed distributions, but RNA counts is more extremely skewed than features. Let’s see how they scatter:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">features_by_counts_scatter_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(koala<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA, koala<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nFeature_RNA) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-4">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nCount_RNA"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nFeature_RNA"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb7-5"></span>
<span id="cb7-6">features_by_counts_scatter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FeatureScatter</span>(</span>
<span id="cb7-7">  koala, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature1 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nCount_RNA"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature2 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nFeature_RNA"</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#+</span></span>
<span id="cb7-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># stat_smooth(formula = "y ~ x*log(x)", method = glm) +</span></span>
<span id="cb7-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># stat_smooth(formula = "y ~ log(x)", method = glm, color = "yellow") +</span></span>
<span id="cb7-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># geom_smooth(formula = y ~ (Vm * x)/(K + x),</span></span>
<span id="cb7-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#             #data = features_by_counts_scatter_table,</span></span>
<span id="cb7-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#             method = "nls", color = "green", se = FALSE,</span></span>
<span id="cb7-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#             method.args = list(start = c(K = 10000, Vm = 6000)))</span></span>
<span id="cb7-14"></span>
<span id="cb7-15">features_by_counts_scatter</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- ```{r} -->
<!-- summary(nls(formula = "nFeature_RNA ~ (Vm * nCount_RNA)/(K + nCount_RNA)", -->
<!--             data = features_by_counts_scatter_table, -->
<!--             start = c(K = 10000, Vm = 6000))) -->
<!-- ``` -->
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">features_by_counts_scatter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_log10</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_log10</span>()</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The feature count appears to increase approximately logarithmicly with RNA count. The Pearson correlation is 0.95, but the non linearity indicates the relationship may be stronger than the correlation coefficient indicates. This observation is consistent with an RNA-seq experiment wherein there is a fixed number of potentially expressed RNAs and the number of detected transcripts begins to saturate the and approach the maximum number able to be detected.</p>
<p>The log-log transformed axis plot shows: - There are only a few cells/droplets with fewer than 300 RNA counts, which is great for an scRNA-seq experiment. - There is still some curve to the line, meaning the relationship is more trancendental (not simply a power-law, like polynomial).</p>
</section>
<section id="filter-on-feature-count" class="level2">
<h2 class="anchored" data-anchor-id="filter-on-feature-count">Filter on feature count</h2>
<p>I am going to keep droplets (“cells”) with 1100 features or fewer</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">koala_filtered <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(koala, nFeature_RNA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1100</span>)</span></code></pre></div>
</div>
<p>Let’s quickly confirm that the filtering changed the number of features throughout the Seurat object by using Seurat size commands to query the number of observations in the pre-filter and post-filter Seurat objects:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(koala<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>orig.ident); <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(koala_filtered<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>orig.ident)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4449</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1410</code></pre>
</div>
</div>
<p>The feature count decreased from 4449 to 1410 upon filtering.</p>
<p>(The <code>orig.ident</code> matrix within the Seurat object stores the cell metadata, and counting its number of entries can tell us number of unique observations.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(koala_filtered<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>orig.ident)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ATGGCTGTCGATTTGA-1 GGTACAAAGTTCCTGC-1 ATTCAACCATAGGCGA-1 TCTCCTCGTCAATACG-1 
             koala              koala              koala              koala 
TTTCTCACAGCACCAT-1 TTCCTTGAGGATCACT-1 
             koala              koala 
Levels: koala</code></pre>
</div>
</div>
<section id="features-1" class="level3">
<h3 class="anchored" data-anchor-id="features-1">Features</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">VlnPlot</span>(koala_filtered, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">features =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nCount_RNA"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nFeature_RNA"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pt.size =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Default search for "data" layer in "RNA" assay yielded no results;
utilizing "counts" layer instead.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Post filtering, the RNA count plot looks more typical, with one major “peak” and a long tail. The features plot looks fairly evenly distributed because of the filtering cut off so close to the “peak” of the distribution, but I hypothesize it was necessary due to the hypothesized doublet peak right at 2000 features per droplet right near by.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">features_by_counts_scatter_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(koala_filtered<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA,</span>
<span id="cb17-2">                                              koala_filtered<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nFeature_RNA) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb17-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb17-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb17-5">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nCount_RNA"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nFeature_RNA"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb17-6"></span>
<span id="cb17-7">features_by_counts_scatter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FeatureScatter</span>(</span>
<span id="cb17-8">  koala_filtered, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature1 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nCount_RNA"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">feature2 =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nFeature_RNA"</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#+</span></span>
<span id="cb17-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># stat_smooth(formula = "y ~ x*log(x)", method = glm) +</span></span>
<span id="cb17-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># stat_smooth(formula = "y ~ log(x)", method = glm, color = "yellow") +</span></span>
<span id="cb17-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># geom_smooth(formula = y ~ (Vm * x)/(K + x),</span></span>
<span id="cb17-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#             #data = features_by_counts_scatter_table,</span></span>
<span id="cb17-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#             method = "nls", color = "green", se = FALSE,</span></span>
<span id="cb17-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#             method.args = list(start = c(K = 10000, Vm = 6000)))</span></span>
<span id="cb17-15"></span>
<span id="cb17-16">features_by_counts_scatter</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="initial-analysis" class="level1">
<h1>Initial Analysis</h1>
<section id="normalization" class="level2">
<h2 class="anchored" data-anchor-id="normalization">Normalization</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">koala_norm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">NormalizeData</span>(koala_filtered)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Normalizing layer: counts</code></pre>
</div>
</div>
<p>The above is a log-normalization. This procedure divides each feature’s abundance by the sample mean for that cell and takes the natural log (<code>log()</code> in <code>R</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">koala_features <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindVariableFeatures</span>(koala_norm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">selection.method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"vst"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Finding variable features for layer counts</code></pre>
</div>
</div>
<p>The vst method is the default feature selection method, but I’m just making it explicit, because a later (cluster identification) package refers to this fact. The variance stabilizing transformation makes the variances (standard deviations) more uniform and stops them from being related to the mean value within a group, which facilitates downstream linear regression-based techniques (<em>e.g.</em> PCA).</p>
</section>
<section id="feature-selection-by-pca" class="level2">
<h2 class="anchored" data-anchor-id="feature-selection-by-pca">Feature Selection by PCA</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">top_koala_features <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">VariableFeatures</span>(koala_features), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb22-2"></span>
<span id="cb22-3">top_koala_features_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">VariableFeaturePlot</span>(koala_features) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb22-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">LabelPoints</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">points =</span> top_koala_features, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">repel =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb22-5"></span>
<span id="cb22-6">top_koala_features_plot</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Transformation introduced infinite values in continuous x-axis</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">top_koala_features</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Nrxn1"  "Ank3"   "Nkain2" "Sntg1"  "Glul"   "Rspo3"  "Reln"   "Aoah"  
 [9] "Slc1a2" "Spp1"  </code></pre>
</div>
</div>
<p>The most highly expressed gene is MEG3 (maternally expressed 3), a maternally expressed, imprinted long non-coding RNA (lncRNA). This likely means the tissue analyzed here is an egg cell, recently fertilized egg, or young embryo.</p>
</section>
<section id="scale" class="level2">
<h2 class="anchored" data-anchor-id="scale">Scale</h2>
<p>Pre-process to center at 0 and make sd = 1 prior to PCA.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1">gene_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(koala_features)</span>
<span id="cb26-2">koala_features <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ScaleData</span>(koala_features, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">features =</span> gene_names)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Centering and scaling data matrix</code></pre>
</div>
</div>
</section>
<section id="run-pca" class="level2">
<h2 class="anchored" data-anchor-id="run-pca">Run PCA</h2>
<p>Linear dimensionality reduction</p>
<p>I’m going to go with all features and use the Elbow plot to determine which features are still important after this step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">koala_pca <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RunPCA</span>(koala_features, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">features =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">VariableFeatures</span>(koala_features) )</span></code></pre></div>
</div>
<section id="visualize-pca-results" class="level3">
<h3 class="anchored" data-anchor-id="visualize-pca-results">Visualize PCA Results</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(koala_pca[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pca"</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dims =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>PC_ 1 
Positive:  Ptprb, Lrmda, Prkg1, Plekhg1, Cemip2, Plpp1, Rasal2, Meis2, Plxnc1, Adam23 
       Sptbn1, Stox2, Ets1, Mrc1, F8, Fyn, Syne1, Hecw2, Slc9a9, Fbxl7 
Negative:  Pck1, Ppara, Ttc39c, Gm29966, G6pc, Abcc2, Mlxipl, Errfi1, Egfr, Gfra1 
       Ahsg, Neat1, Trf, Slc27a2, Fam214a, Slc38a3, Slc7a2, Dpyd, Hc, Alas1 
PC_ 2 
Positive:  Nrxn1, Reln, Rbms3, Dcn, Ntm, Bmp5, Lhfp, Abcc9, Arhgap24, Nkain2 
       Pde3a, Tln2, Ngf, Sox5, Pde1a, Robo2, Hand2os1, Hgf, Ccbe1, Agtr1a 
Negative:  Ptprb, Rasal2, Cemip2, Plpp1, Adam23, Stox2, Fyn, Mrc1, Kdr, F8 
       Prickle1, Dab2, Adgrf5, Cyyr1, Plcb4, Hecw2, Maf, Arhgap31, Nrp1, Cd55 
PC_ 3 
Positive:  Slc8a1, Elmo1, Ptprc, Runx1, Cd5l, Clec4f, Dock2, Adgb, Entpd1, Dock10 
       Aoah, Gm26740, Bank1, Adgre1, Arhgap15, Ikzf1, E230029C05Rik, Epsti1, Adgre4, Cd163 
Negative:  Ptprb, Plekhg1, Cemip2, Meis2, Tshz2, Prkg1, Pard3b, Plpp1, Adgrl2, Plxnc1 
       Stox2, Rasal2, F8, Prickle1, Kdr, Hecw2, Fbxl7, Sptbn1, Adam23, Syne1 
PC_ 4 
Positive:  Gm2682, Skap1, Themis, Cd226, Satb1, Kcnq5, Ms4a4b, Grap2, Dock2, Arhgap15 
       Bcl11b, Ripor2, Inpp4b, Ipcef1, Il7r, Atp8a2, Lef1, Camk4, Cyfip2, Ikzf3 
Negative:  Clec4f, Slc8a1, Frmd4b, Aoah, Slc40a1, Cd5l, Tcf7l2, Kcnk13, Tbxas1, Adgb 
       Myo9a, Hdac9, Entpd1, Pde7b, Cd86, Adgre1, Lgmn, Ksr2, Zeb2, E230029C05Rik </code></pre>
</div>
</div>
<p>Quick print out all of the positive and negative features in the top four fitted principle components.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1">(dim_reduc_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">VizDimLoadings</span>(koala_pca, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dims =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reduction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pca"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb31-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1">(pc_1_2_scatterplot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DimPlot</span>(koala_pca, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reduction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pca"</span>))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DimHeatmap</span>(koala_pca, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dims =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="determine-the-dimensionality-of-the-dataset" class="level2">
<h2 class="anchored" data-anchor-id="determine-the-dimensionality-of-the-dataset">Determine the dimensionality of the dataset</h2>
<p>Using jackstraw</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1">koala_js <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">JackStraw</span>(koala_pca, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num.replicate =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1">koala_js_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ScoreJackStraw</span>(koala_js, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dims =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">JackStrawPlot</span>(koala_js_score, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dims =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 28212 rows containing missing values (`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ElbowPlot</span>(koala_js_score)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Deciding that the elbow occurs at 9 principle components, so should retain dimensions 1 to 10. However, due to the strange behavior of this dataset, I am going to run <code>FindClusters()</code> on all 20 principle components and see what happens. It may confirm my findings without intervention.</p>
</section>
</section>
<section id="clustering" class="level1">
<h1>Clustering</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1">koala_clusters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindNeighbors</span>(koala_pca, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dims =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing nearest neighbor graph</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing SNN</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1">koala_clusters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindClusters</span>(koala_clusters, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resolution =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck

Number of nodes: 1410
Number of edges: 53206

Running Louvain algorithm...
Maximum modularity in 10 random starts: 0.8554
Number of communities: 9
Elapsed time: 0 seconds</code></pre>
</div>
</div>
<p>Despite retaining 20 dimensions in PCA, the Louvain cluster determination algorithm only identified 9 independently-clustering communities of droplets/cells. This is consistent with my by-eye reading of the elbow plot.</p>
</section>
<section id="run-non-linear-dimensional-reduction-umaptsne" class="level1">
<h1>Run non-linear dimensional reduction (UMAP/tSNE)</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1">koala_umap <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RunUMAP</span>(koala_clusters, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dims =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The default method for RunUMAP has changed from calling Python UMAP via reticulate to the R-native UWOT using the cosine metric
To use Python UMAP via reticulate, set umap.method to 'umap-learn' and metric to 'correlation'
This message will be shown once per session</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>23:49:50 UMAP embedding parameters a = 0.9922 b = 1.112</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Found more than one class "dist" in cache; using the first, from namespace 'spam'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Also defined by 'BiocGenerics'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>23:49:50 Read 1410 rows and found 10 numeric columns</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>23:49:50 Using Annoy for neighbor search, n_neighbors = 30</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Found more than one class "dist" in cache; using the first, from namespace 'spam'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Also defined by 'BiocGenerics'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>23:49:50 Building Annoy index with metric = cosine, n_trees = 50</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>0%   10   20   30   40   50   60   70   80   90   100%</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[----|----|----|----|----|----|----|----|----|----|</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>**************************************************|
23:49:50 Writing NN index file to temp file /var/folders/11/sfzn5hhx2995d534f55tvzd40000gn/T//RtmpGrv29G/file1d6c46cda1fd
23:49:50 Searching Annoy index using 1 thread, search_k = 3000
23:49:50 Annoy recall = 100%
23:49:51 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30
23:49:51 Initializing from normalized Laplacian + noise (using RSpectra)
23:49:51 Commencing optimization for 500 epochs, with 55346 positive edges
23:49:52 Optimization finished</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1">(koala_umap_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DimPlot</span>(koala_umap, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reduction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'umap'</span>))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="identify-cluster-biomarkers" class="level2">
<h2 class="anchored" data-anchor-id="identify-cluster-biomarkers">Identify cluster biomarkers</h2>
<section id="cluster-3" class="level3">
<h3 class="anchored" data-anchor-id="cluster-3">Cluster 3</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1">koala_umap_cluster_4 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindMarkers</span>(koala_umap, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ident.1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.pct =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>)</span>
<span id="cb58-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(koala_umap_cluster_4, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               p_val avg_log2FC pct.1 pct.2    p_val_adj
mt-Co2  7.527182e-31  1.2245951 0.985 0.670 1.311687e-26
Malat1  1.723282e-29 -0.7632667 1.000 0.999 3.002992e-25
mt-Co1  5.977587e-27  1.1122765 0.971 0.790 1.041654e-22
Gm42418 3.151082e-26  0.5404391 1.000 1.000 5.491075e-22
Camk1d  3.573460e-26  0.8369697 0.993 0.950 6.227112e-22
Cmss1   5.424007e-26  0.8626727 0.993 0.932 9.451874e-22
Apoe    6.872890e-26  1.2087947 0.919 0.635 1.197670e-21
mt-Nd2  8.808615e-25  1.2449740 0.897 0.524 1.534989e-20
Stab2   1.176373e-24  0.8467994 0.875 0.327 2.049947e-20
mt-Atp6 1.815371e-24  1.1416188 0.949 0.667 3.163465e-20</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find all markers distinguishing cluster 5 from clusters 0 through 3</span></span>
<span id="cb60-2">koala_umap_cluster_4_diff <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindMarkers</span>(koala_umap, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ident.1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ident.2 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.pct =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>)</span>
<span id="cb60-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(koala_umap_cluster_4_diff, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               p_val avg_log2FC pct.1 pct.2    p_val_adj
mt-Co2  9.312486e-27  1.1041138 0.985 0.678 1.622794e-22
Malat1  2.704755e-26 -0.7462688 1.000 0.999 4.713307e-22
Gm42418 3.811073e-26  0.5477534 1.000 1.000 6.641176e-22
Camk1d  1.292259e-25  0.8488007 0.993 0.945 2.251891e-21
Apoe    9.025020e-25  1.1895949 0.919 0.622 1.572700e-20
Cmss1   2.670717e-24  0.8297866 0.993 0.925 4.653991e-20
mt-Co1  7.586908e-23  0.9905739 0.971 0.803 1.322095e-18
Lars2   1.597419e-22  0.8533974 1.000 0.832 2.783662e-18
mt-Atp6 2.901863e-20  0.9995626 0.949 0.680 5.056787e-16
mt-Nd2  3.537213e-20  1.0947916 0.897 0.557 6.163948e-16</code></pre>
</div>
</div>
</section>
<section id="all-marker-analysis" class="level3">
<h3 class="anchored" data-anchor-id="all-marker-analysis">All marker analysis</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find markers for every cluster compared to all other cells, keep only the positive ones</span></span>
<span id="cb62-2">koala_umap_markers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindAllMarkers</span>(koala_umap, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">only.pos =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.pct =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logfc.threshold =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 4</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 5</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 6</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 7</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1">koala_umap_markers_10_per_cluster <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> koala_umap_markers <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb72-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cluster) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb72-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_max</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">order_by =</span> avg_log2FC)</span>
<span id="cb72-4">koala_umap_markers_10_per_cluster</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 90 × 7
# Groups:   cluster [9]
       p_val avg_log2FC pct.1 pct.2 p_val_adj cluster gene    
       &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;fct&gt;   &lt;chr&gt;   
 1 6.94e- 80       3.90 0.488 0.066 1.21e- 75 0       Bmp6    
 2 2.11e- 46       3.86 0.281 0.03  3.68e- 42 0       Col13a1 
 3 8.78e- 66       3.67 0.406 0.052 1.53e- 61 0       Galnt18 
 4 1.10e-126       3.61 0.73  0.113 1.93e-122 0       Adam23  
 5 2.37e- 48       3.60 0.313 0.04  4.13e- 44 0       Dnase1l3
 6 5.07e- 46       3.56 0.294 0.035 8.83e- 42 0       Srgap1  
 7 6.73e- 42       3.52 0.283 0.039 1.17e- 37 0       Clec4g  
 8 6.99e-172       3.49 0.929 0.186 1.22e-167 0       Stab2   
 9 4.34e- 77       3.40 0.488 0.069 7.57e- 73 0       Rasgrp3 
10 4.35e- 46       3.34 0.322 0.048 7.59e- 42 0       Gm15675 
# ℹ 80 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1">koala_umap_markers_10_per_nest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> koala_umap_markers_10_per_cluster <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb74-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(gene) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb74-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb74-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(data, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>.x[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]] )))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `cluster`</code></pre>
</div>
</div>
</section>
<section id="set-up-function-for-all" class="level3">
<h3 class="anchored" data-anchor-id="set-up-function-for-all">Set up function for all</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb76" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1">go_query_fun <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(gene_name_vector){</span>
<span id="cb76-2">  go_result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gost</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">query =</span> gene_name_vector,</span>
<span id="cb76-3">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">organism =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmusculus"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ordered_query =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, </span>
<span id="cb76-4">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">multi_query =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">significant =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exclude_iea =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, </span>
<span id="cb76-5">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">measure_underrepresentation =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">evcodes =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, </span>
<span id="cb76-6">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">user_threshold =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">correction_method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fdr"</span>, </span>
<span id="cb76-7">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">domain_scope =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"annotated"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">custom_bg =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb76-8">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">numeric_ns =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sources =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GO:MF"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">as_short_link =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb76-9">  </span>
<span id="cb76-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(go_result)</span>
<span id="cb76-11">}</span></code></pre></div>
</div>
</section>
<section id="run-the-functon-in-df-env" class="level3">
<h3 class="anchored" data-anchor-id="run-the-functon-in-df-env">Run the functon in df env</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb77" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1">koala_umap_markers_10_per_nest_go_ano <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> koala_umap_markers_10_per_nest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb77-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"go_table"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(data, go_query_fun))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>No results to show
Please make sure that the organism is correct or set significant = FALSE
No results to show
Please make sure that the organism is correct or set significant = FALSE</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1">koala_umap_markers_10_go_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> koala_umap_markers_10_per_nest_go_ano <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb79-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(go_table) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb79-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb79-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(go_table) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb79-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relocate</span>(term_name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.after =</span> cluster) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb79-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(cluster, p_value) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb79-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"query"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"significant"</span>))</span>
<span id="cb79-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(koala_umap_markers_10_go_df)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 13
# Groups:   cluster [1]
  cluster term_name     p_value term_size query_size intersection_size precision
  &lt;fct&gt;   &lt;chr&gt;           &lt;dbl&gt;     &lt;int&gt;      &lt;int&gt;             &lt;int&gt;     &lt;dbl&gt;
1 0       virus corece…  0.0317         1         10                 1       0.1
2 0       polysacchari…  0.0453        26         10                 1       0.1
3 0       protein-lipi…  0.0453        30         10                 1       0.1
4 0       lipoprotein …  0.0453        30         10                 1       0.1
5 0       BMP receptor…  0.0453        14         10                 1       0.1
6 0       transmembran…  0.0453        21         10                 1       0.1
# ℹ 6 more variables: recall &lt;dbl&gt;, term_id &lt;chr&gt;, source &lt;chr&gt;,
#   effective_domain_size &lt;int&gt;, source_order &lt;int&gt;, parents &lt;list&gt;</code></pre>
</div>
</div>
</section>
<section id="all-marker-analysis-1" class="level3">
<h3 class="anchored" data-anchor-id="all-marker-analysis-1">All marker analysis</h3>
<p>without requiring uniqueness</p>
<p>Let’s run the analysis without requiring Variable genes be uniquely upregulated or downregulated in each cluster.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find markers for every cluster, keep only the positive ones</span></span>
<span id="cb81-2">koala_umap_markers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindAllMarkers</span>(koala_umap, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">only.pos =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.pct =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logfc.threshold =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 4</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 5</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 6</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 7</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating cluster 8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb91" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1">koala_umap_markers_10_per_cluster <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> koala_umap_markers <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb91-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cluster) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb91-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_max</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">order_by =</span> avg_log2FC)</span>
<span id="cb91-4">koala_umap_markers_10_per_cluster</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 90 × 7
# Groups:   cluster [9]
       p_val avg_log2FC pct.1 pct.2 p_val_adj cluster gene    
       &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;fct&gt;   &lt;chr&gt;   
 1 6.94e- 80       3.90 0.488 0.066 1.21e- 75 0       Bmp6    
 2 2.11e- 46       3.86 0.281 0.03  3.68e- 42 0       Col13a1 
 3 8.78e- 66       3.67 0.406 0.052 1.53e- 61 0       Galnt18 
 4 1.10e-126       3.61 0.73  0.113 1.93e-122 0       Adam23  
 5 2.37e- 48       3.60 0.313 0.04  4.13e- 44 0       Dnase1l3
 6 5.07e- 46       3.56 0.294 0.035 8.83e- 42 0       Srgap1  
 7 6.73e- 42       3.52 0.283 0.039 1.17e- 37 0       Clec4g  
 8 6.99e-172       3.49 0.929 0.186 1.22e-167 0       Stab2   
 9 4.34e- 77       3.40 0.488 0.069 7.57e- 73 0       Rasgrp3 
10 4.35e- 46       3.34 0.322 0.048 7.59e- 42 0       Gm15675 
# ℹ 80 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb93" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1">koala_umap_markers_10_per_nest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> koala_umap_markers_10_per_cluster <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb93-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(gene) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb93-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb93-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(data, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>.x[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]] )))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `cluster`</code></pre>
</div>
</div>
</section>
<section id="run-the-functon-in-df-env-1" class="level3">
<h3 class="anchored" data-anchor-id="run-the-functon-in-df-env-1">Run the functon in df env</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb95" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1">koala_umap_markers_10_per_nest_go_ano <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> koala_umap_markers_10_per_nest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb95-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"go_table"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(data, go_query_fun))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>No results to show
Please make sure that the organism is correct or set significant = FALSE
No results to show
Please make sure that the organism is correct or set significant = FALSE</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1">koala_umap_2way_markers_10_go_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> koala_umap_markers_10_per_nest_go_ano <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb97-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(go_table) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb97-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb97-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(go_table) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb97-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relocate</span>(term_name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.after =</span> cluster) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb97-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(cluster, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(p_value))</span>
<span id="cb97-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(koala_umap_markers_10_go_df)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 13
# Groups:   cluster [1]
  cluster term_name     p_value term_size query_size intersection_size precision
  &lt;fct&gt;   &lt;chr&gt;           &lt;dbl&gt;     &lt;int&gt;      &lt;int&gt;             &lt;int&gt;     &lt;dbl&gt;
1 0       virus corece…  0.0317         1         10                 1       0.1
2 0       polysacchari…  0.0453        26         10                 1       0.1
3 0       protein-lipi…  0.0453        30         10                 1       0.1
4 0       lipoprotein …  0.0453        30         10                 1       0.1
5 0       BMP receptor…  0.0453        14         10                 1       0.1
6 0       transmembran…  0.0453        21         10                 1       0.1
# ℹ 6 more variables: recall &lt;dbl&gt;, term_id &lt;chr&gt;, source &lt;chr&gt;,
#   effective_domain_size &lt;int&gt;, source_order &lt;int&gt;, parents &lt;list&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb99" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_csv</span>(koala_umap_2way_markers_10_go_df, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"koala_umap_2way_markers_10_go_bdf.csv"</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb100" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1">koala_umap_cluster_7 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindMarkers</span>(koala_umap, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ident.1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.pct =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>)</span>
<span id="cb100-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(koala_umap_cluster_7, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data frame with 0 columns and 10 rows</code></pre>
</div>
</div>
</section>
<section id="cluster-7" class="level3">
<h3 class="anchored" data-anchor-id="cluster-7">Cluster 7</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb102" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1">koala_umap_cluster_unique_7 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindMarkers</span>(koala_umap, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ident.1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ident.2 =</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.pct =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb102-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(koala_umap_cluster_unique_7, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rownames =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gene"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 6
   gene        p_val avg_log2FC pct.1 pct.2 p_val_adj
   &lt;chr&gt;       &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
 1 Mecom    2.22e-75       7.23 0.5   0.011  3.86e-71
 2 Jam2     5.96e-62       4.89 0.587 0.029  1.04e-57
 3 Heg1     4.21e-42       4.27 0.652 0.071  7.33e-38
 4 Cyyr1    3.32e-41       4.26 0.674 0.08   5.78e-37
 5 Pecam1   1.37e-38       4.35 0.587 0.061  2.39e-34
 6 Ptprb    1.13e-35       2.97 0.891 0.181  1.96e-31
 7 Plcb4    5.14e-32       3.71 0.543 0.063  8.96e-28
 8 Meis2    9.37e-32       3.24 0.717 0.122  1.63e-27
 9 Cdh13    1.61e-30       4.63 0.5   0.058  2.81e-26
10 Prex2    7.70e-28       3.09 0.761 0.176  1.34e-23
11 Cemip2   2.88e-27       3.52 0.674 0.126  5.02e-23
12 Crim1    2.23e-26       3.40 0.652 0.129  3.88e-22
13 Adgrf5   3.18e-25       3.29 0.522 0.076  5.54e-21
14 Calcrl   9.21e-21       2.85 0.609 0.132  1.61e-16
15 Arhgap31 8.63e-20       3.32 0.5   0.092  1.50e-15
16 Il6st    3.91e-18       2.71 0.652 0.183  6.82e-14
17 Eng      6.85e-18       2.88 0.5   0.099  1.19e-13
18 Ptprm    1.08e-15       2.31 0.587 0.152  1.88e-11
19 Plekhg1  2.40e-15       2.48 0.5   0.113  4.18e-11
20 Arl15    6.65e-14       2.69 0.717 0.325  1.16e- 9</code></pre>
</div>
</div>
<p>## postsynaptic density protein 95 clustering 6 2 .00 &gt; 100 + 5.20E-06 8.18E-03 ## postsynaptic membrane organization 31 2 .01 &gt; 100 + 9.74E-05 3.00E-02 ## postsynaptic density organization 28 2 .01 &gt; 100 + 8.03E-05 2.81E-02 ## postsynaptic specialization organization 34 2 .02 &gt; 100 + 1.16E-04 3.45E-02 ## NMDA glutamate receptor clustering 6 2 .00 &gt; 100 + 5.20E-06 7.43E-03 ## neurotransmitter-gated ion channel clustering 15 2 .01 &gt; 100 + 2.52E-05 1.80E-02 ## positive regulation of synapse maturation 10 2 .00 &gt; 100 + 1.22E-05 1.38E-02 ## regulation of synapse maturation 23 2 .01 &gt; 100 + 5.54E-05 2.64E-02</p>
<p>Cluster 7 looks like it may be</p>
</section>
</section>
</section>
<section id="cell-type-assignments" class="level1">
<h1>Cell type assignments</h1>
<section id="using-garnett" class="level2">
<h2 class="anchored" data-anchor-id="using-garnett">Using garnett</h2>
<p><a href="https://%20cole-trapnell-lab.github.io/garnett">Garnett</a> is a semi-supervised method of cell-type assignment for single cell data that is compatible with Seurat objects. It consists of four components. First, Garnett defines a markup language for specifying cell types using the genes that they specifically express. The markup language is hierarchical in that a cell type can have subtypes (for example, CD4+ and CD8+ are subsets of T cells). Second, Garnett includes a parser that processes the markup file together with a single-cell dataset, identifying representative cells bearing markers that unambiguously identify them as one of the cell types defined in the file. Third, Garnett trains a classifier that recognizes additional cells as belonging to each cell type based on their similarity to representative cells, similar to an approach that our groups recently developed for annotating a single-cell mouse atlas of chromatin accessibility. Garnett does not require that cells be organized into clusters, but it can optionally extend classifications to additional cells using either its own internal clustering routines or those of other tools. Finally, Garnett provides a method for applying a classifier trained on one dataset to rapidly annotate additional datasets.</p>
<section id="classifier" class="level3">
<h3 class="anchored" data-anchor-id="classifier">Classifier</h3>
<p><a href="https://cole-trapnell-lab.github.io/garnett/classifiers/">Garnett’s directory of already-available classifiers</a> indicates that one is available for Mouse Brain and spinal cord tissues, which I hypothesize is the primary content of this sample I am analyzed based on the gene ontology terms displayed and remarked upon in the previous section. The data are from Zeisel’s and Linnarrson’s <em>et al.</em> <a href="https://www.sciencedirect.com/science/article/pii/S009286741830789X">“Molecular Architecture of the Mouse Nervous System”</a> and were trained and deposited by <a href="https://www.nature.com/articles/s41592-019-0535-3">Pliner &amp; Trapnell <em>et al.</em></a>.</p>
<!-- I will download the "mmbrain" RDS file and import it into R as a classifier—which doesn't require a import special function; all R object structed is saved when the generic `saveRDS()` export function is run. -->
<div class="cell">
<div class="sourceCode cell-code" id="cb104" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># download.file("https://cole-trapnell-lab.github.io/garnett/classifiers/mmBrain_20191017.RDS",</span></span>
<span id="cb104-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#               "mmBrain_20191017.RDS")</span></span>
<span id="cb104-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">download.file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://cole-trapnell-lab.github.io/garnett/marker_files/mmBrain_markers.txt"</span>,</span>
<span id="cb104-4">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmBrain_markers.txt"</span>)</span></code></pre></div>
</div>
</section>
<section id="prepare-scrna-seq-data-for-garnett" class="level3">
<h3 class="anchored" data-anchor-id="prepare-scrna-seq-data-for-garnett">Prepare scRNA-seq data for garnett</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb105" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use Seurat to convert Seurat dimensionally reduced object to a CellDataSet object</span></span>
<span id="cb105-2">koala_umap_cds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.CellDataSet</span>(koala_umap)</span>
<span id="cb105-3"></span>
<span id="cb105-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># generate size factors for normalization later</span></span>
<span id="cb105-5">koala_umap_cds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">estimateSizeFactors</span>(koala_umap_cds)</span></code></pre></div>
</div>
</section>
<section id="prepare-trained-classified-from-heirarchical-marker-gene-file" class="level3">
<h3 class="anchored" data-anchor-id="prepare-trained-classified-from-heirarchical-marker-gene-file">Prepare trained classified from heirarchical marker gene file</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb106" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(org.Mm.eg.db)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: AnnotationDbi</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: IRanges</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: S4Vectors</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'S4Vectors'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:Matrix':

    expand, unname</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:tidyr':

    expand</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:dplyr':

    first, rename</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:utils':

    findMatches</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    expand.grid, I, unname</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'IRanges'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:sp':

    %over%</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:purrr':

    reduce</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:dplyr':

    collapse, desc, slice</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'AnnotationDbi'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    select</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="sourceCode cell-code" id="cb123" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1">marker_file_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmBrain_markers.txt"</span></span>
<span id="cb123-2"></span>
<span id="cb123-3">marker_check <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">check_markers</span>(koala_umap_cds, marker_file_path,</span>
<span id="cb123-4">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">db =</span> org.Mm.eg.db,</span>
<span id="cb123-5">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cds_gene_id_type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SYMBOL"</span>,</span>
<span id="cb123-6">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">marker_file_gene_id_type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SYMBOL"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>There are 144 cell type definitions</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb125" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1">marker_cell_types_analysis <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> marker_check <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb125-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_type"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_type"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parent"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb125-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_cds"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_type"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parent"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in_cds"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb125-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(n_type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb125-5">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_type"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parent"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in_cds"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_type"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_cds"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb125-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>()</span>
<span id="cb125-7">marker_cell_types_analysis</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                             cell_type
1                                                              Neurons
2                                                              Neurons
3                    Cholinergic monoaminergic and peptidergic neurons
4                    Cholinergic monoaminergic and peptidergic neurons
5                                                             CNS glia
6                                                             CNS glia
7                                        Di- and mesencephalon neurons
8                                        Di- and mesencephalon neurons
9                                           Telencephalon interneurons
10                                          Telencephalon interneurons
11                               Cholinergic and monoaminergic neurons
12                               Cholinergic and monoaminergic neurons
13                                    Telencephalon projecting neurons
14                                    Telencephalon projecting neurons
15                                                Astroependymal cells
16                                                Astroependymal cells
17                                          Peripheral sensory neurons
18                                          Peripheral sensory neurons
19                               Telencephalon inhibitory interneurons
20                               Telencephalon inhibitory interneurons
21                            Di- and mesencephalon excitatory neurons
22                            Di- and mesencephalon excitatory neurons
23                                              Neural crest-like glia
24                                              Neural crest-like glia
25                                                 Peptidergic neurons
26                                                 Peptidergic neurons
27                                                    Oligodendrocytes
28                                                    Oligodendrocytes
29                                                      Vascular cells
30                                                      Vascular cells
31                         Telencephalon projecting excitatory neurons
32                         Telencephalon projecting excitatory neurons
33                            Di- and mesencephalon inhibitory neurons
34                            Di- and mesencephalon inhibitory neurons
35                                                          Astrocytes
36                                                          Astrocytes
37                          Peripheral sensory non-peptidergic neurons
38                          Peripheral sensory non-peptidergic neurons
39                                                     Enteric neurons
40                                                     Enteric neurons
41                                  Excitatory neurons cerebral cortex
42                                  Excitatory neurons cerebral cortex
43                                                 Spinal cord neurons
44                                                 Spinal cord neurons
45                         Telencephalon projecting inhibitory neurons
46                         Telencephalon projecting inhibitory neurons
47                                                        Enteric glia
48                                                        Enteric glia
49                                                     Immature neural
50                                                     Immature neural
51                              Peripheral sensory peptidergic neurons
52                              Peripheral sensory peptidergic neurons
53                                        Olfactory inhibitory neurons
54                                        Olfactory inhibitory neurons
55                                      Inhibitory neurons midbrain di
56                                      Inhibitory neurons midbrain di
57                                                Serotonergic neurons
58                                                Serotonergic neurons
59                                                        Immune cells
60                                                        Immune cells
61                                                 Sympathetic neurons
62                                                 Sympathetic neurons
63                                                   Hindbrain neurons
64                                                   Hindbrain neurons
65                                         Cholinergic enteric neurons
66                                         Cholinergic enteric neurons
67                                                  Cerebellum neurons
68                                                  Cerebellum neurons
69                                                           Microglia
70                                                           Microglia
71                                         Excitatory neurons midbrain
72                                         Excitatory neurons midbrain
73                                             Mature oligodendrocytes
74                                             Mature oligodendrocytes
75                                      Spinal cord excitatory neurons
76                                      Spinal cord excitatory neurons
77                                                     Ependymal cells
78                                                     Ependymal cells
79                                           Glutamatergic neuroblasts
80                                           Glutamatergic neuroblasts
81                                   Sympathetic noradrenergic neurons
82                                   Sympathetic noradrenergic neurons
83                                                           Pericytes
84                                                           Pericytes
85                            Peripheral sensory neurofilament neurons
86                            Peripheral sensory neurofilament neurons
87                                       Vascular leptomeningeal cells
88                                       Vascular leptomeningeal cells
89                                    Peptidergic neurons hypothalamus
90                                    Peptidergic neurons hypothalamus
91                                       Non-glutamatergic neuroblasts
92                                       Non-glutamatergic neuroblasts
93                                      Spinal cord inhibitory neurons
94                                      Spinal cord inhibitory neurons
95                     R-LM border Cck interneurons cortex/hippocampus
96                                   Inhibitory neurons olfactory bulb
97                                   Inhibitory neurons olfactory bulb
98                                      Excitatory neurons spinal cord
99                                    D1 medium spiny neurons striatum
100                                   D1 medium spiny neurons striatum
101                                    Myelin forming oligodendrocytes
102                                    Myelin forming oligodendrocytes
103                               Noradrenergic neurons of the medulla
104                               Noradrenergic neurons of the medulla
105                                          Nitrergic enteric neurons
106                                          Nitrergic enteric neurons
107                                  Excitatory neurons hindbrain hind
108                                  Excitatory neurons hindbrain hind
109                                              Neuroblasts olfactory
110                                       Non-telencephalon astrocytes
111                                       Non-telencephalon astrocytes
112                                Inhibitory neurons spinal cord spin
113                                                     Satellite glia
114                                                     Satellite glia
115                                      Newly formed oligodendrocytes
116                                      Newly formed oligodendrocytes
117                                      Dentate gyrus granule neurons
118                                      Dentate gyrus granule neurons
119 Sleep-active long-range projection interneurons cortex/hippocampus
120 Sleep-active long-range projection interneurons cortex/hippocampus
121                                    Inhibitory neurons hindbrain di
122                                    Inhibitory neurons hindbrain di
123                                       Vascular smooth muscle cells
124                                       Vascular smooth muscle cells
125                                    Excitatory neurons hypothalamus
126                                                     Purkinje cells
127                                                     Purkinje cells
128                           Afferent nuclei of cranial nerves VI-XII
129                           Afferent nuclei of cranial nerves VI-XII
130                                           Perivascular macrophages
131                                           Perivascular macrophages
132                           Cholinergic neurons midbrain red nucleus
133                                   Inhibitory neurons telencephalon
134                     Non-border Cck interneurons cortex/hippocampus
135                                  Central canal neurons spinal cord
136                                           Choroid epithelial cells
137                                    Enteric mesothelial fibroblasts
138                           Dopaminergic neurons periaqueductal grey
139                External plexiform layer interneuron olfactory bulb
140                              Adrenergic cell groups of the medulla
141                              Adrenergic cell groups of the medulla
142                                        Excitatory neurons thalamus
143                                        Excitatory neurons thalamus
144              Interneuron-selective interneurons cortex/hippocampus
145              Interneuron-selective interneurons cortex/hippocampus
146                              Subcommissural organ hypendymal cells
147                                           Telencephalon astrocytes
148                                   D2 medium spiny neurons striatum
149                                   D2 medium spiny neurons striatum
150                                  Excitatory neurons hindbrain spin
151                                      Granule neurons dentate gyrus
152                                      Granule neurons dentate gyrus
153                                    Sympathetic cholinergic neurons
154                                    Sympathetic cholinergic neurons
155                                   Committed oligodendrocytes cells
156                                   Committed oligodendrocytes cells
157                                        Olfactory ensheathing cells
158                                        Olfactory ensheathing cells
159                                       Excitatory neurons hindbrain
160                                         Vascular endothelial cells
161                               Inner horizontal cell olfactory bulb
162                               Inner horizontal cell olfactory bulb
163                         Subventricular zone radial glia-like cells
164                         Subventricular zone radial glia-like cells
165                                  Inhibitory neurons hindbrain hind
166                                  Inhibitory neurons hindbrain hind
167                                         Matrix D1 neurons striatum
168                                                      Bergmann Glia
169                 CGE-derived neurogliaform cells cortex/hippocampus
170                                        Neuroblasts cerebellum glut
171                                    Cajal-Retzius cells hippocampus
172                               Dentate gyrus radial glia-like cells
173              Glutamatergic projection neurons of the raphe nucleus
174                                   Inhibitory neurons midbrain pept
175                                  Granule neuroblasts dentate gyrus
176                                      Cholinergic neurons hindbrain
177                                       Patch D1/D2 neurons striatum
178     Cholinergic neurons septal nucleus Meissnert and diagonal band
179                                 Inhibitory neurons hypothalamus di
180                                         Granule neurons cerebellum
181                              Neuronal intermidate progenitor cells
182                                               Olfactory astrocytes
183                                         Neuroblasts olfactory bulb
184                                   Oligodendrocytes precursor cells
185                                        Inhibitory neurons thalamus
186                                Inhibitory interneurons hippocampus
187                             Granule neuroblasts dentate gyrus dent
188                                        Inhibitory neurons midbrain
189                                                      Schwann cells
190                                             Neuroblasts cerebellum
191                            Molecular layer interneurons cerebellum
192                                           Neuroblast-like habenula
193                              Oxytocin-producing cells hypothalamus
194                                          Pmch neurons hypothalamus
195                           Vasopressin-producing cells hypothalamus
196         Ivy and MGE-derived neurogliaform cells cortex/hippocampus
197                                                 Neuroblasts septum
198                                     Inhibitory neurons spinal cord
199                                 Excitatory neurons hippocampus CA1
200                   Basket and bistratified cells cortex/hippocampus
201                                 Excitatory neurons hippocampus CA3
202                             Cholinergic interneurons telencephalon
203                            Afferent nuclei of cranial nerves III-V
204                                        Inhibitory neurons pallidum
205                                   Inhibitory neurons thalamus tele
206                                    Inhibitory neurons hypothalamus
207             Dopaminergic periglomerular interneuron olfactory bulb
208                     Hippocamposeptal projection cortex/hippocampus
209                                       Trilaminar cells hippocampus
210                              Dopaminergic neurons ventral midbrain
211                             Granular layer interneurons cerebellum
212                                      Axo-axonic cortex/hippocampus
213                     Dorsal midbrain Myoc-expressing astrocyte-like
214                                        Excitatory neurons amygdala
215                              Orexin-producing neurons hypothalamus
216                                  Inhibitory neurons septal nucleus
217                                       Inhibitory neurons hindbrain
218                                       Cholinergic neurons habenula
                                               parent in_cds n_type n_cds
1                                                root  FALSE    197   119
2                                                root   TRUE    197    78
3                                             Neurons  FALSE     42    26
4                                             Neurons   TRUE     42    16
5                                                root   TRUE     38    17
6                                                root  FALSE     38    21
7                                             Neurons  FALSE     31    19
8                                             Neurons   TRUE     31    12
9                                             Neurons  FALSE     28    18
10                                            Neurons   TRUE     28    10
11  Cholinergic monoaminergic and peptidergic neurons   TRUE     25    10
12  Cholinergic monoaminergic and peptidergic neurons  FALSE     25    15
13                                            Neurons  FALSE     25    14
14                                            Neurons   TRUE     25    11
15                                           CNS glia   TRUE     24    11
16                                           CNS glia  FALSE     24    13
17                                            Neurons  FALSE     23    14
18                                            Neurons   TRUE     23     9
19                         Telencephalon interneurons  FALSE     20    12
20                         Telencephalon interneurons   TRUE     20     8
21                      Di- and mesencephalon neurons  FALSE     18    14
22                      Di- and mesencephalon neurons   TRUE     18     4
23                                               root   TRUE     18    12
24                                               root  FALSE     18     6
25  Cholinergic monoaminergic and peptidergic neurons  FALSE     16    10
26  Cholinergic monoaminergic and peptidergic neurons   TRUE     16     6
27                                           CNS glia  FALSE     14     8
28                                           CNS glia   TRUE     14     6
29                                               root  FALSE     13     5
30                                               root   TRUE     13     8
31                   Telencephalon projecting neurons   TRUE     13     5
32                   Telencephalon projecting neurons  FALSE     13     8
33                      Di- and mesencephalon neurons   TRUE     13     8
34                      Di- and mesencephalon neurons  FALSE     13     5
35                               Astroependymal cells  FALSE     12     5
36                               Astroependymal cells   TRUE     12     7
37                         Peripheral sensory neurons  FALSE     11     9
38                         Peripheral sensory neurons   TRUE     11     2
39                                            Neurons  FALSE     10     7
40                                            Neurons   TRUE     10     3
41        Telencephalon projecting excitatory neurons   TRUE     10     4
42        Telencephalon projecting excitatory neurons  FALSE     10     6
43                                            Neurons  FALSE     10     5
44                                            Neurons   TRUE     10     5
45                   Telencephalon projecting neurons  FALSE      9     4
46                   Telencephalon projecting neurons   TRUE      9     5
47                             Neural crest-like glia  FALSE      9     3
48                             Neural crest-like glia   TRUE      9     6
49                                            Neurons  FALSE      9     5
50                                            Neurons   TRUE      9     4
51                         Peripheral sensory neurons  FALSE      8     3
52                         Peripheral sensory neurons   TRUE      8     5
53                         Telencephalon interneurons  FALSE      8     6
54                         Telencephalon interneurons   TRUE      8     2
55           Di- and mesencephalon inhibitory neurons  FALSE      8     3
56           Di- and mesencephalon inhibitory neurons   TRUE      8     5
57              Cholinergic and monoaminergic neurons   TRUE      8     5
58              Cholinergic and monoaminergic neurons  FALSE      8     3
59                                               root   TRUE      8     4
60                                               root  FALSE      8     4
61                                            Neurons  FALSE      7     3
62                                            Neurons   TRUE      7     4
63                                            Neurons  FALSE      7     5
64                                            Neurons   TRUE      7     2
65                                    Enteric neurons   TRUE      7     2
66                                    Enteric neurons  FALSE      7     5
67                                            Neurons  FALSE      7     5
68                                            Neurons   TRUE      7     2
69                                       Immune cells   TRUE      6     3
70                                       Immune cells  FALSE      6     3
71           Di- and mesencephalon excitatory neurons  FALSE      6     4
72           Di- and mesencephalon excitatory neurons   TRUE      6     2
73                                   Oligodendrocytes  FALSE      6     4
74                                   Oligodendrocytes   TRUE      6     2
75                                Spinal cord neurons  FALSE      5     3
76                                Spinal cord neurons   TRUE      5     2
77                               Astroependymal cells  FALSE      5     4
78                               Astroependymal cells   TRUE      5     1
79                                    Immature neural  FALSE      5     4
80                                    Immature neural   TRUE      5     1
81                                Sympathetic neurons   TRUE      5     3
82                                Sympathetic neurons  FALSE      5     2
83                                     Vascular cells  FALSE      4     1
84                                     Vascular cells   TRUE      4     3
85                         Peripheral sensory neurons  FALSE      4     2
86                         Peripheral sensory neurons   TRUE      4     2
87                                     Vascular cells   TRUE      4     3
88                                     Vascular cells  FALSE      4     1
89                                Peptidergic neurons  FALSE      4     3
90                                Peptidergic neurons   TRUE      4     1
91                                    Immature neural   TRUE      4     3
92                                    Immature neural  FALSE      4     1
93                                Spinal cord neurons   TRUE      4     1
94                                Spinal cord neurons  FALSE      4     3
95              Telencephalon inhibitory interneurons   TRUE      3     3
96                       Olfactory inhibitory neurons   TRUE      3     1
97                       Olfactory inhibitory neurons  FALSE      3     2
98                     Spinal cord excitatory neurons  FALSE      3     3
99        Telencephalon projecting inhibitory neurons   TRUE      3     2
100       Telencephalon projecting inhibitory neurons  FALSE      3     1
101                                  Oligodendrocytes   TRUE      3     1
102                                  Oligodendrocytes  FALSE      3     2
103             Cholinergic and monoaminergic neurons  FALSE      3     1
104             Cholinergic and monoaminergic neurons   TRUE      3     2
105                                   Enteric neurons  FALSE      3     2
106                                   Enteric neurons   TRUE      3     1
107                                 Hindbrain neurons  FALSE      3     2
108                                 Hindbrain neurons   TRUE      3     1
109                         Glutamatergic neuroblasts  FALSE      3     3
110                                        Astrocytes  FALSE      3     1
111                                        Astrocytes   TRUE      3     2
112                    Spinal cord inhibitory neurons  FALSE      3     3
113                            Neural crest-like glia  FALSE      3     2
114                            Neural crest-like glia   TRUE      3     1
115                                  Oligodendrocytes   TRUE      3     2
116                                  Oligodendrocytes  FALSE      3     1
117                  Telencephalon projecting neurons  FALSE      3     2
118                  Telencephalon projecting neurons   TRUE      3     1
119             Telencephalon inhibitory interneurons  FALSE      2     1
120             Telencephalon inhibitory interneurons   TRUE      2     1
121          Di- and mesencephalon inhibitory neurons   TRUE      2     1
122          Di- and mesencephalon inhibitory neurons  FALSE      2     1
123                                    Vascular cells  FALSE      2     1
124                                    Vascular cells   TRUE      2     1
125          Di- and mesencephalon excitatory neurons  FALSE      2     2
126                                Cerebellum neurons  FALSE      2     1
127                                Cerebellum neurons   TRUE      2     1
128             Cholinergic and monoaminergic neurons  FALSE      2     1
129             Cholinergic and monoaminergic neurons   TRUE      2     1
130                                      Immune cells  FALSE      2     1
131                                      Immune cells   TRUE      2     1
132          Di- and mesencephalon excitatory neurons  FALSE      2     2
133                               Peptidergic neurons  FALSE      2     2
134             Telencephalon inhibitory interneurons  FALSE      2     2
135                               Peptidergic neurons   TRUE      2     2
136                              Astroependymal cells  FALSE      2     2
137                            Neural crest-like glia   TRUE      2     2
138             Cholinergic and monoaminergic neurons  FALSE      2     2
139                      Olfactory inhibitory neurons  FALSE      2     2
140             Cholinergic and monoaminergic neurons   TRUE      2     1
141             Cholinergic and monoaminergic neurons  FALSE      2     1
142          Di- and mesencephalon excitatory neurons   TRUE      2     1
143          Di- and mesencephalon excitatory neurons  FALSE      2     1
144             Telencephalon inhibitory interneurons   TRUE      2     1
145             Telencephalon inhibitory interneurons  FALSE      2     1
146                              Astroependymal cells   TRUE      2     2
147                                        Astrocytes   TRUE      2     2
148       Telencephalon projecting inhibitory neurons   TRUE      2     1
149       Telencephalon projecting inhibitory neurons  FALSE      2     1
150                    Spinal cord excitatory neurons   TRUE      2     2
151                     Dentate gyrus granule neurons  FALSE      2     1
152                     Dentate gyrus granule neurons   TRUE      2     1
153                               Sympathetic neurons   TRUE      2     1
154                               Sympathetic neurons  FALSE      2     1
155                                  Oligodendrocytes  FALSE      2     1
156                                  Oligodendrocytes   TRUE      2     1
157                            Neural crest-like glia  FALSE      2     1
158                            Neural crest-like glia   TRUE      2     1
159          Di- and mesencephalon excitatory neurons  FALSE      2     2
160                                    Vascular cells  FALSE      2     2
161                      Olfactory inhibitory neurons  FALSE      2     1
162                      Olfactory inhibitory neurons   TRUE      2     1
163                              Astroependymal cells   TRUE      2     1
164                              Astroependymal cells  FALSE      2     1
165                                 Hindbrain neurons  FALSE      2     1
166                                 Hindbrain neurons   TRUE      2     1
167       Telencephalon projecting inhibitory neurons   TRUE      1     1
168                                        Astrocytes   TRUE      1     1
169             Telencephalon inhibitory interneurons  FALSE      1     1
170                         Glutamatergic neuroblasts   TRUE      1     1
171          Di- and mesencephalon excitatory neurons  FALSE      1     1
172                              Astroependymal cells  FALSE      1     1
173             Cholinergic and monoaminergic neurons  FALSE      1     1
174                               Peptidergic neurons  FALSE      1     1
175                     Non-glutamatergic neuroblasts  FALSE      1     1
176                                 Hindbrain neurons  FALSE      1     1
177       Telencephalon projecting inhibitory neurons   TRUE      1     1
178             Cholinergic and monoaminergic neurons  FALSE      1     1
179          Di- and mesencephalon inhibitory neurons   TRUE      1     1
180                                Cerebellum neurons  FALSE      1     1
181                     Non-glutamatergic neuroblasts   TRUE      1     1
182                                        Astrocytes   TRUE      1     1
183                     Non-glutamatergic neuroblasts   TRUE      1     1
184                            Neural crest-like glia   TRUE      1     1
185                               Peptidergic neurons   TRUE      1     1
186             Telencephalon inhibitory interneurons   TRUE      1     1
187                     Dentate gyrus granule neurons  FALSE      1     1
188                                Cerebellum neurons  FALSE      1     1
189                            Neural crest-like glia   TRUE      1     1
190                                Cerebellum neurons  FALSE      1     1
191                                Cerebellum neurons  FALSE      1     1
192                     Non-glutamatergic neuroblasts   TRUE      1     1
193                               Peptidergic neurons  FALSE      1     1
194             Cholinergic and monoaminergic neurons  FALSE      1     1
195                               Peptidergic neurons   TRUE      1     1
196             Telencephalon inhibitory interneurons   TRUE      1     1
197                         Glutamatergic neuroblasts  FALSE      1     1
198                                 Hindbrain neurons  FALSE      1     1
199       Telencephalon projecting excitatory neurons  FALSE      1     1
200             Telencephalon inhibitory interneurons  FALSE      1     1
201       Telencephalon projecting excitatory neurons  FALSE      1     1
202             Cholinergic and monoaminergic neurons  FALSE      1     1
203             Cholinergic and monoaminergic neurons  FALSE      1     1
204          Di- and mesencephalon inhibitory neurons  FALSE      1     1
205             Telencephalon inhibitory interneurons  FALSE      1     1
206                               Peptidergic neurons  FALSE      1     1
207                      Olfactory inhibitory neurons  FALSE      1     1
208             Telencephalon inhibitory interneurons  FALSE      1     1
209             Telencephalon inhibitory interneurons  FALSE      1     1
210             Cholinergic and monoaminergic neurons  FALSE      1     1
211                                Cerebellum neurons   TRUE      1     1
212             Telencephalon inhibitory interneurons  FALSE      1     1
213                                        Astrocytes  FALSE      1     1
214       Telencephalon projecting excitatory neurons   TRUE      1     1
215             Cholinergic and monoaminergic neurons  FALSE      1     1
216                               Peptidergic neurons  FALSE      1     1
217                    Spinal cord inhibitory neurons   TRUE      1     1
218          Di- and mesencephalon excitatory neurons  FALSE      1     1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb127" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_csv</span>(marker_check_analysis, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmBrain_markers_marker_check_analysis.csv"</span>)</span></code></pre></div>
</div>
<p>Make a table showing percent of genes for each cell type sub-classification that are present so I can filter and subset the marker genes to decrease the complexity of the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1">marker_cell_types_prefilter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> marker_cell_types_analysis <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb128-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>n_type) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb128-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_type"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parent"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_cds"</span>,</span>
<span id="cb128-4">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in_cds"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_glue =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gene_present_{in_cds}"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb128-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"percent_genes_present"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> gene_present_TRUE <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (gene_present_TRUE <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> gene_present_FALSE)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb128-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relocate</span>(gene_present_TRUE, percent_genes_present, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.after =</span> parent) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb128-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(gene_present_TRUE), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(percent_genes_present))</span>
<span id="cb128-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(marker_cell_types_prefilter)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  cell_type    parent gene_present_TRUE percent_genes_present gene_present_FALSE
  &lt;chr&gt;        &lt;chr&gt;              &lt;int&gt;                 &lt;dbl&gt;              &lt;int&gt;
1 Neurons      root                  78                 0.396                119
2 CNS glia     root                  17                 0.447                 21
3 Cholinergic… Neuro…                16                 0.381                 26
4 Neural cres… root                  12                 0.667                  6
5 Di- and mes… Neuro…                12                 0.387                 19
6 Astroependy… CNS g…                11                 0.458                 13</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb130" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1">marker_cell_types_postfilter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> marker_cell_types_prefilter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb130-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(parent <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"root"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> gene_present_TRUE <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> percent_genes_present <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.49</span>)</span>
<span id="cb130-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(marker_cell_types_postfilter)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  cell_type    parent gene_present_TRUE percent_genes_present gene_present_FALSE
  &lt;chr&gt;        &lt;chr&gt;              &lt;int&gt;                 &lt;dbl&gt;              &lt;int&gt;
1 Neurons      root                  78                 0.396                119
2 CNS glia     root                  17                 0.447                 21
3 Cholinergic… Neuro…                16                 0.381                 26
4 Neural cres… root                  12                 0.667                  6
5 Di- and mes… Neuro…                12                 0.387                 19
6 Astroependy… CNS g…                11                 0.458                 13</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb132" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1">marker_df_filtered <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> marker_check <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb132-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># filter for cell_types retained by filter line in "postfilter"</span></span>
<span id="cb132-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">semi_join</span>(marker_cell_types_postfilter, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_type"</span>)</span>
<span id="cb132-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(marker_df_filtered)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  marker_gene            gene_id                                parent
1       Crhbp ENSMUSG00000021680 Telencephalon inhibitory interneurons
2       Tacr1 ENSMUSG00000030043 Telencephalon inhibitory interneurons
3         Trh ENSMUSG00000005892                               Neurons
4        Trdn ENSMUSG00000019787                               Neurons
5      Nccrp1 ENSMUSG00000047586                               Neurons
6        Dlx5 ENSMUSG00000029755                               Neurons
                                                           cell_type in_cds
1 Sleep-active long-range projection interneurons cortex/hippocampus  FALSE
2 Sleep-active long-range projection interneurons cortex/hippocampus   TRUE
3                                         Telencephalon interneurons  FALSE
4                                         Telencephalon interneurons   TRUE
5                                         Telencephalon interneurons  FALSE
6                                         Telencephalon interneurons  FALSE
  nominates total_nominated exclusion_dismisses inclusion_ambiguates
1        NA              NA                  NA                   NA
2         1               1                   1                    0
3        NA              NA                  NA                   NA
4         1             158                   1                    1
5        NA              NA                  NA                   NA
6        NA              NA                  NA                   NA
        most_overlap ambiguity marker_score         summary
1               &lt;NA&gt;        NA           NA      Not in CDS
2               &lt;NA&gt;         0 1.000000e+02              Ok
3               &lt;NA&gt;        NA           NA      Not in CDS
4 Cerebellum neurons         1 6.266449e-03 High ambiguity?
5               &lt;NA&gt;        NA           NA      Not in CDS
6               &lt;NA&gt;        NA           NA      Not in CDS</code></pre>
</div>
<div class="sourceCode cell-code" id="cb134" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1">marker_df_filtered_orphans <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> marker_df_filtered <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb134-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">anti_join</span>(., ., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_type"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parent"</span>))</span>
<span id="cb134-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(marker_df_filtered_orphans)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  marker_gene            gene_id                                parent
1       Crhbp ENSMUSG00000021680 Telencephalon inhibitory interneurons
2       Tacr1 ENSMUSG00000030043 Telencephalon inhibitory interneurons
3         Trh ENSMUSG00000005892                               Neurons
4        Trdn ENSMUSG00000019787                               Neurons
5      Nccrp1 ENSMUSG00000047586                               Neurons
6        Dlx5 ENSMUSG00000029755                               Neurons
                                                           cell_type in_cds
1 Sleep-active long-range projection interneurons cortex/hippocampus  FALSE
2 Sleep-active long-range projection interneurons cortex/hippocampus   TRUE
3                                         Telencephalon interneurons  FALSE
4                                         Telencephalon interneurons   TRUE
5                                         Telencephalon interneurons  FALSE
6                                         Telencephalon interneurons  FALSE
  nominates total_nominated exclusion_dismisses inclusion_ambiguates
1        NA              NA                  NA                   NA
2         1               1                   1                    0
3        NA              NA                  NA                   NA
4         1             158                   1                    1
5        NA              NA                  NA                   NA
6        NA              NA                  NA                   NA
        most_overlap ambiguity marker_score         summary
1               &lt;NA&gt;        NA           NA      Not in CDS
2               &lt;NA&gt;         0 1.000000e+02              Ok
3               &lt;NA&gt;        NA           NA      Not in CDS
4 Cerebellum neurons         1 6.266449e-03 High ambiguity?
5               &lt;NA&gt;        NA           NA      Not in CDS
6               &lt;NA&gt;        NA           NA      Not in CDS</code></pre>
</div>
<div class="sourceCode cell-code" id="cb136" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1">marker_df_filtered_orph_rem <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">anti_join</span>(marker_df_filtered, marker_df_filtered_orphans, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"marker_gene"</span>)</span>
<span id="cb136-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(marker_df_filtered_orph_rem)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  marker_gene            gene_id  parent                  cell_type in_cds
1      Gm7271               &lt;NA&gt; Neurons Peripheral sensory neurons  FALSE
2     Fam19a4               &lt;NA&gt; Neurons Peripheral sensory neurons  FALSE
3        Tlx3 ENSMUSG00000040610 Neurons Peripheral sensory neurons  FALSE
4      Mrgprd ENSMUSG00000051207 Neurons Peripheral sensory neurons  FALSE
5        Otoa ENSMUSG00000034990 Neurons Peripheral sensory neurons   TRUE
6     Mrgpra3 ENSMUSG00000078698 Neurons Peripheral sensory neurons  FALSE
  nominates total_nominated exclusion_dismisses inclusion_ambiguates
1        NA              NA                  NA                   NA
2        NA              NA                  NA                   NA
3        NA              NA                  NA                   NA
4        NA              NA                  NA                   NA
5         1             275                   0                    0
6        NA              NA                  NA                   NA
  most_overlap ambiguity marker_score    summary
1         &lt;NA&gt;        NA           NA  Not in db
2         &lt;NA&gt;        NA           NA  Not in db
3         &lt;NA&gt;        NA           NA Not in CDS
4         &lt;NA&gt;        NA           NA Not in CDS
5         &lt;NA&gt;         0    0.3636364         Ok
6         &lt;NA&gt;        NA           NA Not in CDS</code></pre>
</div>
</div>
<p>I also have to head off an error about parent cell types referred to in the parent field of other entries not being present by doing a recursive semi_join. See the error copied below: <code>Error in check_markers(koala_umap_cds, marker_file_path, db = org.Mm.eg.db, : Subtype Telencephalon inhibitory interneurons is not defined in marker file.Subtype Cerebellum neurons is not defined in marker file.Subtype root is not defined in marker file.Subtype Di- and mesencephalon excitatory neurons is not defined in marker file.Subtype Dentate gyrus granule neurons is not defined in marker file.Subtype Oligodendrocytes is not defined in marker file.Subtype Immature neural is not defined in marker file.Subtype Olfactory inhibitory neurons is not defined in marker file.Subtype Hindbrain neurons is not defined in marker file.</code></p>
<p><strong>2023-05-29 14:36 PM</strong> <strong>Where I left off: Marker checks are writing to disk and are parsing. But missing parents (orphaned cell types) are still in the marker .txt specs, and I have misplaced the dataframes that actually contain the gene info.</strong></p>
<section id="write-new-marker-file-to-disk" class="level4">
<h4 class="anchored" data-anchor-id="write-new-marker-file-to-disk">write new marker file to disk</h4>
<p>The basic structure of the Garnett marker file is a series of entries, each describing elements of a cell type. After the cell name, each additional line will be a descriptor, which begins with a keyword, followed by a colon (‘:’). After the colon, a series of specifications can be added, separated by commas (‘,’). Descriptors may spill onto following lines so long as you do not split a specification across multiple lines (i.e.&nbsp;if breaking up a long descriptor across multiple lines, all but the last line should end with a comma). Each new descriptor should begin on a new line. A generic cell type entry looks like this:</p>
<p>“’ &gt; cell type name descriptor: spec1, spec2, spec3, spec4 descriptor2: spec1 “’</p>
</section>
<section id="define-new-writer-function" class="level4">
<h4 class="anchored" data-anchor-id="define-new-writer-function">define new writer function</h4>
<p>The joy of for loops</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1">write_garnett_marker_file <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(marker_df, filename){</span>
<span id="cb138-2">  </span>
<span id="cb138-3">  marker_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> marker_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb138-4">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(cell_type, parent, marker_gene) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb138-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"marker_gene"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(marker_gene, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>),</span>
<span id="cb138-6">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(cell_type, parent))</span>
<span id="cb138-7">  </span>
<span id="cb138-8">  marker_file_lines <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>()</span>
<span id="cb138-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (rowNum <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(marker_df)){</span>
<span id="cb138-10">    marker_file_lines <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(marker_file_lines, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;"</span>, marker_df[rowNum, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_type"</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)))</span>
<span id="cb138-11">    </span>
<span id="cb138-12">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(marker_df[rowNum, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parent"</span>])) {</span>
<span id="cb138-13">        </span>
<span id="cb138-14">      } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(marker_df[rowNum, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parent"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"root"</span>) {</span>
<span id="cb138-15">        </span>
<span id="cb138-16">      } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(marker_df[rowNum, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parent"</span>])) {</span>
<span id="cb138-17">        marker_file_lines <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(marker_file_lines, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"subtype of:"</span>, marker_df[rowNum, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parent"</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>)))</span>
<span id="cb138-18">      }</span>
<span id="cb138-19">    </span>
<span id="cb138-20">    marker_file_lines <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(marker_file_lines, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"expressed:"</span>, marker_df[rowNum, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"marker_gene"</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>)))</span>
<span id="cb138-21">    marker_file_lines <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(marker_file_lines, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb138-22">  }</span>
<span id="cb138-23">  </span>
<span id="cb138-24">  fileConn <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file</span>(filename)</span>
<span id="cb138-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">writeLines</span>(marker_file_lines, fileConn)</span>
<span id="cb138-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">close</span>(fileConn)</span>
<span id="cb138-27">}</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb139" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_garnett_marker_file</span>(marker_df_filtered_orph_rem, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmBrain_markers_filtered.txt"</span>)</span></code></pre></div>
</div>
</section>
</section>
<section id="prepare-trained-classified-from-heirarchical-marker-gene-file-1" class="level3">
<h3 class="anchored" data-anchor-id="prepare-trained-classified-from-heirarchical-marker-gene-file-1">Prepare trained classified from heirarchical marker gene file</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb140" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(org.Mm.eg.db)</span>
<span id="cb140-2"></span>
<span id="cb140-3">marker_file_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmBrain_markers_filtered.txt"</span></span>
<span id="cb140-4"></span>
<span id="cb140-5">marker_check <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">check_markers</span>(koala_umap_cds, marker_file_path,</span>
<span id="cb140-6">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">db =</span> org.Mm.eg.db,</span>
<span id="cb140-7">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cds_gene_id_type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SYMBOL"</span>,</span>
<span id="cb140-8">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">marker_file_gene_id_type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SYMBOL"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>There are 13 cell type definitions</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb142" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1">marker_check_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_markers</span>(marker_check)</span></code></pre></div>
</div>
<p>The marker plot is too large to be viewed in R or in the Rmarkdown output. (It errors). Please view “mmBrain_markers_check_plot.png” in the google drive filesystem. It is exported with manually-found dimensions that work for display and do not error.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmBrain_markers_check_plot.png"</span>, marker_check_plot, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limitsize =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span></code></pre></div>
</div>
<p>Basically, this is a really big model.</p>
</section>
<section id="train-the-classifier" class="level3">
<h3 class="anchored" data-anchor-id="train-the-classifier">Train the classifier</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb144" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import previoously trained classifier</span></span>
<span id="cb144-2">mmBrain_classifier <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../pdcherry_github_data/scRNAseq/2023_06_03-13_cell_def_mmBrain_classifier.Rds"</span>)</span></code></pre></div>
</div>
</section>
<section id="perform-garnett-classify" class="level3">
<h3 class="anchored" data-anchor-id="perform-garnett-classify">Perform garnett classify</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb145" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1">koala_features_classified <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">classify_cells</span>(koala_umap_cds, mmBrain_classifier,</span>
<span id="cb145-2">                                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">db =</span> org.Mm.eg.db,</span>
<span id="cb145-3">                                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_extend =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb145-4">                                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cds_gene_id_type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SYMBOL"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>This graph was created by an old(er) igraph version.
  Call upgrade_graph() on it to use with the current igraph version
  For now we convert it on the fly...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb147" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1">koala_features_classified</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CellDataSet (storageMode: environment)
assayData: 17426 features, 1410 samples 
  element names: exprs 
protocolData: none
phenoData
  sampleNames: ATGGCTGTCGATTTGA-1 GGTACAAAGTTCCTGC-1 ...
    TCGCCCATCTAATTGG-1 (1410 total)
  varLabels: orig.ident nCount_RNA ... cluster_ext_type (9 total)
  varMetadata: labelDescription
featureData
  featureNames: Xkr4 Rp1 ... AC149090.1 (17426 total)
  fvarLabels: vf_vst_counts_mean vf_vst_counts_variance ...
    gene_short_name (9 total)
  fvarMetadata: labelDescription
experimentData: use 'experimentData(object)'
Annotation:  </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb149" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">suppressPackageStartupMessages</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse))</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb150" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(koala_features_classified) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb150-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(cell_type)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                          cell_type   n
1                        Astrocytes  89
2              Astroependymal cells  33
3                          CNS glia 111
4     Di- and mesencephalon neurons  35
5            Neural crest-like glia  34
6                           Neurons  83
7        Peripheral sensory neurons  57
8  Telencephalon projecting neurons 126
9                           Unknown 830
10                   Vascular cells  12</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb152" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(koala_features_classified) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb152-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(cluster_ext_type)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   cluster_ext_type   n
1                        Astrocytes 645
2              Astroependymal cells  16
3                          CNS glia  46
4     Di- and mesencephalon neurons  22
5            Neural crest-like glia  32
6                           Neurons  35
7        Peripheral sensory neurons  17
8  Telencephalon projecting neurons  96
9                           Unknown 490
10                   Vascular cells  11</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb154" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1">koala_features_classified_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb154-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames_to_column</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(koala_features_classified))),</span>
<span id="cb154-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames_to_column</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(koala_features_classified<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>reducedDimS)),</span>
<span id="cb154-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rowname"</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb155" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1">classified_umap_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(koala_features_classified_df) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb155-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> umap_1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> umap_2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> cluster_ext_type), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb155-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb155-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_viridis_d</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"H"</span>)</span>
<span id="cb155-5">classified_umap_plot</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb156" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1">classified_umap_drop_unknowns_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb156-2">  koala_features_classified_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb156-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(cluster_ext_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Unknown"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb156-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb156-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> umap_1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> umap_2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> cluster_ext_type), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb156-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb156-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_viridis_d</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"H"</span>)</span>
<span id="cb156-8">classified_umap_drop_unknowns_plot</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb157" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1">classified_umap_drop_unknowns_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb157-2">  koala_features_classified_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb157-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(cell_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Unknown"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb157-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb157-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> umap_1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> umap_2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> cell_type), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb157-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb157-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_viridis_d</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"H"</span>)</span>
<span id="cb157-8">classified_umap_drop_unknowns_plot</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-67-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="htp-go-anlaysis-for-all-10-clusters" class="level2">
<h2 class="anchored" data-anchor-id="htp-go-anlaysis-for-all-10-clusters">HTP GO Anlaysis for all 10 clusters</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb158" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1">koala_umap_markers_for_GO <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> koala_umap_markers <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb158-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cluster) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_max</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">order_by =</span> avg_log2FC)</span>
<span id="cb158-3">koala_umap_markers_for_GO <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gene"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_tail</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">167</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dput</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>structure(list(gene = c("Plpp1", "Kdr", "Flt4", "F8", "Fgd5", 
"Fcgr2b", "Adgrl4", "Gm35696", "Uroc1", "Cxcl1", "Tedc2", "Hal", 
"Grm8", "Gldc", "Hsd17b13", "Gcnt2", "BC024386", "Itih3", "Noct", 
"Ftcd", "Osgin1", "Amdhd1", "Gls2", "Ctcflos", "Gm50136", "Gramd1c", 
"Serpina10", "Vtn", "mt-Co1", "mt-Nd4", "Gm48099", "mt-Co2", 
"mt-Nd1", "mt-Cytb", "Serpina1c", "Il31ra", "Ces1c", "Lars2", 
"mt-Nd3", "mt-Atp6", "mt-Nd2", "Serpinf2", "Cmss1", "Cdk8", "Gm15564", 
"mt-Co3", "Serpina1e", "Nr1h5", "Mamdc2", "Arvcf", "Ngf", "Ank3", 
"Gpc6", "Pde3a", "Cacna2d1", "Bmp5", "Nrxn1", "Gucy1a1", "Fendrr", 
"Abcc9", "Ntm", "Reln", "Pde1a", "Col5a1", "Carmn", "Nkain2", 
"Lhfp", "Mup17", "mt-Cytb", "Il31ra", "mt-Atp8", "mt-Nd2", "mt-Nd4", 
"mt-Co2", "Apoe", "Ppfia2", "mt-Co3", "mt-Atp6", "Pgrmc1", "Plxnc1", 
"mt-Co1", "Dab2", "Erg", "mt-Nd5", "Chchd2", "Serpina3k", "Fcgr2b", 
"Cyp2c38", "Gm13775", "Lhpp", "Slc1a2", "Rnf43", "Prodh", "Atf3", 
"Glt1d1", "Cyp3a59", "Serpina6", "Glul", "Tox", "Slc16a10", "Klb", 
"Slc25a25", "Irs1", "Tenm3", "Kank1", "Nr0b2", "Hnf4aos", "Adgre4", 
"Fam129a", "Cd5l", "Adgb", "Bank1", "E230029C05Rik", "Clec4f", 
"Slc8a1", "Entpd1", "Abr", "Fyb", "Gm26740", "Hdac9", "Madd", 
"Unc93b1", "Elmo1", "Runx1", "Ctsc", "Slc40a1", "Cadm1", "Nuak1", 
"Wnt9b", "Vwf", "Dnm3", "Mecom", "Eln", "Thsd7a", "Rspo3", "Pgm5", 
"Unc13b", "Ptpn14", "Fbn1", "Zfp521", "Jam2", "Heg1", "Pecam1", 
"Plxna4", "March3", "Myo1d", "Tbc1d4", "Bcl11b", "Atp8a2", "Gm2682", 
"Themis", "Cd226", "Itk", "Skap1", "Ms4a4b", "Grap2", "Satb1", 
"Kcnq5", "Ptpn22", "Pde7a", "Arhgap15", "Dock2", "Inpp4b", "Epsti1", 
"Itgal", "Pik3cd", "Ripor2")), row.names = c(NA, -167L), class = c("tbl_df", 
"tbl", "data.frame"))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb160" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1">Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FeaturePlot</span>(koala_umap, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">features =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ptprb"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stab2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lrmda"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prkg1"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_22-scRNA-seq_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- ```{r} -->
<!-- (koala_umap_GOs <- topGOtable(DEgenes = c("Hal", "Grm8", "Hsd17b13", "Sds", "Gm35696", -->
<!--                                           "Ncam2", "Chrm3", "Acaca", "Gldc", "Aox3"), -->
<!--                               BGgenes = bg_gene_vector, -->
<!--                                 #koala_js@assays$RNA@var.features, -->
<!--                               ontology = "BP", geneID = "symbol", addGeneToTerms = TRUE)) -->
<!-- ``` -->


</section>
</section>

 ]]></description>
  <category>code</category>
  <category>scRNA-seq</category>
  <category>RNA-seq</category>
  <guid>https://pdcherry.github.io/posts/2024_01_22-scRNA-seq.html</guid>
  <pubDate>Mon, 22 Jan 2024 08:00:00 GMT</pubDate>
</item>
<item>
  <title>GTEX RNA-seq Liver-specific Process and TF Identification</title>
  <dc:creator>Patrick Cherry</dc:creator>
  <link>https://pdcherry.github.io/posts/2024_01_03-GTEX_RNA_seq_liver.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>I use the publicly available bulk RNA-Seq data from <a href="https://www.gtexportal.org/home/downloads/adult-gtex">GTEX</a> (v8) identify biological pathways and processes specific to the liver. I also identify putative transcriptional regulators of these pathways and processes. To ensure that the analysis fits into local memory, I restrict the features in scope to be protein-coding genes, and the tissues in scope to be the following following: heart, kidney, liver, lung, muscle, pancreas, spleen, stomach, pituitary gland, and thyroid.</p>
<section id="notes-on-approach" class="level2">
<h2 class="anchored" data-anchor-id="notes-on-approach">Notes on approach</h2>
<p><a href="https://www.science.org/doi/full/10.1126/science.aaz1776">The GTEx Consortium atlas of genetic regulatory effects across human tissues</a> The Genotype-Tissue Expression (GTEx) project was established to characterize genetic effects on the transcriptome across human tissues and to link these regulatory mechanisms to trait and disease associations.</p>
<p>I’m interpreting “specific to the liver” to mean uniquely expressed in the liver compared to each other tissue in scope. I will express this in the analysis by running instructing DEseq to run a one-to-many test by ranking liver first among the tissue factors, and then running a p-value meta-analysis on the p-value results for features (protein-coding genes) in all comparisons. (Meaning, it only takes one liver-to-tissue comparison revealing that a gene is NOT up-regulated in the liver to remove that gene from consideration.)</p>
</section>
<section id="patricks-hypothesis" class="level2">
<h2 class="anchored" data-anchor-id="patricks-hypothesis">Patrick’s hypothesis</h2>
<p>Given this is liver RNA-seq, I expect to see genes implicated in the liver main roles, namely:</p>
<ul>
<li>conditioning the blood by secreting important proteins into it, like serum albumin, immune complement proteins, C-reactive protein, clotting factors (pre-pro-thrombin, fibrinogen, plasminogen), etc.</li>
<li>cytochrome P450 proteins (CYPxxx), by which the liver catabolizes xenobiotics</li>
<li>glycolysis, gluconeogenesis, and fatty acid catabolism</li>
<li>bile salts catabolism and anabolism (cholesterols, hemoglobin/porphyrin)</li>
<li>amino acid conversion and catabolism</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(usethis)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(readr)                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for reading and writing csvs</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(fs)                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for filesystem navigation in R</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for dataframe manipulation</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for dataframe group nesting and manipulation</span></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(purrr)                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for functional programming, including on nested dataframes</span></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(readxl)                 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for reading excel files</span></span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(stringr)                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for efficient string manipulation</span></span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(magrittr)               <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for enhanced pipes</span></span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(broom)                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for model manipulation</span></span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(forcats)                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for factor manipulation</span></span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for additional plotting features</span></span>
<span id="cb1-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ensembldb)</span>
<span id="cb1-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(DESeq2)</span>
<span id="cb1-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(AnnotationDbi)</span>
<span id="cb1-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(org.Hs.eg.db)</span>
<span id="cb1-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(gage)</span>
<span id="cb1-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(gageData)</span>
<span id="cb1-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pathview)</span>
<span id="cb1-20"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(TFEA.ChIP)              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># analyze transcription factor enrichment in a gene set</span></span>
<span id="cb1-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(BiocParallel)           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># speed up some parallelizeable processing</span></span>
<span id="cb1-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">register</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MulticoreParam</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set core parallelization to 4 CPU cores</span></span>
<span id="cb1-23"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>())           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set the default ggplot theme to be clear &amp; cartooney</span></span></code></pre></div>
</div>
</section>
</section>
<section id="metadata-sample-annotations" class="level1">
<h1>Metadata (sample annotations)</h1>
<p>Samples come from https://github.com/broadinstitute/gtex-v8/blob/master/data/GTEx_Analysis_v8_RNAseq_samples.txt, and have to be manually downloaded.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">gtex_samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.delim</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../GTEX-liver-parent-dir/GTEx_Analysis_v8_RNAseq_samples.txt"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample_id"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_replace_all</span>(sample_id, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span>))</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">gtex_samples <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(tissue_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(n))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                               tissue_id   n
1                        Muscle_Skeletal 803
2                            Whole_Blood 755
3             Skin_Sun_Exposed_Lower_leg 701
4                   Adipose_Subcutaneous 663
5                          Artery_Tibial 663
6                                Thyroid 653
7                           Nerve_Tibial 619
8        Skin_Not_Sun_Exposed_Suprapubic 604
9                                   Lung 578
10                      Esophagus_Mucosa 555
11              Adipose_Visceral_Omentum 541
12                  Esophagus_Muscularis 515
13            Cells_Cultured_fibroblasts 504
14                 Breast_Mammary_Tissue 459
15                          Artery_Aorta 432
16                  Heart_Left_Ventricle 432
17                Heart_Atrial_Appendage 429
18                      Colon_Transverse 406
19   Esophagus_Gastroesophageal_Junction 375
20                         Colon_Sigmoid 373
21                                Testis 361
22                               Stomach 359
23                              Pancreas 328
24                             Pituitary 283
25                         Adrenal_Gland 258
26                          Brain_Cortex 255
27           Brain_Caudate_basal_ganglia 246
28 Brain_Nucleus_accumbens_basal_ganglia 246
29                              Prostate 245
30                      Brain_Cerebellum 241
31                                Spleen 241
32                       Artery_Coronary 240
33                                 Liver 226
34           Brain_Cerebellar_Hemisphere 215
35              Brain_Frontal_Cortex_BA9 209
36           Brain_Putamen_basal_ganglia 205
37                    Brain_Hypothalamus 202
38                     Brain_Hippocampus 197
39        Small_Intestine_Terminal_Ileum 187
40                                 Ovary 180
41  Brain_Anterior_cingulate_cortex_BA24 176
42     Cells_EBV-transformed_lymphocytes 174
43                  Minor_Salivary_Gland 162
44        Brain_Spinal_cord_cervical_c-1 159
45                                Vagina 156
46                        Brain_Amygdala 152
47                                Uterus 142
48                Brain_Substantia_nigra 139
49                         Kidney_Cortex  85
50                               Bladder  21
51                     Cervix_Endocervix  10
52                     Cervix_Ectocervix   9
53                        Fallopian_Tube   9
54                        Kidney_Medulla   4</code></pre>
</div>
</div>
<p>Put <em>liver</em> first in this list, because after filtering, I will use it to set the order of the factors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">tissue_keep <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Liver"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Heart_Left_Ventricle"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Heart_Atrial_Appendage"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kidney_Cortex"</span>,</span>
<span id="cb5-2">                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kidney_Medulla"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lung"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Muscle_Skeletal"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pancreas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Spleen"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stomach"</span>,</span>
<span id="cb5-3">                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pituitary"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Thyroid"</span>)</span></code></pre></div>
</div>
<p>Double-check I got all the names right</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(tissue_keep <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> gtex_samples[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tissue_id'</span>]])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Got ’em!</p>
<section id="filter-sample-table-to-our-scoped-tissue-types" class="level2">
<h2 class="anchored" data-anchor-id="filter-sample-table-to-our-scoped-tissue-types">Filter sample table to our scoped tissue types</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">gtex_samples_filtered <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gtex_samples <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(tissue_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> tissue_keep) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># on the next line, set order of factors with liver first</span></span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tissue_id"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_relevel</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(tissue_id), tissue_keep) )</span>
<span id="cb8-5">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(gtex_samples_filtered)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     n
1 4421</code></pre>
</div>
</div>
<p>4421 / 17382 = .254 . We are keeping ~ 25% of samples that were in GTEx v8.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">gtex_samples_filtered <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(tissue_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"percent"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(n))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                tissue_id   n percent
1         Muscle_Skeletal 803   18.00
2                 Thyroid 653   15.00
3                    Lung 578   13.00
4    Heart_Left_Ventricle 432    9.80
5  Heart_Atrial_Appendage 429    9.70
6                 Stomach 359    8.10
7                Pancreas 328    7.40
8               Pituitary 283    6.40
9                  Spleen 241    5.50
10                  Liver 226    5.10
11          Kidney_Cortex  85    1.90
12         Kidney_Medulla   4    0.09</code></pre>
</div>
</div>
</section>
<section id="import-the-related-bulk-rnaseq-counts" class="level2">
<h2 class="anchored" data-anchor-id="import-the-related-bulk-rnaseq-counts">Import the related bulk RNAseq counts</h2>
<p>Bulk RNAseq gct files came from: https://www.gtexportal.org/home/downloads/adult-gtex</p>
<p>I’ll use read counts because that’s what DEseq2’s statistical modeling requires. Unzip it first:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> ..</span>
<span id="cb12-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gunzip</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span>.gz</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">rna_counts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.delim</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../GTEX-liver-parent-dir/bulk-gex_v8_rna-seq_GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct"</span>,</span>
<span id="cb13-2">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">skip =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb13-3">  tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">column_to_rownames</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">var =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Name"</span>)</span></code></pre></div>
</div>
<section id="troubleshoot-filtering-samplesmatrix-columns" class="level3">
<h3 class="anchored" data-anchor-id="troubleshoot-filtering-samplesmatrix-columns">Troubleshoot filtering samples/matrix columns</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">rna_counts_cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(rna_counts)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(gtex_samples_filtered[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sample_id'</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> rna_counts_cols)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4421</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">anti_join</span>(gtex_samples_filtered, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(rna_counts_cols),</span>
<span id="cb17-2">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample_id"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] sample_id    donor_id     has_genotype tissue_id   
&lt;0 rows&gt; (or 0-length row.names)</code></pre>
</div>
</div>
<p>0 is the desired outcome of an anti-join.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">rna_counts_filtered <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rna_counts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb19-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(gtex_samples_filtered[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sample_id'</span>]]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb19-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>()</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(rna_counts_filtered)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 56200  4421</code></pre>
</div>
</div>
<p>Great: filtering went correctly. The dashes-to-periods issue was irksome. We have y = 4421 samples, and 56200 features.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(gtex_samples_filtered[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sample_id'</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(rna_counts_filtered))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(gtex_samples_filtered[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sample_id'</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(rna_counts_filtered))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Great, we are good to continue to DEseq2 DESeqDataSet</p>
</section>
</section>
<section id="filter-features-to-protein-coding-genes" class="level2">
<h2 class="anchored" data-anchor-id="filter-features-to-protein-coding-genes">Filter features to protein-coding genes</h2>
<p>please restrict your analyses to protein-coding genes and the following tissues:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">keytypes</span>(org.Hs.eg.db)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "ACCNUM"       "ALIAS"        "ENSEMBL"      "ENSEMBLPROT"  "ENSEMBLTRANS"
 [6] "ENTREZID"     "ENZYME"       "EVIDENCE"     "EVIDENCEALL"  "GENENAME"    
[11] "GENETYPE"     "GO"           "GOALL"        "IPI"          "MAP"         
[16] "OMIM"         "ONTOLOGY"     "ONTOLOGYALL"  "PATH"         "PFAM"        
[21] "PMID"         "PROSITE"      "REFSEQ"       "SYMBOL"       "UCSCKG"      
[26] "UNIPROT"     </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">ensgs_to_filter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ENSG"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dimnames</span>(rna_counts_filtered)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]])</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1">ensgs_filtered_protein <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ensgs_to_filter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb29-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"short_ensg"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(ENSG, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(?&lt;=ENSG</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d{1,14})</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.{0,1}</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d{0,3}$"</span>),</span>
<span id="cb29-3">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"genetype"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapIds</span>(org.Hs.eg.db,</span>
<span id="cb29-4">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keys =</span> short_ensg,</span>
<span id="cb29-5">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GENETYPE"</span>,</span>
<span id="cb29-6">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keytype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ENSEMBL"</span>,</span>
<span id="cb29-7">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">multiVals =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"first"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>'select()' returned 1:many mapping between keys and columns</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(ensgs_filtered_protein, genetype) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(n))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
   genetype           n
   &lt;chr&gt;          &lt;int&gt;
 1 &lt;NA&gt;           21144
 2 protein-coding 19198
 3 pseudo          8918
 4 ncRNA           5820
 5 snoRNA           654
 6 other            368
 7 snRNA             75
 8 rRNA              20
 9 scRNA              2
10 unknown            1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1">ensgs_filtered_protein <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(ensgs_filtered_protein, genetype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"protein-coding"</span>)</span></code></pre></div>
</div>
<p>Actually apply the filter below</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1">rna_counts_filtered <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rna_counts_filtered[ensgs_filtered_protein[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], ]</span>
<span id="cb34-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(rna_counts_filtered)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 19198  4421</code></pre>
</div>
</div>
<section id="number-of-features" class="level3">
<h3 class="anchored" data-anchor-id="number-of-features">Number of features</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(ensgs_to_filter)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 56200</code></pre>
</div>
</div>
<p>19184/56200 = 34%, so we are keeping 34% of features in the counts matrix, because ENSEMBL annotates them as protein-coding. Thus we are jettisoning 66% of features as being non-protein coding. What the ENCODE db indicates is that annotated ENCODE entries are the most common, followed by pseudo, ncRNA, snoRNA, “other,” snRNA, rRNA, scRNA, and “unknown.”</p>
</section>
</section>
</section>
<section id="run-deseq2-analysis" class="level1">
<h1>Run DEseq2 analysis</h1>
<section id="prepare-data-object-for-deseq2" class="level2">
<h2 class="anchored" data-anchor-id="prepare-data-object-for-deseq2">Prepare data object for DEseq2</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1">tissue_DE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DESeqDataSetFromMatrix</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">countData =</span> rna_counts_filtered,</span>
<span id="cb38-2">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colData =</span> gtex_samples_filtered,</span>
<span id="cb38-3">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">design =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> tissue_id)</span>
<span id="cb38-4">tissue_DE</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class: DESeqDataSet 
dim: 19198 4421 
metadata(1): version
assays(1): counts
rownames(19198): ENSG00000186092.4 ENSG00000187634.11 ...
  ENSG00000198695.2 ENSG00000198727.2
rowData names(0):
colnames(4421): GTEX.1117F.0426.SM.5EGHI GTEX.1117F.0726.SM.5GIEN ...
  GTEX.ZZPU.1426.SM.5GZZ6 GTEX.ZZPU.2626.SM.5E45Y
colData names(4): sample_id donor_id has_genotype tissue_id</code></pre>
</div>
</div>
<section id="filter-for-minimum-counts" class="level3">
<h3 class="anchored" data-anchor-id="filter-for-minimum-counts">Filter for minimum counts</h3>
<p>Filter for features (genes) where there are less than 113 or more samples with normalized counts greater than or equal to 5. (113 is half the number of liver samples in the data, allowing for at least some dispersion in at least among the samples of the tissue type we want to understand.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1">tissue_DE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">estimateSizeFactors</span>(tissue_DE)</span>
<span id="cb40-2">idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowSums</span>( <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">counts</span>(tissue_DE, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalized =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">113</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1">tissue_DE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tissue_DE[idx,]</span>
<span id="cb41-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(tissue_DE)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 18023  4421</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1">(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">56200-33387</span>);</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 22813</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1">(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">56200-33387</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">56200</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4059253</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1">(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19184-18013</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19184</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.06104045</code></pre>
</div>
</div>
<p>Originally, when filtering for features with a minimum number of counts over the minimum number of genes, I filtered out 22,813 (40.6%) based on low counts / coverage. <em>However, now the I’m filtering genes for counts <em>after</em> filtering for protein coding genes</em>, only 6.1% of features are dropped. This difference in proportionality indicates that low count features and protein coding genes are not necessarily independent. In fact, the non-protein-coding features were enriched for low expression levels across many of the samples.</p>
</section>
</section>
<section id="run-deseq2-analysis-1" class="level2">
<h2 class="anchored" data-anchor-id="run-deseq2-analysis-1">Run DEseq2 analysis</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rm</span>(gtex_samples, gtex_samples_filtered, rna_counts_filtered, rna_counts)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1">tissue_DE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DESeq</span>(tissue_DE)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>using pre-existing size factors</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>estimating dispersions</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>gene-wise dispersion estimates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>mean-dispersion relationship</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>final dispersion estimates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>fitting model and testing</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>-- replacing outliers and refitting for 237 genes
-- DESeq argument 'minReplicatesForReplace' = 7 
-- original counts are preserved in counts(dds)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>estimating dispersions</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>fitting model and testing</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1">contrasts_no_intercept <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">resultsNames</span>(tissue_DE)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">resultsNames</span>(tissue_DE))]</span>
<span id="cb60-2">contrasts_no_intercept</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "tissue_id_Heart_Left_Ventricle_vs_Liver"  
 [2] "tissue_id_Heart_Atrial_Appendage_vs_Liver"
 [3] "tissue_id_Kidney_Cortex_vs_Liver"         
 [4] "tissue_id_Kidney_Medulla_vs_Liver"        
 [5] "tissue_id_Lung_vs_Liver"                  
 [6] "tissue_id_Muscle_Skeletal_vs_Liver"       
 [7] "tissue_id_Pancreas_vs_Liver"              
 [8] "tissue_id_Spleen_vs_Liver"                
 [9] "tissue_id_Stomach_vs_Liver"               
[10] "tissue_id_Pituitary_vs_Liver"             
[11] "tissue_id_Thyroid_vs_Liver"               </code></pre>
</div>
</div>
<section id="extract-all-contrast-data-from-deseq" class="level3">
<h3 class="anchored" data-anchor-id="extract-all-contrast-data-from-deseq">Extract all contrast data from DEseq</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1">combine_contrast_results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(deseq_obj){</span>
<span id="cb62-2">  </span>
<span id="cb62-3">  contrasts_no_intercept <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">resultsNames</span>(deseq_obj)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">resultsNames</span>(deseq_obj))]</span>
<span id="cb62-4">  </span>
<span id="cb62-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(contrasts_no_intercept, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb62-6">    tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames_to_column</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">results</span>(deseq_obj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> .x)),</span>
<span id="cb62-7">                               <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ENSG"</span>),</span>
<span id="cb62-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"contrast"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> .x)</span>
<span id="cb62-9">    )</span>
<span id="cb62-10">  )</span>
<span id="cb62-11">}</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1">tissue_DE_results_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">combine_contrast_results</span>(tissue_DE) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb63-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"contrast"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(contrast, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^tissue_id_"</span>))</span>
<span id="cb63-3"></span>
<span id="cb63-4">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(tissue_DE_results_long, contrast)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                          contrast     n
1  Heart_Atrial_Appendage_vs_Liver 18023
2    Heart_Left_Ventricle_vs_Liver 18023
3           Kidney_Cortex_vs_Liver 18023
4          Kidney_Medulla_vs_Liver 18023
5                    Lung_vs_Liver 18023
6         Muscle_Skeletal_vs_Liver 18023
7                Pancreas_vs_Liver 18023
8               Pituitary_vs_Liver 18023
9                  Spleen_vs_Liver 18023
10                Stomach_vs_Liver 18023
11                Thyroid_vs_Liver 18023</code></pre>
</div>
</div>
</section>
</section>
<section id="prepare-data-with-additional-annotations" class="level2">
<h2 class="anchored" data-anchor-id="prepare-data-with-additional-annotations">Prepare data with additional annotations</h2>
<section id="check-if-ensg-string-manipulation-prodcuces-unique-values" class="level4">
<h4 class="anchored" data-anchor-id="check-if-ensg-string-manipulation-prodcuces-unique-values">Check if ENSG string manipulation prodcuces unique values</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(tissue_DE_results_long),</span>
<span id="cb65-2">           <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(?&lt;=ENSG</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d{1,14})</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.{0,1}</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d{0,3}$"</span>)), value) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb65-3">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(n);</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
      n     nn
  &lt;int&gt;  &lt;int&gt;
1     1 198253</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(tissue_DE_results_long)), value) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb67-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(n)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
      n     nn
  &lt;int&gt;  &lt;int&gt;
1     1 198253</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb69" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1">tissue_DE_results_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tissue_DE_results_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb69-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"short_ensg"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(ENSG, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(?&lt;=ENSG</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d{1,14})</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.{0,1}</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d{0,3}$"</span>),</span>
<span id="cb69-3">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"symbol"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapIds</span>(org.Hs.eg.db,</span>
<span id="cb69-4">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keys =</span> short_ensg,</span>
<span id="cb69-5">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SYMBOL"</span>,</span>
<span id="cb69-6">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keytype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ENSEMBL"</span>,</span>
<span id="cb69-7">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">multiVals =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"first"</span>),</span>
<span id="cb69-8">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"entrez"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapIds</span>(org.Hs.eg.db,</span>
<span id="cb69-9">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keys =</span> short_ensg,</span>
<span id="cb69-10">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ENTREZID"</span>,</span>
<span id="cb69-11">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keytype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ENSEMBL"</span>,</span>
<span id="cb69-12">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">multiVals =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"first"</span>),</span>
<span id="cb69-13">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapIds</span>(org.Hs.eg.db,</span>
<span id="cb69-14">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keys =</span> short_ensg,</span>
<span id="cb69-15">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GENENAME"</span>,</span>
<span id="cb69-16">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keytype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ENSEMBL"</span>,</span>
<span id="cb69-17">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">multiVals =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"first"</span>)</span>
<span id="cb69-18">         )</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>'select()' returned 1:many mapping between keys and columns
'select()' returned 1:many mapping between keys and columns
'select()' returned 1:many mapping between keys and columns</code></pre>
</div>
</div>
</section>
<section id="further-explore-the-contrasts" class="level3">
<h3 class="anchored" data-anchor-id="further-explore-the-contrasts">Further explore the contrasts</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb71" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1">top_10_hits_summary <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tissue_DE_results_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb71-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log2FoldChange"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>log2FoldChange) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb71-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(contrast) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb71-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(stat, log2FoldChange) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb71-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_head</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb71-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relocate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"contrast"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"short_ensg"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"symbol"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"entrez"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log2FoldChange"</span>)</span>
<span id="cb71-7"></span>
<span id="cb71-8">top_10_hits_summary <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"contrast"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"symbol"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log2FoldChange"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 110 × 4
# Groups:   contrast [11]
   contrast                        symbol  name                   log2FoldChange
   &lt;chr&gt;                           &lt;chr&gt;   &lt;chr&gt;                           &lt;dbl&gt;
 1 Heart_Atrial_Appendage_vs_Liver SLC27A5 solute carrier family…           7.77
 2 Heart_Atrial_Appendage_vs_Liver RDH16   retinol dehydrogenase…           9.76
 3 Heart_Atrial_Appendage_vs_Liver SLC22A1 solute carrier family…          11.8 
 4 Heart_Atrial_Appendage_vs_Liver CYP2E1  cytochrome P450 famil…          11.5 
 5 Heart_Atrial_Appendage_vs_Liver ASGR1   asialoglycoprotein re…          10.1 
 6 Heart_Atrial_Appendage_vs_Liver CYP2D6  cytochrome P450 famil…           8.74
 7 Heart_Atrial_Appendage_vs_Liver CPS1    carbamoyl-phosphate s…           8.98
 8 Heart_Atrial_Appendage_vs_Liver APOM    apolipoprotein M                 7.20
 9 Heart_Atrial_Appendage_vs_Liver ATF5    activating transcript…           7.22
10 Heart_Atrial_Appendage_vs_Liver MST1    macrophage stimulatin…           7.25
# ℹ 100 more rows</code></pre>
</div>
</div>
<p>This is looking promising. When sorted by statistic and the top ten genes are displayed from each tissue, there are many common genes that are relatively up-regulated (in mRNA expression) in liver compared to each of the other tissues. SLC27A5 is very commonly (and very strongly) up-regulated in liver; RDH16 and CPS1 are as well.</p>
</section>
<section id="ma-plot-analysis-qc" class="level3">
<h3 class="anchored" data-anchor-id="ma-plot-analysis-qc">MA Plot (analysis QC)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb73" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1">ma_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tissue_DE_results_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb73-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> log2FoldChange, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> baseMean)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density_2d</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> lm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yellow"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_log10</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MA-plot: a scatter plot of log2 fold changes"</span>,</span>
<span id="cb73-8">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean of normalized counts"</span>,</span>
<span id="cb73-9">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log2 fold change"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb73-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> contrast)</span>
<span id="cb73-11">ma_plot</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_03-GTEX_RNA_seq_liver_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>For all contrasts, the data points (gene IDs) are roughly symmetric around the x-axis (indicating no systematic bias), and the majority are close to the x-axis, indicating many genes are not differentially expressed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1">ma_hist <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tissue_DE_results_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb74-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(log2FoldChange)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb74-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">binwidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb74-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MA-plot: histogram of log2 fold changes"</span>,</span>
<span id="cb74-5">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"number of genes"</span>,</span>
<span id="cb74-6">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log2 fold change"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb74-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> contrast)</span>
<span id="cb74-8">ma_hist</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_03-GTEX_RNA_seq_liver_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1">ma_hist_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tissue_DE_results_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb75-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(contrast) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb75-3">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean log2FoldChange"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(log2FoldChange),</span>
<span id="cb75-4">                   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S.D. log2FoldChange"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(log2FoldChange),</span>
<span id="cb75-5">                   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n features"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>())</span>
<span id="cb75-6">ma_hist_stats</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 4
   contrast             `mean log2FoldChange` `S.D. log2FoldChange` `n features`
   &lt;chr&gt;                                &lt;dbl&gt;                 &lt;dbl&gt;        &lt;int&gt;
 1 Heart_Atrial_Append…               -0.0807                  2.49        18023
 2 Heart_Left_Ventricl…               -0.160                   2.53        18023
 3 Kidney_Cortex_vs_Li…                0.120                   2.10        18023
 4 Kidney_Medulla_vs_L…               -0.0501                  2.29        18023
 5 Lung_vs_Liver                       0.134                   2.37        18023
 6 Muscle_Skeletal_vs_…               -0.342                   2.77        18023
 7 Pancreas_vs_Liver                  -0.0455                  2.21        18023
 8 Pituitary_vs_Liver                  0.229                   2.69        18023
 9 Spleen_vs_Liver                    -0.156                   2.36        18023
10 Stomach_vs_Liver                    0.112                   2.27        18023
11 Thyroid_vs_Liver                   -0.0922                  2.37        18023</code></pre>
</div>
</div>
<p>As a clearer summary plot, the histograms for each contrast a preponderance of genes are close to the 0 on the x-axis, indicating many features have limited fold change between samples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1">stat_hist <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tissue_DE_results_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb77-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(stat)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb77-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bins =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb77-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stat (statistic)"</span>,</span>
<span id="cb77-5">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"number of genes"</span>,</span>
<span id="cb77-6">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Statistic"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb77-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> contrast)</span>
<span id="cb77-8">stat_hist</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_03-GTEX_RNA_seq_liver_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>While the test statistic outputted by DEseq2 is less “clipped” to zero than the p-values (many of which exhaust the range and get reported as 0.000000e+00), the statistic range/distribution is not the same for all contrasts, notably for the Kidney Medulla vs Liver comparison. This can be explained from the Filter sample table to our scoped tissue types section of this document, which shows the Kidney Medulla GTEx tissue set as having far fewer samples (n = 4) than the other tissue types (mean = 368, sd = 230).</p>
<p>As long as we <code>group_by()</code> when ranking, sorting, and otherwise comparing (in long format), this should be okay. Once pivoted into wide format, this can present a problem because not every column of values will be able to react similarly to the same ranking, sorting, or cut-offs.</p>
</section>
</section>
</section>
<section id="cross-contrast-analysis" class="level1">
<h1>Cross-contrast analysis</h1>
<section id="summarize-by-feature" class="level2">
<h2 class="anchored" data-anchor-id="summarize-by-feature">Summarize by feature</h2>
<p>Which is effectively a wide format, appropriate for joining. (Grouped-by calculations in the same column run more efficiently and are easier to program than row-wise multi-column calculations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1">tissue_DE_results_feature_summary <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tissue_DE_results_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb78-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log2FoldChange"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stat"</span>),</span>
<span id="cb78-3">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.fns =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mean, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> sd,</span>
<span id="cb78-4">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"below_zero_min"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>( (.x[.x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]) ) ),</span>
<span id="cb78-5">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.names =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{.fn}_{.col}"</span>),</span>
<span id="cb78-6">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lfcSE"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pvalue"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"padj"</span>),</span>
<span id="cb78-7">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.fns =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mean, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> sd,</span>
<span id="cb78-8">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"min"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> min),</span>
<span id="cb78-9">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.names =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{.fn}_{.col}"</span>),</span>
<span id="cb78-10">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ENSG"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"short_ensg"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"symbol"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"entrez"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There were 4798 warnings in `summarize()`.
The first warning was:
ℹ In argument: `across(...)`.
ℹ In group 7: `ENSG = "ENSG00000188290.10"`, `short_ensg = "ENSG00000188290"`,
  `symbol = "HES4"`, `entrez = "57801"`, `name = "hes family bHLH transcription
  factor 4"`.
Caused by warning in `min()`:
! no non-missing arguments to min; returning Inf
ℹ Run `dplyr::last_dplyr_warnings()` to see the 4797 remaining warnings.</code></pre>
</div>
</div>
<p>To explain why I’m contriving these summary statistics, I have to first acknowledge that downstream processing (GO analysis, TF.ChIP) expects continuous data ( <em>e.g.</em> <code>log2FoldChange</code>, <code>adj.p.val</code>) for <em>both</em> the up-regulated and down-regulated features. Thus, in drawing conclusions from the comparisons, I am balancing maintaining continuous variables that can be used later with summary statistics that <em>suggest</em> consistency across all the tissue type comparisons made (and in the case of the highly confident features/genes, these suggestive consistency metrics indicate high levels of agreement).</p>
<p>These metrics are the <code>mean_log2FoldChange</code>, <code>sd_log2FoldChange</code>, and the <code>below_zero_min_log2FoldChange</code>, (as well as these versions on <code>stat</code> and <code>padj</code>). Together, these continuous feature summary metrics describe how consistently the metrics are across comparisons (e.g.&nbsp;liver to thyroid, liver to lung, etc.). When a feature is specific to the liver, the mean will be negative and large, the sd will be smaller than the mean, and the min_below_zero will not be far away from the mean. Such an outcome indicates that all the comparisons agree that a gene is specifically up-regulated in the liver compared to all other tissues considered here.</p>
<p>Applying these summary transformations to the <code>log2FoldChange</code>, <code>pvalue</code>, and <code>padj</code> are reasonable because these metrics either do not depend on the number of samples (<code>log2FoldChange</code>), or account for the number of samples in the condition (<code>pvalue</code>, and <code>padj</code>), explicitly allowing for comparisons between conditions.</p>
</section>
<section id="pivot-to-wide" class="level2">
<h2 class="anchored" data-anchor-id="pivot-to-wide">Pivot to wide</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb80" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1">tissue_DE_results_wide <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tissue_DE_results_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb80-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id_cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ENSG"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"short_ensg"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"symbol"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"entrez"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>),</span>
<span id="cb80-3">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"contrast"</span>,</span>
<span id="cb80-4">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"baseMean"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log2FoldChange"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lfcSE"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stat"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pvalue"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"padj"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb80-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(tissue_DE_results_feature_summary,</span>
<span id="cb80-6">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ENSG"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"short_ensg"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"symbol"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"entrez"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb80-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relocate</span>(short_ensg, mean_log2FoldChange, mean_stat, symbol, name,</span>
<span id="cb80-8">           sd_log2FoldChange, below_zero_min_log2FoldChange, sd_stat, below_zero_min_stat, mean_lfcSE,</span>
<span id="cb80-9">           sd_lfcSE, min_lfcSE, mean_pvalue, sd_pvalue, min_pvalue, mean_padj, sd_padj, min_padj) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb80-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(mean_padj, mean_log2FoldChange)</span></code></pre></div>
</div>
</section>
</section>
<section id="pathway-gene-ontology-go-enrichment-analysis" class="level1">
<h1>Pathway / Gene Ontology (GO) Enrichment Analysis</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_head</span>(dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(tissue_DE_results_wide,</span>
<span id="cb81-2">                         mean_log2FoldChange, sd_log2FoldChange, mean_pvalue, symbol, name),</span>
<span id="cb81-3">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 5
   mean_log2FoldChange sd_log2FoldChange mean_pvalue symbol  name               
                 &lt;dbl&gt;             &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;              
 1               -7.60             0.560   1.66e-214 SLC27A5 solute carrier fam…
 2               -9.37             0.785   5.51e-156 RDH16   retinol dehydrogen…
 3               -9.48             0.401   5.40e-152 CPS1    carbamoyl-phosphat…
 4               -8.15             1.04    1.47e-147 A1BG    alpha-1-B glycopro…
 5               -9.56             1.28    1.90e-135 ASGR1   asialoglycoprotein…
 6              -10.5              0.842   1.91e-124 CYP2E1  cytochrome P450 fa…
 7              -10.5              1.93    7.35e-119 VTN     vitronectin        
 8              -10.3              0.948   7.10e-118 SLC22A1 solute carrier fam…
 9               -6.96             0.329   1.60e-116 ATF5    activating transcr…
10               -6.88             1.01    2.56e-106 ANG     angiogenin         
11              -11.3              2.46    7.90e-100 APOB    apolipoprotein B   
12              -11.5              1.01    5.25e- 98 HPX     hemopexin          
13               -7.68             1.31    2.42e- 97 ITIH4   inter-alpha-trypsi…
14              -12.0              1.89    2.99e- 92 APOA1   apolipoprotein A1  
15              -10.3              1.84    1.37e- 90 TFR2    transferrin recept…
16               -4.45             0.542   1.93e- 88 DHODH   dihydroorotate deh…
17               -9.34             1.81    6.04e- 88 APOC1   apolipoprotein C1  
18              -10.7              1.03    3.93e- 86 TF      transferrin        
19               -7.63             1.10    5.78e- 85 CYP2D6  cytochrome P450 fa…
20                4.33             2.05    6.71e- 84 AIF1L   allograft inflamma…</code></pre>
</div>
</div>
<p>Checking in on genes and hypotheses:</p>
<ol type="1">
<li>conditioning the blood by secreting important proteins into it, like serum albumin, immune complement proteins, C-reactive protein, clotting factors (pre-pro-thrombin, fibrinogen, plasminogen), etc.
<ul>
<li>fibrinogen alpha chain</li>
<li>amyloid P component, serum</li>
<li>coagulation factor IX</li>
<li>fibrinogen beta chain</li>
<li>complement C8 beta chain</li>
<li>plasminogen</li>
<li>fibrinogen gamma chain</li>
<li>C-reactive protein</li>
<li>complement factor H related 2</li>
<li>complement factor H related 5</li>
<li>complement C8 alpha chain</li>
<li>coagulation factor II, thrombin</li>
<li>albumin</li>
<li>complement C9</li>
<li>coagulation factor XIII B chain</li>
</ul></li>
<li>cytochrome P450 proteins (CYPxxx), by which the liver catabolizes xenobiotics
<ul>
<li>cytochrome P450 family 2 subfamily B member 6</li>
<li>cytochrome P450 family 2 subfamily C member 9</li>
<li>cytochrome P450 family 4 subfamily F member 2</li>
</ul></li>
<li>glycolysis, gluconeogenesis, and fatty acid catabolism
<ul>
<li>apolipoprotein C3</li>
<li>apolipoprotein H</li>
<li>apolipoprotein A2</li>
<li>glucose-6-phosphatase catalytic subunit 1</li>
<li>aldolase, fructose-bisphosphate B</li>
</ul></li>
<li>bile salts catabolism and anabolism (cholesterols, hemoglobin/porphyrin)
<ul>
<li>??? (we’ll see later in the pathways analysis)</li>
</ul></li>
<li>amino acid conversion and catabolism
<ul>
<li>alanine–glyoxylate aminotransferase</li>
<li>tyrosine aminotransferase</li>
<li>alanine–glyoxylate aminotransferase 2</li>
</ul></li>
</ol>
<p>I didn’t find many bile salts and cholesterol metabolism genes. Curious. Maybe this is a lesser function of the liver than I imagined, or maybe tissue sampling area makes a difference.</p>
<p>I also recovered some interesting “other” proteins:</p>
<ul>
<li>GC vitamin D binding protein</li>
<li>serpin family A member 7</li>
<li>hydroxyacid oxidase 1</li>
<li>UDP glucuronosyltransferase family 2 member B10</li>
<li>kininogen 1</li>
<li>mannose binding lectin 2</li>
<li>UDP glucuronosyltransferase family 2 member B4</li>
<li>serpin family A member 11</li>
<li>secreted phosphoprotein 2</li>
<li>solute carrier family 2 member 2</li>
<li>carboxypeptidase N subunit 1</li>
<li>cAMP responsive element binding protein 3 like 3</li>
<li>insulin like growth factor binding protein 1</li>
</ul>
<p>Themes on vitamin D, UDP-yl-ation (a means of preparing xenobiotics for excretion), and regulatory / signaling proteins.</p>
<section id="pathway-analysis" class="level2">
<h2 class="anchored" data-anchor-id="pathway-analysis">Pathway analysis</h2>
<p>with GAGE</p>
<section id="prepare-gages-needed-data" class="level3">
<h3 class="anchored" data-anchor-id="prepare-gages-needed-data">Prepare GAGE’s needed data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb83" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(kegg.sets.hs)</span>
<span id="cb83-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(sigmet.idx.hs)</span>
<span id="cb83-3">kegg.sets.hs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> kegg.sets.hs[sigmet.idx.hs]</span></code></pre></div>
</div>
</section>
<section id="perpare-deseq2-result-for-gage" class="level3">
<h3 class="anchored" data-anchor-id="perpare-deseq2-result-for-gage">Perpare DEseq2 result for GAGE</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb84" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1">foldchanges <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> tissue_DE_results_wide<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mean_log2FoldChange</span>
<span id="cb84-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(foldchanges) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> tissue_DE_results_wide<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>entrez</span>
<span id="cb84-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(foldchanges)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     10998       8608       1373          1        432       1571 
 -7.601432  -9.367489  -9.478086  -8.152599  -9.564476 -10.454284 </code></pre>
</div>
</div>
</section>
</section>
<section id="run-gage" class="level2">
<h2 class="anchored" data-anchor-id="run-gage">Run GAGE</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb86" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1">keggres <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gage</span>(foldchanges, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gsets =</span> kegg.sets.hs, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">same.dir =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
</div>
<section id="view-results" class="level3">
<h3 class="anchored" data-anchor-id="view-results">View Results</h3>
<p>Remember that “down-regulated” (i.e.&nbsp;the “$less” table) is <em>up-regulated</em> in liver, due to the DEseq contrasts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(keggres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>less, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb87-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p.geomean"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stat.mean"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p.val"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"set.size"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                         p.geomean stat.mean
hsa00830 Retinol metabolism                           2.779301e-15 -9.570937
hsa00982 Drug metabolism - cytochrome P450            1.480861e-13 -8.552114
hsa00980 Metabolism of xenobiotics by cytochrome P450 3.742608e-12 -7.909572
hsa00140 Steroid hormone biosynthesis                 7.829862e-12 -7.983658
hsa00983 Drug metabolism - other enzymes              3.227821e-11 -7.785412
hsa04610 Complement and coagulation cascades          1.590380e-10 -7.112876
hsa00260 Glycine, serine and threonine metabolism     8.543085e-08 -6.071404
hsa00053 Ascorbate and aldarate metabolism            3.398045e-07 -6.247135
hsa04146 Peroxisome                                   3.456135e-07 -5.215038
hsa00071 Fatty acid metabolism                        8.363971e-07 -5.220379
hsa00040 Pentose and glucuronate interconversions     8.446235e-07 -5.659101
hsa00860 Porphyrin and chlorophyll metabolism         3.474540e-06 -4.994513
hsa00500 Starch and sucrose metabolism                5.047958e-06 -4.774060
hsa00380 Tryptophan metabolism                        1.180799e-05 -4.535570
hsa00280 Valine, leucine and isoleucine degradation   2.437706e-05 -4.277734
hsa03320 PPAR signaling pathway                       4.831137e-05 -4.070571
hsa04976 Bile secretion                               5.608400e-05 -4.037952
hsa04975 Fat digestion and absorption                 8.538312e-05 -4.013194
hsa00120 Primary bile acid biosynthesis               1.087369e-04 -4.465205
hsa00591 Linoleic acid metabolism                     1.465698e-04 -4.016737
                                                             p.val set.size
hsa00830 Retinol metabolism                           2.779301e-15       60
hsa00982 Drug metabolism - cytochrome P450            1.480861e-13       68
hsa00980 Metabolism of xenobiotics by cytochrome P450 3.742608e-12       66
hsa00140 Steroid hormone biosynthesis                 7.829862e-12       52
hsa00983 Drug metabolism - other enzymes              3.227821e-11       48
hsa04610 Complement and coagulation cascades          1.590380e-10       69
hsa00260 Glycine, serine and threonine metabolism     8.543085e-08       32
hsa00053 Ascorbate and aldarate metabolism            3.398045e-07       22
hsa04146 Peroxisome                                   3.456135e-07       78
hsa00071 Fatty acid metabolism                        8.363971e-07       43
hsa00040 Pentose and glucuronate interconversions     8.446235e-07       28
hsa00860 Porphyrin and chlorophyll metabolism         3.474540e-06       38
hsa00500 Starch and sucrose metabolism                5.047958e-06       50
hsa00380 Tryptophan metabolism                        1.180799e-05       42
hsa00280 Valine, leucine and isoleucine degradation   2.437706e-05       44
hsa03320 PPAR signaling pathway                       4.831137e-05       70
hsa04976 Bile secretion                               5.608400e-05       70
hsa04975 Fat digestion and absorption                 8.538312e-05       44
hsa00120 Primary bile acid biosynthesis               1.087369e-04       16
hsa00591 Linoleic acid metabolism                     1.465698e-04       28</code></pre>
</div>
</div>
<p>What’s <em>down-regulated in liver</em> <em>compared to other tissues in the scope of our analysis</em>?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(keggres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>greater, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb89-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p.geomean"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stat.mean"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p.val"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"set.size"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                            p.geomean stat.mean
hsa04260 Cardiac muscle contraction                      4.226930e-05 4.0485431
hsa04510 Focal adhesion                                  8.259308e-05 3.8042683
hsa04020 Calcium signaling pathway                       4.162910e-04 3.3711842
hsa04971 Gastric acid secretion                          4.992409e-04 3.3629263
hsa04540 Gap junction                                    2.260180e-03 2.8795187
hsa04512 ECM-receptor interaction                        1.063049e-02 2.3255219
hsa00512 Mucin type O-Glycan biosynthesis                1.216787e-02 2.3178454
hsa04310 Wnt signaling pathway                           1.365919e-02 2.2195964
hsa04010 MAPK signaling pathway                          1.744613e-02 2.1151951
hsa04740 Olfactory transduction                          1.772475e-02 2.1215165
hsa04144 Endocytosis                                     1.777225e-02 2.1102659
hsa04360 Axon guidance                                   2.267219e-02 2.0114313
hsa04810 Regulation of actin cytoskeleton                2.364354e-02 1.9896256
hsa04070 Phosphatidylinositol signaling system           4.524494e-02 1.7041610
hsa04742 Taste transduction                              4.633914e-02 1.7021994
hsa04666 Fc gamma R-mediated phagocytosis                5.200090e-02 1.6354378
hsa00603 Glycosphingolipid biosynthesis - globo series   5.488971e-02 1.6593012
hsa04916 Melanogenesis                                   6.589818e-02 1.5133800
hsa04960 Aldosterone-regulated sodium reabsorption       7.526571e-02 1.4512414
hsa04970 Salivary secretion                              7.787447e-02 1.4259647
hsa04966 Collecting duct acid secretion                  9.503672e-02 1.3287753
hsa04720 Long-term potentiation                          1.029613e-01 1.2717033
hsa04722 Neurotrophin signaling pathway                  1.100258e-01 1.2305040
hsa04012 ErbB signaling pathway                          1.306016e-01 1.1275052
hsa00604 Glycosphingolipid biosynthesis - ganglio series 1.335755e-01 1.1341216
hsa04730 Long-term depression                            1.385772e-01 1.0911741
hsa04330 Notch signaling pathway                         1.424132e-01 1.0774610
hsa04962 Vasopressin-regulated water reabsorption        1.465997e-01 1.0579483
hsa03010 Ribosome                                        1.579660e-01 1.0084068
hsa00562 Inositol phosphate metabolism                   1.619385e-01 0.9910216
                                                                p.val set.size
hsa04260 Cardiac muscle contraction                      4.226930e-05       76
hsa04510 Focal adhesion                                  8.259308e-05      200
hsa04020 Calcium signaling pathway                       4.162910e-04      176
hsa04971 Gastric acid secretion                          4.992409e-04       73
hsa04540 Gap junction                                    2.260180e-03       88
hsa04512 ECM-receptor interaction                        1.063049e-02       84
hsa00512 Mucin type O-Glycan biosynthesis                1.216787e-02       30
hsa04310 Wnt signaling pathway                           1.365919e-02      148
hsa04010 MAPK signaling pathway                          1.744613e-02      262
hsa04740 Olfactory transduction                          1.772475e-02       97
hsa04144 Endocytosis                                     1.777225e-02      201
hsa04360 Axon guidance                                   2.267219e-02      129
hsa04810 Regulation of actin cytoskeleton                2.364354e-02      209
hsa04070 Phosphatidylinositol signaling system           4.524494e-02       78
hsa04742 Taste transduction                              4.633914e-02       43
hsa04666 Fc gamma R-mediated phagocytosis                5.200090e-02       93
hsa00603 Glycosphingolipid biosynthesis - globo series   5.488971e-02       14
hsa04916 Melanogenesis                                   6.589818e-02       99
hsa04960 Aldosterone-regulated sodium reabsorption       7.526571e-02       42
hsa04970 Salivary secretion                              7.787447e-02       85
hsa04966 Collecting duct acid secretion                  9.503672e-02       27
hsa04720 Long-term potentiation                          1.029613e-01       69
hsa04722 Neurotrophin signaling pathway                  1.100258e-01      127
hsa04012 ErbB signaling pathway                          1.306016e-01       87
hsa00604 Glycosphingolipid biosynthesis - ganglio series 1.335755e-01       15
hsa04730 Long-term depression                            1.385772e-01       68
hsa04330 Notch signaling pathway                         1.424132e-01       47
hsa04962 Vasopressin-regulated water reabsorption        1.465997e-01       43
hsa03010 Ribosome                                        1.579660e-01       87
hsa00562 Inositol phosphate metabolism                   1.619385e-01       57</code></pre>
</div>
</div>
<p>Note that the p-values for pathways down-regulated in the liver are less significant than those of pathways up-regulated, likely due to by high dispersion among the comparison tissues.</p>
</section>
<section id="pathway-plots" class="level3">
<h3 class="anchored" data-anchor-id="pathway-plots">Pathway plots</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb91" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1">keggrespathways <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(keggres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>less), keggres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>less) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb91-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb91-3">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_head</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb91-4">  .<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb91-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb91-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># top 5, plus some pet pathways part of my starting hypothesis</span></span>
<span id="cb91-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hsa04976 Bile secretion"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb91-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hsa00860 Porphyrin and chlorophyll metabolism"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb91-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hsa00280 Valine, leucine and isoleucine degradation"</span>)</span>
<span id="cb91-10"></span>
<span id="cb91-11">keggresids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_sub</span>(keggrespathways, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">end =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb91-12"></span>
<span id="cb91-13">keggrespathways</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "hsa00830 Retinol metabolism"                          
[2] "hsa00982 Drug metabolism - cytochrome P450"           
[3] "hsa00980 Metabolism of xenobiotics by cytochrome P450"
[4] "hsa00140 Steroid hormone biosynthesis"                
[5] "hsa00983 Drug metabolism - other enzymes"             
[6] "hsa04976 Bile secretion"                              
[7] "hsa00860 Porphyrin and chlorophyll metabolism"        
[8] "hsa00280 Valine, leucine and isoleucine degradation"  </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb93" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setwd</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./2024_01_03-GTEX_RNA_seq_liver/"</span>)</span>
<span id="cb93-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define plotting function for applying later</span></span>
<span id="cb93-3">plot_pathway <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(pid) {<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pathview</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gene.data =</span> foldchanges,</span>
<span id="cb93-4">                                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pathway.id =</span> pid, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">species =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hsa"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new.signature =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)}</span>
<span id="cb93-5"></span>
<span id="cb93-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot multiple pathways (plots saved to disk and returns a throwaway list object)</span></span>
<span id="cb93-7">tmp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(keggresids, plot_pathway)</span>
<span id="cb93-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setwd</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".."</span>)</span></code></pre></div>
</div>
<p>Typically, expression heat maps use the color-blind-unfriendly and unintuitive red for up-regulated expression, and green for decreased expression.</p>
<p>However, here, because I never inverted (multiplied by -1) the log2-fold-change values, green is for increased relative expression, and red is for decreased relative expression.</p>
<section id="hsa00830-retinol-metabolism" class="level4">
<h4 class="anchored" data-anchor-id="hsa00830-retinol-metabolism">hsa00830 Retinol metabolism</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_03-GTEX_RNA_seq_liver/hsa00830.pathview.png" class="img-fluid figure-img"></p>
<figcaption>hsa00830 Retinol metabolism</figcaption>
</figure>
</div>
</section>
<section id="hsa00982-drug-metabolism---cytochrome-p450" class="level4">
<h4 class="anchored" data-anchor-id="hsa00982-drug-metabolism---cytochrome-p450">hsa00982 Drug metabolism - cytochrome P450</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_03-GTEX_RNA_seq_liver/hsa00982.pathview.png" class="img-fluid figure-img"></p>
<figcaption>hsa00982 Drug metabolism - cytochrome P450</figcaption>
</figure>
</div>
</section>
<section id="hsa00980-metabolism-of-xenobiotics-by-cytochrome-p450" class="level4">
<h4 class="anchored" data-anchor-id="hsa00980-metabolism-of-xenobiotics-by-cytochrome-p450">hsa00980 Metabolism of xenobiotics by cytochrome P450</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_03-GTEX_RNA_seq_liver/hsa00980.pathview.png" class="img-fluid figure-img"></p>
<figcaption>hsa00980 Metabolism of xenobiotics by cytochrome P450</figcaption>
</figure>
</div>
</section>
<section id="hsa00983-drug-metabolism---other-enzymes" class="level4">
<h4 class="anchored" data-anchor-id="hsa00983-drug-metabolism---other-enzymes">hsa00983 Drug metabolism - other enzymes</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_03-GTEX_RNA_seq_liver/hsa00983.pathview.png" class="img-fluid figure-img"></p>
<figcaption>hsa00983 Drug metabolism - other enzymes</figcaption>
</figure>
</div>
</section>
<section id="hsa00140-steroid-hormone-biosynthesis" class="level4">
<h4 class="anchored" data-anchor-id="hsa00140-steroid-hormone-biosynthesis">hsa00140 Steroid hormone biosynthesis</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_03-GTEX_RNA_seq_liver/hsa00140.pathview.png" class="img-fluid figure-img"></p>
<figcaption>hsa00140 Steroid hormone biosynthesis</figcaption>
</figure>
</div>
</section>
<section id="hsa00983-drug-metabolism---other-enzymes-1" class="level4">
<h4 class="anchored" data-anchor-id="hsa00983-drug-metabolism---other-enzymes-1">hsa00983 Drug metabolism - other enzymes</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_03-GTEX_RNA_seq_liver/hsa00983.pathview.png" class="img-fluid figure-img"></p>
<figcaption>hsa00983 Drug metabolism - other enzymes</figcaption>
</figure>
</div>
</section>
<section id="hsa04976-bile-secretion" class="level4">
<h4 class="anchored" data-anchor-id="hsa04976-bile-secretion">hsa04976 Bile secretion</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_03-GTEX_RNA_seq_liver/hsa04976.pathview.png" class="img-fluid figure-img"></p>
<figcaption>hsa04976 Bile secretion</figcaption>
</figure>
</div>
<p>The bile secretion graphic is particularly interesting because it depicts spatial regulation across cell types, and those expectations (hypotheses) are upheld by the bulk RNA-seq data from GTEx. Most hepatocyte genes are up-regulated, whereas most cholangiocyte (epithelial cells of the bile duct) genes are not up-regulated.</p>
</section>
<section id="hsa00860-porphyrin-and-chlorophyll-metabolism" class="level4">
<h4 class="anchored" data-anchor-id="hsa00860-porphyrin-and-chlorophyll-metabolism">hsa00860 Porphyrin and chlorophyll metabolism</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_03-GTEX_RNA_seq_liver/hsa00860.pathview.png" class="img-fluid figure-img"></p>
<figcaption>hsa00860 Porphyrin and chlorophyll metabolism</figcaption>
</figure>
</div>
<p>Porphyrin metabolism is a curious case: not many of the GO term’s genes are up-regulated, and even along a linear pathway, not all the genes in are up-regulated. I am especially surprised to see biliverdin to bilirubin conversion down-regulated relative to the other tissues in this set. Meanwhile, two of bilirubin’s downstream steps are up-regulated.</p>
</section>
</section>
</section>
</section>
<section id="transcription-factor-enrichment-analysis" class="level1">
<h1>Transcription Factor Enrichment Analysis</h1>
<p>With <code>TFEA_ChIP</code>, we will leverage the contingency matrices crossing DEseq2 up v. down and previously-existing ChIP-seq (up v. down) data sets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1">TFEA_DE_results_ordered <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(tissue_DE_results_wide,</span>
<span id="cb94-2">                                                       <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Genes"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> short_ensg, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#symbol,</span></span>
<span id="cb94-3">                                                       <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log2FoldChange"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mean_log2FoldChange,</span>
<span id="cb94-4">                                                       <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pvalue"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mean_pvalue,</span>
<span id="cb94-5">                                                       <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"padj"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mean_padj))</span>
<span id="cb94-6"></span>
<span id="cb94-7">TFEA_DE_results_ordered<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>log2FoldChange <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> TFEA_DE_results_ordered<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>log2FoldChange</span>
<span id="cb94-8"></span>
<span id="cb94-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(TFEA_DE_results_ordered) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> TFEA_DE_results_ordered<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>short_ensg</span>
<span id="cb94-10"></span>
<span id="cb94-11">TFEA_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> TFEA.ChIP<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">preprocessInputData</span>(TFEA_DE_results_ordered)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Some genes returned 1:many mapping to ENTREZ ID. Genes were assigned the first ENTREZ ID match found.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb96" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#extract vector with names of up-regulated genes</span></span>
<span id="cb96-2">genes_upreg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> TFEA.ChIP<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Select_genes</span>(TFEA_table, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min_LFC =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb96-3"></span>
<span id="cb96-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#extract vector with names of non-responsive genes</span></span>
<span id="cb96-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#genes_ctrl &lt;- TFEA.ChIP::Select_genes(TFEA_table,</span></span>
<span id="cb96-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#    min_pval = 0.05, max_pval = 1, max_LFC = -4)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1">DE_CM <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">contingency_matrix</span>(genes_upreg) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># generates list of contingency tables, one per dataset</span></span>
<span id="cb97-2">pval_up_genes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getCMstats</span>(DE_CM) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># generates list of p-values and OR from association test</span></span></code></pre></div>
</div>
<section id="chip-transcription-factor-data" class="level2">
<h2 class="anchored" data-anchor-id="chip-transcription-factor-data">ChIP Transcription Factor data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb98" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1">chip_index <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_chip_index</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">encodeFilter =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb98-2">DE_CM_chip <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">contingency_matrix</span>(genes_upreg, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#genes_ctrl,</span></span>
<span id="cb98-3">                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chip_index =</span> chip_index)</span>
<span id="cb98-4">DE_CM_chip_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getCMstats</span>(DE_CM_chip, chip_index)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb99" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1">TF_ranking <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rankTFs</span>(DE_CM_chip_stats, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rankMethod =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gsea"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">makePlot =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb99-2">TF_ranking <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb99-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is_significant"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(pVal <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb99-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(is_significant), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(ES), pVal) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb99-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_head</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             TF       ES arg.ES pVal numberOfChIPs is_significant
FOXA2     FOXA2  0.99125      8 0.00             2           TRUE
HNF1A     HNF1A  0.97817     16 0.02             1           TRUE
HNF4G     HNF4G  0.97522     19 0.02             2           TRUE
NR2F6     NR2F6  0.97234     20 0.03             1           TRUE
HNF4A     HNF4A  0.96642     26 0.00             3           TRUE
FOXA1     FOXA1  0.94599     40 0.01             3           TRUE
NR2F2     NR2F2  0.94015     44 0.01             3           TRUE
ATF3       ATF3  0.76196     11 0.04             6           TRUE
MXI1       MXI1 -0.78348    564 0.05             5           TRUE
SIN3A     SIN3A -0.81379    654 0.04             5           TRUE
CHD2       CHD2 -0.86508    618 0.01             5           TRUE
MAZ         MAZ -0.88623    639 0.04             3           TRUE
CREM       CREM -0.89989    672 0.05             2           TRUE
ELF1       ELF1 -0.90544    627 0.00             5           TRUE
CBFB       CBFB -0.95049    660 0.04             2           TRUE
PML         PML -0.96507    663 0.04             1           TRUE
PBX3       PBX3 -0.97234    668 0.03             1           TRUE
SMAD5     SMAD5 -0.99854    686 0.00             1           TRUE
NR5A1     NR5A1  0.95779     30 0.08             1          FALSE
HHEX       HHEX  0.95488     32 0.06             1          FALSE
GFI1       GFI1  0.95342     33 0.12             1          FALSE
ONECUT1 ONECUT1  0.94905     36 0.11             1          FALSE
MBD4       MBD4  0.94614     38 0.10             1          FALSE
SOX13     SOX13  0.94469     39 0.14             1          FALSE
PAXIP1   PAXIP1  0.93886     43 0.13             1          FALSE
FOXJ3     FOXJ3  0.93450     46 0.19             1          FALSE
FOXP1     FOXP1  0.93294     48 0.06             2          FALSE
ATF4       ATF4  0.92868     50 0.17             1          FALSE
ZNF609   ZNF609  0.92576     52 0.23             1          FALSE
THRB       THRB  0.92431     53 0.13             1          FALSE</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb101" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1">TFrank_ES_p_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> TF_ranking <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(ES)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb101-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rank"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb101-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> ES, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> rank, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> pVal)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb101-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb101-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_viridis_c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb101-6">  gghighlight<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gghighlight</span>(pVal <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">05</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#keep_scales = TRUE,</span></span>
<span id="cb101-7">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label_key =</span> TF,</span>
<span id="cb101-8">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unhighlighted_params =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb101-9">                                                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb101-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb101-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_cartesian</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.25</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.25</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb101-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#scale_x_continuous(trans = "log1p") +</span></span>
<span id="cb101-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Enrichment score by rank, pVal highlighted"</span>,</span>
<span id="cb101-14">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Enrighment score"</span>,</span>
<span id="cb101-15">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rank"</span>,</span>
<span id="cb101-16">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Enrichment score of transcription factors by rank. p-values &lt; .05 are highlighted, other TFs are grey."</span>)</span>
<span id="cb101-17">TFrank_ES_p_plot</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_03-GTEX_RNA_seq_liver_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Notes on TF_ranking results:</p>
<ul>
<li>HNF4 (Hepatocyte Nuclear Factor 4) is a nuclear receptor protein mostly expressed in the liver, gut, kidney, and pancreatic beta cells that is critical for liver development.</li>
<li>Forkhead box protein A2 (FOXA2), also known as hepatocyte nuclear factor 3-beta (HNF-3B), is a transcription factor that plays an important role during development</li>
<li>ATF-3 (Cyclic AMP-dependent transcription factor) is an activating member of the mammalian activation transcription factor/cAMP responsive element-binding (CREB) protein family. <em>ATF-3 is induced upon physiological stress in various tissues.</em></li>
<li>Forkhead box protein A1 (FOXA1), also known as hepatocyte nuclear factor 3-alpha (HNF-3A), is a transcriptional activator for liver-specific transcripts such as albumin and transthyretin, and they also interact with chromatin as a pioneer factor.</li>
<li>JUND: a functional component of the AP1 transcription factor complex. It has been proposed to protect cells from p53-dependent senescence and apoptosis.</li>
<li>TAF1 is TFIID subunit 1, a general pol II transcriptional complex component.</li>
<li>REST: RE1-silencing transcription factor gene encodes a transcriptional repressor which represses neuronal genes in non-neuronal tissues.</li>
<li>HNF1 homeobox A (hepatocyte nuclear factor 1 homeobox A), also known as HNF1A, is ubiquitously expressed in many tissues and cell types. The protein encoded by this gene is a transcription factor that is highly expressed in the liver and is involved in the regulation of the expression of several liver-specific genes.</li>
</ul>
<p>The GSEA option was unhelpful at sorting TFs by the level of evidence to support them (all enrichment scores were 1, and all p-values were 0). Wilcoxon doesn’t make a pretty plot, but it gives us helpful sorting data.</p>
<p>Still, I’m not impressed by these results. Even with more stringent filtering (log2-fold-change, p-value), I still can’t get a list that looks specific to the liver.</p>
<section id="run-gsea-on-tfea.chip" class="level3">
<h3 class="anchored" data-anchor-id="run-gsea-on-tfea.chip">Run GSEA on TFEA.ChIP</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb102" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1">GSEA.result[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Enrichment.table"</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pval.adj</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(ES)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_head</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb102-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pval.adj"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Arg.ES"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    Accession   Cell Treatment      TF      ES p.val
1     ENCSR297GII.HNF4G.liver  liver             HNF4G 0.54053     0
2      ENCSR016BMM.TAF1.liver  liver              TAF1 0.49766     0
3     ENCSR735KEY.FOXA1.liver  liver             FOXA1 0.49263     0
4   ENCSR000EZP.SREBF1.Hep-G2 Hep-G2            SREBF1 0.48636     0
5     ENCSR310NYI.FOXA2.liver  liver             FOXA2 0.48343     0
6     ENCSR324RCI.FOXA1.liver  liver             FOXA1 0.48302     0
7     ENCSR000BQW.MBD4.Hep-G2 Hep-G2              MBD4 0.47427     0
8      ENCSR205FOW.ATF3.liver  liver              ATF3 0.47074     0
9      ENCSR480LIS.ATF3.liver  liver              ATF3 0.47024     0
10  ENCSR000EVQ.TCF7L2.Hep-G2 Hep-G2            TCF7L2 0.46749     0
11  ENCSR000EZO.SREBF2.Hep-G2 Hep-G2            SREBF2 0.45675     0
12   ENCSR516HUP.ZBTB33.liver  liver            ZBTB33 0.45420     0
13     ENCSR893QWP.REST.liver  liver              REST 0.45235     0
14    ENCSR080XEY.FOXA2.liver  liver             FOXA2 0.44996     0
15     ENCSR736BUG.EGR1.liver  liver              EGR1 0.44549     0
16    ENCSR656JZL.HHEX.Hep-G2 Hep-G2              HHEX 0.44122     0
17   ENCSR800QIT.HNF1A.Hep-G2 Hep-G2             HNF1A 0.43966     0
18     ENCSR867WPH.REST.liver  liver              REST 0.43082     0
19    ENCSR669LCD.ATF4.Hep-G2 Hep-G2              ATF4 0.42999     0
20    ENCSR000BQX.NFIC.Hep-G2 Hep-G2              NFIC 0.42440     0
21     ENCSR837GTK.JUND.liver  liver              JUND 0.42418     0
22     ENCSR196HGZ.JUND.liver  liver              JUND 0.42393     0
23      ENCSR521IID.MAX.liver  liver               MAX 0.41846     0
24   ENCSR267DFA.FOXA1.Hep-G2 Hep-G2             FOXA1 0.41741     0
25 ENCSR887LYD.SMARCC2.Hep-G2 Hep-G2           SMARCC2 0.41697     0
26     ENCSR290ZOS.EGR1.liver  liver              EGR1 0.40709     0
27   ENCSR620YNB.KAT2B.Hep-G2 Hep-G2             KAT2B 0.40506     0
28   ENCSR000BRO.MYBL2.Hep-G2 Hep-G2             MYBL2 0.40453     0
29   ENCSR345YWJ.ZBTB33.liver  liver            ZBTB33 0.40031     0
30      ENCSR994YLZ.YY1.liver  liver               YY1 0.39534     0
31   ENCSR000BVM.NR2F2.Hep-G2 Hep-G2             NR2F2 0.39042     0
32    ENCSR444LIN.TCF7.Hep-G2 Hep-G2              TCF7 0.38687     0
33    ENCSR849FVL.GFI1.Hep-G2 Hep-G2              GFI1 0.38592     0
34   ENCSR029LBT.FOXP1.Hep-G2 Hep-G2             FOXP1 0.38317     0
35   ENCSR000EEW.ESRRA.Hep-G2 Hep-G2             ESRRA 0.38049     0
36    ENCSR000BHU.RXRA.Hep-G2 Hep-G2              RXRA 0.37795     0
37   ENCSR000EEU.HNF4A.Hep-G2 Hep-G2             HNF4A 0.37548     0
38   ENCSR791AGT.ZNF24.Hep-G2 Hep-G2             ZNF24 0.37417     0
39   ENCSR413AJG.FOXJ3.Hep-G2 Hep-G2             FOXJ3 0.37378     0
40     ENCSR000BJX.SP1.Hep-G2 Hep-G2               SP1 0.37328     0</code></pre>
</div>
</div>
<p>The above table shows that GSEA (in addition to TFEA.ChIP) also returns many liver-implicated transcriptional regulators. The above table is sorted in descending order of effect size (running enrichment score), and also displays the accession ID of the tissue sample that generated the ChIP seq data set. The TFs (transcription factors) can be in the table more than once.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1">GSEA.result[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Enrichment.table"</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(TF) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(n)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_head</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       TF  n
1    CTCF 31
2   EP300 11
3     MAX 11
4    JUND 10
5    REST 10
6   GABPA  9
7     MYC  7
8    TAF1  7
9  ZBTB33  7
10   ATF3  6</code></pre>
</div>
</div>
<p>The above table counts the number of line items for each TF; despite CTCF (a practically ubiquitous transcriptional and chromatin regulator) being so highly represented across data sets, its running effect size was not high enough to make it show up in the top 40 (5.8%) of line items. (Same goes for EP300.)</p>
<p>What this result shows is that the number of ChIP datasets under consideration in this package is not evenly distributed across all potential transcription factors, and so the number of times a transcription factor is identified as a hit is not a good measure of significance or salience.</p>


</section>
</section>
</section>

 ]]></description>
  <category>code</category>
  <category>RNA-seq</category>
  <guid>https://pdcherry.github.io/posts/2024_01_03-GTEX_RNA_seq_liver.html</guid>
  <pubDate>Wed, 03 Jan 2024 08:00:00 GMT</pubDate>
  <media:content url="https://pdcherry.github.io/posts/2024_01_03-GTEX_RNA_seq_liver/2024_01_03-liver_creative_commons.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Why you should elect a high-deductible health plan</title>
  <dc:creator>Patrick Cherry</dc:creator>
  <link>https://pdcherry.github.io/posts/2024_01_02-why_you_should_elect_a_HDHP.html</link>
  <description><![CDATA[ 





<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_02-why_you_should_elect_a_HDHP/2024_01_02-misunderstood_HSA_spider.png" class="img-fluid figure-img"></p>
<figcaption>The Misunderstood Spider of the annual enrollment process just wants to cuddle.</figcaption>
</figure>
</div>
<section id="disclaimer" class="level1">
<h1>Disclaimer</h1>
<p>This is employee-to-employee advice. I do not work for or represent the Human Resources, Benefits, Finance, or Legal teams. I have no stake in the health plan you elect. I am not a lawyer; I am not a financial advisor; I am not a medical professional. I am in no way qualified to advise you, and any decisions you make based on the content I am presenting remain your own decisions and responsibility. Your mileage may vary. Investing carries risk. Past performance is no guarantee of future performance. This presentation is furnished as is, without warranty of the presentation whatsoever, whether express, implied, or statutory, including, but not limited to, any warranty of merchantability or fitness for a particular purpose or any warranty that the contents of this presentation are error-free. If you have received this presentation in error, please notify the presenter and delete the content from your brain immediately. Side effects may include nausea, dizziness, and drowsiness.</p>
<p>Consult your own financial advisor, lawyer, doctor, and/or benefits professional.</p>
</section>
<section id="high-deductible-health-plan-health-savings-account-tech-talk" class="level1">
<h1>High-Deductible Health Plan + Health Savings Account Tech Talk</h1>
<section id="background-basics-medical-benefit-plan-definitions" class="level2">
<h2 class="anchored" data-anchor-id="background-basics-medical-benefit-plan-definitions">Background: Basics medical benefit plan definitions</h2>
<ul>
<li><strong>Premium</strong>: the amount you pay for your plan from your paycheck</li>
<li><strong>Deductible</strong>: a fixed amount that you must pay out-of-pocket before your plan begins paying for expenses</li>
<li><strong>Co-pay/co-insurance</strong>: a flat (percentage) rate that you pay for each medical event</li>
<li><strong>Out-of-pocket maximum</strong>: an upper bound on what you pay from your personal accounts in a given plan year; after this is hit, plan will cover everything at 100% (no co-pay/co-insurance)</li>
<li><strong>Medical Spending Account</strong>: account for pre-tax money diverted from your paycheck to be used for qualifying medical expenses:
<ul>
<li><em>Flexible Spending Account (FSA)</em>: traditional “use it or lose it” annual account for PPOs</li>
<li><em>Health Savings Account (HSA)</em>: only available to high-deductible plan participants</li>
</ul></li>
</ul>
</section>
<section id="so-why-are-we-instinctively-afraid-of-high-deductible-plans" class="level2">
<h2 class="anchored" data-anchor-id="so-why-are-we-instinctively-afraid-of-high-deductible-plans">So why are we instinctively afraid of high-deductible plans?</h2>
<p>Over the years, we’ve been conditioned to think about healthcare in certain ways. For example, we think that Premiums work like: “you pay more for more doctor options”, or “deductible: smaller is better”. But we lose sight of our sunk costs, like premiums and taxes. FSA example: if you put $1,000 in an FSA, and lose $200 because you can’t spend it, that feels terrible and you are likely to put in less next year, because you’ve lost sight of what would have happened if that money were taxed— if your tax bracket is 30%, you are still $100 ahead!</p>
<p>We also tend to think in annual cycles for health care. But if there were the ability save or ‘carry over’ unspent dollars from year to year, that situation would open up to budgeting healthcare over multiple years. And one thing actuaries know about budgeting for unpredictable events with a high spread of potential costs: averaging over time makes the ending outcome more predictable. (See the central limit theorem).</p>
<p>What we haven’t been conditioned to think about is: premiums as a function of deductibles; costs summed / averaged over multiple years; tax &amp; retirement benefits of healthcare budgeting.</p>
</section>
<section id="the-case-for-hgih-deductible-health-plans-the-health-savings-account-hsa" class="level2">
<h2 class="anchored" data-anchor-id="the-case-for-hgih-deductible-health-plans-the-health-savings-account-hsa">The case for hgih-deductible health plans: the health savings account (HSA)</h2>
<ol type="1">
<li>The high deductible sounds scary, but it’s covered by the combination of your employer’s contribution to your HSA and the money you save on monthly premiums. <em>You are paying it with “house money,” and if you don’t spend all of that, you keep it.</em></li>
<li>The HSA is the very best supplemental retirement savings vehicle there is; in some ways, it’s even better than your 401K, which every financial planner tells you is the first thing you should max out.</li>
<li>The upper bound (out-of-pocket max) on HDHPs means the scenarios in which you could end up paying more than you would on a PPO or EPO/HMO are probably pretty narrow even in a single year, and across multiple years the risk is very low.</li>
<li>HDHP plans are generally the same plan network as that insurer’s PPO or EPO/HMO. Everything about it is the same, except for how you pay for it. Your doctor doesn’t care. Switch, switch back, no issue.</li>
</ol>
</section>
<section id="but-what-if-i-have-an-expensive-year" class="level2">
<h2 class="anchored" data-anchor-id="but-what-if-i-have-an-expensive-year">But what if I have an expensive year?</h2>
<p>My 2020, among other ongoing medical events:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_02-why_you_should_elect_a_HDHP/2024_01_02-2020_bad_year_x_rays.png" class="img-fluid figure-img"></p>
<figcaption>Left: an X-ray of a fracture of the left radial head, annotated in red; right: Another X-ray view of a fractured radial head</figcaption>
</figure>
</div>
<p>You can have a bad year, but it won’t be as bad as it may seem at first:</p>
<ul>
<li>$28k billed</li>
<li>$12k allowed by insurance</li>
<li>$3.5k is what I had to pay</li>
</ul>
</section>
<section id="an-example-2023-comparative-cost-model" class="level2">
<h2 class="anchored" data-anchor-id="an-example-2023-comparative-cost-model">An example 2023 comparative cost model</h2>
<p>These numbers are purely hypothetical and in no way related to my or any specific employer.</p>
<section id="make-cost-model-data-frame" class="level4">
<h4 class="anchored" data-anchor-id="make-cost-model-data-frame">Make cost model data frame</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">ppo_deductible <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span></span>
<span id="cb1-2">ppo_oop_max <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2250</span></span>
<span id="cb1-3">ppo_employer_contributes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-4">ppo_premium <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-5">ppo_co_insurance <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span></span>
<span id="cb1-6"></span>
<span id="cb1-7">hdhp_deductible <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1600</span></span>
<span id="cb1-8">hdhp_oop_max <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3500</span></span>
<span id="cb1-9">hdhp_employer_contributes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3850</span></span>
<span id="cb1-10">hdhp_premium <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-11">hdhp_co_insurance <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span></span>
<span id="cb1-12"></span>
<span id="cb1-13">health_spending_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(raw_expenditure,</span>
<span id="cb1-14">                                  deductible,</span>
<span id="cb1-15">                                  co_insurance,</span>
<span id="cb1-16">                                  oop_max,</span>
<span id="cb1-17">                                  emp_contribution,</span>
<span id="cb1-18">                                  premium){</span>
<span id="cb1-19">  </span>
<span id="cb1-20">  actual_expenditure <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(</span>
<span id="cb1-21">    raw_expenditure <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> deductible, raw_expenditure, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(</span>
<span id="cb1-22">      (deductible <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ((raw_expenditure <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> deductible) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> co_insurance) ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> oop_max, oop_max,</span>
<span id="cb1-23">        (deductible <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ((raw_expenditure <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> deductible) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> co_insurance) )</span>
<span id="cb1-24">      )</span>
<span id="cb1-25">    )  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> emp_contribution <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> premium</span>
<span id="cb1-26">  </span>
<span id="cb1-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(actual_expenditure)</span>
<span id="cb1-28">}</span>
<span id="cb1-29"></span>
<span id="cb1-30">costsdf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb1-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb1-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"raw_expenditure"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb1-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PPO"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">health_spending_model</span>(raw_expenditure, ppo_deductible, ppo_co_insurance, ppo_oop_max,</span>
<span id="cb1-34">                                       ppo_employer_contributes, ppo_premium),</span>
<span id="cb1-35">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HDHP"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">health_spending_model</span>(raw_expenditure, hdhp_deductible, hdhp_co_insurance, hdhp_oop_max,</span>
<span id="cb1-36">                                       hdhp_employer_contributes, hdhp_premium)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb1-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PPO"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HDHP"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"your_cost"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plan_type"</span>)</span></code></pre></div>
</div>
</section>
<section id="plot-cost-model" class="level4">
<h4 class="anchored" data-anchor-id="plot-cost-model">Plot cost model</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">costsdf <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> raw_expenditure, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> your_cost, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> plan_type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_viridis_d</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">begin =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">end =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotdash"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_currency</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_currency</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Plot of personal cost versus raw allowed health expenditure"</span>,</span>
<span id="cb2-9">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Raw allowed healthcare expenditure ($)"</span>,</span>
<span id="cb2-10">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Your cost ($)"</span>,</span>
<span id="cb2-11">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Plan type"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2024_01_02-why_you_should_elect_a_HDHP_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><em>Assumes 100% in-network providers, co-insurances are 90% of total accepted expenditure.</em></p>
<p>The HDHP is actually less expensive than PPO until &gt;$11,000 of raw expense. Because both plans have 90% co-insurance, the amount paid by each is similar when under the OOP Max.</p>
<p>HDHP costs 11.1% more than PPO until reaching the deductible.</p>
<p>Because the OOP Max for the HDHP is lower than the HSA contribution (from the employer), there is no medical expense scenario when this model keeps less than $350 at the end of the year.</p>
</section>
</section>
<section id="the-hsa-a-very-different-medical-spending-account" class="level2">
<h2 class="anchored" data-anchor-id="the-hsa-a-very-different-medical-spending-account">The HSA: a very different medical spending account</h2>
<blockquote class="blockquote">
<p>“From a tax standpoint, an HSA is the best thing out there because it has a triple tax advantage,” Fronstin says. “The money goes in tax free, it builds up tax free and it comes out tax free” if withdrawn for qualified medical expenses.</p>
<p><a href="https://www.nytimes.com/2021/03/19/business/health-savings-accounts-tax-break.html">NYT The Triple Tax Break You May Be Missing: A Health Savings Account</a></p>
</blockquote>
<p><em>CA, NJ, and AL tax HSA contributions; NH and TN tax earnings.</em></p>
<ul>
<li>No “use it or lose it”— it’s your money.</li>
<li>Treated like a 401K account: pre-tax, interest-earning, able to be invested in stocks, <em>etc</em>.</li>
<li>Not tied to your employer: your HSA goes with you, can be rolled over into another HSA (like 401K)
<ul>
<li>$4,150 individual contribution limit; $8,300 contribution family limit (2024 IRS limits)</li>
<li>Employer may contribute some or most of that, as an employee benefit.</li>
<li>If 55 or over, extra $1,000/year “catch-up” contributions are permitted</li>
</ul></li>
<li>Interest/investment growth is tax-free..
<ul>
<li><em>CA, NJ, and AL tax HSA contributions; NH and TN tax earnings.</em></li>
</ul></li>
<li>At retirement age, can withdraw and use for any reason, but taxed as income (with no penalty) (like traditional IRA).
<ul>
<li>Withdrawal after retirement age decreases the number of tax advantages from 3 to 2.</li>
</ul></li>
<li>If used for qualifying medical expenses, neither the principal nor the growth is ever taxed!</li>
</ul>
</section>
<section id="multi-year-thinking" class="level2">
<h2 class="anchored" data-anchor-id="multi-year-thinking">Multi-Year Thinking</h2>
<p>We’ve been taught to think in annual cycles, and to over-value downside risk. Think about the upside benefit of a light year: one year in which I spend only half of my premium savings + employer contribution “stake” can cover the downside risk of years when I spend more. PPO premiums are sunk costs—you will never see that money again.</p>
<p>Multiply your contribution (not your employer’s contribution) by your tax bracket—that is free money (in that it would have been taxed at that marginal rate if it were instead kept in your paycheck).</p>
<p>Your employer’s contribution is free money.</p>
<p><em>CA, NJ, and AL tax HSA contributions; NH and TN tax earnings.</em> <em><a href="https://www.irs.gov/publications/p969#en_US_2022_publink1000204094">IRS Publication 969</a></em></p>
<p>If you meet your deductible in 2024, pack all your annual checkups into the end of 2024 and the beginning of 2026, and look to have a light year in 2025.</p>
<p>Banking your receipts: you can claim your HSA reimbursements at any time, so you can “bank up” your reimbursable expenses across years, allowing your money to grow tax-free in the HSA, but leaving you the option to reimburse yourself tax-free for multiple years worth of expenses at any time. No reason or justification is required; just keep the receipts and records of when each was withdrawn from the HSA in case the IRS asks to see.</p>
<p><em><a href="https://www.irs.gov/publications/p969#en_US_2022_publink1000204094">IRS Publication 969</a></em></p>
</section>
<section id="qualifying-to-contribute-to-an-hsa" class="level2">
<h2 class="anchored" data-anchor-id="qualifying-to-contribute-to-an-hsa">Qualifying to contribute to an HSA</h2>
<section id="requirements" class="level4">
<h4 class="anchored" data-anchor-id="requirements">Requirements</h4>
<ul>
<li>You are enrolled in a high-deductible health insurance plan.</li>
</ul>
<p><em><a href="https://www.irs.gov/publications/p969#en_US_2022_publink1000204094">IRS Publication 969</a></em></p>
</section>
<section id="disqualifications" class="level4">
<h4 class="anchored" data-anchor-id="disqualifications">Disqualifications</h4>
<ul>
<li>You must NOT be covered by a disqualifying health plan (like another plan) (except for dental, vision, and other specific exceptions).
<ul>
<li>To be disqualified, you must be actively covered, not just eligible to get coverage (say, during open enrollment).</li>
</ul></li>
<li>You must NOT be enrolled in medicare.</li>
<li>You must NOT be claimed as a dependent on someone else’s tax filing.</li>
</ul>
</section>
</section>
<section id="the-fine-print-things-to-watch-out-for" class="level2">
<h2 class="anchored" data-anchor-id="the-fine-print-things-to-watch-out-for">The fine print: things to watch out for</h2>
<ul>
<li>You are responsible for record-keeping—IRS can audit, so you need records for at least 3 years, probably 6 (<a href="https://www.irs.gov/businesses/small-businesses-self-employed/irs-audits#far-back">IRS page on audits</a>)
<ul>
<li>taxes + 20% penalty due for any money withdrawn that you can’t prove was “qualified”</li>
<li>count years from when you withdrew from the HSA, not when the medical expense happened</li>
</ul></li>
<li>The State of California (among others) taxes contributions, interest, and capital gains of HSAs. (Employers document this on W-2; state vs.&nbsp;federal taxable incomes will be different.)</li>
<li>HSA contributions are taxable to California residents; use Schedule CA (540) “other earned income.”</li>
<li>You will need to file an extra schedule with your taxes (IRS form 8889).</li>
<li>You will become a savvier medical consumer—it’s your money! Watch for mis-billing, look at service costs up front.</li>
<li>Don’t underestimate the possibility you will end up going out-of-network when you do your calculations.</li>
<li>If you invest your HSA money in index funds, it may grow faster, but not be FDIC-insured.</li>
</ul>
</section>
<section id="in-summary-what-have-we-learned" class="level2">
<h2 class="anchored" data-anchor-id="in-summary-what-have-we-learned">In summary: what have we learned?</h2>
<p><strong>Playing with house money</strong>: with your employer’s contribution, your premium savings, and the money you would have put in an FSA, you’re already better than break-even on the deductible; if you don’t meet your deductible in a given a year, you get that benefit instead of the insurance company.</p>
<p><strong>Think multi-year when assessing risk</strong>: it’s possible you might pay a little more in a really expensive year, but you will pay a lot less in a good year; across years, it’s hard to lose.</p>
<p><strong>HSAs are awesome</strong>: max out your contribution of pre-tax money to the HSA and get even better tax advantages than your 401(k); avoid taxes on it completely if you continue to use it for medical expenses after you retire.</p>
</section>
<section id="resources-further-reading" class="level2">
<h2 class="anchored" data-anchor-id="resources-further-reading">Resources &amp; Further Reading</h2>
<ul>
<li><a href="https://www.irs.gov/publications/p969#en_US_2022_publink1000204094">IRS Publication 969</a></li>
<li><a href="https://www.fidelity.com/learning-center/smart-money/hsa-contribution-limits">Fidelity HSA contribution limits and eligibility rules</a></li>
<li><a href="https://www.ftb.ca.gov/forms/2022/2022-540-ca-instructions.html">Instructions for California Franchise Tax Board Schedule CA (540)</a></li>
<li><a href="https://www.bogleheads.org/wiki/Health_savings_account#cite_ref-1">Bogleheads Health Savings Account</a></li>
</ul>


</section>
</section>

 ]]></description>
  <category>finance</category>
  <category>healthcare</category>
  <guid>https://pdcherry.github.io/posts/2024_01_02-why_you_should_elect_a_HDHP.html</guid>
  <pubDate>Tue, 02 Jan 2024 08:00:00 GMT</pubDate>
  <media:content url="https://pdcherry.github.io/posts/2024_01_02-why_you_should_elect_a_HDHP/2024_01_02-misunderstood_HSA_spider.png" medium="image" type="image/png" height="96" width="144"/>
</item>
<item>
  <title>How I run and deploy this Quarto blog</title>
  <dc:creator>Patrick Cherry</dc:creator>
  <link>https://pdcherry.github.io/posts/2023_12_29-How_I_host_quarto_blog.html</link>
  <description><![CDATA[ 





<p>I started a blog! Isn’t that grand!?</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2023_12_29-How_I_host_quarto_blog/2023_12_29-How_I_host_quarto_blog.jpg" class="img-fluid figure-img"></p>
<figcaption>Rolling my own</figcaption>
</figure>
</div>
<section id="why-do-i-want-to-blog" class="level2">
<h2 class="anchored" data-anchor-id="why-do-i-want-to-blog">Why do I want to blog?</h2>
<p>I’ve always had a lot of thoughts and opinions on many topics. And when I have a thought, idea, or opinion I really want to develop, I often use writing (privately, for myself) as an exercise for exploring, evaluating, and making more rigorous the thought.</p>
<blockquote class="blockquote">
<p>When I sit down to write a book, I do not say to myself, ‘I am going to produce a work of art.’ I write it because there is some lie that I want to expose, some fact to which I want to draw attention, and my initial concern is to get a hearing.</p>
<p>-George Orwell, <a href="https://www.orwellfoundation.com/the-orwell-foundation/orwell/essays-and-other-works/why-i-write/">“Why I Write”</a></p>
</blockquote>
<p>I suppose I’m passionate about some topics, some of which are clearly in my lane (<em>e.g.</em> Molecular Biology, Photography), and some of which are veering for me (<em>e.g.</em> Economics, Finance, Business Trends). That being said, I feel a duty as a scientist to explore these ideas honestly and with every intent of uncovering truth—especially to a standard that would meet those of the scientific community or journalism community.</p>
<p>And most practically, I sometimes need more space to discuss an idea than is allowed in a tweet or mastodon post. (And those threads never seem to fully connect, anyway.)</p>
</section>
<section id="introduction-to-self-hosted-blogging" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-self-hosted-blogging">Introduction to self-hosted blogging</h2>
<section id="which-is-really-an-introduction-to-the-publishing-ecosystem" class="level4">
<h4 class="anchored" data-anchor-id="which-is-really-an-introduction-to-the-publishing-ecosystem">Which is really an introduction to the publishing ecosystem</h4>
<p>I have chosen to set up a self-hosted blog for many reasons. Self hosting has always seemed like the platonic ideal of a technically capable individual, and so I have set out to manifest this idea as a weekend project. As I will describe below, the default state of this is not ideal, and I’ve learned a lot about git, Github, Github Actions, Rmarkdown, Quarto, YAML, and TOML along the way.</p>
<p>Self hosting doesn’t literally mean I have set up a server in my office nook or anything so physically present. Self hosting just means I’m using my own html to render the content you see on the webpage before you. But why might that be worth it?</p>
<p>The state of online publishing today is a morass, to say the least. Some problems are quotidian, such as not being able to view a blog page without being bombarded with obnoxious popovers asking to log in, subscribe on the platform, or subscribe to the newsletter by email. Worse, the economics of <a href="https://www.nytimes.com/2021/04/11/business/media/substack-newsletter-competition.html?searchResultPosition=12">certain high-profile blogging platforms</a> recruiting writers to post their content there for a six-figure salary requires such platforms, in turn, to either monetize charge other, ‘lesser’ subscribers or readers. With leadership that doesn’t recognize how the mass-dissemination of hate speech can be a threat to democracy, platforms can <a href="https://www.theatlantic.com/ideas/archive/2023/11/substack-extremism-nazi-white-supremacy-newsletters/676156/">accrue a hate speech problem</a>, and be <a href="https://www.businessinsider.com/substack-nazi-problem-free-speech-money-analysis-2023-12?op=1">financially motivated to keep it</a>.</p>
<p>Self-hosted blogging side-steps a lot of these problems. By self-hosting, I can craft a good web experience for the reader: no ads and no obnoxious popovers. I can post content without supporting these ethically dubious platforms with more content and more users (which would then be subjected to their recommendation algorithm). Should I devote the time, I could add an RSS feed, which is reminiscent of the time when all publications (aka blogs) were easily available and sync-able and readable as you wish: kind of like how podcasts <em>still</em> are today. (Can we make <a href="https://netnewswire.com/">NetNewsWire</a> relevant again?)</p>
<p>Plus, Quarto and Hugo makes for a blazing fast-loading website. <strong>How cyber-punk is that?!</strong></p>
</section>
</section>
<section id="why-quarto" class="level2">
<h2 class="anchored" data-anchor-id="why-quarto">Why Quarto</h2>
<p>Why would I choose Quarto as the mechanism of munging my writing and coding into a website? Well, the question partly answers itself.</p>
<p><strong>I write tons of R markdown scripts already.</strong> <a href="https://rmarkdown.rstudio.com/">R Markdown</a> is a display wrapper language that allows for the execution of code in “chunks”. It makes for beautiful documents and reports where the code, figures/tables, and descriptions are fully self-contained for reproducible data analysis. The outputs can be useful and beautiful: as simple as a 1-page PDF, or as interactive as a Shiny web application.</p>
<p><strong>I already have my data-driven resume in R Markdown.</strong> So I have some experience manipulating the rendering code to make documents pretty and multi-output compatible (e.g.&nbsp;PDF, Github Markdown, html). And, in theory, these documents should be easily compatible when translated into a website / blog.</p>
<p><strong>I plan on posting lots of analysis and code, and the outputs.</strong> I have been, on occasion, posting these analyses to my github project repos, like for <a href="https://github.com/pdcherry/statistics">statistics</a>, <a href="https://github.com/pdcherry/scRNAseq-vignettes">scRNA-seq</a>, or <a href="https://github.com/pdcherry/GTEX-RNA-seq-liver">bulk RNA-seq</a>. Having a proper blog will be a great home to host all these posts together, and their future posts I can even tag them, so readers who are interested in one type can keep focused on posts of that topic.</p>
<p><strong><a href="https://quarto.org/">Quarto</a> is the next generation of scientific publishing systems</strong>, following-up where R Markdown left off. Quarto natively renders to HTML, PDF, MS Word, ePub (all by <em>first</em> passing through Pandoc, one of the most widely-supported markdown systems). And Quarto natively supports running Python, R, Julia, and Observable JS code, because yes, contrary to popular belief, I can code in Python. (Also, I may mess around with Observable JS in the future; it sounds nice for dashboards and interactive web data explorations.)</p>
</section>
<section id="sec-road-less-trodden" class="level2">
<h2 class="anchored" data-anchor-id="sec-road-less-trodden">Deploying without weirdness (The road less trodden)</h2>
<p>But, it turns out, <a href="https://quarto.org/docs/websites/website-blog.html">Quarto’s own recommended</a> implementation of a “Quarto Blog” involves some weird git and deploy mechanics. Quarto recommends either rendering the HTML locally and pushing it to git (using the <code>quarto publish</code> shell command), or setting up a GitHub action.</p>
<ul>
<li>The “render HTML locally and push” option is not optimal, because it makes for a very large git repo with large changes for even small updates, all of which are generated programmatically from the Quarto code.</li>
<li>The <code>quarto publish</code> shell command creates a new branch of the repo to contain the HTML pages (still checking HTML into git), but this branch is never supposed to be merged with the main/HEAD branch. (Furthermore, it cannot be merged, because it is not descended from the main branch, and contains no copies of files in it main branch.)</li>
<li>The last option, which is <a href="https://quarto.org/docs/publishing/github-pages.html#publish-command">Quarto’s recommended Github Action</a>, still carries out code execution in the Action, requiring a fully copy of the R environment that solves for all possible code/projects ever run. I got many failures on installing <code>reticulate</code> to the docker image just so I could say <code>print('Hello, world')</code> using Python. Even more annoyingly, <code>Rmarkdown</code> was required to evaluate some code chunks. Both <code>reticulate</code> and <code>Rmarkdown</code> are notoriously difficult and long to install to a new environment.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Since June of 2024, I have made some changes to render and deploy
</div>
</div>
<div class="callout-body-container callout-body">
<p>As of June 22, 2024, I realized that the specifics were different than I described in this section. The following section (Section&nbsp;5) for details on the update.</p>
</div>
</div>
<p><a href="https://www.ianmtaylor.net/posts/2022/deploy-quarto-to-github-pages/">Ian Taylor notes this in his blog post about GitHub actions</a>. So, similarly to Ian, I added <code>execute: freeze: auto</code> lines to this blogs _quarto.yml so that 100% of Quarto would be pre-executed locally on my machine, and only if it changed. And those pre-rendered results are committed to git. Thus, this allows for the Github Action to be very sparse, only requiring an installation of Quarto on the shell PATH. From there, Quarto renders the HTML from the frozen quarto documents, and deploys it to Github Pages with an artifact transfer. The GitHub action takes ~ 45 seconds to deploy the site, and my locally run render takes less than 10 seconds. Nice!</p>
<section id="rolling-your-own" class="level3">
<h3 class="anchored" data-anchor-id="rolling-your-own">Rolling your own</h3>
<p>I learned a lot from this adventure. From troubleshooting those malfunctioning Github Action deploys for so long, it really struck me that for this blog, as is so often the case in life, in the outdoors, and in data science, the road less traveled is sometimes a road more suitable. And with good documentation, it’s not too bad to implement.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello, world"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Hello, world"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Hello, world'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hello, world</code></pre>
</div>
</div>
</section>
</section>
<section id="sec-update-render-deploy" class="level2">
<h2 class="anchored" data-anchor-id="sec-update-render-deploy">2024-06-22 Update on workings of render and deploy</h2>
<p>In June of 2024, I was reviewing the <code>.github/workflows</code> files and the logs of the GitHub actions, and realized that I was doing <em>none</em> of the publish and deploy paths I had described above (Section&nbsp;4).</p>
<ul>
<li>In contrast to bullet point 1, I <em>am</em> rendering the HTML locally (by virtue of the bash <code>quarto render</code> command, which outputs the HTML site artifact to the <code>/docs</code> directory). Then, this version of the repository gets committed to git, and ultimately pushed to GitHub. <strong>Thus, I am checking programmatically generated / rendered content into git</strong>, in contrast to my previous plan.
<ul>
<li><div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://pdcherry.github.io/posts/2023_12_29-How_I_host_quarto_blog/2024_06_22-gh_repo_languages.png" class="img-fluid figure-img" style="width:40.0%"></p>
<figcaption>Screen capture of GitHub repository languages breakdown</figcaption>
</figure>
</div></li>
</ul></li>
<li>In contrast to bullet point 2, I do commit the HTML to git (including the main / HEAD branch).</li>
<li>I am following bullet point 3. No notes to past Patrick; even with more experience, I still can’t imagine installing reticulate to a virtual machine on a compute node just to publish the next version of a blog.</li>
</ul>
<p>My GitHub <code>publish.yml</code> action workflow is very sparse due to entirely local execution and rendering, far more sparse than <a href="https://quarto.org/docs/publishing/github-pages.html">whatever Quarto has recommended</a>. For example, the <code>publish.yml</code> of this blog doesn’t even install / activate quarto on the compute node, because no quarto rendering processes are needed.</p>
<p>While it is inelegant (and against best practice of avoiding committing programmatically-generated code), I find committing the HTML very simple, and so I go with this. (This decision may not be best for everyone else.) I don’t use the <code>quarto publish</code> command or a different branch for the HTML.</p>
<ul>
<li>Pro: This keeps it simple (one command to publish to the web), and it also keeps the published version aligned with the GitHub-hosted <code>main</code> branch: each push represents a publication event.</li>
<li>Con: In order to store or back-up an intermediate piece of writing or analysis, I have to keep the start of the .qmd file labeled as “XXXX-XX-XX”; those files are excluded from the render, which I enforce as with the line of code <code>render: - "!*xxxx_xx_xx*"</code> in the <code>_quarto.yml</code> file.
<ul>
<li>I’m a little cagey about putting unfinished work in publicly-visible git repositories anyway, so these files are typically very close to being ready for publication. (I rely on local backups, like using Apple’s OS X Time Machine and Proton Drive to back up works-in-progress, as well as other, independent, and private GitHub repos on a project-specific basis.)</li>
</ul></li>
</ul>
<p>So it works! This process get the job done on a good enough basis for me, and has stood up to numerous updates to the blog, including new analysis posts with packages that were novel to me at the time. What a nice win for streamlined science communication.</p>
<section id="update-from-2024-08-30" class="level3">
<h3 class="anchored" data-anchor-id="update-from-2024-08-30">Update from 2024-08-30</h3>
<p>I encountered the error “<code>fatal: the remote end hung up unexpectedly</code>” while trying to execute <code>git push</code>. This occurred both in the terminal and in R Studio’s nice git GUI. After <a href="https://stackoverflow.com/questions/15240815/git-fatal-the-remote-end-hung-up-unexpectedly">searching up the error</a>, I was able to fix it by running <code>git config http.postBuffer 524288000</code> in my git-enabled project directory. All subsequent git pushes have worked.</p>
<p>So it would appear one downside of checking into git the entire website artifact is that the size of the git delta can overwhelm the git http transfer (when not configured specially). Word to the wise.</p>


</section>
</section>

 ]]></description>
  <category>news</category>
  <category>code</category>
  <category>community</category>
  <guid>https://pdcherry.github.io/posts/2023_12_29-How_I_host_quarto_blog.html</guid>
  <pubDate>Fri, 29 Dec 2023 08:00:00 GMT</pubDate>
  <media:content url="https://pdcherry.github.io/posts/2023_12_29-How_I_host_quarto_blog/2023_12_29-How_I_host_quarto_blog.jpg" medium="image" type="image/jpeg"/>
</item>
</channel>
</rss>
