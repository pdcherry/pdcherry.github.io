<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Patrick Cherry">
<meta name="dcterms.date" content="2024-05-19">

<title>Frameshift – emmeans: estimated marginal means</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Frameshift - emmeans: estimated marginal means">
<meta property="og:description" content="">
<meta property="og:image" content="2024_05_19-emmeans_estimated_marginal_means_dir/2024_05_19-emmeans_diff_plot.png">
<meta property="og:site_name" content="Frameshift">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Frameshift</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../Patrick-Cherry-resume.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pdcherry"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://fosstodon.org/@pcherry"> <i class="bi bi-mastodon" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://pixelfed.social/pcherry"> <i class="bi bi-instagram" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/p-cherry/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">emmeans: estimated marginal means</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">data</div>
                <div class="quarto-category">code</div>
                <div class="quarto-category">experimental analysis</div>
                <div class="quarto-category">unbalanced DoE</div>
                <div class="quarto-category">causal inference</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Patrick Cherry </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 19, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction-to-marginal-means" id="toc-introduction-to-marginal-means" class="nav-link active" data-scroll-target="#introduction-to-marginal-means">Introduction to marginal means</a>
  <ul class="collapse">
  <li><a href="#ceteris-paribus" id="toc-ceteris-paribus" class="nav-link" data-scroll-target="#ceteris-paribus"><em>Ceteris paribus</em></a></li>
  <li><a href="#note-on-using-emms-for-experiments" id="toc-note-on-using-emms-for-experiments" class="nav-link" data-scroll-target="#note-on-using-emms-for-experiments">Note on using EMMs for <em>experiments</em></a></li>
  </ul></li>
  <li><a href="#the-pigs-dataset" id="toc-the-pigs-dataset" class="nav-link" data-scroll-target="#the-pigs-dataset">The pigs dataset</a>
  <ul class="collapse">
  <li><a href="#initial-model-fitting" id="toc-initial-model-fitting" class="nav-link" data-scroll-target="#initial-model-fitting">Initial model fitting</a></li>
  </ul></li>
  <li><a href="#estimated-marginal-means" id="toc-estimated-marginal-means" class="nav-link" data-scroll-target="#estimated-marginal-means">Estimated marginal means</a>
  <ul class="collapse">
  <li><a href="#comparison-to-ordinary-means" id="toc-comparison-to-ordinary-means" class="nav-link" data-scroll-target="#comparison-to-ordinary-means">Comparison to ordinary means</a></li>
  </ul></li>
  <li><a href="#the-reference-grid-and-definition-of-emms" id="toc-the-reference-grid-and-definition-of-emms" class="nav-link" data-scroll-target="#the-reference-grid-and-definition-of-emms">The reference grid, and definition of EMMs</a></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<!-- improved plot, added table illustrating EMM OMM differences -->
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="2024_05_19-emmeans_estimated_marginal_means_dir/2024_05_19-emmeans_estimated_marginal_means_pigs_cc.jpg" class="img-fluid figure-img"></p>
<figcaption>The diet of pigs contributes to their rate of growth and macromolecular composition. Photo reproduced here from m_takahashi under CC BY-ND 2.0 Deed Attribution-NoDerivs 2.0 Generic</figcaption>
</figure>
</div>
<section id="introduction-to-marginal-means" class="level1">
<h1>Introduction to marginal means</h1>
<p>Estimated marginal means (EMMs, previously known as least-squares means in the context of traditional regression models) are derived by using a model to make predictions over a regular grid of predictor combinations (called a reference grid) <span class="citation" data-cites="Searle1980">(<a href="#ref-Searle1980" role="doc-biblioref">S. R. Searle and Milliken 1980</a>)</span>. Estimated marginal means have historically been used commonly in agricultural science publications. <a href="https://stat.uiowa.edu/people/russell-v-lenth">Russ Lenth</a> authored the <code>emmeans</code> package (distributed <a href="https://cran.r-project.org/web/packages/emmeans/">on CRAN</a>) to be an implementation of the “least-squares” means (which Lenth prefers to call “marginal means” for the reasons discussed below) in R.</p>
<p>As Searle, <em>et al.</em> write, there is a <strong>marginal mean</strong> for every variable (and every level of factor variables) in a data set, and a sufficiently defined model (be it a linear model (<code>lm</code>), <code>glm</code>, <code>lmer</code>, or <code>glmer</code> <em>etc</em>.) will allow for those marginal means to be estimated.</p>
<section id="ceteris-paribus" class="level3">
<h3 class="anchored" data-anchor-id="ceteris-paribus"><em>Ceteris paribus</em></h3>
<p>But I just used “marginal” in the definition of “estimated marginal means.” So what does marginal signify? To distill it down, a marginal mean is the effect size that a particular variable contributes, <em>all else being equal</em>. (The all else being equal part comes from accounting for all other <em>significant</em> effects in the model.)</p>
<p>There are many advantages to using estimated marginal means to arrive at effect sizes (as well as confidence intervals) for a multi-factor / multi-level <em>experiment</em>.</p>
<ol type="1">
<li>One challenge where EMMs provide real advantage is when the number of subjects / samples per condition are not all the same or close to the same; this situation is called an “unbalanced experiment,” and it occurs often during large <a href="../posts/2024_04_05-DoE_design_of_experiment.html">Designs of Experiment (DoEs)</a>, either intentionally by design, or unintentionally due to experimental sample drop outs. EMMs can provide accurate estimates of means and standard errors (confidence intervals) for conditions that differ in sample size, such that, all else equal, conditions with a smaller <em>n</em> have wider confidence intervals.</li>
<li>Another advantage is when there is a hypothesized (or evident) interaction effect in either the mean or the spread of one or more conditions in the experiment. EMMs can estimate accurate relative effects and standard errors (confidence intervals) for each of those interactions.</li>
</ol>
</section>
<section id="note-on-using-emms-for-experiments" class="level3">
<h3 class="anchored" data-anchor-id="note-on-using-emms-for-experiments">Note on using EMMs for <em>experiments</em></h3>
<div id="EMMs-for-experiments" class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
EMMs are best used on data obtained from controlled experiments.
</div>
</div>
<div class="callout-body-container callout-body">
<p>EMMs are less applicable to observational data.</p>
</div>
</div>
<p>A <em><a href="https://en.wikipedia.org/wiki/Ceteris_paribus">ceteris paribus</a></em> (all else being equal) assumption is often critical to drawing scientific conclusions, because scientists seek to infer cause by ruling out all other possible influences. The “else” in “all else equal” distills both:</p>
<ol type="1">
<li><strong>the scientific idea of a controlled experiment</strong>, wherein variables being tested are altered precisely and systematically, and variables <em>not</em> being tested are held constant for all samples in the experiment;</li>
<li>and <strong>the statistical idea of marginal</strong>, which is the relative change from an arbitrary starting point. Marginal statistics show what change or influence can be expected if we know one variable is changing—but know no other information about the condition.</li>
</ol>
<p>Thus, a marginal effect, or a marginal mean, is a <em>causal</em> statement that says, on the margin (all else being equal), if a variable changes in this way, the average response <em>due to that one change</em> is this much <span class="citation" data-cites="hernan2010causal">(<a href="#ref-hernan2010causal" role="doc-biblioref">Hernán and Robins 2010</a>)</span>.</p>
</section>
</section>
<section id="the-pigs-dataset" class="level1">
<h1>The pigs dataset</h1>
<p>Consider the pigs dataset provided with the package (<code>help("pigs")</code> provides details). These data come from an experiment where pigs are given different percentages of protein (percent) from different sources (source) in their diet, and later the concentration (conc) of free plasma leucine, in mcg/mL, was measured. (Observations 7, 22, 23, 31, 33, and 35 have been omitted, creating a more notable imbalance. <span class="citation" data-cites="oehlert2010first">(<a href="#ref-oehlert2010first" role="doc-biblioref">Oehlert 2010</a>)</span>) The percent values are quantitative, but the experimenter chose those particular values deliberately (like a DoE), and (at least initially) the experimenter wants separate estimates at each percent level; that is, in this case, percent is a factor, not a quantitative predictor.</p>
<section id="initial-model-fitting" class="level2">
<h2 class="anchored" data-anchor-id="initial-model-fitting">Initial model fitting</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)          <span class="co"># dplyr, ggplot2, etc.</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_light</span>())    <span class="co"># set default themes for ggplot in this doc to add contrast</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)              <span class="co"># help tidy display and compare of model summary stats</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans)            <span class="co"># ~~The estimated marginal means package~~</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)          <span class="co"># for combining plots</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelbased)         <span class="co"># https://easystats.github.io/modelbased/articles/estimate_means.html</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our first task is to come up with a good model. Making sure the model is appropriate for the data, experiment, and underlying scientific processes is critical to drawing valid conclusions with <code>emmeans</code>. Constructing good models is equal parts art and science, but I won’t labor too much over the details; any reader is encouraged to seek more in-depth guidance on model construction and evaluation. I will construct and view some models and settle on one of them. The key model diagnostics I will keep an eye on are:</p>
<ul>
<li>AIC</li>
<li>BIC</li>
<li>r-squared</li>
<li>Residuals vs Fitted (appropriate model)</li>
<li>Scale-Location (<a href="https://en.wikipedia.org/wiki/Homoscedasticity_and_heteroscedasticity">homoscedasticity</a>)</li>
<li>Residuals vs Leverage (outliers / overly-influential points)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>mod1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(conc <span class="sc">~</span> source <span class="sc">*</span> <span class="fu">factor</span>(percent), <span class="at">data =</span> pigs)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>)); <span class="fu">plot</span>(mod1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2024_05_19-emmeans_estimated_marginal_means_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>mod2 <span class="ot">&lt;-</span> <span class="fu">update</span>(mod1, . <span class="sc">~</span> source <span class="sc">+</span> <span class="fu">factor</span>(percent))   <span class="co"># no interaction</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>)); <span class="fu">plot</span>(mod2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2024_05_19-emmeans_estimated_marginal_means_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dfr</span>(<span class="fu">list</span>(mod1, mod2), glance, <span class="at">.id =</span> <span class="st">"model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 2%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 10%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">model</th>
<th style="text-align: right;">r.squared</th>
<th style="text-align: right;">adj.r.squared</th>
<th style="text-align: right;">sigma</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p.value</th>
<th style="text-align: right;">df</th>
<th style="text-align: right;">logLik</th>
<th style="text-align: right;">AIC</th>
<th style="text-align: right;">BIC</th>
<th style="text-align: right;">deviance</th>
<th style="text-align: right;">df.residual</th>
<th style="text-align: right;">nobs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: right;">0.8083816</td>
<td style="text-align: right;">0.6843933</td>
<td style="text-align: right;">4.716024</td>
<td style="text-align: right;">6.519819</td>
<td style="text-align: right;">0.0003417</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">-78.38304</td>
<td style="text-align: right;">182.7661</td>
<td style="text-align: right;">200.5409</td>
<td style="text-align: right;">378.0950</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">29</td>
</tr>
<tr class="even">
<td style="text-align: left;">2</td>
<td style="text-align: right;">0.6996728</td>
<td style="text-align: right;">0.6343843</td>
<td style="text-align: right;">5.075926</td>
<td style="text-align: right;">10.716628</td>
<td style="text-align: right;">0.0000207</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">-84.89886</td>
<td style="text-align: right;">183.7977</td>
<td style="text-align: right;">193.3688</td>
<td style="text-align: right;">592.5957</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">29</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>These models have R2 values of 0.808 and 0.700, and adjusted R2 values of 0.684 and 0.634. mod1 is preferable to mod2, suggesting the interaction term is needed. However, a residual-vs-predicted plot of mod2 has a classic “horn” shape (curving and fanning out), indicating a situation where a response transformation might help better than including the interaction.</p>
<p>After trial and error, it turns out that an inverse (reciprocal) transformation, (1/conc) serves really well. (Perhaps this isn’t too surprising, as concentrations are often determined by titration, in which the actual measurements are volumes of some counter-reactant; and these are reciprocally related to concentrations, i.e., amounts per unit volume.) In a real experiment, I would read the experimental protocol to verify this idea, or speak with the scientist conducting the experiment.</p>
<p>So here are three more models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>mod3 <span class="ot">&lt;-</span> <span class="fu">update</span>(mod1, <span class="fu">inverse</span>(conc) <span class="sc">~</span> .)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>mod4 <span class="ot">&lt;-</span> <span class="fu">update</span>(mod2, <span class="fu">inverse</span>(conc) <span class="sc">~</span> .)     <span class="co"># no interaction</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>mod5 <span class="ot">&lt;-</span> <span class="fu">update</span>(mod4, . <span class="sc">~</span> source <span class="sc">+</span> percent)  <span class="co"># continuous (non-factor) term for percent</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>)); <span class="fu">plot</span>(mod5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2024_05_19-emmeans_estimated_marginal_means_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dfr</span>(<span class="fu">list</span>(mod1, mod2, mod3, mod4, mod5), glance, <span class="at">.id =</span> <span class="st">"model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 4%">
<col style="width: 8%">
<col style="width: 11%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 2%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">model</th>
<th style="text-align: right;">r.squared</th>
<th style="text-align: right;">adj.r.squared</th>
<th style="text-align: right;">sigma</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p.value</th>
<th style="text-align: right;">df</th>
<th style="text-align: right;">logLik</th>
<th style="text-align: right;">AIC</th>
<th style="text-align: right;">BIC</th>
<th style="text-align: right;">deviance</th>
<th style="text-align: right;">df.residual</th>
<th style="text-align: right;">nobs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: right;">0.8083816</td>
<td style="text-align: right;">0.6843933</td>
<td style="text-align: right;">4.7160240</td>
<td style="text-align: right;">6.519819</td>
<td style="text-align: right;">0.0003417</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">-78.38304</td>
<td style="text-align: right;">182.7661</td>
<td style="text-align: right;">200.5409</td>
<td style="text-align: right;">378.0950000</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">29</td>
</tr>
<tr class="even">
<td style="text-align: left;">2</td>
<td style="text-align: right;">0.6996728</td>
<td style="text-align: right;">0.6343843</td>
<td style="text-align: right;">5.0759265</td>
<td style="text-align: right;">10.716628</td>
<td style="text-align: right;">0.0000207</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">-84.89886</td>
<td style="text-align: right;">183.7977</td>
<td style="text-align: right;">193.3688</td>
<td style="text-align: right;">592.5956760</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">29</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: right;">0.8175928</td>
<td style="text-align: right;">0.6995647</td>
<td style="text-align: right;">0.0031259</td>
<td style="text-align: right;">6.927099</td>
<td style="text-align: right;">0.0002349</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">133.86797</td>
<td style="text-align: right;">-241.7359</td>
<td style="text-align: right;">-223.9611</td>
<td style="text-align: right;">0.0001661</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">29</td>
</tr>
<tr class="even">
<td style="text-align: left;">4</td>
<td style="text-align: right;">0.7866455</td>
<td style="text-align: right;">0.7402641</td>
<td style="text-align: right;">0.0029065</td>
<td style="text-align: right;">16.960361</td>
<td style="text-align: right;">0.0000005</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">131.59563</td>
<td style="text-align: right;">-249.1912</td>
<td style="text-align: right;">-239.6202</td>
<td style="text-align: right;">0.0001943</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">29</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: right;">0.7487292</td>
<td style="text-align: right;">0.7185767</td>
<td style="text-align: right;">0.0030254</td>
<td style="text-align: right;">24.831412</td>
<td style="text-align: right;">0.0000001</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">129.22377</td>
<td style="text-align: right;">-248.4475</td>
<td style="text-align: right;">-241.6111</td>
<td style="text-align: right;">0.0002288</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">29</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="reciprocal-fun-model" class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>I could have used <code>1/conc</code> as the response variable, but <code>emmeans</code> provides an equivalent <code>inverse()</code> function that will prove more advantageous later.</p>
</div>
</div>
<p>The residual plots for these models look a lot more like a random scatter of points (and that is good). The R^2 values for these models are 0.818, 0.787, and 0.749, respectively; and the adjusted R^2s are 0.700, 0.740, and 0.719. mod4 has the best adjusted R^2 and will be our choice.</p>
</section>
</section>
<section id="estimated-marginal-means" class="level1">
<h1>Estimated marginal means</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>(EMM.source <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(mod4, <span class="at">specs =</span> <span class="st">"source"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> source emmean       SE df lower.CL upper.CL
 fish   0.0337 0.000926 23   0.0318   0.0356
 soy    0.0257 0.000945 23   0.0237   0.0276
 skim   0.0229 0.000994 23   0.0208   0.0249

Results are averaged over the levels of: percent 
Results are given on the inverse (not the response) scale. 
Confidence level used: 0.95 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>(EMM.percent <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(mod4, <span class="at">specs =</span> <span class="st">"percent"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> percent emmean       SE df lower.CL upper.CL
       9 0.0322 0.001032 23   0.0301   0.0344
      12 0.0270 0.000969 23   0.0250   0.0290
      15 0.0263 0.001104 23   0.0240   0.0286
      18 0.0241 0.001337 23   0.0213   0.0268

Results are averaged over the levels of: source 
Results are given on the inverse (not the response) scale. 
Confidence level used: 0.95 </code></pre>
</div>
</div>
<p>Calling <code>tidy()</code> (from <code>broom</code>) on the object will put it into a beautiful data frame. And data frames can be plotted.</p>
<p>The input type can be set to <code>“response”</code>, indicating that values should be back-transformed. Note that the back-transformation is done as the last step, so all tests are conducted on the transformed scale.</p>
<p>The package <code>emmeans</code> supports <code>confint</code> (confidence intervals) and <code>test</code> (hypothesis testing) using a function parameter called <code>type</code>. The parameter <code>type</code> only has an effect if there is a known transformation or link function. The parameter value <code>"response"</code> specifies that the inverse transformation be applied, and in that case, the reported values (estimates, standard errors, confidence intervals) will be on the original response scale; otherwise, the output is on the non-linear predictor scale, as defined in the formula for the regression.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(<span class="fu">confint</span>(EMM.percent, <span class="at">type =</span> <span class="st">"response"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">percent</th>
<th style="text-align: right;">response</th>
<th style="text-align: right;">std.error</th>
<th style="text-align: right;">df</th>
<th style="text-align: right;">conf.low</th>
<th style="text-align: right;">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">31.01002</td>
<td style="text-align: right;">0.9926247</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">29.08415</td>
<td style="text-align: right;">33.20903</td>
</tr>
<tr class="even">
<td style="text-align: right;">12</td>
<td style="text-align: right;">37.03236</td>
<td style="text-align: right;">1.3286375</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">34.47376</td>
<td style="text-align: right;">40.00120</td>
</tr>
<tr class="odd">
<td style="text-align: right;">15</td>
<td style="text-align: right;">38.05676</td>
<td style="text-align: right;">1.5989204</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">35.01363</td>
<td style="text-align: right;">41.67922</td>
</tr>
<tr class="even">
<td style="text-align: right;">18</td>
<td style="text-align: right;">41.53107</td>
<td style="text-align: right;">2.3061140</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">37.25203</td>
<td style="text-align: right;">46.92072</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(<span class="fu">confint</span>(EMM.percent, <span class="at">type =</span> <span class="st">"response"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> response, <span class="at">x =</span> percent)) <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">width =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">width =</span> <span class="fl">0.5</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(<span class="at">ymin =</span> conf.low,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ymax =</span> conf.high)) <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Marginal effect with confidence intervals"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"response, free plasma leucine (µg/mL)"</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"percent of source protein in diet (%)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2024_05_19-emmeans_estimated_marginal_means_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>emmeans<span class="sc">::</span><span class="fu">test</span>(EMM.percent, <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">percent</th>
<th style="text-align: right;">response</th>
<th style="text-align: right;">SE</th>
<th style="text-align: right;">df</th>
<th style="text-align: right;">null</th>
<th style="text-align: right;">t.ratio</th>
<th style="text-align: right;">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">31.01002</td>
<td style="text-align: right;">0.9926247</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">31.24043</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">12</td>
<td style="text-align: right;">37.03236</td>
<td style="text-align: right;">1.3286375</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">27.87243</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">15</td>
<td style="text-align: right;">38.05676</td>
<td style="text-align: right;">1.5989204</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">23.80154</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">18</td>
<td style="text-align: right;">41.53107</td>
<td style="text-align: right;">2.3061140</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">18.00911</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<section id="comparison-to-ordinary-means" class="level2">
<h2 class="anchored" data-anchor-id="comparison-to-ordinary-means">Comparison to ordinary means</h2>
<p>Let’s compare these with the ordinary marginal means (OMMs) on inverse(conc):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(pigs, <span class="fu">tapply</span>(<span class="fu">inverse</span>(conc), source, mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      fish        soy       skim 
0.03331687 0.02632333 0.02372024 </code></pre>
</div>
</div>
<p>The above code is <a href="https://www.rostrum.blog/posts/2024-05-08-aesthetic/">in the style of</a> base R <span class="citation" data-cites="Dray2024">(<a href="#ref-Dray2024" role="doc-biblioref">Dray 2024</a>)</span>. Can I write the above ordinary means in Tidyverse/dplyr language?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>pigs <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">conc =</span> <span class="fu">inverse</span>(conc)) <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(conc),</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n"</span> <span class="ot">=</span> <span class="fu">n</span>(),</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">.by =</span> source)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">source</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">fish</td>
<td style="text-align: right;">0.0333169</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="even">
<td style="text-align: left;">soy</td>
<td style="text-align: right;">0.0263233</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="odd">
<td style="text-align: left;">skim</td>
<td style="text-align: right;">0.0237202</td>
<td style="text-align: right;">9</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(pigs, <span class="fu">tapply</span>(<span class="fu">inverse</span>(conc), percent, mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         9         12         15         18 
0.03146170 0.02700341 0.02602757 0.02659336 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>pigs <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">conc =</span> <span class="fu">inverse</span>(conc)) <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(conc),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n"</span> <span class="ot">=</span> <span class="fu">n</span>(),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">.by =</span> percent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">percent</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">0.0314617</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="even">
<td style="text-align: right;">12</td>
<td style="text-align: right;">0.0270034</td>
<td style="text-align: right;">9</td>
</tr>
<tr class="odd">
<td style="text-align: right;">15</td>
<td style="text-align: right;">0.0260276</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="even">
<td style="text-align: right;">18</td>
<td style="text-align: right;">0.0265934</td>
<td style="text-align: right;">5</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Both sets of OMMs are vaguely similar to the corresponding EMMs. However, please note that the EMMs for percent form a decreasing sequence, while the the OMMs decrease but then increase at the end.</p>
</section>
</section>
<section id="the-reference-grid-and-definition-of-emms" class="level1 page-columns page-full">
<h1>The reference grid, and definition of EMMs</h1>
<p>Estimated marginal means are defined as marginal means of model predictions over the grid comprising all factor combinations—called the reference grid. For the example at hand, the reference grid is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>emmeans<span class="sc">::</span><span class="fu">ref_grid</span>(mod4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'emmGrid' object with variables:
    source = fish, soy, skim
    percent =  9, 12, 15, 18
Transformation: "inverse" </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>(RG <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">source =</span> <span class="fu">levels</span>(pigs<span class="sc">$</span>source), <span class="at">percent =</span> <span class="fu">as_factor</span>(<span class="fu">unique</span>(pigs<span class="sc">$</span>percent))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">source</th>
<th style="text-align: left;">percent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">fish</td>
<td style="text-align: left;">9</td>
</tr>
<tr class="even">
<td style="text-align: left;">soy</td>
<td style="text-align: left;">9</td>
</tr>
<tr class="odd">
<td style="text-align: left;">skim</td>
<td style="text-align: left;">9</td>
</tr>
<tr class="even">
<td style="text-align: left;">fish</td>
<td style="text-align: left;">12</td>
</tr>
<tr class="odd">
<td style="text-align: left;">soy</td>
<td style="text-align: left;">12</td>
</tr>
<tr class="even">
<td style="text-align: left;">skim</td>
<td style="text-align: left;">12</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fish</td>
<td style="text-align: left;">15</td>
</tr>
<tr class="even">
<td style="text-align: left;">soy</td>
<td style="text-align: left;">15</td>
</tr>
<tr class="odd">
<td style="text-align: left;">skim</td>
<td style="text-align: left;">15</td>
</tr>
<tr class="even">
<td style="text-align: left;">fish</td>
<td style="text-align: left;">18</td>
</tr>
<tr class="odd">
<td style="text-align: left;">soy</td>
<td style="text-align: left;">18</td>
</tr>
<tr class="even">
<td style="text-align: left;">skim</td>
<td style="text-align: left;">18</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>To get the EMMs, I first need to obtain predictions on this grid:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>(preds <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">predict</span>(mod4, <span class="at">newdata =</span> RG), <span class="at">nrow =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]       [,2]       [,3]       [,4]
[1,] 0.03853514 0.03329091 0.03256404 0.03036586
[2,] 0.03050486 0.02526063 0.02453376 0.02233558
[3,] 0.02770292 0.02245869 0.02173182 0.01953364</code></pre>
</div>
</div>
<p>then obtain the marginal means of these predictions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(preds, <span class="dv">1</span>, mean)   <span class="co"># row means for source</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.03368899 0.02565870 0.02285677</code></pre>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p>For further reading on the family of R’s <code>apply</code> functions, see <a href="https://www.guru99.com/r-apply-sapply-tapply.html">Guru99’s great summary</a>.</p>
</div></div><div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(preds, <span class="dv">2</span>, mean)   <span class="co"># column means for percent</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.03224764 0.02700341 0.02627654 0.02407836</code></pre>
</div>
</div>
<p>These marginal averages match the EMMs obtained earlier via <code>emmeans()</code>.</p>
<p>Now let’s go back to the comparison with the ordinary marginal means. The source levels are represented by the columns of <code>pred</code>; and note that each row of <code>pred</code> is a decreasing set of values. So it is no wonder that the marginal means—the EMMs for source—are decreasing. That the OMMs for percent do not behave this way is due to the imbalance in sample sizes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(pigs, <span class="fu">table</span>(source, percent));</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      percent
source 9 12 15 18
  fish 2  3  2  3
  soy  3  3  3  1
  skim 3  3  2  1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(pigs) <span class="sc">/</span> <span class="fu">nrow</span>(RG)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.416667</code></pre>
</div>
</div>
<p><code>table</code> uses factors to build a contingency table of the counts at each combination of factor levels.</p>
<p>The mean number of samples per condition is 2.42, so any source * percent condition with greater than 2.42 has greater than average weighting in the OMM, whereas those with below 2.42 observations has below the average weighting.</p>
<p>The alarming observation that two conditions have only one observation (soy @ 18% and skim @ 18%) show that those effects, while they may be reported as “means,” are really just one observation, a situation which is more susceptible to bias.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>emmeans<span class="sc">::</span><span class="fu">emmip</span>(mod4, source <span class="sc">~</span> percent, <span class="at">type =</span> <span class="st">"response"</span>) <span class="sc">+</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"EMM: Estimated marginal means result"</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2024_05_19-emmeans_estimated_marginal_means_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">summarize</span>(pigs, <span class="st">"conc"</span> <span class="ot">=</span> <span class="fu">mean</span>(conc), <span class="at">.by =</span> <span class="fu">c</span>(<span class="st">"percent"</span>, <span class="st">"source"</span>)),</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">aes</span>(<span class="at">y =</span> conc, <span class="at">x =</span> percent, <span class="at">color =</span> source)) <span class="sc">+</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OMM: Ordinary grouped means result"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2024_05_19-emmeans_estimated_marginal_means_files/figure-html/unnamed-chunk-22-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>pigs_sample_n <span class="ot">&lt;-</span> pigs <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">"percent"</span> <span class="ot">=</span> <span class="fu">as_factor</span>(percent)) <span class="sc">%&gt;%</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(percent, source)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>combined_omm_emm_data <span class="ot">&lt;-</span> pigs <span class="sc">%&gt;%</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">"percent"</span> <span class="ot">=</span> <span class="fu">as_factor</span>(percent)) <span class="sc">%&gt;%</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="st">"conc"</span> <span class="ot">=</span> <span class="fu">mean</span>(conc), <span class="at">.by =</span> <span class="fu">c</span>(<span class="st">"percent"</span>, <span class="st">"source"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(RG,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>              <span class="fu">inverse</span>(<span class="fu">predict</span>(mod4, <span class="at">newdata =</span> RG, <span class="at">interval =</span> <span class="st">"confidence"</span>, <span class="at">level =</span> <span class="fl">0.95</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>                <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="st">"conc"</span> <span class="ot">=</span> fit)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>              ),</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">.id =</span> <span class="st">"analysis"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">"analysis"</span> <span class="ot">=</span> <span class="fu">case_when</span>(analysis <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"OMM"</span>,</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>                                analysis <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"EMM"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(pigs_sample_n, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"percent"</span>, <span class="st">"source"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As seen in the above code, I can also use the <code>predict()</code> function to calculate confidence intervals for the marginal means. To do this, I need to specify the <code>interva</code> argument, which can take two values: <code>"confidence"</code> and <code>"prediction"</code> <span class="citation" data-cites="Sanderson2023">(<a href="#ref-Sanderson2023" role="doc-biblioref">Steven P. Sanderson II 2023</a>)</span>.</p>
<p>A confidence interval is the range of values within which we are confident that the true mean of the population will fall. A prediction interval is the range of values within which we are confident that the true value of a new observation will fall. Thus, for comparing the EMM to the OMM, a confidence interval is appropriate because we are comparing means, not individual observations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>combined_omm_emm_plot <span class="ot">&lt;-</span> combined_omm_emm_data <span class="sc">%&gt;%</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> conc, <span class="at">x =</span> percent, <span class="at">color =</span> source, <span class="at">linetype =</span> analysis,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>             <span class="co">#</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>             )) <span class="sc">+</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> <span class="fu">interaction</span>(source, analysis))) <span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> n)) <span class="sc">+</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> upr, <span class="at">ymax =</span> lwr),</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.1</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">"D"</span>, <span class="at">end =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="fl">4.5</span>)) <span class="sc">+</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> source) <span class="sc">+</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Overlay of EMM and ordinary means analysis"</span>,</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"response, free plasma leucine (µg/mL)"</span>,</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"percent of source protein in diet (%)"</span>,</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">size =</span> <span class="st">"sample n"</span>,</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Error bars are for EMMs."</span>)</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>combined_omm_emm_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2024_05_19-emmeans_estimated_marginal_means_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Overlaying the data using some custom code to tidy up the combining of both EMM and OMM data into one plottable frame shows how the ordinary marginal (<em>i.e.</em> grouped) means deviate from the Estimated Marginal Means when there are fewer individual observations (n = 1 for soy @ 18% and n = 1 for skim @ 18%, which happens to deviate the farthest). Those low-n observations are displayed as smaller dots, whereas the other conditions have 2 or 3, which get plotted as larger dots.</p>
<p>Note that where the ordinary marginal means diverge away from the estimated marginal means, the EMM confidence interval is also wide, ultimately leading to the ordinary mean being within the confidence interval. This observation shows that the model (and its predictions) are consistent with the data. These confidence intervals are not calculated when doing ordinary means analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>combined_omm_emm_data <span class="sc">%&gt;%</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="fu">c</span>(<span class="st">"source"</span>, <span class="st">"percent"</span>, <span class="st">"n"</span>),</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_from =</span> <span class="st">"analysis"</span>,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> <span class="fu">c</span>(<span class="st">"conc"</span>, <span class="st">"lwr"</span>, <span class="st">"upr"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">where</span>(<span class="sc">~</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(.x)) <span class="sc">&gt;=</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">"EMM_CI_width"</span> <span class="ot">=</span> lwr_EMM <span class="sc">-</span> upr_EMM,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>         <span class="st">"EMM_pct_uncertainty"</span> <span class="ot">=</span> <span class="fu">round</span>(EMM_CI_width <span class="sc">/</span> conc_EMM <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>),</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>         <span class="st">"OMM_EMM_pct_diff"</span> <span class="ot">=</span> <span class="fu">round</span>((conc_OMM <span class="sc">-</span> conc_EMM) <span class="sc">/</span> conc_EMM <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(EMM_pct_uncertainty, OMM_EMM_pct_diff, <span class="at">.after =</span> conc_EMM)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 2%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 19%">
<col style="width: 16%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">source</th>
<th style="text-align: left;">percent</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">conc_OMM</th>
<th style="text-align: right;">conc_EMM</th>
<th style="text-align: right;">EMM_pct_uncertainty</th>
<th style="text-align: right;">OMM_EMM_pct_diff</th>
<th style="text-align: right;">lwr_EMM</th>
<th style="text-align: right;">upr_EMM</th>
<th style="text-align: right;">EMM_CI_width</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">fish</td>
<td style="text-align: left;">9</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">25.75000</td>
<td style="text-align: right;">25.95034</td>
<td style="text-align: right;">14.6</td>
<td style="text-align: right;">-0.8</td>
<td style="text-align: right;">27.98352</td>
<td style="text-align: right;">24.19259</td>
<td style="text-align: right;">3.790934</td>
</tr>
<tr class="even">
<td style="text-align: left;">fish</td>
<td style="text-align: left;">12</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">30.93333</td>
<td style="text-align: right;">30.03823</td>
<td style="text-align: right;">15.6</td>
<td style="text-align: right;">3.0</td>
<td style="text-align: right;">32.55836</td>
<td style="text-align: right;">27.88020</td>
<td style="text-align: right;">4.678168</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fish</td>
<td style="text-align: left;">15</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">31.15000</td>
<td style="text-align: right;">30.70872</td>
<td style="text-align: right;">17.7</td>
<td style="text-align: right;">1.4</td>
<td style="text-align: right;">33.66886</td>
<td style="text-align: right;">28.22702</td>
<td style="text-align: right;">5.441832</td>
</tr>
<tr class="even">
<td style="text-align: left;">fish</td>
<td style="text-align: left;">18</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">32.33333</td>
<td style="text-align: right;">32.93172</td>
<td style="text-align: right;">19.0</td>
<td style="text-align: right;">-1.8</td>
<td style="text-align: right;">36.35469</td>
<td style="text-align: right;">30.09786</td>
<td style="text-align: right;">6.256834</td>
</tr>
<tr class="odd">
<td style="text-align: left;">soy</td>
<td style="text-align: left;">9</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">34.63333</td>
<td style="text-align: right;">32.78166</td>
<td style="text-align: right;">17.2</td>
<td style="text-align: right;">5.6</td>
<td style="text-align: right;">35.83639</td>
<td style="text-align: right;">30.20681</td>
<td style="text-align: right;">5.629573</td>
</tr>
<tr class="even">
<td style="text-align: left;">soy</td>
<td style="text-align: left;">12</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">39.63333</td>
<td style="text-align: right;">39.58730</td>
<td style="text-align: right;">20.4</td>
<td style="text-align: right;">0.1</td>
<td style="text-align: right;">44.04318</td>
<td style="text-align: right;">35.95019</td>
<td style="text-align: right;">8.092997</td>
</tr>
<tr class="odd">
<td style="text-align: left;">soy</td>
<td style="text-align: left;">15</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">39.23333</td>
<td style="text-align: right;">40.76017</td>
<td style="text-align: right;">21.8</td>
<td style="text-align: right;">-3.7</td>
<td style="text-align: right;">45.69176</td>
<td style="text-align: right;">36.78942</td>
<td style="text-align: right;">8.902343</td>
</tr>
<tr class="even">
<td style="text-align: left;">soy</td>
<td style="text-align: left;">18</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">42.90000</td>
<td style="text-align: right;">44.77162</td>
<td style="text-align: right;">30.6</td>
<td style="text-align: right;">-4.2</td>
<td style="text-align: right;">52.64817</td>
<td style="text-align: right;">38.94515</td>
<td style="text-align: right;">13.703024</td>
</tr>
<tr class="odd">
<td style="text-align: left;">skim</td>
<td style="text-align: left;">9</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">35.40000</td>
<td style="text-align: right;">36.09727</td>
<td style="text-align: right;">19.1</td>
<td style="text-align: right;">-1.9</td>
<td style="text-align: right;">39.86363</td>
<td style="text-align: right;">32.98118</td>
<td style="text-align: right;">6.882447</td>
</tr>
<tr class="even">
<td style="text-align: left;">skim</td>
<td style="text-align: left;">12</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">43.46667</td>
<td style="text-align: right;">44.52619</td>
<td style="text-align: right;">23.3</td>
<td style="text-align: right;">-2.4</td>
<td style="text-align: right;">50.30224</td>
<td style="text-align: right;">39.94000</td>
<td style="text-align: right;">10.362244</td>
</tr>
<tr class="odd">
<td style="text-align: left;">skim</td>
<td style="text-align: left;">15</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">50.45000</td>
<td style="text-align: right;">46.01547</td>
<td style="text-align: right;">26.8</td>
<td style="text-align: right;">9.6</td>
<td style="text-align: right;">53.00407</td>
<td style="text-align: right;">40.65509</td>
<td style="text-align: right;">12.348975</td>
</tr>
<tr class="even">
<td style="text-align: left;">skim</td>
<td style="text-align: left;">18</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">59.80000</td>
<td style="text-align: right;">51.19373</td>
<td style="text-align: right;">35.6</td>
<td style="text-align: right;">16.8</td>
<td style="text-align: right;">61.88076</td>
<td style="text-align: right;">43.65446</td>
<td style="text-align: right;">18.226302</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The EMMs vs OMMs tend to differ more for smaller sample sizes (n). The confidence intervals also tend to be wider for the <code>lm</code> predictions on the lower sample size conditions in the experiment, and these tend to correlate with the difference between the OMM (ordinary marginal mean) and the EMM (estimated marginal mean), as the table above shows.</p>
<p>EMMs worked well for us. The application of a linear model (and a linearizing transformation of the response scale) allows for the balanced <em>reference grid</em> to get balanced estimated means for each effect. This process produced more balanced estimated means than the ordinary means taken from the grouped-by factor levels.</p>
<p>Given the good fit of the model, I would trust these EMMs more than the ordinary grouped-by means. Plus, the linear model gives us confidence intervals for each estimated marginal effect, to which statistical analysis can be applied.</p>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<p>In summary, I obtained a reference grid of all factor combinations, obtained model predictions on that grid, and then I estimated the expected marginal means as equally-weighted marginal averages of those predictions. Those EMMs are not subject to confounding by other factors or biased sampling, such as might happen with ordinary marginal means of the data. Moreover, unlike OMMs, EMMs are based on a model that is well-fitted to the data.</p>
</section>
<section id="references" class="level1">
<h1>References</h1>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Dray2024" class="csl-entry" role="listitem">
Dray, Matt. 2024. <span>“The Aesthetics Wiki: An r Addendum.”</span> rostrum.blog. <a href="https://www.rostrum.blog/posts/2024-05-08-aesthetic/">https://www.rostrum.blog/posts/2024-05-08-aesthetic/</a>.
</div>
<div id="ref-hernan2010causal" class="csl-entry" role="listitem">
Hernán, Miguel A, and James M Robins. 2010. <em>"Causal Inference: What If"</em>. Boca Raton: Chapman &amp; Hall/CRC.
</div>
<div id="ref-oehlert2010first" class="csl-entry" role="listitem">
Oehlert, Gary W. 2010. <em>A First Course in Design and Analysis of Experiments</em>.
</div>
<div id="ref-Searle1980" class="csl-entry" role="listitem">
S. R. Searle, F. M. Speed, and G. A. Milliken. 1980. <span>“Population Marginal Means in the Linear Model: An Alternative to Least Squares Means.”</span> <em>The American Statistician</em> 34 (4): 216–21. <a href="https://doi.org/10.1080/00031305.1980.10483031">https://doi.org/10.1080/00031305.1980.10483031</a>.
</div>
<div id="ref-Sanderson2023" class="csl-entry" role="listitem">
Steven P. Sanderson II, MPH. 2023. <span>“Unlocking the Power of Prediction Intervals in r: A Practical Guide.”</span> Steve’s Data Tips; Tricks. <a href="https://www.spsanderson.com/steveondata/posts/2023-11-13/index.html">https://www.spsanderson.com/steveondata/posts/2023-11-13/index.html</a>.
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="pdcherry/blogComments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2024, Patrick Cherry <a rel="me" href="https://fosstodon.org/@pcherry">@pcherry@fosstodon.org</a> or <a rel="me" href="https://genomic.social/@pcherry">@pcherry@genomic.social</a></p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>