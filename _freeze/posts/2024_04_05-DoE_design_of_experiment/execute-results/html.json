{
  "hash": "5cfe89ba7eb06a460e231929d2adb964",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"DoE: Design of Experiment\"\nauthor: \"Patrick Cherry\"\ndate: \"2024-04-05\"\ncategories:\n  - politics\nimage: \"2024_04_05-DoE_architecture_imperfect_grid.jpg\"\nformat:\n  html:\n    df-print: paged\nexecute:\n  freeze: TRUE\n  echo: FALSE\neditor_options: \n  chunk_output_type: inline\n---\n\n::: {.cell}\n\n:::\n\n\n![DoE experiments can make conclusions that are greater than the sum of its parts, though thoughtful designs. Much like an architectureal facade, DoEs often employ a grid of conditions that do not perfectly sample every possible combination. Image credit: seier+seier on Flickr under CC](2024_04_05-DoE_architecture_imperfect_grid.jpg)\n\n## Introduction and Background\nI had the idea that, given the success Panel A's bioinformatic performance, *it could be useful to show that TE panels work well for an extension of said bioinformatic performance.*\n\nTo do so, I propose using multiplexed capture, 100 ng (and optionally 10 ng of RNA input), and technical replicates (3, perhaps 2). These are parameterized in this DoE script below and the resulting sample plan is exported to google sheets.\n\n## Procedure\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfile_pref <- \"2023_05_24_RNA_TE__sensitivty_DoE\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npanel_info <- tribble(\n  ~panel,  ~panel_size,  ~needed_sequencing,\n  \"TE Panel A\", 3.0, NA,\n  \"TE Panel B\",  36.8, NA,\n  \"TE Panel C\",  35.8, NA,\n  \"Whole Transcriptome\", NA, NA,\n)\n```\n:::\n\n\n## DoE with blocking for multiple operators\nI will block for the operators carrying out library prep, because operator is a known source of variation that is not relevant to understanding the effect of TE panel, RNA input mass, or concentration on performance.\n\nBlocking is the non-random assignment of samples to groups to minimize differences in the sample composition between the groups such that any effect of the grouping can be determined by the model and ignored (modeled out quantitatively and precisely).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrna_TE__sensitivity_doe$D;\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.3789291\n```\n\n\n:::\n\n```{.r .cell-code}\nrna_TE__sensitivity_doe$diagonality\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.871\n```\n\n\n:::\n:::\n\n\nDiagonality is the degree to which the blocked variables are uncorrelated: a diagonality of 1.0 is perfectly uncorrelated. A value of 0.871 is moderate. We are getting values less than 1.0, because not every number of unique sample ( 2 * 4 * ~~5~~ ) factors to be processed is divisible by the number of blocking groups. We will see this effect illustrated in the \"Check orthogonality of blocking\" section.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrna_TE__blocking_df <- bind_rows(\n mutate(rna_TE__sensitivity_doe$Blocks$B1, \"operator\" = \"Operator A\"),\n mutate(rna_TE__sensitivity_doe$Blocks$B2, \"operator\" = \"Operator B\"),\n) %>%\n  arrange(panel, conc, mass_input)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n(panels_to_join <- rna_TE__blocking_df %>%\n  distinct(panel) %>%\n   bind_cols(rename(panel_info, \"panel_name\" = 1)))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"panel\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"panel_name\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"panel_size\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"needed_sequencing\"],\"name\":[4],\"type\":[\"lgl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"1\",\"2\":\"TE Panel A\",\"3\":\"3.0\",\"4\":\"NA\"},{\"1\":\"2\",\"2\":\"TE Panel B\",\"3\":\"36.8\",\"4\":\"NA\"},{\"1\":\"3\",\"2\":\"TE Panel C\",\"3\":\"35.8\",\"4\":\"NA\"},{\"1\":\"4\",\"2\":\"Whole Transcriptome\",\"3\":\"NA\",\"4\":\"NA\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n(fusconcs_to_join <- rna_TE__blocking_df %>%\n  distinct(conc) %>%\n  bind_cols(concentrations) %>%\n  rename(\"concentrations\" = 2))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"conc\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"concentrations\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"-2\",\"2\":\"0.027\"},{\"1\":\"-1\",\"2\":\"0.0027\"},{\"1\":\"0\",\"2\":\"0.00027\"},{\"1\":\"1\",\"2\":\"2.7e-05\"},{\"1\":\"2\",\"2\":\"2.7e-06\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n(massinput_to_join <- rna_TE__blocking_df %>%\n  distinct(mass_input) %>%\n  bind_cols(mass_inputs) %>%\n  rename(\"mass_inputs\" = 2))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"mass_input\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"mass_inputs\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"-1\",\"2\":\"10\"},{\"1\":\"1\",\"2\":\"100\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrna_TE__doe_blocked <- rna_TE__blocking_df %>%\n  left_join(panels_to_join, by = \"panel\") %>%\n  left_join(fusconcs_to_join, by = \"conc\") %>%\n  left_join(massinput_to_join, by = \"mass_input\") %>%\n  select(\"panel\" = \"panel_name\", \"conc\" = \"concentrations\",\n         \"mass_input\" = \"mass_inputs\", \"operator\", panel_size, needed_sequencing) %>%\n  arrange(panel, desc(conc), mass_input) %>%\n  mutate(\"replicate_num\" = row_number(), .by = c(panel, conc, mass_input)) %>%\n  relocate(replicate_num, .after = operator) %>%\n  rename(\"LP_operator\" = \"operator\") %>%\n  arrange(panel, mass_input) %>%\n  mutate(\"capture\" = ceiling(row_number()/6) ) %>%\n  relocate(\"capture\", .after = replicate_num) %>%\n  arrange(panel, desc(conc), mass_input)\nhead(rna_TE__doe_blocked, n = 10)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"panel\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"conc\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"mass_input\"],\"name\":[3],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"LP_operator\"],\"name\":[4],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"replicate_num\"],\"name\":[5],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"capture\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"panel_size\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"needed_sequencing\"],\"name\":[8],\"type\":[\"lgl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"TE Panel A\",\"2\":\"0.027\",\"3\":\"10\",\"4\":\"Operator A\",\"5\":\"1\",\"6\":\"1\",\"7\":\"3\",\"8\":\"NA\",\"_rn_\":\"1\"},{\"1\":\"TE Panel A\",\"2\":\"0.027\",\"3\":\"10\",\"4\":\"Operator B\",\"5\":\"2\",\"6\":\"1\",\"7\":\"3\",\"8\":\"NA\",\"_rn_\":\"2\"},{\"1\":\"TE Panel A\",\"2\":\"0.027\",\"3\":\"10\",\"4\":\"Operator B\",\"5\":\"3\",\"6\":\"1\",\"7\":\"3\",\"8\":\"NA\",\"_rn_\":\"3\"},{\"1\":\"TE Panel A\",\"2\":\"0.027\",\"3\":\"100\",\"4\":\"Operator B\",\"5\":\"1\",\"6\":\"3\",\"7\":\"3\",\"8\":\"NA\",\"_rn_\":\"4\"},{\"1\":\"TE Panel A\",\"2\":\"0.027\",\"3\":\"100\",\"4\":\"Operator B\",\"5\":\"2\",\"6\":\"3\",\"7\":\"3\",\"8\":\"NA\",\"_rn_\":\"5\"},{\"1\":\"TE Panel A\",\"2\":\"0.027\",\"3\":\"100\",\"4\":\"Operator B\",\"5\":\"3\",\"6\":\"3\",\"7\":\"3\",\"8\":\"NA\",\"_rn_\":\"6\"},{\"1\":\"TE Panel A\",\"2\":\"0.0027\",\"3\":\"10\",\"4\":\"Operator A\",\"5\":\"1\",\"6\":\"1\",\"7\":\"3\",\"8\":\"NA\",\"_rn_\":\"7\"},{\"1\":\"TE Panel A\",\"2\":\"0.0027\",\"3\":\"10\",\"4\":\"Operator A\",\"5\":\"2\",\"6\":\"1\",\"7\":\"3\",\"8\":\"NA\",\"_rn_\":\"8\"},{\"1\":\"TE Panel A\",\"2\":\"0.0027\",\"3\":\"10\",\"4\":\"Operator A\",\"5\":\"3\",\"6\":\"1\",\"7\":\"3\",\"8\":\"NA\",\"_rn_\":\"9\"},{\"1\":\"TE Panel A\",\"2\":\"0.0027\",\"3\":\"100\",\"4\":\"Operator A\",\"5\":\"1\",\"6\":\"4\",\"7\":\"3\",\"8\":\"NA\",\"_rn_\":\"10\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n### Check orthogonality of blocking\n\n::: {.cell}\n\n```{.r .cell-code}\nrna_TE__doe_blocked %>% count(LP_operator, mass_input)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"LP_operator\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"mass_input\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"n\"],\"name\":[3],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"Operator A\",\"2\":\"10\",\"3\":\"30\"},{\"1\":\"Operator A\",\"2\":\"100\",\"3\":\"30\"},{\"1\":\"Operator B\",\"2\":\"10\",\"3\":\"30\"},{\"1\":\"Operator B\",\"2\":\"100\",\"3\":\"30\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrna_TE__doe_blocked %>% count(LP_operator, panel)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"LP_operator\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"panel\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"n\"],\"name\":[3],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"Operator A\",\"2\":\"TE Panel A\",\"3\":\"15\"},{\"1\":\"Operator A\",\"2\":\"TE Panel B\",\"3\":\"15\"},{\"1\":\"Operator A\",\"2\":\"TE Panel C\",\"3\":\"15\"},{\"1\":\"Operator A\",\"2\":\"Whole Transcriptome\",\"3\":\"15\"},{\"1\":\"Operator B\",\"2\":\"TE Panel A\",\"3\":\"15\"},{\"1\":\"Operator B\",\"2\":\"TE Panel B\",\"3\":\"15\"},{\"1\":\"Operator B\",\"2\":\"TE Panel C\",\"3\":\"15\"},{\"1\":\"Operator B\",\"2\":\"Whole Transcriptome\",\"3\":\"15\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrna_TE__doe_blocked %>% count(LP_operator, conc)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"LP_operator\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"conc\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"n\"],\"name\":[3],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"Operator A\",\"2\":\"2.7e-06\",\"3\":\"13\"},{\"1\":\"Operator A\",\"2\":\"2.7e-05\",\"3\":\"12\"},{\"1\":\"Operator A\",\"2\":\"0.00027\",\"3\":\"9\"},{\"1\":\"Operator A\",\"2\":\"0.0027\",\"3\":\"14\"},{\"1\":\"Operator A\",\"2\":\"0.027\",\"3\":\"12\"},{\"1\":\"Operator B\",\"2\":\"2.7e-06\",\"3\":\"11\"},{\"1\":\"Operator B\",\"2\":\"2.7e-05\",\"3\":\"12\"},{\"1\":\"Operator B\",\"2\":\"0.00027\",\"3\":\"15\"},{\"1\":\"Operator B\",\"2\":\"0.0027\",\"3\":\"10\"},{\"1\":\"Operator B\",\"2\":\"0.027\",\"3\":\"12\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ngooglesheets4::write_sheet(rna_TE__doe_blocked, ss = \"sheet_string_goes_here\",\n                           sheet = \"rna_TE__sensitivity_doe\");\nfile_dest_dir <- \"doe_design_of_experiment_with_library_prep_files\"\nfs::dir_create(file_dest_dir);\nwrite_csv(rna_TE__doe_blocked, paste0(file_dest_dir, \"/\",\n                                      file_pref,\n                                      \"_rna_TE__sensitivity_doe.csv\"))\n```\n:::\n\n\n### Analyze captures\n\n::: {.cell}\n\n```{.r .cell-code}\nrna_TE__doe_blocked %>%\n  count(capture, panel, mass_input)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"capture\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"panel\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"mass_input\"],\"name\":[3],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"n\"],\"name\":[4],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"1\",\"2\":\"TE Panel A\",\"3\":\"10\",\"4\":\"6\"},{\"1\":\"2\",\"2\":\"TE Panel A\",\"3\":\"10\",\"4\":\"6\"},{\"1\":\"3\",\"2\":\"TE Panel A\",\"3\":\"10\",\"4\":\"3\"},{\"1\":\"3\",\"2\":\"TE Panel A\",\"3\":\"100\",\"4\":\"3\"},{\"1\":\"4\",\"2\":\"TE Panel A\",\"3\":\"100\",\"4\":\"6\"},{\"1\":\"5\",\"2\":\"TE Panel A\",\"3\":\"100\",\"4\":\"6\"},{\"1\":\"6\",\"2\":\"TE Panel B\",\"3\":\"10\",\"4\":\"6\"},{\"1\":\"7\",\"2\":\"TE Panel B\",\"3\":\"10\",\"4\":\"6\"},{\"1\":\"8\",\"2\":\"TE Panel B\",\"3\":\"10\",\"4\":\"3\"},{\"1\":\"8\",\"2\":\"TE Panel B\",\"3\":\"100\",\"4\":\"3\"},{\"1\":\"9\",\"2\":\"TE Panel B\",\"3\":\"100\",\"4\":\"6\"},{\"1\":\"10\",\"2\":\"TE Panel B\",\"3\":\"100\",\"4\":\"6\"},{\"1\":\"11\",\"2\":\"TE Panel C\",\"3\":\"10\",\"4\":\"6\"},{\"1\":\"12\",\"2\":\"TE Panel C\",\"3\":\"10\",\"4\":\"6\"},{\"1\":\"13\",\"2\":\"TE Panel C\",\"3\":\"10\",\"4\":\"3\"},{\"1\":\"13\",\"2\":\"TE Panel C\",\"3\":\"100\",\"4\":\"3\"},{\"1\":\"14\",\"2\":\"TE Panel C\",\"3\":\"100\",\"4\":\"6\"},{\"1\":\"15\",\"2\":\"TE Panel C\",\"3\":\"100\",\"4\":\"6\"},{\"1\":\"16\",\"2\":\"Whole Transcriptome\",\"3\":\"10\",\"4\":\"6\"},{\"1\":\"17\",\"2\":\"Whole Transcriptome\",\"3\":\"10\",\"4\":\"6\"},{\"1\":\"18\",\"2\":\"Whole Transcriptome\",\"3\":\"10\",\"4\":\"3\"},{\"1\":\"18\",\"2\":\"Whole Transcriptome\",\"3\":\"100\",\"4\":\"3\"},{\"1\":\"19\",\"2\":\"Whole Transcriptome\",\"3\":\"100\",\"4\":\"6\"},{\"1\":\"20\",\"2\":\"Whole Transcriptome\",\"3\":\"100\",\"4\":\"6\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n## Conclusion\nGreat! We have an experiment design for testing the effect of these panels against each other and against whole transcriptome sequencing. The experiment had n = 3 replicates, and it is blocked for having two operators carry out the RNA-seq library preps.\n\nImportantly, when I get feedback on the design of this sample layout, I can easily show my work. Even better, if changes are needed, the entire design is programmed, and can be changed in seconds.\n\nLet's go!\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}